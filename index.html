<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎧 Soundscape Studio - Professional Field Recording & Composition</title>

    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Tone.js for high-quality sampled instruments -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e8f5f1 0%, #d4f1e8 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d5f4f 0%, #3d7f6f 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f8f9f5;
            color: #2d5f4f;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-button:hover {
            background: #2d5f4f;
            color: white;
        }

        .nav-button.active {
            background: #2d5f4f;
            color: white;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(45,95,79,0.2);
        }

        .card h3 {
            color: #2d5f4f;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .card-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5f4f, #8ba888);
            transition: width 0.3s;
        }

        /* Spectrogram Container */
        .spectrogram-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .spectrogram-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .spectrogram-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #f4a261;
            color: white;
        }

        .btn-primary:hover {
            background: #e89b5a;
        }

        .btn-secondary {
            background: #8ba888;
            color: white;
        }

        .btn-secondary:hover {
            background: #7a9777;
        }

        .btn-danger {
            background: #e76f51;
            color: white;
        }

        .btn-danger:hover {
            background: #d66548;
        }

        #spectrogramCanvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            background: #000;
        }

        .spectrogram-info {
            display: flex;
            justify-content: space-between;
            color: #8ba888;
            font-size: 12px;
            margin-top: 10px;
            font-family: monospace;
        }

        /* Exercise Grid */
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .exercise-card {
            position: relative;
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #2d5f4f;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .exercise-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(45,95,79,0.2);
        }

        .exercise-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .cat-ascolto { background: #ffeaa7; color: #2d3436; }
        .cat-registrazione { background: #74b9ff; color: #2d3436; }
        .cat-editing { background: #a29bfe; color: white; }
        .cat-composizione { background: #fd79a8; color: white; }

        .exercise-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d5f4f;
            margin-bottom: 8px;
        }

        .exercise-meta {
            font-size: 13px;
            color: #666;
        }

        /* Toolkit */
        .toolkit-section {
            margin-bottom: 30px;
        }

        .toolkit-section h3 {
            color: #2d5f4f;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .reference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .reference-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .reference-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Reference Modal */
        .reference-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            overflow-y: auto;
        }

        .reference-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            max-width: 800px;
            border-radius: 12px;
            position: relative;
        }

        .reference-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #666;
        }

        .reference-modal-close:hover {
            color: #2d5f4f;
        }

        .frequency-bar {
            display: flex;
            height: 60px;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .frequency-section {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
            padding: 5px;
            position: relative;
        }

        .eq-diagram {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        /* Equipment Cards */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .equipment-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #2d5f4f;
        }

        .equipment-card h4 {
            color: #2d5f4f;
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .equipment-card .price {
            color: #8ba888;
            font-weight: bold;
            font-size: 16px;
            margin: 10px 0;
        }

        .equipment-card .category-badge {
            display: inline-block;
            background: #2d5f4f;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .equipment-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .equipment-card ul li {
            margin: 5px 0;
            font-size: 14px;
            color: #555;
        }

        /* Library Cards */
        .library-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #2d5f4f;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .library-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .library-item h4 {
            color: #2d5f4f;
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .library-item .author {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            font-style: italic;
        }

        .library-item .description {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .library-item .link-btn {
            display: inline-block;
            background: #2d5f4f;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .library-item .link-btn:hover {
            background: #1f4538;
            transform: translateX(3px);
        }

        .library-category {
            display: inline-block;
            background: #e8f5e9;
            color: #2d5f4f;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Audio Upload */
        .upload-area {
            border: 2px dashed #8ba888;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #2d5f4f;
            background: #f8f9f5;
        }

        .upload-area input {
            display: none;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2d5f4f;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #2d5f4f;
            background: #f8f9f5;
        }

        .filter-btn.active {
            border-color: #2d5f4f;
            background: #2d5f4f;
            color: white;
        }

        /* Example Image Cards */
        .example-image-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .example-image-card:hover {
            transform: translateY(-4px);
        }

        .example-image-card canvas {
            transition: border-color 0.3s;
        }

        .example-image-card:hover canvas {
            border-color: #2d5f4f !important;
            box-shadow: 0 4px 8px rgba(45,95,79,0.3);
        }

        /* Footer */
        .section-footer {
            margin-top: 40px;
            padding: 30px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .footer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .footer-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .footer-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .footer-btn.whatsapp:hover {
            background: #1da851;
        }

        .footer-btn.facebook {
            background: #1877F2;
            color: white;
        }

        .footer-btn.facebook:hover {
            background: #145dbf;
        }

        .footer-btn.paypal {
            background: #FFC439;
            color: #003087;
        }

        .footer-btn.paypal:hover {
            background: #e6b033;
        }

        .footer-btn.feedback {
            background: #2d5f4f;
            color: white;
        }

        .footer-btn.feedback:hover {
            background: #1f4538;
        }

        .footer-credits {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .footer-credits strong {
            color: #2d5f4f;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>🎧 Soundscape Studio</h1>
        <p>Professional Field Recording & Composition Toolkit</p>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <button class="nav-button active" onclick="showSection('dashboard')">🏠 Dashboard</button>
        <button class="nav-button" onclick="showSection('exercises')">🔔 Soundscape Exercises</button>
        <button class="nav-button" onclick="showMapSection()">🗺️ Soundscape Map</button>
        <button class="nav-button" onclick="showSection('toolkit')">🔧 Toolkit</button>
        <button class="nav-button" onclick="showSection('library')">📚 Library</button>
        <button class="nav-button" onclick="showSection('guide')">📖 Guide</button>
    </div>

    <!-- Container -->
    <div class="container">

        <!-- DASHBOARD SECTION -->
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">👋 Welcome to Your Studio</h2>

            <!-- Completed Exercises -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 15px;">📝 Your Completed Exercises</h3>
                <div id="completedExercisesList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated dynamically -->
                </div>
                <button onclick="showAllCompletedExercises()" style="margin-top: 15px; padding: 10px 20px; background: #2d5f4f; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600;">
                    📋 View All Completed Exercises
                </button>
            </div>

            <!-- Quick Access -->
            <h3 style="margin: 30px 0 15px; color: #2d5f4f;">🚀 Quick Access</h3>
            <div class="dashboard-grid">
                <div class="card" onclick="showSection('exercises')">
                    <div class="card-icon">🎯</div>
                    <h3>Daily Exercises</h3>
                    <p>100 professional field recording exercises</p>
                </div>

                <div class="card" onclick="showSection('toolkit')">
                    <div class="card-icon">🔧</div>
                    <h3>Professional Toolkit</h3>
                    <p>Technical guides, reference charts, templates</p>
                </div>

                <div class="card" onclick="showSection('library')">
                    <div class="card-icon">📚</div>
                    <h3>Library</h3>
                    <p>History, theory, articles and resources</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Check%20out%20Soundscape%20Studio!%20A%20complete%20toolkit%20for%20field%20recording%20and%20sound%20composition%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- EXERCISES SECTION -->
        <div id="exercises" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">🔔 Soundscape Exercises</h2>

            <!-- Filters -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="margin-bottom: 15px;">
                    <strong style="color: #2d5f4f;">Filter by Category:</strong>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="filter-btn active" onclick="filterExercises('all')" data-filter="all">
                            All
                        </button>
                        <button class="filter-btn" onclick="filterExercises('ascolto-base')" data-filter="ascolto-base">
                            👂 Basic Listening
                        </button>
                        <button class="filter-btn" onclick="filterExercises('movimento-suono')" data-filter="movimento-suono">
                            🚶 Movement and Sound
                        </button>
                        <button class="filter-btn" onclick="filterExercises('ascolto-estremo')" data-filter="ascolto-estremo">
                            🔭 Extreme Listening
                        </button>
                        <button class="filter-btn" onclick="filterExercises('produzione-imitazione')" data-filter="produzione-imitazione">
                            🎭 Production and Imitation
                        </button>
                        <button class="filter-btn" onclick="filterExercises('giochi-vocali')" data-filter="giochi-vocali">
                            🗣️ Vocal Games
                        </button>
                        <button class="filter-btn" onclick="filterExercises('registrazione-analisi')" data-filter="registrazione-analisi">
                            🎚️ Recording and Analysis
                        </button>
                        <button class="filter-btn" onclick="filterExercises('silenzio-memoria')" data-filter="silenzio-memoria">
                            🤫 Silence and Memory
                        </button>
                        <button class="filter-btn" onclick="filterExercises('comunita-ambiente')" data-filter="comunita-ambiente">
                            🏛️ Community and Environment
                        </button>
                        <button class="filter-btn" onclick="filterExercises('parchi-spazi')" data-filter="parchi-spazi">
                            🌳 Parks and Spaces
                        </button>
                    </div>
                </div>
            </div>

            <div class="exercise-grid" id="exerciseGrid">
                <!-- Exercises will be generated via JavaScript -->
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Check%20out%20Soundscape%20Studio!%20A%20complete%20toolkit%20for%20field%20recording%20and%20sound%20composition%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- TOOLKIT SECTION -->
        <div id="toolkit" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">🔧 Professional Toolkit</h2>

            <!-- Reference Guides - Clickable -->
            <div class="toolkit-section">
                <h3>📐 Reference Guides</h3>
                <div class="reference-grid">
                    <div class="reference-item" onclick="showReferenceModal('polar-patterns')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">🎙️</div>
                        <strong>Polar Patterns</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Polar pattern guide</p>
                    </div>
                    <div class="reference-item" onclick="showReferenceModal('frequency-chart')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">📊</div>
                        <strong>Frequency Chart</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Frequency ranges</p>
                    </div>
                    <div class="reference-item" onclick="showReferenceModal('eq-settings')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">🎚️</div>
                        <strong>EQ Settings</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">EQ for environments</p>
                    </div>
                    <div class="reference-item" onclick="showReferenceModal('sample-rate')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">💿</div>
                        <strong>Sample Rate</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Audio format guide</p>
                    </div>
                </div>
            </div>

            <!-- Equipment Tabs -->
            <div class="toolkit-section" style="margin-top: 30px;">
                <h3>🎙️ Recommended Equipment</h3>

                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="filter-btn active" onclick="showEquipmentTab('recorders')" data-equipment="recorders">
                        🎙️ Field Recorders
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('microphones')" data-equipment="microphones">
                        🎤 Microphones
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('windscreens')" data-equipment="windscreens">
                        🌬️ Windscreens
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('stands')" data-equipment="stands">
                        🎚️ Stands
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('storage')" data-equipment="storage">
                        💾 Memory Cards
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('bags')" data-equipment="bags">
                        🎒 Bags
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('smartphones')" data-equipment="smartphones">
                        📱 Smartphones
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('software')" data-equipment="software">
                        💻 Software
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="equipment-content">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Check%20out%20Soundscape%20Studio!%20A%20complete%20toolkit%20for%20field%20recording%20and%20sound%20composition%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- LIBRARY SECTION -->
        <div id="library" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">📚 Soundscape Library</h2>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="filter-btn active" onclick="showLibraryTab('books')" data-library="books">
                    📕 Essential Books
                </button>
                <button class="filter-btn" onclick="showLibraryTab('videos')" data-library="videos">
                    🎬 Videos & Documentaries
                </button>
                <button class="filter-btn" onclick="showLibraryTab('audio')" data-library="audio">
                    🎧 Audio Examples
                </button>
                <button class="filter-btn" onclick="showLibraryTab('papers')" data-library="papers">
                    📄 Papers & Articles
                </button>
                <button class="filter-btn" onclick="showLibraryTab('resources')" data-library="resources">
                    🔗 Online Resources
                </button>
            </div>

            <!-- Tab Content -->
            <div id="library-content">
                <!-- Content will be loaded by JavaScript -->
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Check%20out%20Soundscape%20Studio!%20A%20complete%20toolkit%20for%20field%20recording%20and%20sound%20composition%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- GUIDE SECTION -->
        <div id="guide" class="section">
            <h2 style="margin-bottom: 30px; color: #2d5f4f; text-align: center;">📖 Complete Guide to Soundscape Studio</h2>

            <!-- Project Introduction -->
            <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #f0f7f4 0%, #e8f5f1 100%); border-left: 5px solid #2d5f4f;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">🎯 The Project</h3>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    <strong>Soundscape Studio</strong> is part of a broader project of <strong>research and development of educational applications for artists and musicians</strong>,
                    created by <strong>Francesco Mariano</strong> of <strong>Gruppo Apuano Sperimentale</strong>.
                </p>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    This project stems from the need to provide professional and accessible tools to support the artistic and technical growth
                    of musicians, sound designers, composers and sound artists. The goal is to democratize access to advanced skills through
                    interactive digital platforms that combine theory, practice and field experience.
                </p>

                <!-- Francesco Mariano Presentation -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #4a9d7f;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">👤 Francesco Mariano</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 15px;">
                        My artistic research focuses on <strong>electroacoustic composition</strong>, <strong>interactive sound installations</strong>,
                        <strong>soundscape composition</strong> and <strong>immersive audio environments</strong> through <strong>Max/MSP Jitter</strong>,
                        <strong>TouchDesigner</strong> programming and development of interactive applications and software in the artistic field.
                    </p>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        <strong>Professor of Interaction Design</strong> at the <strong>Academy of Fine Arts of Macerata</strong> and the <strong>Academy of Fine Arts of Catania</strong>.
                    </p>
                </div>

                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">🌟 Project Philosophy</h4>
                    <ul style="line-height: 2; color: #2c3e50; font-size: 15px;">
                        <li><strong>Active Learning</strong>: Not just theory, but guided practical exercises</li>
                        <li><strong>Accessibility</strong>: Free and open, to break down economic barriers</li>
                        <li><strong>Professionalism</strong>: Professional standards, real equipment, established workflows</li>
                        <li><strong>Community</strong>: Sharing experiences, recordings and discoveries</li>
                        <li><strong>Innovation</strong>: Use of modern technologies (IndexedDB, Web Audio API, Geolocation)</li>
                    </ul>
                </div>

                <div style="background: #fffbe6; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f4a261;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">🚀 Future Roadmap</h4>
                    <p style="color: #2c3e50; line-height: 1.8; font-size: 15px; margin-bottom: 15px;">
                        <strong>📱 iOS Soundscape Studio App</strong> (coming to App Store): Native version with cloud synchronization,
                        advanced offline features, professional export, and additional analysis tools. Will be paid
                        to support continuous project development.
                    </p>
                    <p style="color: #2c3e50; line-height: 1.8; font-size: 15px;">
                        Soundscape Studio is the first of a series of educational tools dedicated to various musical and artistic disciplines.
                        Future applications will be developed for composition, music theory, sound design, audio production,
                        acoustic analysis, and more.
                    </p>
                </div>
            </div>

            <!-- What is Soundscape -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">🎧 What is Soundscape?</h3>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    The term <strong>soundscape</strong> was coined by Canadian composer and theorist <strong>R. Murray Schafer</strong>
                    in the 1970s, as part of his revolutionary <em>World Soundscape Project</em>.
                </p>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    A soundscape is the ensemble of all sounds present in a specific environment: natural (wind, rain, animals),
                    human (voices, traffic, machines) and architectural (reverbs, reflections). It's not just "ambient recording",
                    but a conscious approach to <strong>deep listening</strong> and <strong>composition with real sounds</strong>.
                </p>

                <div style="background: #f8f9f5; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">📚 Schafer's Fundamental Concepts</h4>
                    <ul style="line-height: 2; color: #2c3e50; font-size: 15px;">
                        <li><strong>Keynote Sounds</strong>: Constant background sounds (wind, distant traffic, sea)</li>
                        <li><strong>Signal Sounds</strong>: Foreground sounds that emerge (bell tower, siren, bird)</li>
                        <li><strong>Soundmark</strong>: Characteristic sounds of a place (like a visual "landmark")</li>
                        <li><strong>Hi-Fi vs Lo-Fi</strong>: Clean sound environments vs noisy/confused</li>
                        <li><strong>Schizophonia</strong>: Separation of sound from its original source (e.g. recordings)</li>
                    </ul>
                </div>

                <div style="background: #e8f5f1; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">🎼 Field Recording Applications</h4>
                    <ul style="line-height: 2; color: #2c3e50; font-size: 15px;">
                        <li><strong>Musique Concrète</strong>: Composition with concrete sounds (Pierre Schaeffer, Pierre Henry)</li>
                        <li><strong>Sound Art</strong>: Sound installations, acoustic sculptures</li>
                        <li><strong>Sound Design</strong>: Film, video games, theater</li>
                        <li><strong>Acoustic Documentation</strong>: Sound archives, anthropological research</li>
                        <li><strong>Acoustic Ecology</strong>: Study of natural environments, bioacoustics</li>
                        <li><strong>Sound Mindfulness</strong>: Deep listening, meditation, sound therapy</li>
                    </ul>
                </div>
            </div>

            <!-- Section Explanation -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 25px; font-size: 22px;">🧭 How to Use Soundscape Studio</h3>

                <!-- Dashboard -->
                <div style="background: #f8f9f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2d5f4f;">
                    <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 18px;">🏠 Dashboard</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        Your <strong>home base</strong>. Here you'll find:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>Completed Exercises</strong>: History of your saved exercises with audio, photos and notes</li>
                        <li><strong>Quick Access</strong>: Shortcuts to main sections (Exercises, Toolkit, Map, Library)</li>
                        <li><strong>Activity Overview</strong>: View your progress in field recording</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 Tip: Return here after each session to review your work!
                    </p>
                </div>

                <!-- Exercises -->
                <div style="background: #fff8f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #d32f2f;">
                    <h4 style="color: #d32f2f; margin-bottom: 12px; font-size: 18px;">🔔 Soundscape Exercises</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        The <strong>heart of the toolkit</strong>. 96 professional exercises divided into 12 categories:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>Urban Traffic</strong>: Cars, motorcycles, buses, traffic jams</li>
                        <li><strong>Markets</strong>: Voices, vendors, commercial atmospheres</li>
                        <li><strong>Nature</strong>: Woods, birds, rain, wind</li>
                        <li><strong>Coast</strong>: Sea, waves, ports, beaches</li>
                        <li><strong>Railways</strong>: Trains, stations, level crossings</li>
                        <li><strong>Industry</strong>: Factories, machinery, construction sites</li>
                        <li><strong>Urban Parks</strong>: City and nature combined</li>
                        <li><strong>Voices/Crowds</strong>: Demonstrations, events, conversations</li>
                        <li><strong>Construction Sites</strong>: Building, demolition, roadworks</li>
                        <li><strong>Airports</strong>: Planes, terminals, announcements</li>
                        <li><strong>Public Interiors</strong>: Museums, libraries, metro stations</li>
                        <li><strong>Special Events</strong>: Festivals, concerts, celebrations</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 How it works:
                    </p>
                    <ol style="line-height: 1.8; color: #2c3e50; font-size: 14px; margin-left: 20px; margin-top: 8px;">
                        <li>Filter by category or difficulty level</li>
                        <li>Read brief, objectives, recommended setup</li>
                        <li>Go to the field and record</li>
                        <li>Return to the app and click "Start Exercise"</li>
                        <li>Upload audio, photos, notes, answers to guide questions</li>
                        <li>Save everything locally (IndexedDB) - no account required!</li>
                    </ol>
                </div>

                <!-- Soundscape Map -->
                <div style="background: #e8f5f1; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4a9d7f;">
                    <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 18px;">🗺️ Soundscape Map</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        An <strong>interactive map</strong> to document your soundscapes:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>Geolocate</strong>: Click on the map to add markers</li>
                        <li><strong>Categorize</strong>: Traffic, market, nature, industrial, etc.</li>
                        <li><strong>Record or Upload</strong>: Add audio directly from microphone or file</li>
                        <li><strong>Annotate</strong>: Describe the soundscape, time, weather conditions</li>
                        <li><strong>Play</strong>: Click on markers to listen to your recordings</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 Use the Map to build a <strong>personal geolocated archive</strong> of your recordings.
                        Perfect for urban or natural acoustic documentation projects.
                    </p>
                </div>

                <!-- Toolkit -->
                <div style="background: #fff4f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff6b35;">
                    <h4 style="color: #d32f2f; margin-bottom: 12px; font-size: 18px;">🔧 Toolkit</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        An <strong>equipment guide</strong> for field recording. Divided into 3 levels:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>🟢 Budget (€50-200)</strong>: Smartphone + apps, entry-level recorders (Zoom H1n)</li>
                        <li><strong>🟡 Intermediate (€200-1000)</strong>: Zoom H5/F3, shotgun microphones, accessories</li>
                        <li><strong>🔴 Professional (€1000+)</strong>: Zoom F6, Sound Devices, professional Sennheiser/Rode microphones</li>
                    </ul>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-top: 12px;">
                        Each product includes:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 14px; margin-left: 20px;">
                        <li>📄 <strong>Professional review</strong>: Pros, cons, ideal use cases</li>
                        <li>🛒 <strong>Purchase links</strong>: Thomann (audio hardware) or Amazon (accessories/books)</li>
                        <li>💰 <strong>Price range</strong>: Updated estimate</li>
                        <li>⚙️ <strong>Key specs</strong>: Resolution, channels, battery life, weight</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 You don't need to buy everything! Start with Budget, experiment, then invest based on your needs.
                    </p>
                </div>

                <!-- Library -->
                <div style="background: #f0f4ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #5b7cff;">
                    <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 18px;">📚 Library</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        Curated resources to deepen theory and practice:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>📕 Essential Books</strong>: Schafer, Krause, Watson, Oliveros - field recording classics</li>
                        <li><strong>🎬 Videos & Documentaries</strong>: Tutorials, interviews, soundscape documentaries</li>
                        <li><strong>🎧 Audio Examples</strong>: Iconic recordings to study (Bernie Krause, Chris Watson)</li>
                        <li><strong>📄 Papers & Articles</strong>: Academic research on acoustic ecology, sound studies</li>
                        <li><strong>🔗 Online Resources</strong>: Sound archives, communities, forums, databases</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 Amazon links in the Library include the affiliate tag <code>soundscapestu-21</code> - if you purchase from there,
                        you support the development of this project at no extra cost!
                    </p>
                </div>
            </div>

            <!-- Tips & Best Practices -->
            <div class="card" style="margin-bottom: 30px; background: #fffbe6; border-left: 5px solid #f4a261;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">💡 Tips & Best Practices</h3>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">🎤 During Recording</h4>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Always use <strong>headphones</strong> to monitor in real-time</li>
                        <li>Check levels: avoid clipping (red LEDs), but don't record too low</li>
                        <li>Record at least <strong>2-3 minutes</strong> for each soundscape (you need material for editing)</li>
                        <li>Make multiple takes of the same location (morning vs evening, weekday vs weekend)</li>
                        <li>Experiment with different angles: stereo XY, MS, spaced pair</li>
                        <li>Note everything: time, weather, special events, technical issues</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">📝 Documentation</h4>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Take <strong>setup photos</strong>: microphone, position, environment</li>
                        <li>Mark precise GPS coordinates (use the Map!)</li>
                        <li>Describe in detail: "Market square, Saturday morning 9:30 AM, sunny, about 50 people"</li>
                        <li>Save technical metadata: gain, sample rate, microphone type</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">🔒 Privacy & Legal</h4>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>In most countries, recording in <strong>public spaces</strong> is generally legal (no expectation of privacy)</li>
                        <li>Avoid recognizable private conversations (GDPR/privacy laws)</li>
                        <li>Request permission for private spaces (museums, shops, restaurants)</li>
                        <li>If publishing online, consider Creative Commons licensing</li>
                    </ul>
                </div>

                <div>
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">🎓 Recommended Workflow</h4>
                    <ol style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Choose 1-2 exercises from the <strong>Exercises</strong> section</li>
                        <li>Study the brief and prepare equipment (see <strong>Toolkit</strong>)</li>
                        <li>Go to the field and record (use <strong>Soundscape Map</strong> to geolocate)</li>
                        <li>Return home, complete the exercise in the app (upload audio, photos, notes)</li>
                        <li>Listen back, analyze with the exercise's guide questions</li>
                        <li>Deepen your knowledge by reading resources from the <strong>Library</strong></li>
                        <li>Repeat! Consistent practice is essential</li>
                    </ol>
                </div>
            </div>

            <!-- FAQ -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">❓ FAQ - Frequently Asked Questions</h3>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Where is my data saved?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Everything is stored <strong>locally in your browser</strong> (IndexedDB). There's no server, no account, no uploads.
                        Your audio, photos, and exercises remain private on your device.
                        <strong>⚠️ Warning</strong>: If you clear your browser data, you'll lose everything! Use the "Export" function for backups.
                    </p>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Can I use Soundscape Studio on mobile?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Yes! The site is responsive. Audio recording works on mobile browsers (Chrome, Safari).
                        Geolocation works perfectly on smartphones. A dedicated native iOS app is planned for the future.
                    </p>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Is it really free?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        The <strong>website is 100% free</strong>. No paywall, no subscription.
                        The <strong>iOS app on App Store will be paid</strong> (with additional features like cloud sync, offline access, and professional export tools).
                    </p>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-top: 10px;">
                        The project is supported through <strong>app sales</strong>, <strong>affiliate links</strong> (Thomann, Amazon), and voluntary PayPal donations.
                        If you find this toolkit useful, consider purchasing the app when available, buying equipment from the provided links, or making a small donation!
                    </p>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Can I contribute to the project?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Absolutely! You can:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px; margin-top: 8px;">
                        <li>📧 Send feedback and suggestions via email</li>
                        <li>🎧 Share the project with other sound recordists</li>
                        <li>💰 Make a PayPal donation</li>
                        <li>🛒 Purchase equipment from affiliate links</li>
                        <li>📝 Report bugs or propose new exercises</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">How much browser space does it use?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        It depends on how many exercises you complete. An exercise with 5 audio files (2-3 min each) and 3 photos takes about 20-50 MB.
                        Most modern browsers allow several GB of IndexedDB storage.
                        You can monitor space in your browser settings.
                    </p>
                </div>

                <div>
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Can I share my recordings?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Currently there's no integrated sharing function (everything is local).
                        You can export your exercises as files and share them manually.
                        An optional community/gallery feature may be added in the future.
                    </p>
                </div>
            </div>

            <!-- Contacts & Support -->
            <div class="card" style="background: linear-gradient(135deg, #2d5f4f 0%, #3d7f6f 100%); color: white;">
                <h3 style="margin-bottom: 20px; font-size: 22px; color: white;">📧 Contacts & Support</h3>

                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px;">
                    For questions, feedback, bug reports or collaborations:
                </p>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="font-size: 15px; margin-bottom: 5px;"><strong>📧 Email:</strong></p>
                    <p style="font-size: 16px;">
                        <a href="mailto:artistmentalhealth@gmail.com" style="color: #a8e6cf; text-decoration: underline;">
                            artistmentalhealth@gmail.com
                        </a>
                    </p>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="font-size: 15px; margin-bottom: 5px;"><strong>🎨 Developed by:</strong></p>
                    <p style="font-size: 16px;"><strong>Francesco Mariano</strong> - Gruppo Apuano Sperimentale</p>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <p style="font-size: 15px; margin-bottom: 5px;"><strong>💰 Support the Project:</strong></p>
                    <p style="font-size: 14px; line-height: 1.6;">
                        This project is free and open. If you find it useful, consider supporting it through a
                        <a href="https://www.paypal.com/paypalme/francescomariano" target="_blank" style="color: #a8e6cf; text-decoration: underline;">PayPal donation</a>
                        or by purchasing equipment from the Thomann/Amazon affiliate links in the Toolkit and Library.
                    </p>
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Check%20out%20Soundscape%20Studio!%20A%20complete%20toolkit%20for%20field%20recording%20and%20sound%20composition%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- MAP SECTION -->
        <div id="map" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">🗺️ Soundscape Map</h2>

            <!-- Instructions -->
            <div class="card" style="background: #fffbe6; border-left: 4px solid #f4a261; margin-bottom: 20px;">
                <p style="color: #2d5f4f; font-weight: 600; margin-bottom: 8px;">📍 How to use the map:</p>
                <p style="color: #666; font-size: 14px;">
                    1. Click on the map to add a marker<br>
                    2. Select a category (traffic, market, nature, etc.)<br>
                    3. Add a description<br>
                    4. Record audio from microphone or upload a file<br>
                    5. Play your saved soundscapes!
                </p>
            </div>

            <!-- Map Container with Sidebar -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <!-- Sidebar with Controls -->
                <div style="flex: 0 0 280px;">
                    <div class="card">
                        <h4 style="color: #2d5f4f; margin-bottom: 15px;">🎯 Add Marker</h4>

                        <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Click on the map to place</p>

                        <label style="display: block; font-weight: 600; color: #2d5f4f; margin-bottom: 8px; font-size: 14px;">Category:</label>
                        <select id="markerCategory" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #e0e0e0; margin-bottom: 15px;">
                            <option value="traffic">🚗 Urban Traffic</option>
                            <option value="market">🛒 Market</option>
                            <option value="voices">👥 Voices/Crowd</option>
                            <option value="industrial">🏭 Industrial</option>
                            <option value="railway">🚂 Railway</option>
                            <option value="coastal">🌊 Coastal</option>
                            <option value="forest">🌲 Forest</option>
                            <option value="park">🌳 Urban Park</option>
                            <option value="construction">🚧 Construction</option>
                            <option value="airport">✈️ Airport</option>
                            <option value="other">📌 Other</option>
                        </select>

                        <label style="display: block; font-weight: 600; color: #2d5f4f; margin-bottom: 8px; font-size: 14px;">Notes:</label>
                        <textarea id="markerNotes" placeholder="Soundscape description..." style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #e0e0e0; min-height: 60px; font-family: inherit; resize: vertical; margin-bottom: 15px;"></textarea>

                        <div style="border-top: 2px solid #e8f5f1; padding-top: 15px; margin-top: 15px;">
                            <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 14px;">🎤 Audio</h4>

                            <!-- Recording Controls -->
                            <div id="recordingControls">
                                <button id="startRecording" class="btn" style="width: 100%; margin-bottom: 8px; background: #d32f2f; color: white;">
                                    🔴 Record
                                </button>
                                <button id="stopRecording" class="btn" style="width: 100%; margin-bottom: 8px; display: none; background: #666;">
                                    ⏹️ Stop
                                </button>
                                <div id="recordingTime" style="text-align: center; font-size: 14px; color: #d32f2f; margin-bottom: 8px; display: none; font-weight: 600;">
                                    ⏱️ 00:00
                                </div>
                            </div>

                            <!-- Upload File -->
                            <label for="audioFileUpload" class="btn" style="width: 100%; text-align: center; display: inline-block; margin-bottom: 8px; background: #2d5f4f; color: white; cursor: pointer;">
                                📁 Upload Audio File
                            </label>
                            <input type="file" id="audioFileUpload" accept="audio/*" style="display: none;">

                            <!-- Audio Preview -->
                            <div id="audioPreview" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9f5; border-radius: 6px;">
                                <p style="font-size: 12px; color: #2d5f4f; margin-bottom: 6px; font-weight: 600;">Preview:</p>
                                <audio id="audioPreviewPlayer" controls style="width: 100%; height: 32px;"></audio>
                            </div>
                        </div>
                    </div>

                    <!-- Markers List -->
                    <div class="card" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                        <h4 style="color: #2d5f4f; margin-bottom: 12px;">📍 Your Markers</h4>
                        <div id="markersList" style="font-size: 14px;">
                            <p style="color: #999; font-style: italic;">No markers saved</p>
                        </div>
                    </div>
                </div>

                <!-- Map -->
                <div style="flex: 1;">
                    <div id="leafletMap" style="height: 600px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #e0e0e0;"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Check%20out%20Soundscape%20Studio!%20A%20complete%20toolkit%20for%20field%20recording%20and%20sound%20composition%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>


    </div>

    <!-- Modal per Esercizi -->
    <div class="modal" id="exerciseModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeExerciseModal()">×</button>
            <div id="exerciseDetails"></div>
        </div>
    </div>

    <!-- Complete Exercise Modal -->
    <div class="modal" id="completeExerciseModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeCompleteExerciseModal()">×</button>
            <div id="completeExerciseContent">
                <h2 style="color: #2d5f4f; margin-bottom: 20px;">📋 Complete Your Exercise</h2>

                <!-- Exercise Summary -->
                <div id="exerciseSummary" style="background: #f0f7f4; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #2d5f4f;">
                    <!-- Will be populated dynamically -->
                </div>

                <form id="exerciseCompletionForm" onsubmit="return saveExerciseCompletion(event)">

                    <!-- Section 1: Basic Info -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">📍 Basic Information</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">📅 Date</label>
                                <input type="date" id="exerciseDate" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">⏰ Start time</label>
                                <input type="time" id="exerciseTime" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">📍 Where did you do the exercise?</label>
                            <input type="text" id="exerciseLocation" placeholder="e.g. Central Park, New York" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <button type="button" onclick="getGeolocation()" style="margin-top: 10px; padding: 8px 16px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                🌍 Detect GPS location
                            </button>
                            <span id="geoStatus" style="margin-left: 10px; color: #666; font-size: 13px;"></span>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">⏱️ Actual duration</label>
                            <input type="text" id="exerciseDuration" placeholder="e.g. 15 minutes" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>

                    <!-- Section 2: Environmental Context -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">🌤️ Environmental Context</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">Describe the surrounding environment</label>
                            <textarea id="environmentDescription" rows="3" placeholder="Describe the environment, predominant sounds, general atmosphere..." required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">☀️ Weather conditions</label>
                                <select id="weatherConditions" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="sunny">☀️ Sunny</option>
                                    <option value="cloudy">☁️ Cloudy</option>
                                    <option value="rainy">🌧️ Rainy</option>
                                    <option value="windy">💨 Windy</option>
                                    <option value="foggy">🌫️ Foggy</option>
                                    <option value="snowy">❄️ Snow</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🔊 Noise level</label>
                                <select id="noiseLevel" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="very-quiet">🔇 Very quiet</option>
                                    <option value="quiet">🔉 Quiet</option>
                                    <option value="moderate">🔊 Moderate</option>
                                    <option value="noisy">📢 Noisy</option>
                                    <option value="very-noisy">📣 Very noisy</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">👥 Were you alone?</label>
                                <select id="alone" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="yes">Yes, alone</option>
                                    <option value="no">No, with company</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🚶 Were you stationary or moving?</label>
                                <select id="movement" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="stationary">Stationary</option>
                                    <option value="moving">Moving</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Tools and Recording -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">🎙️ Tools and Recording</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">What tools did you use to record?</label>
                            <input type="text" id="recordingTools" placeholder="e.g. Zoom H5, binaural microphone, smartphone..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">📁 Do you have a recording to upload?</label>
                            <input type="file" id="audioUpload" accept="audio/*" multiple style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <small style="color: #666; display: block; margin-top: 5px;">You can upload multiple audio files</small>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">📸 Photos of the location (optional)</label>
                            <input type="file" id="photoUpload" accept="image/*" multiple style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🗺️ Do you want to add a marker on the map?</label>
                            <select id="addMapMarker" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="no">No</option>
                                <option value="yes">Yes, add to map</option>
                            </select>
                        </div>
                    </div>

                    <!-- Section 4: Drawing Canvas -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">✏️ Draw your sound analysis</h3>
                        <p style="color: #666; margin-bottom: 15px;">Use this space to draw sound maps, directions, listening circles, etc.</p>

                        <div style="margin-bottom: 15px;">
                            <button type="button" onclick="setDrawingTool('pen')" style="padding: 8px 16px; margin-right: 10px; background: #2d5f4f; color: white; border: none; border-radius: 6px; cursor: pointer;">🖊️ Pen</button>
                            <button type="button" onclick="setDrawingTool('eraser')" style="padding: 8px 16px; margin-right: 10px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">🧹 Eraser</button>
                            <button type="button" onclick="clearCanvas()" style="padding: 8px 16px; margin-right: 10px; background: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer;">🗑️ Clear all</button>
                            <label style="margin-left: 10px;">
                                Color: <input type="color" id="drawingColor" value="#2d5f4f" onchange="updateDrawingColor()" style="vertical-align: middle; cursor: pointer;">
                            </label>
                            <label style="margin-left: 10px;">
                                Size:
                                <select id="drawingThickness" onchange="updateDrawingThickness()" style="padding: 4px; border-radius: 4px;">
                                    <option value="2">Thin</option>
                                    <option value="5" selected>Medium</option>
                                    <option value="10">Thick</option>
                                    <option value="15">Very thick</option>
                                </select>
                            </label>
                        </div>

                        <canvas id="drawingCanvas" width="800" height="500" style="border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: crosshair; display: block; max-width: 100%;"></canvas>
                    </div>

                    <!-- Section 5: Notes and Considerations -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">💭 Considerations and Notes</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">What did you discover? Personal reflections</label>
                            <textarea id="personalNotes" rows="6" placeholder="Describe your experience, what you learned, interesting observations, emotions felt... (optional)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🏷️ Tags (separate with commas)</label>
                            <input type="text" id="exerciseTags" placeholder="e.g. urban, nature, morning, quiet" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">⭐ Rate your experience</label>
                            <div id="ratingStars" style="font-size: 32px; cursor: pointer;">
                                <span onclick="setRating(1)" data-rating="1">☆</span>
                                <span onclick="setRating(2)" data-rating="2">☆</span>
                                <span onclick="setRating(3)" data-rating="3">☆</span>
                                <span onclick="setRating(4)" data-rating="4">☆</span>
                                <span onclick="setRating(5)" data-rating="5">☆</span>
                            </div>
                            <input type="hidden" id="exerciseRating" value="0">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" onclick="closeCompleteExerciseModal()" style="padding: 14px 28px; background: #999; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">
                            Cancel
                        </button>
                        <button type="submit" style="padding: 14px 28px; background: #2d5f4f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">
                            💾 Save Exercise
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal per Visualizzare Esercizio Completato -->
    <div class="modal" id="viewCompletedExerciseModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeViewCompletedModal()">×</button>
            <div id="viewCompletedContent">
                <!-- Verrà popolato dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal per Reference Guides -->
    <div class="reference-modal" id="referenceModal" onclick="if(event.target === this) closeReferenceModal()">
        <div class="reference-modal-content">
            <span class="reference-modal-close" onclick="closeReferenceModal()">×</span>
            <div id="referenceContent">
                <!-- Verrà popolato dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Load Complete Exercise Database -->
    <script src="exercises-complete.js"></script>

    <script>
        // ==================== INDEXEDDB SETUP ====================
        let db;
        const DB_NAME = 'SoundscapeStudioDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'completedExercises';

        // Inizializza IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => {
                    console.error('Database opening error:', request.error);
                    reject(request.error);
                };

                request.onsuccess = () => {
                    db = request.result;
                    console.log('✅ IndexedDB database opened successfully');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    // Crea object store se non esiste
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id',
                            autoIncrement: true
                        });

                        // Crea indici per query più veloci
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                        objectStore.createIndex('exerciseTitle', 'exercise.title', { unique: false });
                        objectStore.createIndex('date', 'date', { unique: false });

                        console.log('✅ Object store created');
                    }
                };
            });
        }

        // Save exercise in IndexedDB with audio and photo files
        async function saveExerciseToIndexedDB(exerciseData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);

                const request = objectStore.add(exerciseData);

                request.onsuccess = () => {
                    console.log('✅ Exercise saved with ID:', request.result);
                    resolve(request.result);
                };

                request.onerror = () => {
                    console.error('❌ Save error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Retrieve all exercises
        async function getAllExercisesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    resolve(request.result || []);
                };

                request.onerror = () => {
                    console.error('❌ Exercise retrieval error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Retrieve single exercise by ID
        async function getExerciseFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.get(id);

                request.onsuccess = () => {
                    resolve(request.result);
                };

                request.onerror = () => {
                    console.error('❌ Exercise retrieval error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Delete exercise
        async function deleteExerciseFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    console.log('✅ Exercise deleted');
                    resolve();
                };

                request.onerror = () => {
                    console.error('❌ Deletion error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Delete all exercises
        async function clearAllExercisesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.clear();

                request.onsuccess = () => {
                    console.log('✅ All exercises deleted');
                    resolve();
                };

                request.onerror = () => {
                    console.error('❌ Database cleanup error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Converte File in Blob per salvare in IndexedDB
        async function fileToBlob(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    resolve({
                        data: e.target.result,
                        name: file.name,
                        type: file.type,
                        size: file.size
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Converte FileList in array di Blob
        async function filesToBlobs(fileList) {
            if (!fileList || fileList.length === 0) return [];

            const promises = Array.from(fileList).map(file => fileToBlob(file));
            return Promise.all(promises);
        }

        // ==================== NAVIGATION ====================
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Attiva il pulsante corrispondente (se chiamato da un click)
            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            } else {
                // Se chiamato programmaticamente, trova il pulsante corrispondente
                const btn = document.querySelector(`[onclick*="showSection('${sectionId}')"]`);
                if (btn) btn.classList.add('active');
            }

            // Initialize toolkit equipment tabs when first opened
            if (sectionId === 'toolkit') {
                setTimeout(() => {
                    if (window.initializeToolkit) {
                        window.initializeToolkit();
                    }
                }, 100);
            }

            // Initialize library when first opened
            if (sectionId === 'library') {
                setTimeout(() => {
                    if (window.initializeLibrary) {
                        window.initializeLibrary();
                    }
                }, 100);
            }
        }

        // Funzione dedicata per mostrare la sezione mappa
        function showMapSection() {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));

            // Show map section
            document.getElementById('map').classList.add('active');
            event.target.classList.add('active');

            // Initialize map after a brief delay to ensure DOM is ready
            setTimeout(() => {
                initializeSoundscapeMap();
            }, 200);
        }

        // ==================== GLOBAL FUNCTION DECLARATIONS ====================
        // These are declared early so onclick handlers can find them

        window.showReferenceModal = function(type) {
            console.log('showReferenceModal called with type:', type);
        };

        window.closeReferenceModal = function() {
            console.log('closeReferenceModal called');
        };

        window.showEquipmentTab = function(category) {
            console.log('showEquipmentTab called with category:', category);
        };

        window.showLibraryTab = function(category) {
            console.log('showLibraryTab called with category:', category);
        };

        window.initializeToolkit = function() {
            console.log('initializeToolkit called');
        };

        window.initializeLibrary = function() {
            console.log('initializeLibrary called');
        };

        // ==================== SPETTROGRAMMA ====================
        // Codice spettrogramma rimosso (sezione HTML rimossa)

        /* SPETTROGRAMMA CODE - COMMENTED OUT
        let audioContext;
        let analyser;
        let dataArray;
        let bufferLength;
        let canvas;
        let canvasCtx;
        let animationId;
        let microphone;
        let audioElement;
        let sourceNode;

        function initSpectrogram() {
            canvas = document.getElementById('spectrogramCanvas');
            canvasCtx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;

            // Initialize audio context
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
        }

        // Start Microphone
        const startMicBtn = document.getElementById('startMicBtn');
        if (startMicBtn) {
        startMicBtn.addEventListener('click', async () => {
            if (!audioContext) initSpectrogram();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                document.getElementById('startMicBtn').style.display = 'none';
                document.getElementById('stopMicBtn').style.display = 'inline-block';

                drawSpectrogram();
            } catch (err) {
                alert('Errore accesso microfono: ' + err.message);
            }
        });

        // Stop Microphone
        document.getElementById('stopMicBtn').addEventListener('click', () => {
            if (microphone) {
                microphone.disconnect();
                microphone.mediaStream.getTracks().forEach(track => track.stop());
                microphone = null;
            }

            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            document.getElementById('startMicBtn').style.display = 'inline-block';
            document.getElementById('stopMicBtn').style.display = 'none';

            // Clear canvas
            canvasCtx.fillStyle = '#000';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        });

        // Load Audio File
        document.getElementById('audioFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!audioContext) initSpectrogram();

            const arrayBuffer = await file.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            // Create audio element for playback
            audioElement = new Audio(URL.createObjectURL(file));

            document.getElementById('playAudioBtn').style.display = 'inline-block';
            document.getElementById('pauseAudioBtn').style.display = 'none';
        });

        // Play Audio
        document.getElementById('playAudioBtn').addEventListener('click', () => {
            if (!audioElement) return;

            if (!sourceNode) {
                sourceNode = audioContext.createMediaElementSource(audioElement);
                sourceNode.connect(analyser);
                analyser.connect(audioContext.destination);
            }

            audioElement.play();
            document.getElementById('playAudioBtn').style.display = 'none';
            document.getElementById('pauseAudioBtn').style.display = 'inline-block';

            drawSpectrogram();
        });

        // Pause Audio
        document.getElementById('pauseAudioBtn').addEventListener('click', () => {
            if (audioElement) {
                audioElement.pause();
                document.getElementById('playAudioBtn').style.display = 'inline-block';
                document.getElementById('pauseAudioBtn').style.display = 'none';
            }
        });

        // Draw Spectrogram
        function drawSpectrogram() {
            animationId = requestAnimationFrame(drawSpectrogram);

            analyser.getByteFrequencyData(dataArray);

            // Shift canvas left
            const imageData = canvasCtx.getImageData(1, 0, canvas.width - 1, canvas.height);
            canvasCtx.putImageData(imageData, 0, 0);

            // Draw new column
            for (let i = 0; i < bufferLength; i++) {
                const value = dataArray[i];
                const y = canvas.height - (i / bufferLength) * canvas.height;

                // Color mapping (black -> blue -> green -> yellow -> red)
                let r, g, b;
                if (value < 64) {
                    r = 0; g = 0; b = value * 4;
                } else if (value < 128) {
                    r = 0; g = (value - 64) * 4; b = 255;
                } else if (value < 192) {
                    r = (value - 128) * 4; g = 255; b = 255 - (value - 128) * 4;
                } else {
                    r = 255; g = 255 - (value - 192) * 4; b = 0;
                }

                canvasCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                canvasCtx.fillRect(canvas.width - 1, y, 1, canvas.height / bufferLength);
            }

            // Update info
            const maxIndex = dataArray.indexOf(Math.max(...dataArray));
            const frequency = Math.round((maxIndex / bufferLength) * (audioContext.sampleRate / 2));
            const avgLevel = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const dB = 20 * Math.log10(avgLevel / 255);

            document.getElementById('freqInfo').textContent = `Frequenza dominante: ${frequency} Hz`;
            document.getElementById('dbInfo').textContent = `Livello: ${dB.toFixed(1)} dB`;

            if (audioElement) {
                document.getElementById('timeInfo').textContent = `Tempo: ${audioElement.currentTime.toFixed(2)}s / ${audioElement.duration.toFixed(2)}s`;
            }
        }
        END OF SPETTROGRAMMA CODE */

        // ==================== ESERCIZI ====================
        // Convert fieldRecordingExercises object to flat array
        var exercises = [];
        if (typeof fieldRecordingExercises !== 'undefined') {
            Object.keys(fieldRecordingExercises).forEach(category => {
                fieldRecordingExercises[category].forEach(ex => {
                    exercises.push({
                        category: category,
                        title: ex.title,
                        description: ex.description,
                        prompt: ex.prompt,
                        duration: ex.duration,
                        examples: ex.examples,
                        level: 'Intermedio', // Default level
                        time: ex.duration
                    });
                });
            });
        }

        // State for filtering
        var currentCategoryFilter = 'all';
        var currentLevelFilter = 'all';

        async function loadExercises(filteredExercises = exercises) {
            const grid = document.getElementById('exerciseGrid');
            grid.innerHTML = ''; // Clear existing

            if (filteredExercises.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🔍</div>
                        <p>No exercises found with these filters.</p>
                    </div>
                `;
                return;
            }

            // Get all completed exercises
            const completedExercises = await getAllExercisesFromIndexedDB();

            // Create a Set with completed exercise titles for fast lookup
            const completedTitles = new Set(
                completedExercises.map(ex => ex.exercise.title)
            );

            filteredExercises.forEach(ex => {
                const card = document.createElement('div');
                card.className = 'exercise-card';
                card.onclick = () => showExerciseDetail(ex);

                const isCompleted = completedTitles.has(ex.title);
                const completedBadge = isCompleted ?
                    `<span style="position: absolute; top: 10px; right: 10px; font-size: 24px; background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">✅</span>` : '';

                card.innerHTML = `
                    ${completedBadge}
                    <span class="exercise-category cat-${ex.category}">${ex.category.toUpperCase()}</span>
                    <div class="exercise-title">${ex.title}</div>
                    <div class="exercise-meta">
                        📊 ${ex.level} | ⏱️ ${ex.time}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function filterExercises(category) {
            currentCategoryFilter = category;
            applyFilters();

            // Update button states
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${category}"]`).classList.add('active');
        }

        function filterByLevel(level) {
            currentLevelFilter = level;
            applyFilters();

            // Update button states
            document.querySelectorAll('[data-level]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
        }

        async function applyFilters() {
            let filtered = exercises;

            // Apply category filter
            if (currentCategoryFilter !== 'all') {
                filtered = filtered.filter(ex => ex.category === currentCategoryFilter);
            }

            // Apply level filter
            if (currentLevelFilter !== 'all') {
                filtered = filtered.filter(ex => ex.level === currentLevelFilter);
            }

            await loadExercises(filtered);
        }

        function showExerciseDetail(exercise) {
            const modal = document.getElementById('exerciseModal');
            const details = document.getElementById('exerciseDetails');

            const examplesHTML = exercise.examples && exercise.examples.length > 0 ?
                `<div style="margin-top: 20px;">
                    <h3 style="color: #2d5f4f; margin-bottom: 10px;">💡 Examples</h3>
                    <ul style="line-height: 2;">
                        ${exercise.examples.map(ex => `<li>${ex}</li>`).join('')}
                    </ul>
                </div>` : '';

            details.innerHTML = `
                <span class="exercise-category cat-${exercise.category}">${exercise.category.replace(/-/g, ' ').toUpperCase()}</span>
                <h2 style="margin: 15px 0; color: #2d5f4f;">${exercise.title}</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    <strong>Duration:</strong> ${exercise.time}
                </p>
                <div style="line-height: 1.8;">
                    <h3 style="color: #2d5f4f; margin-bottom: 10px;">📝 Description</h3>
                    <p>${exercise.description}</p>

                    <h3 style="color: #2d5f4f; margin: 20px 0 10px 0;">🎯 Instructions</h3>
                    <p style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #2d5f4f;">
                        ${exercise.prompt}
                    </p>

                    ${examplesHTML}
                </div>
                <button onclick="startExerciseCompletion()" style="margin-top: 20px; padding: 12px 24px; background: #2d5f4f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Start Exercise
                </button>
            `;

            modal.classList.add('active');
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        // ==================== EXERCISE COMPLETION FUNCTIONS ====================
        var currentExercise = null;
        var drawingCanvas = null;
        var drawingCtx = null;
        var isDrawing = false;
        var currentTool = 'pen';
        var currentColor = '#2d5f4f';
        var currentThickness = 5;

        function startExerciseCompletion() {
            // Salva l'esercizio corrente
            const exerciseTitle = document.querySelector('#exerciseDetails h2').textContent;
            const exerciseCategory = document.querySelector('#exerciseDetails .exercise-category').textContent;
            const exerciseDescription = document.querySelector('#exerciseDetails p:nth-of-type(2)').textContent;
            const exercisePrompt = document.querySelector('#exerciseDetails p[style*="background"]').textContent;

            currentExercise = {
                title: exerciseTitle,
                category: exerciseCategory,
                description: exerciseDescription,
                prompt: exercisePrompt
            };

            // Close exercise modal
            closeExerciseModal();

            // Populate summary
            document.getElementById('exerciseSummary').innerHTML = `
                <h3 style="color: #2d5f4f; margin-bottom: 10px;">${currentExercise.title}</h3>
                <p style="margin-bottom: 15px;"><strong>Category:</strong> ${currentExercise.category}</p>
                <p style="margin-bottom: 15px;"><strong>Description:</strong> ${currentExercise.description}</p>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #4a9d7f;">
                    <strong>Key steps:</strong><br>
                    ${currentExercise.prompt}
                </div>
            `;

            // Set current date and time
            const now = new Date();
            document.getElementById('exerciseDate').valueAsDate = now;
            document.getElementById('exerciseTime').value = now.toTimeString().slice(0,5);

            // Reset form
            document.getElementById('exerciseCompletionForm').reset();
            document.getElementById('exerciseDate').valueAsDate = now;
            document.getElementById('exerciseTime').value = now.toTimeString().slice(0,5);
            document.getElementById('exerciseRating').value = '0';

            // Reset stelle
            document.querySelectorAll('#ratingStars span').forEach(star => {
                star.textContent = '☆';
            });

            // Apri il modal di completamento
            document.getElementById('completeExerciseModal').classList.add('active');

            // Inizializza il canvas
            setTimeout(() => {
                initDrawingCanvas();
            }, 100);
        }

        function closeCompleteExerciseModal() {
            document.getElementById('completeExerciseModal').classList.remove('active');
            currentExercise = null;
        }

        function initDrawingCanvas() {
            drawingCanvas = document.getElementById('drawingCanvas');
            if (!drawingCanvas) return;

            drawingCtx = drawingCanvas.getContext('2d');
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';

            // Clear canvas
            drawingCtx.fillStyle = 'white';
            drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);

            // Mouse events
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            drawingCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                drawingCanvas.dispatchEvent(mouseEvent);
            });

            drawingCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                drawingCanvas.dispatchEvent(mouseEvent);
            });

            drawingCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                drawingCanvas.dispatchEvent(mouseEvent);
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            drawingCtx.beginPath();
            drawingCtx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentTool === 'pen') {
                drawingCtx.strokeStyle = currentColor;
                drawingCtx.lineWidth = currentThickness;
                drawingCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'eraser') {
                drawingCtx.strokeStyle = 'white';
                drawingCtx.lineWidth = currentThickness * 3;
                drawingCtx.globalCompositeOperation = 'destination-out';
            }

            drawingCtx.lineTo(x, y);
            drawingCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function setDrawingTool(tool) {
            currentTool = tool;
        }

        function clearCanvas() {
            if (!drawingCtx || !drawingCanvas) return;
            drawingCtx.fillStyle = 'white';
            drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }

        function updateDrawingColor() {
            currentColor = document.getElementById('drawingColor').value;
        }

        function updateDrawingThickness() {
            currentThickness = parseInt(document.getElementById('drawingThickness').value);
        }

        function getGeolocation() {
            const statusEl = document.getElementById('geoStatus');

            if (!navigator.geolocation) {
                statusEl.textContent = '❌ Geolocation not supported';
                return;
            }

            statusEl.textContent = '🔄 Detecting location...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);

                    // Use reverse geocoding if possible or show coordinates
                    const locationInput = document.getElementById('exerciseLocation');
                    locationInput.value = `Lat: ${lat}, Lon: ${lon}`;

                    statusEl.textContent = '✅ Location detected!';
                    statusEl.style.color = 'green';

                    // Save coordinates to use in map
                    locationInput.dataset.lat = lat;
                    locationInput.dataset.lon = lon;
                },
                (error) => {
                    statusEl.textContent = '❌ Unable to detect location';
                    statusEl.style.color = 'red';
                    console.error('Geolocation error:', error);
                }
            );
        }

        function setRating(rating) {
            document.getElementById('exerciseRating').value = rating;

            // Aggiorna stelle visivamente
            document.querySelectorAll('#ratingStars span').forEach((star, index) => {
                if (index < rating) {
                    star.textContent = '★';
                } else {
                    star.textContent = '☆';
                }
            });
        }

        async function saveExerciseCompletion(event) {
            event.preventDefault();

            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '⏳ Saving...';
            submitBtn.disabled = true;

            try {
                // Convert audio and photo files to Blob
                const audioFiles = document.getElementById('audioUpload').files;
                const photoFiles = document.getElementById('photoUpload').files;

                const audioBlobs = await filesToBlobs(audioFiles);
                const photoBlobs = await filesToBlobs(photoFiles);

                // Collect all data including audio and photos
                const completionData = {
                    exercise: currentExercise,
                    date: document.getElementById('exerciseDate').value,
                    time: document.getElementById('exerciseTime').value,
                    location: document.getElementById('exerciseLocation').value,
                    locationCoords: {
                        lat: document.getElementById('exerciseLocation').dataset.lat || null,
                        lon: document.getElementById('exerciseLocation').dataset.lon || null
                    },
                    duration: document.getElementById('exerciseDuration').value,
                    environment: document.getElementById('environmentDescription').value,
                    weather: document.getElementById('weatherConditions').value,
                    noiseLevel: document.getElementById('noiseLevel').value,
                    alone: document.getElementById('alone').value,
                    movement: document.getElementById('movement').value,
                    recordingTools: document.getElementById('recordingTools').value,
                    notes: document.getElementById('personalNotes').value,
                    tags: document.getElementById('exerciseTags').value,
                    rating: document.getElementById('exerciseRating').value,
                    addMapMarker: document.getElementById('addMapMarker').value,
                    drawing: drawingCanvas ? drawingCanvas.toDataURL() : null,
                    audioFiles: audioBlobs,  // Array di file audio
                    photoFiles: photoBlobs,  // Array di foto
                    timestamp: new Date().toISOString()
                };

                // Save in IndexedDB and get generated ID
                const exerciseId = await saveExerciseToIndexedDB(completionData);

                // If requested, add marker to map
                if (completionData.addMapMarker === 'yes' && completionData.locationCoords.lat) {
                    try {
                        await addExerciseMarkerToMap(completionData, exerciseId);
                        console.log('✅ Marker added to map:', completionData.locationCoords);
                    } catch (error) {
                        console.error('Marker addition error:', error);
                    }
                }

                // Show confirmation
                alert('✅ Exercise saved successfully!\n\n' +
                      `Audio files saved: ${audioBlobs.length}\n` +
                      `Photos saved: ${photoBlobs.length}\n\n` +
                      'You can find all your completed exercises in the Dashboard section.');

                // Close modal
                closeCompleteExerciseModal();

                // Update completed exercises counter
                await updateCompletedExercisesCounter();

                // Reload exercises to show green checkmark
                await applyFilters();

            } catch (error) {
                console.error('Save error:', error);
                alert('❌ Error during save!\n\n' + error.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }

            return false;
        }

        async function updateCompletedExercisesCounter() {
            try {
                const savedExercises = await getAllExercisesFromIndexedDB();
                const counters = document.querySelectorAll('[style*="Completed exercises"]');
                counters.forEach(counter => {
                    counter.textContent = `Completed exercises: ${savedExercises.length}/96`;
                });

                // Also update the list in Dashboard
                await loadCompletedExercisesList();
            } catch (error) {
                console.error('Counter update error:', error);
            }
        }

        // ==================== VISUALIZZAZIONE ESERCIZI COMPLETATI ====================

        async function loadCompletedExercisesList() {
            const listContainer = document.getElementById('completedExercisesList');
            if (!listContainer) return;

            try {
                const savedExercises = await getAllExercisesFromIndexedDB();

                if (savedExercises.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">📭</div>
                            <p>You haven't completed any exercises yet.</p>
                            <p style="font-size: 14px; margin-top: 10px;">Start an exercise and document your experience!</p>
                        </div>
                    `;
                    return;
                }

                // Mostra gli ultimi 5 esercizi
                const recentExercises = savedExercises.slice(-5).reverse();

                listContainer.innerHTML = recentExercises.map((ex) => {
                    const date = new Date(ex.timestamp);
                    const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = ex.time || date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                    // Badge per audio e foto
                    const badges = [];
                    if (ex.audioFiles && ex.audioFiles.length > 0) {
                        badges.push(`🎵 ${ex.audioFiles.length}`);
                    }
                    if (ex.photoFiles && ex.photoFiles.length > 0) {
                        badges.push(`📷 ${ex.photoFiles.length}`);
                    }

                    return `
                        <div onclick="viewCompletedExercise(${ex.id})" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #2d5f4f;" onmouseover="this.style.background='#f0f7f4'" onmouseout="this.style.background='#f9f9f9'">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 8px 0; color: #2d5f4f;">${ex.exercise.title}</h4>
                                    <div style="font-size: 13px; color: #666;">
                                        <span>📅 ${dateStr}</span> •
                                        <span>⏰ ${timeStr}</span> •
                                        <span>📍 ${ex.location}</span>
                                    </div>
                                    ${badges.length > 0 ? `<div style="margin-top: 5px; font-size: 12px; color: #4a9d7f;">${badges.join(' • ')}</div>` : ''}
                                    ${ex.rating > 0 ? `<div style="margin-top: 5px; color: #f39c12;">${'★'.repeat(parseInt(ex.rating))}</div>` : ''}
                                </div>
                                <div style="font-size: 24px;">👁️</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('List loading error:', error);
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #d9534f;">
                        <div style="font-size: 48px; margin-bottom: 15px;">❌</div>
                        <p>Exercise loading error</p>
                    </div>
                `;
            }
        }

        async function showAllCompletedExercises() {
            try {
                const savedExercises = await getAllExercisesFromIndexedDB();

                if (savedExercises.length === 0) {
                    alert('You haven't completed any exercises yet!');
                return;
            }

            const modal = document.getElementById('viewCompletedExerciseModal');
            const content = document.getElementById('viewCompletedContent');

            content.innerHTML = `
                <h2 style="color: #2d5f4f; margin-bottom: 20px;">📋 All Completed Exercises (${savedExercises.length})</h2>

                <div style="margin-bottom: 20px;">
                    <button onclick="exportAllExercises()" style="padding: 10px 20px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                        📥 Export All (JSON)
                    </button>
                    <button onclick="clearAllExercises()" style="padding: 10px 20px; background: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        🗑️ Delete All
                    </button>
                </div>

                <div style="max-height: 500px; overflow-y: auto;">
                    ${savedExercises.map((ex) => {
                        const date = new Date(ex.timestamp);
                        const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
                        const timeStr = ex.time || date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                        // Badge per audio e foto
                        const badges = [];
                        if (ex.audioFiles && ex.audioFiles.length > 0) {
                            badges.push(`🎵 ${ex.audioFiles.length} audio`);
                        }
                        if (ex.photoFiles && ex.photoFiles.length > 0) {
                            badges.push(`📷 ${ex.photoFiles.length} foto`);
                        }

                        return `
                            <div onclick="viewCompletedExercise(${ex.id})" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <span style="display: inline-block; background: #2d5f4f; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; margin-bottom: 8px;">${ex.exercise.category}</span>
                                        <h3 style="margin: 5px 0; color: #2d5f4f;">${ex.exercise.title}</h3>
                                    </div>
                                    ${ex.rating > 0 ? `<div style="font-size: 20px; color: #f39c12;">${'★'.repeat(parseInt(ex.rating))}</div>` : ''}
                                </div>
                                <div style="font-size: 14px; color: #666; line-height: 1.8;">
                                    <div><strong>📅 Data:</strong> ${dateStr} alle ${timeStr}</div>
                                    <div><strong>📍 Luogo:</strong> ${ex.location}</div>
                                    <div><strong>⏱️ Durata:</strong> ${ex.duration}</div>
                                    <div><strong>☀️ Meteo:</strong> ${ex.weather}</div>
                                </div>
                                ${badges.length > 0 ? `<div style="margin-top: 10px; padding: 8px; background: #f0f7f4; border-radius: 6px; font-size: 13px; color: #2d5f4f; font-weight: 600;">${badges.join(' • ')}</div>` : ''}
                                ${ex.tags ? `<div style="margin-top: 10px;">${ex.tags.split(',').map(tag => `<span style="background: #e0f2f7; color: #2d5f4f; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px;">${tag.trim()}</span>`).join('')}</div>` : ''}
                                <div style="margin-top: 10px; text-align: right; color: #4a9d7f; font-weight: 600;">Clicca per vedere dettagli →</div>
                            </div>
                        `;
                    }).reverse().join('')}
                </div>
            `;

                modal.classList.add('active');
            } catch (error) {
                console.error('Errore visualizzazione esercizi:', error);
                alert('❌ Errore durante il caricamento degli esercizi!');
            }
        }

        async function viewCompletedExercise(id) {
            try {
                const ex = await getExerciseFromIndexedDB(id);

                if (!ex) {
                    alert('❌ Esercizio non trovato!');
                    return;
                }

                const modal = document.getElementById('viewCompletedExerciseModal');
                const content = document.getElementById('viewCompletedContent');

                const date = new Date(ex.timestamp);
                const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
                const timeStr = ex.time || date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                // HTML per audio files
                var audioHTML = '';
                if (ex.audioFiles && ex.audioFiles.length > 0) {
                    audioHTML = `
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="color: #2d5f4f; margin-bottom: 15px;">🎵 Registrazioni Audio (${ex.audioFiles.length})</h3>
                            ${ex.audioFiles.map((audio, idx) => `
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="margin-bottom: 10px; font-weight: 600; color: #2d5f4f;">
                                        Audio ${idx + 1} - ${audio.name}
                                    </div>
                                    <audio controls style="width: 100%; margin-bottom: 10px;">
                                        <source src="${audio.data}" type="${audio.type}">
                                        Your browser does not support HTML5 audio.
                                    </audio>
                                    <button onclick="downloadAudio(${ex.id}, ${idx})" style="padding: 6px 12px; background: #4a9d7f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                        📥 Download Audio
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // HTML per photo files
                var photoHTML = '';
                if (ex.photoFiles && ex.photoFiles.length > 0) {
                    photoHTML = `
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="color: #2d5f4f; margin-bottom: 15px;">📷 Foto del Luogo (${ex.photoFiles.length})</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                                ${ex.photoFiles.map((photo, idx) => `
                                    <div style="background: #f9f9f9; padding: 10px; border-radius: 8px;">
                                        <img src="${photo.data}"
                                             onclick="viewFullImage('${photo.data.replace(/'/g, "\\'")}', '${photo.name.replace(/'/g, "\\'")}')"
                                             style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; cursor: pointer; margin-bottom: 8px;"
                                             alt="${photo.name}">
                                        <button onclick="downloadPhoto(${ex.id}, ${idx})" style="width: 100%; padding: 6px; background: #4a9d7f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            📥 Download
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <button onclick="showAllCompletedExercises()" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 15px;">
                            ← Back to list
                        </button>
                        <button onclick="deleteExercise(${ex.id})" style="padding: 8px 16px; background: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                            🗑️ Delete this exercise
                        </button>
                    </div>

                    <h2 style="color: #2d5f4f; margin-bottom: 10px;">${ex.exercise.title}</h2>
                    <span style="display: inline-block; background: #2d5f4f; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 20px;">${ex.exercise.category}</span>

                    ${ex.rating > 0 ? `<div style="font-size: 32px; color: #f39c12; margin-bottom: 20px;">${'★'.repeat(parseInt(ex.rating))}</div>` : ''}

                    ${audioHTML}
                    ${photoHTML}

                    <!-- Basic Info -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">📍 Basic Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px; line-height: 2;">
                            <div><strong>📅 Date:</strong> ${dateStr}</div>
                            <div><strong>⏰ Time:</strong> ${timeStr}</div>
                            <div><strong>📍 Location:</strong> ${ex.location}</div>
                            <div><strong>⏱️ Duration:</strong> ${ex.duration}</div>
                        </div>
                    </div>

                    <!-- Environmental Context -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">🌤️ Environmental Context</h3>
                        <div style="margin-bottom: 15px;">
                            <strong>Environment description:</strong>
                            <p style="background: #f9f9f9; padding: 12px; border-radius: 6px; margin-top: 5px;">${ex.environment}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; font-size: 14px;">
                            <div><strong>☀️ Weather:</strong> ${ex.weather}</div>
                            <div><strong>🔊 Noise:</strong> ${ex.noiseLevel}</div>
                            <div><strong>👥 Alone:</strong> ${ex.alone}</div>
                            <div><strong>🚶 Movement:</strong> ${ex.movement}</div>
                        </div>
                    </div>

                    <!-- Equipment -->
                    ${ex.recordingTools ? `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">🎙️ Equipment Used</h3>
                        <p>${ex.recordingTools}</p>
                    </div>
                    ` : ''}

                    <!-- Drawing -->
                    ${ex.drawing ? `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">✏️ Sound Analysis Drawing</h3>
                        <img src="${ex.drawing}" onclick="viewFullImage('${ex.drawing.replace(/'/g, "\\'")}', 'Sound Analysis')" style="max-width: 100%; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                        <button onclick="downloadDrawing(${ex.id})" style="margin-top: 10px; padding: 8px 16px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📥 Download Image
                        </button>
                    </div>
                    ` : ''}

                    <!-- Notes and Reflections -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">💭 Reflections and Notes</h3>
                        <p style="background: #f9f9f9; padding: 15px; border-radius: 6px; line-height: 1.8; white-space: pre-wrap;">${ex.notes}</p>
                        ${ex.tags ? `
                        <div style="margin-top: 15px;">
                            <strong>🏷️ Tag:</strong><br>
                            ${ex.tags.split(',').map(tag => `<span style="background: #e0f2f7; color: #2d5f4f; padding: 5px 12px; border-radius: 4px; font-size: 13px; margin-right: 8px; margin-top: 8px; display: inline-block;">${tag.trim()}</span>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;

                modal.classList.add('active');
            } catch (error) {
                console.error('Errore visualizzazione esercizio:', error);
                alert('❌ Errore durante il caricamento dell\'esercizio!');
            }
        }

        function closeViewCompletedModal() {
            document.getElementById('viewCompletedExerciseModal').classList.remove('active');
        }

        async function deleteExercise(id) {
            if (!confirm('Are you sure you want to delete this exercise? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteExerciseFromIndexedDB(id);
                alert('✅ Exercise deleted successfully!');
                await updateCompletedExercisesCounter();
                closeViewCompletedModal();
                // Reload exercise list if we're in the full view
                showAllCompletedExercises();
            } catch (error) {
                console.error('Deletion error:', error);
                alert('❌ Error deleting exercise!');
            }
        }

        async function clearAllExercises() {
            if (!confirm('⚠️ WARNING!\n\nAre you sure you want to delete ALL completed exercises?\n\nThis action is IRREVERSIBLE and will delete all your saved data (audio, photos, drawings, notes).')) {
                return;
            }

            if (!confirm('Confirm to proceed? All your exercises, drawings, audio and photos will be lost forever.')) {
                return;
            }

            try {
                await clearAllExercisesFromIndexedDB();
                alert('✅ All exercises have been deleted.');
                await updateCompletedExercisesCounter();
                closeViewCompletedModal();
                // Reload dashboard
                await loadCompletedExercisesList();
            } catch (error) {
                console.error('Deletion error:', error);
                alert('❌ Error deleting exercises!');
            }
        }

        function exportAllExercises() {
            const savedExercises = JSON.parse(localStorage.getItem('completedExercises') || '[]');

            if (savedExercises.length === 0) {
                alert('No exercises to export!');
                return;
            }

            const dataStr = JSON.stringify(savedExercises, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `soundscape-exercises-backup-${new Date().toISOString().slice(0,10)}.json`;
            link.click();

            URL.revokeObjectURL(url);

            alert('✅ Export completed! The file has been downloaded.');
        }

        // Helper function to download audio
        async function downloadAudio(exerciseId, audioIndex) {
            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);
                if (!ex || !ex.audioFiles || !ex.audioFiles[audioIndex]) {
                    alert('❌ Audio not found!');
                    return;
                }

                const audio = ex.audioFiles[audioIndex];
                const link = document.createElement('a');
                link.href = audio.data;
                link.download = audio.name || `audio-${audioIndex + 1}.${audio.type.split('/')[1]}`;
                link.click();
            } catch (error) {
                console.error('Audio download error:', error);
                alert('❌ Error downloading audio!');
            }
        }

        // Helper function to download photo
        async function downloadPhoto(exerciseId, photoIndex) {
            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);
                if (!ex || !ex.photoFiles || !ex.photoFiles[photoIndex]) {
                    alert('❌ Photo not found!');
                    return;
                }

                const photo = ex.photoFiles[photoIndex];
                const link = document.createElement('a');
                link.href = photo.data;
                link.download = photo.name || `photo-${photoIndex + 1}.${photo.type.split('/')[1]}`;
                link.click();
            } catch (error) {
                console.error('Photo download error:', error);
                alert('❌ Error downloading photo!');
            }
        }

        // Helper function per visualizzare immagine a schermo intero
        function viewFullImage(dataUrl, imageName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = dataUrl;
            img.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                object-fit: contain;
                border-radius: 8px;
            `;

            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '✕ Close';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                background: white;
                color: black;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                z-index: 10001;
            `;

            closeBtn.onclick = (e) => {
                e.stopPropagation();
                document.body.removeChild(modal);
            };

            modal.onclick = () => {
                document.body.removeChild(modal);
            };

            modal.appendChild(img);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);
        }

        // Download drawing
        async function downloadDrawing(exerciseId) {
            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);

                if (!ex || !ex.drawing) {
                    alert('❌ Drawing not found!');
                    return;
                }

                const link = document.createElement('a');
                link.href = ex.drawing;
                link.download = `soundscape-drawing-${ex.exercise.title.replace(/[^a-z0-9]/gi, '-')}.png`;
                link.click();
            } catch (error) {
                console.error('Drawing download error:', error);
                alert('❌ Error downloading drawing!');
            }
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            // Initialize IndexedDB
            try {
                await initDB();
                console.log('✅ Database initialized');
            } catch (error) {
                console.error('❌ Database initialization error:', error);
                alert('⚠️ Database initialization error!\n\nThe app may not work correctly.');
            }

            // Load interface
            loadExercises();
            generateExampleImages();
            await updateCompletedExercisesCounter();
        });

        // ==================== EXAMPLE IMAGES GENERATION ====================
        function generateExampleImages() {
            // Check if example canvases exist
            if (!document.getElementById('exampleCanvas0')) {
                console.log('Example canvases not found, skipping generation');
                return;
            }

            // 0: Rainbow Gradient
            const canvas0 = document.getElementById('exampleCanvas0');
            if (!canvas0) return;
            const ctx0 = canvas0.getContext('2d');
            const gradient0 = ctx0.createLinearGradient(0, 0, 150, 0);
            gradient0.addColorStop(0, '#ff0000');
            gradient0.addColorStop(0.17, '#ff7f00');
            gradient0.addColorStop(0.33, '#ffff00');
            gradient0.addColorStop(0.5, '#00ff00');
            gradient0.addColorStop(0.67, '#0000ff');
            gradient0.addColorStop(0.83, '#4b0082');
            gradient0.addColorStop(1, '#9400d3');
            ctx0.fillStyle = gradient0;
            ctx0.fillRect(0, 0, 150, 150);

            // 1: Checkerboard
            const ctx1 = document.getElementById('exampleCanvas1').getContext('2d');
            const squareSize = 15;
            for (let y = 0; y < 150; y += squareSize) {
                for (let x = 0; x < 150; x += squareSize) {
                    ctx1.fillStyle = ((x / squareSize) + (y / squareSize)) % 2 === 0 ? '#000' : '#fff';
                    ctx1.fillRect(x, y, squareSize, squareSize);
                }
            }

            // 2: Geometric Spiral
            const ctx2 = document.getElementById('exampleCanvas2').getContext('2d');
            ctx2.fillStyle = '#f0f0f0';
            ctx2.fillRect(0, 0, 150, 150);
            ctx2.strokeStyle = '#2d5f4f';
            ctx2.lineWidth = 2;
            ctx2.beginPath();
            const centerX = 75, centerY = 75;
            let angle = 0;
            let radius = 0;
            ctx2.moveTo(centerX, centerY);
            while (radius < 70) {
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                ctx2.lineTo(x, y);
                angle += 0.1;
                radius += 0.3;
            }
            ctx2.stroke();

            // 3: Vertical Lines
            const ctx3 = document.getElementById('exampleCanvas3').getContext('2d');
            ctx3.fillStyle = '#fff';
            ctx3.fillRect(0, 0, 150, 150);
            for (let x = 0; x < 150; x += 10) {
                const brightness = Math.floor((x / 150) * 255);
                ctx3.fillStyle = `rgb(${brightness}, ${brightness}, ${brightness})`;
                ctx3.fillRect(x, 0, 10, 150);
            }

            // 4: Abstract Art (Random Circles)
            const ctx4 = document.getElementById('exampleCanvas4').getContext('2d');
            ctx4.fillStyle = '#1a1a1a';
            ctx4.fillRect(0, 0, 150, 150);
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * 150;
                const y = Math.random() * 150;
                const r = Math.random() * 30 + 10;
                const hue = Math.random() * 360;
                ctx4.fillStyle = `hsla(${hue}, 80%, 60%, 0.5)`;
                ctx4.beginPath();
                ctx4.arc(x, y, r, 0, Math.PI * 2);
                ctx4.fill();
            }

            // 5: Sine Wave
            const ctx5 = document.getElementById('exampleCanvas5').getContext('2d');
            ctx5.fillStyle = '#fff';
            ctx5.fillRect(0, 0, 150, 150);
            ctx5.strokeStyle = '#2d5f4f';
            ctx5.lineWidth = 3;
            ctx5.beginPath();
            for (let x = 0; x < 150; x++) {
                const y = 75 + Math.sin(x / 10) * 40;
                if (x === 0) ctx5.moveTo(x, y);
                else ctx5.lineTo(x, y);
            }
            ctx5.stroke();

            // Add more waves with different frequencies
            ctx5.strokeStyle = '#8ba888';
            ctx5.lineWidth = 2;
            ctx5.beginPath();
            for (let x = 0; x < 150; x++) {
                const y = 75 + Math.sin(x / 5) * 20;
                if (x === 0) ctx5.moveTo(x, y);
                else ctx5.lineTo(x, y);
            }
            ctx5.stroke();

            // 6: Circular Pattern (Mandala-like)
            const ctx6 = document.getElementById('exampleCanvas6').getContext('2d');
            ctx6.fillStyle = '#fff';
            ctx6.fillRect(0, 0, 150, 150);
            const cx = 75, cy = 75;
            for (let r = 10; r < 70; r += 10) {
                const hue = (r / 70) * 360;
                ctx6.strokeStyle = `hsl(${hue}, 70%, 50%)`;
                ctx6.lineWidth = 3;
                ctx6.beginPath();
                ctx6.arc(cx, cy, r, 0, Math.PI * 2);
                ctx6.stroke();
            }

            // 7: QR-like Pattern
            const ctx7 = document.getElementById('exampleCanvas7').getContext('2d');
            ctx7.fillStyle = '#fff';
            ctx7.fillRect(0, 0, 150, 150);
            ctx7.fillStyle = '#000';
            const blockSize = 10;
            for (let y = 0; y < 150; y += blockSize) {
                for (let x = 0; x < 150; x += blockSize) {
                    if (Math.random() > 0.5) {
                        ctx7.fillRect(x, y, blockSize, blockSize);
                    }
                }
            }

            // 8: Sunset Gradient
            const ctx8 = document.getElementById('exampleCanvas8').getContext('2d');
            const gradient8 = ctx8.createLinearGradient(0, 0, 0, 150);
            gradient8.addColorStop(0, '#ff6b35');
            gradient8.addColorStop(0.3, '#f7931e');
            gradient8.addColorStop(0.5, '#fdc830');
            gradient8.addColorStop(0.7, '#f37335');
            gradient8.addColorStop(1, '#4a148c');
            ctx8.fillStyle = gradient8;
            ctx8.fillRect(0, 0, 150, 150);

            // 9: Noise Texture
            const ctx9 = document.getElementById('exampleCanvas9').getContext('2d');
            const imageData = ctx9.createImageData(150, 150);
            for (let i = 0; i < imageData.data.length; i += 4) {
                const noise = Math.random() * 255;
                imageData.data[i] = noise;     // R
                imageData.data[i + 1] = noise; // G
                imageData.data[i + 2] = noise; // B
                imageData.data[i + 3] = 255;   // A
            }
            ctx9.putImageData(imageData, 0, 0);
        }

        function loadExampleImage(index) {
            const exampleCanvas = document.getElementById(`exampleCanvas${index}`);

            // Load the example into the main image canvas
            imgCanvas = document.getElementById('imageCanvas');
            imgCtx = imgCanvas.getContext('2d');

            // Set canvas size to match example
            const size = 400; // Larger for better quality
            imgCanvas.width = size;
            imgCanvas.height = size;
            imageWidth = size;
            imageHeight = size;

            // Regenerate the image at higher resolution
            regenerateExampleImage(index, imgCtx, size);

            // Get image data
            imgData = imgCtx.getImageData(0, 0, size, size);

            // Show canvas and controls
            document.getElementById('imageCanvasContainer').style.display = 'block';
            document.getElementById('sonificationControls').style.display = 'block';

            // Update scan line height
            document.getElementById('scanLine').style.height = size + 'px';
        }

        // Load example image and navigate to Image Sonification section
        function loadExampleImageAndNavigate(index) {
            // Load the image first
            loadExampleImage(index);

            // Navigate to imagesonification section
            showSection('imagesonification');
        }

        function regenerateExampleImage(index, ctx, size) {
            switch(index) {
                case 0: // Rainbow
                    const gradient0 = ctx.createLinearGradient(0, 0, size, 0);
                    gradient0.addColorStop(0, '#ff0000');
                    gradient0.addColorStop(0.17, '#ff7f00');
                    gradient0.addColorStop(0.33, '#ffff00');
                    gradient0.addColorStop(0.5, '#00ff00');
                    gradient0.addColorStop(0.67, '#0000ff');
                    gradient0.addColorStop(0.83, '#4b0082');
                    gradient0.addColorStop(1, '#9400d3');
                    ctx.fillStyle = gradient0;
                    ctx.fillRect(0, 0, size, size);
                    break;

                case 1: // Checkerboard
                    const squareSize = Math.floor(size / 10);
                    for (let y = 0; y < size; y += squareSize) {
                        for (let x = 0; x < size; x += squareSize) {
                            ctx.fillStyle = ((x / squareSize) + (y / squareSize)) % 2 === 0 ? '#000' : '#fff';
                            ctx.fillRect(x, y, squareSize, squareSize);
                        }
                    }
                    break;

                case 2: // Spiral
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, size, size);
                    ctx.strokeStyle = '#2d5f4f';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    const centerX = size / 2, centerY = size / 2;
                    let angle = 0, radius = 0;
                    ctx.moveTo(centerX, centerY);
                    while (radius < size / 2 - 20) {
                        const x = centerX + radius * Math.cos(angle);
                        const y = centerY + radius * Math.sin(angle);
                        ctx.lineTo(x, y);
                        angle += 0.1;
                        radius += 0.8;
                    }
                    ctx.stroke();
                    break;

                case 3: // Vertical Lines
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    for (let x = 0; x < size; x += size / 15) {
                        const brightness = Math.floor((x / size) * 255);
                        ctx.fillStyle = `rgb(${brightness}, ${brightness}, ${brightness})`;
                        ctx.fillRect(x, 0, size / 15, size);
                    }
                    break;

                case 4: // Abstract Art
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(0, 0, size, size);
                    for (let i = 0; i < 50; i++) {
                        const x = Math.random() * size;
                        const y = Math.random() * size;
                        const r = Math.random() * 80 + 20;
                        const hue = Math.random() * 360;
                        ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.5)`;
                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;

                case 5: // Sine Wave
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    ctx.strokeStyle = '#2d5f4f';
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    for (let x = 0; x < size; x++) {
                        const y = size / 2 + Math.sin(x / 30) * (size / 4);
                        if (x === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    ctx.strokeStyle = '#8ba888';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    for (let x = 0; x < size; x++) {
                        const y = size / 2 + Math.sin(x / 15) * (size / 8);
                        if (x === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    break;

                case 6: // Circular Pattern
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    const cx = size / 2, cy = size / 2;
                    for (let r = 20; r < size / 2 - 20; r += 20) {
                        const hue = (r / (size / 2)) * 360;
                        ctx.strokeStyle = `hsl(${hue}, 70%, 50%)`;
                        ctx.lineWidth = 5;
                        ctx.beginPath();
                        ctx.arc(cx, cy, r, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    break;

                case 7: // QR-like
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    ctx.fillStyle = '#000';
                    const blockSize = Math.floor(size / 15);
                    for (let y = 0; y < size; y += blockSize) {
                        for (let x = 0; x < size; x += blockSize) {
                            if (Math.random() > 0.5) {
                                ctx.fillRect(x, y, blockSize, blockSize);
                            }
                        }
                    }
                    break;

                case 8: // Sunset
                    const gradient8 = ctx.createLinearGradient(0, 0, 0, size);
                    gradient8.addColorStop(0, '#ff6b35');
                    gradient8.addColorStop(0.3, '#f7931e');
                    gradient8.addColorStop(0.5, '#fdc830');
                    gradient8.addColorStop(0.7, '#f37335');
                    gradient8.addColorStop(1, '#4a148c');
                    ctx.fillStyle = gradient8;
                    ctx.fillRect(0, 0, size, size);
                    break;

                case 9: // Noise
                    const imageData = ctx.createImageData(size, size);
                    for (let i = 0; i < imageData.data.length; i += 4) {
                        const noise = Math.random() * 255;
                        imageData.data[i] = noise;
                        imageData.data[i + 1] = noise;
                        imageData.data[i + 2] = noise;
                        imageData.data[i + 3] = 255;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
            }
        }

        // ==================== IMAGE SONIFICATION ====================
        let imgCanvas, imgCtx, imgData;
        let sonificationContext, sonificationOscillators = [];
        let sonificationInterval, isPaused = false, currentPosition = 0;
        let imageWidth, imageHeight;
        let masterCompressor, masterReverb, reverbGain;

        // Tone.js Samplers for high-quality instruments
        let toneSynths = {};
        let toneInitialized = false;

        // Initialize Tone.js instruments
        async function initializeToneSynths() {
            if (toneInitialized) return;

            console.log('🎹 Initializing Tone.js instruments...');

            // Start Tone.js audio context
            await Tone.start();
            console.log('✅ Tone.start() completed, context state:', Tone.context.state);

            // Create simple synths first (more reliable)
            toneSynths.piano = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths.piano.set({
                oscillator: { type: "sine" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
            });

            toneSynths['synth-pad'] = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths['synth-pad'].set({
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.3, decay: 0.4, sustain: 0.7, release: 2.0 }
            });

            toneSynths.bass = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths.bass.set({
                oscillator: { type: "square" },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.8 }
            });

            toneSynths.bells = new Tone.PolySynth(Tone.FMSynth).toDestination();
            toneSynths.bells.set({
                harmonicity: 8,
                modulationIndex: 2,
                envelope: { attack: 0.001, decay: 2, sustain: 0.1, release: 2 }
            });

            toneSynths.pluck = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths.pluck.set({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.2 }
            });

            // Set LOUD volume for all synths
            Object.values(toneSynths).forEach(synth => {
                synth.volume.value = 0; // 0 dB = full volume
            });

            toneInitialized = true;
            console.log('✅ Tone.js instruments ready!');

            // Test sound
            console.log('🔊 Testing piano with C4...');
            toneSynths.piano.triggerAttackRelease("C4", "8n");
            console.log('✅ Test note triggered');
        }

        // Load Image
        const imageInput = document.getElementById('imageInput');
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Setup canvas
                    imgCanvas = document.getElementById('imageCanvas');
                    imgCtx = imgCanvas.getContext('2d');

                    // Resize image to reasonable size (max 800px width)
                    const maxWidth = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        const ratio = maxWidth / width;
                        width = maxWidth;
                        height = height * ratio;
                    }

                    imgCanvas.width = width;
                    imgCanvas.height = height;
                    imageWidth = width;
                    imageHeight = height;

                    // Draw image
                    imgCtx.drawImage(img, 0, 0, width, height);
                    imgData = imgCtx.getImageData(0, 0, width, height);

                    // Show canvas and controls
                    document.getElementById('imageCanvasContainer').style.display = 'block';
                    document.getElementById('sonificationControls').style.display = 'block';

                    // Update scan line height
                    document.getElementById('scanLine').style.height = height + 'px';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            });
        }

        // Clear Image
        const clearImageBtn = document.getElementById('clearImageBtn');
        if (clearImageBtn) {
            clearImageBtn.addEventListener('click', function() {
            document.getElementById('imageCanvasContainer').style.display = 'none';
            document.getElementById('sonificationControls').style.display = 'none';
            document.getElementById('imageInput').value = '';
            stopSonification();
            });
        }

        // Speed Slider
        const scanSpeed = document.getElementById('scanSpeed');
        if (scanSpeed) {
            scanSpeed.addEventListener('input', function(e) {
                document.getElementById('speedValue').textContent = parseFloat(e.target.value).toFixed(1) + 'x';
            });
        }

        // Filter Cutoff Slider
        const filterCutoff = document.getElementById('filterCutoff');
        if (filterCutoff) {
            filterCutoff.addEventListener('input', function(e) {
                document.getElementById('filterValue').textContent = e.target.value + ' Hz';
            });
        }

        // Resonance Slider
        const resonance = document.getElementById('resonance');
        if (resonance) {
            resonance.addEventListener('input', function(e) {
                document.getElementById('resonanceValue').textContent = parseFloat(e.target.value).toFixed(1);
            });
        }

        // Attack Slider
        const attackTime = document.getElementById('attackTime');
        if (attackTime) {
            attackTime.addEventListener('input', function(e) {
                document.getElementById('attackValue').textContent = parseFloat(e.target.value).toFixed(3) + 's';
            });
        }

        // Release Slider
        const releaseTime = document.getElementById('releaseTime');
        if (releaseTime) {
            releaseTime.addEventListener('input', function(e) {
                document.getElementById('releaseValue').textContent = parseFloat(e.target.value).toFixed(2) + 's';
            });
        }

        // Musical Scales Toggle
        const useMusicalScales = document.getElementById('useMusicalScales');
        if (useMusicalScales) {
            useMusicalScales.addEventListener('change', function(e) {
                const scaleControls = document.getElementById('scaleControls');
                if (scaleControls) {
                    scaleControls.style.display = e.target.checked ? 'grid' : 'none';
                }
            });
        }

        // Musical Scales Definitions (in semitones from root)
        const musicalScales = {
            // Major modes
            major: [0, 2, 4, 5, 7, 9, 11],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],

            // Minor modes
            minor: [0, 2, 3, 5, 7, 8, 10],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            harmonic_minor: [0, 2, 3, 5, 7, 8, 11],
            melodic_minor: [0, 2, 3, 5, 7, 9, 11],

            // Pentatonic
            pentatonic_major: [0, 2, 4, 7, 9],
            pentatonic_minor: [0, 3, 5, 7, 10],

            // Blues & Jazz
            blues: [0, 3, 5, 6, 7, 10],
            bebop_major: [0, 2, 4, 5, 7, 8, 9, 11],
            bebop_minor: [0, 2, 3, 5, 7, 8, 9, 10],

            // Mediorientali/Arabe
            arabic: [0, 1, 4, 5, 7, 8, 11],          // Maqam Hijaz
            persian: [0, 1, 4, 5, 6, 8, 11],         // Dastgah
            hijaz: [0, 1, 4, 5, 7, 8, 10],           // Hijaz

            // Indiane (Raga)
            raga_bhairav: [0, 1, 4, 5, 7, 8, 11],   // Alba
            raga_todi: [0, 1, 3, 6, 7, 8, 11],       // Mezzogiorno
            raga_yaman: [0, 2, 4, 6, 7, 9, 11],     // Sera

            // Giapponesi
            japanese_in: [0, 1, 5, 7, 8],            // In (misteriosa)
            japanese_yo: [0, 2, 5, 7, 9],            // Yo (allegra)
            japanese_hirajoshi: [0, 2, 3, 7, 8],     // Hirajōshi

            // Africane
            african_1: [0, 2, 3, 5, 7, 9, 10],       // Africana comune
            african_2: [0, 3, 5, 7, 10],             // Pentatonica africana

            // Esotiche/Moderne
            whole_tone: [0, 2, 4, 6, 8, 10],         // Debussy
            diminished: [0, 2, 3, 5, 6, 8, 9, 11],   // Jazz
            augmented: [0, 3, 4, 7, 8, 11],
            spanish: [0, 1, 3, 4, 5, 6, 8, 10],      // Flamenco
            gypsy: [0, 2, 3, 6, 7, 8, 11],

            // Altre
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            whole_half: [0, 2, 3, 5, 6, 8, 9, 11]
        };

        // Function to quantize frequency to nearest note in scale
        function quantizeToScale(frequency, scaleName, keyOffset, octaveRange) {
            const scale = musicalScales[scaleName];
            if (!scale) return frequency;

            // Convert frequency to MIDI note number
            const midiNote = 12 * Math.log2(frequency / 440) + 69;

            // Get the scale notes across all octaves
            const baseOctave = Math.floor(midiNote / 12) - Math.floor(octaveRange / 2);
            const scaleNotes = [];

            for (let oct = 0; oct < octaveRange + 1; oct++) {
                for (let i = 0; i < scale.length; i++) {
                    const note = (baseOctave + oct) * 12 + scale[i] + parseInt(keyOffset);
                    scaleNotes.push(note);
                }
            }

            // Find closest scale note
            let closestNote = scaleNotes[0];
            let minDistance = Math.abs(midiNote - closestNote);

            for (let i = 1; i < scaleNotes.length; i++) {
                const distance = Math.abs(midiNote - scaleNotes[i]);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestNote = scaleNotes[i];
                }
            }

            // Convert back to frequency
            return 440 * Math.pow(2, (closestNote - 69) / 12);
        }

        // Play Sonification
        const playSonificationBtn = document.getElementById('playSonificationBtn');
        if (playSonificationBtn) {
            playSonificationBtn.addEventListener('click', function() {
                startSonification();
            });
        }

        // Stop Sonification
        const stopSonificationBtn = document.getElementById('stopSonificationBtn');
        if (stopSonificationBtn) {
            stopSonificationBtn.addEventListener('click', function() {
                stopSonification();
            });
        }

        // Pause Sonification
        const pauseSonificationBtn = document.getElementById('pauseSonificationBtn');
        if (pauseSonificationBtn) {
            pauseSonificationBtn.addEventListener('click', function() {
                pauseSonification();
            });
        }

        // Resume Sonification
        const resumeSonificationBtn = document.getElementById('resumeSonificationBtn');
        if (resumeSonificationBtn) {
            resumeSonificationBtn.addEventListener('click', function() {
                resumeSonification();
            });
        }

        async function startSonification() {
            if (!imgData) {
                alert('Carica prima un\'immagine!');
                return;
            }

            try {
                // Initialize Tone.js instruments first
                await initializeToneSynths();
                console.log('✅ Tone.js initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing Tone.js:', error);
            }

            // Initialize Audio Context
            if (!sonificationContext) {
                sonificationContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create master compressor for better dynamics
                masterCompressor = sonificationContext.createDynamicsCompressor();
                masterCompressor.threshold.value = -24;
                masterCompressor.knee.value = 30;
                masterCompressor.ratio.value = 12;
                masterCompressor.attack.value = 0.003;
                masterCompressor.release.value = 0.25;

                // Create reverb using ConvolverNode
                masterReverb = sonificationContext.createConvolver();
                reverbGain = sonificationContext.createGain();
                reverbGain.gain.value = 0.15; // Mix leggero di reverb

                // Generate impulse response for reverb
                const reverbLength = sonificationContext.sampleRate * 2; // 2 secondi
                const impulse = sonificationContext.createBuffer(2, reverbLength, sonificationContext.sampleRate);
                const impulseL = impulse.getChannelData(0);
                const impulseR = impulse.getChannelData(1);

                for (let i = 0; i < reverbLength; i++) {
                    const decay = Math.pow(1 - i / reverbLength, 2);
                    impulseL[i] = (Math.random() * 2 - 1) * decay;
                    impulseR[i] = (Math.random() * 2 - 1) * decay;
                }
                masterReverb.buffer = impulse;

                // Connect reverb chain: reverb -> reverbGain -> compressor -> destination
                masterReverb.connect(reverbGain);
                reverbGain.connect(masterCompressor);
                masterCompressor.connect(sonificationContext.destination);
            }

            // Reset position
            currentPosition = 0;

            // Update UI
            document.getElementById('playSonificationBtn').style.display = 'none';
            document.getElementById('stopSonificationBtn').style.display = 'inline-block';
            document.getElementById('pauseSonificationBtn').style.display = 'inline-block';
            document.getElementById('resumeSonificationBtn').style.display = 'none';
            document.getElementById('scanLine').style.display = 'block';

            // Get parameters
            const scanMode = document.getElementById('scanMode').value;
            const speed = parseFloat(document.getElementById('scanSpeed').value);
            const mappingMode = document.getElementById('mappingMode').value;

            // Start scanning
            isPaused = false;
            scanImage(scanMode, speed, mappingMode);
        }

        function stopSonification() {
            // Stop interval
            if (sonificationInterval) {
                clearInterval(sonificationInterval);
                sonificationInterval = null;
            }

            // Stop all oscillators
            sonificationOscillators.forEach(osc => {
                try {
                    osc.stop();
                } catch (e) {}
            });
            sonificationOscillators = [];

            // Stop all Tone.js synths
            if (toneInitialized) {
                Object.values(toneSynths).forEach(synth => {
                    synth.releaseAll();
                });
            }

            // Reset UI
            document.getElementById('playSonificationBtn').style.display = 'inline-block';
            document.getElementById('stopSonificationBtn').style.display = 'none';
            document.getElementById('pauseSonificationBtn').style.display = 'none';
            document.getElementById('resumeSonificationBtn').style.display = 'none';
            document.getElementById('scanLine').style.display = 'none';
            document.getElementById('sonificationProgress').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';

            currentPosition = 0;
            isPaused = false;
        }

        function pauseSonification() {
            isPaused = true;
            if (sonificationInterval) {
                clearInterval(sonificationInterval);
                sonificationInterval = null;
            }

            sonificationOscillators.forEach(osc => {
                try {
                    osc.stop();
                } catch (e) {}
            });
            sonificationOscillators = [];

            // Stop all Tone.js synths
            if (toneInitialized) {
                Object.values(toneSynths).forEach(synth => {
                    synth.releaseAll();
                });
            }

            document.getElementById('pauseSonificationBtn').style.display = 'none';
            document.getElementById('resumeSonificationBtn').style.display = 'inline-block';
        }

        function resumeSonification() {
            isPaused = false;
            const scanMode = document.getElementById('scanMode').value;
            const speed = parseFloat(document.getElementById('scanSpeed').value);
            const mappingMode = document.getElementById('mappingMode').value;

            document.getElementById('pauseSonificationBtn').style.display = 'inline-block';
            document.getElementById('resumeSonificationBtn').style.display = 'none';

            scanImage(scanMode, speed, mappingMode);
        }

        function scanImage(scanMode, speed, mappingMode) {
            const baseInterval = 20; // ms per column/row
            const interval = baseInterval / speed;

            sonificationInterval = setInterval(() => {
                if (isPaused) return;

                if (scanMode === 'horizontal') {
                    if (currentPosition >= imageWidth) {
                        stopSonification();
                        return;
                    }

                    // Get column data
                    const columnData = getColumnData(currentPosition);

                    // Sonify column
                    sonifyData(columnData, currentPosition / imageWidth, mappingMode);

                    // Update scan line
                    const scanLine = document.getElementById('scanLine');
                    scanLine.style.left = currentPosition + 'px';

                    // Update progress
                    const progress = (currentPosition / imageWidth) * 100;
                    document.getElementById('sonificationProgress').style.width = progress + '%';
                    document.getElementById('progressText').textContent = Math.round(progress) + '%';

                    currentPosition++;

                } else if (scanMode === 'vertical') {
                    if (currentPosition >= imageHeight) {
                        stopSonification();
                        return;
                    }

                    // Get row data
                    const rowData = getRowData(currentPosition);

                    // Sonify row
                    sonifyData(rowData, currentPosition / imageHeight, mappingMode);

                    // Update scan line (rotate for vertical)
                    const scanLine = document.getElementById('scanLine');
                    scanLine.style.width = imageWidth + 'px';
                    scanLine.style.height = '2px';
                    scanLine.style.top = currentPosition + 'px';
                    scanLine.style.left = '0px';

                    // Update progress
                    const progress = (currentPosition / imageHeight) * 100;
                    document.getElementById('sonificationProgress').style.width = progress + '%';
                    document.getElementById('progressText').textContent = Math.round(progress) + '%';

                    currentPosition++;
                }

            }, interval);
        }

        function getColumnData(x) {
            const data = [];
            for (let y = 0; y < imageHeight; y++) {
                const index = (y * imageWidth + x) * 4;
                const r = imgData.data[index];
                const g = imgData.data[index + 1];
                const b = imgData.data[index + 2];
                data.push({ r, g, b, y });
            }
            return data;
        }

        function getRowData(y) {
            const data = [];
            for (let x = 0; x < imageWidth; x++) {
                const index = (y * imageWidth + x) * 4;
                const r = imgData.data[index];
                const g = imgData.data[index + 1];
                const b = imgData.data[index + 2];
                data.push({ r, g, b, x });
            }
            return data;
        }

        function sonifyData(pixelData, progress, mappingMode) {
            // Stop previous oscillators
            sonificationOscillators.forEach(osc => {
                try {
                    osc.stop();
                } catch (e) {}
            });
            sonificationOscillators = [];

            // Get all parameters
            const freqRangeSelect = document.getElementById('freqRange').value;
            const synthesisType = document.getElementById('synthesisType').value;
            const filterCutoff = parseFloat(document.getElementById('filterCutoff').value);
            const resonance = parseFloat(document.getElementById('resonance').value);
            const attackTime = parseFloat(document.getElementById('attackTime').value);
            const releaseTime = parseFloat(document.getElementById('releaseTime').value);

            // Musical scales parameters
            const useScales = document.getElementById('useMusicalScales').checked;
            const scaleName = document.getElementById('musicalScale').value;
            const keyOffset = document.getElementById('musicalKey').value;
            const octaveRange = parseInt(document.getElementById('octaveRange').value);

            let minFreq, maxFreq;
            switch(freqRangeSelect) {
                case 'low': minFreq = 50; maxFreq = 200; break;
                case 'mid': minFreq = 200; maxFreq = 1000; break;
                case 'high': minFreq = 1000; maxFreq = 4000; break;
                case 'full': minFreq = 50; maxFreq = 4000; break;
                default: minFreq = 200; maxFreq = 1000;
            }

            const now = sonificationContext.currentTime;
            const duration = attackTime + releaseTime;

            if (mappingMode === 'brightness') {
                // Brightness mode: average brightness → single frequency
                let totalBrightness = 0;
                pixelData.forEach(pixel => {
                    const brightness = (pixel.r + pixel.g + pixel.b) / 3;
                    totalBrightness += brightness;
                });
                const avgBrightness = totalBrightness / pixelData.length;
                const normalizedBrightness = avgBrightness / 255;
                let frequency = minFreq + (normalizedBrightness * (maxFreq - minFreq));

                // Apply musical scale quantization if enabled
                if (useScales) {
                    frequency = quantizeToScale(frequency, scaleName, keyOffset, octaveRange);
                }

                createSynthVoice(frequency, normalizedBrightness, 0, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);

            } else if (mappingMode === 'color') {
                // Color mode: RGB → 3 separate voices
                let totalR = 0, totalG = 0, totalB = 0;
                pixelData.forEach(pixel => {
                    totalR += pixel.r;
                    totalG += pixel.g;
                    totalB += pixel.b;
                });

                const avgR = totalR / pixelData.length / 255;
                const avgG = totalG / pixelData.length / 255;
                const avgB = totalB / pixelData.length / 255;

                let freqR = minFreq + (avgR * (maxFreq - minFreq));
                let freqG = minFreq + (avgG * (maxFreq - minFreq));
                let freqB = minFreq + (avgB * (maxFreq - minFreq));

                // Apply musical scale quantization if enabled
                if (useScales) {
                    freqR = quantizeToScale(freqR, scaleName, keyOffset, octaveRange);
                    freqG = quantizeToScale(freqG, scaleName, keyOffset, octaveRange);
                    freqB = quantizeToScale(freqB, scaleName, keyOffset, octaveRange);
                }

                // Create separate voices for R, G, B
                createSynthVoice(freqR, avgR, -0.3, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);
                createSynthVoice(freqG, avgG, 0, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);
                createSynthVoice(freqB, avgB, 0.3, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);

            } else if (mappingMode === 'position') {
                // Position mode: vertical position → frequency, horizontal → pan
                let totalBrightness = 0;
                let weightedPosition = 0;

                pixelData.forEach(pixel => {
                    const brightness = (pixel.r + pixel.g + pixel.b) / 3;
                    totalBrightness += brightness;
                    const pos = pixel.y !== undefined ? pixel.y : pixel.x;
                    weightedPosition += pos * brightness;
                });

                const avgBrightness = totalBrightness / pixelData.length;
                const avgPosition = weightedPosition / totalBrightness;
                const maxPos = pixelData[0].y !== undefined ? imageHeight : imageWidth;
                const normalizedPos = avgPosition / maxPos;
                let frequency = minFreq + (normalizedPos * (maxFreq - minFreq));
                const panValue = (progress * 2) - 1; // -1 to 1

                // Apply musical scale quantization if enabled
                if (useScales) {
                    frequency = quantizeToScale(frequency, scaleName, keyOffset, octaveRange);
                }

                createSynthVoice(frequency, avgBrightness / 255, panValue, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);
            }
        }

        function createSynthVoice(frequency, intensity, pan, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration) {
            // Check if using Tone.js sampled instruments
            const toneSynthTypes = ['piano', 'synth-pad', 'bass', 'bells', 'pluck'];
            if (toneSynthTypes.includes(synthesisType)) {
                // Tone.js should already be initialized in startSonification
                if (!toneInitialized) {
                    console.warn('⚠️ Tone.js not initialized yet');
                    return;
                }

                // Convert frequency to note name
                const midiNote = 12 * Math.log2(frequency / 440) + 69;
                const noteName = Tone.Frequency(Math.round(midiNote), "midi").toNote();

                // Calculate velocity from intensity (0-1)
                const velocity = Math.max(0.1, Math.min(1, intensity * 1.5));

                // Schedule note with Tone.js
                const synth = toneSynths[synthesisType];
                if (synth) {
                    // Trigger note immediately with duration
                    // Tone.js uses seconds for duration, so we use duration directly
                    synth.triggerAttackRelease(noteName, duration, "+0", velocity);
                    console.log(`🎵 Playing ${noteName} on ${synthesisType} (velocity: ${velocity.toFixed(2)})`);
                } else {
                    console.error(`❌ Synth not found: ${synthesisType}`);
                }

                return; // Exit early, Tone.js handles everything
            }

            // Web Audio API synthesis (original code)
            const gainValue = intensity * 0.2; // Ridotto per headroom del compressore

            // Migliora attack e release per evitare click
            const improvedAttack = Math.max(attackTime, 0.01); // Minimo 10ms
            const improvedRelease = Math.max(releaseTime, 0.05); // Minimo 50ms

            if (synthesisType === 'pure') {
                // Pure sine wave
                const osc = sonificationContext.createOscillator();
                const filter = sonificationContext.createBiquadFilter();
                const gain = sonificationContext.createGain();
                const panner = sonificationContext.createStereoPanner();
                const dryGain = sonificationContext.createGain();
                const wetGain = sonificationContext.createGain();

                osc.type = 'sine';
                osc.frequency.value = frequency;

                // Filter
                filter.type = 'lowpass';
                filter.frequency.value = filterCutoff;
                filter.Q.value = resonance;

                // Envelope migliorato
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(gainValue, now + improvedAttack);
                gain.gain.setValueAtTime(gainValue, now + duration - improvedRelease);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                panner.pan.value = pan;

                // Dry/Wet mix: 80% dry, 20% wet
                dryGain.gain.value = 0.8;
                wetGain.gain.value = 0.2;

                // Routing: osc -> filter -> gain -> panner -> [dry->compressor, wet->reverb]
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(panner);

                panner.connect(dryGain);
                panner.connect(wetGain);

                dryGain.connect(masterCompressor);
                wetGain.connect(masterReverb);

                osc.start(now);
                osc.stop(now + duration);
                sonificationOscillators.push(osc);

            } else if (synthesisType === 'harmonic') {
                // Additive synthesis with harmonics (migliorato)
                const harmonics = [1, 2, 3, 4, 5, 6];
                const harmAmps = [1.0, 0.6, 0.4, 0.25, 0.15, 0.1];

                harmonics.forEach((harmonic, i) => {
                    const osc = sonificationContext.createOscillator();
                    const filter = sonificationContext.createBiquadFilter();
                    const gain = sonificationContext.createGain();
                    const panner = sonificationContext.createStereoPanner();
                    const dryGain = sonificationContext.createGain();
                    const wetGain = sonificationContext.createGain();

                    osc.type = 'sine';
                    osc.frequency.value = frequency * harmonic;

                    // Filter
                    filter.type = 'lowpass';
                    filter.frequency.value = filterCutoff;
                    filter.Q.value = resonance;

                    // Envelope migliorato per ogni armonica
                    const harmGain = gainValue * harmAmps[i];
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(harmGain, now + improvedAttack);
                    gain.gain.setValueAtTime(harmGain, now + duration - improvedRelease);
                    gain.gain.linearRampToValueAtTime(0, now + duration);

                    panner.pan.value = pan + (Math.random() * 0.1 - 0.05); // Leggero stereo spread

                    // Dry/Wet mix
                    dryGain.gain.value = 0.8;
                    wetGain.gain.value = 0.2;

                    // Routing
                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(panner);

                    panner.connect(dryGain);
                    panner.connect(wetGain);

                    dryGain.connect(masterCompressor);
                    wetGain.connect(masterReverb);

                    osc.start(now);
                    osc.stop(now + duration);
                    sonificationOscillators.push(osc);
                });

            } else if (synthesisType === 'filtered') {
                // Sawtooth with lowpass filter
                const osc = sonificationContext.createOscillator();
                const filter = sonificationContext.createBiquadFilter();
                const gain = sonificationContext.createGain();
                const panner = sonificationContext.createStereoPanner();
                const dryGain = sonificationContext.createGain();
                const wetGain = sonificationContext.createGain();

                osc.type = 'sawtooth';
                osc.frequency.value = frequency;

                filter.type = 'lowpass';
                filter.frequency.value = filterCutoff;
                filter.Q.value = resonance;

                // Envelope migliorato
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(gainValue, now + improvedAttack);
                gain.gain.setValueAtTime(gainValue, now + duration - improvedRelease);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                panner.pan.value = pan;

                // Dry/Wet mix
                dryGain.gain.value = 0.8;
                wetGain.gain.value = 0.2;

                // Routing
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(panner);

                panner.connect(dryGain);
                panner.connect(wetGain);

                dryGain.connect(masterCompressor);
                wetGain.connect(masterReverb);

                osc.start(now);
                osc.stop(now + duration);
                sonificationOscillators.push(osc);

            } else if (synthesisType === 'rich') {
                // Multi-harmonic rich sound
                const harmonics = [1, 1.5, 2, 2.5, 3, 4, 5, 6];
                const harmAmps = [1.0, 0.6, 0.5, 0.3, 0.25, 0.2, 0.15, 0.1];

                harmonics.forEach((harmonic, i) => {
                    const osc = sonificationContext.createOscillator();
                    const filter = sonificationContext.createBiquadFilter();
                    const gain = sonificationContext.createGain();
                    const panner = sonificationContext.createStereoPanner();
                    const dryGain = sonificationContext.createGain();
                    const wetGain = sonificationContext.createGain();

                    osc.type = i % 2 === 0 ? 'sine' : 'triangle';
                    osc.frequency.value = frequency * harmonic;

                    // Filter
                    filter.type = 'lowpass';
                    filter.frequency.value = filterCutoff;
                    filter.Q.value = resonance;

                    // Envelope migliorato
                    const harmGain = gainValue * harmAmps[i] * 0.4;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(harmGain, now + improvedAttack);
                    gain.gain.setValueAtTime(harmGain, now + duration - improvedRelease);
                    gain.gain.linearRampToValueAtTime(0, now + duration);

                    panner.pan.value = pan + (Math.random() * 0.2 - 0.1);

                    // Dry/Wet mix
                    dryGain.gain.value = 0.75;
                    wetGain.gain.value = 0.25;

                    // Routing
                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(panner);

                    panner.connect(dryGain);
                    panner.connect(wetGain);

                    dryGain.connect(masterCompressor);
                    wetGain.connect(masterReverb);

                    osc.start(now);
                    osc.stop(now + duration);
                    sonificationOscillators.push(osc);
                });

            } else if (synthesisType === 'granular') {
                // Granular synthesis simulation
                const grains = 5;
                const grainDuration = duration / 3;

                for (let g = 0; g < grains; g++) {
                    const osc = sonificationContext.createOscillator();
                    const filter = sonificationContext.createBiquadFilter();
                    const gain = sonificationContext.createGain();
                    const panner = sonificationContext.createStereoPanner();
                    const dryGain = sonificationContext.createGain();
                    const wetGain = sonificationContext.createGain();

                    const freqVariation = frequency * (0.98 + Math.random() * 0.04);
                    osc.type = 'sine';
                    osc.frequency.value = freqVariation;

                    // Filter
                    filter.type = 'lowpass';
                    filter.frequency.value = filterCutoff;
                    filter.Q.value = resonance;

                    const startTime = now + (g * duration / grains);
                    const grainGain = gainValue * 0.25;

                    // Envelope con attack/release migliorato
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(grainGain, startTime + Math.max(grainDuration * 0.3, 0.01));
                    gain.gain.linearRampToValueAtTime(0, startTime + grainDuration);

                    panner.pan.value = pan + (Math.random() * 0.4 - 0.2);

                    // Dry/Wet mix
                    dryGain.gain.value = 0.7;
                    wetGain.gain.value = 0.3;

                    // Routing
                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(panner);

                    panner.connect(dryGain);
                    panner.connect(wetGain);

                    dryGain.connect(masterCompressor);
                    wetGain.connect(masterReverb);

                    osc.start(startTime);
                    osc.stop(startTime + grainDuration);
                    sonificationOscillators.push(osc);
                }

            } else if (synthesisType === 'noise') {
                // Filtered noise
                const bufferSize = sonificationContext.sampleRate * duration;
                const buffer = sonificationContext.createBuffer(1, bufferSize, sonificationContext.sampleRate);
                const data = buffer.getChannelData(0);

                // Generate noise
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                const noise = sonificationContext.createBufferSource();
                const filter = sonificationContext.createBiquadFilter();
                const gain = sonificationContext.createGain();
                const panner = sonificationContext.createStereoPanner();
                const dryGain = sonificationContext.createGain();
                const wetGain = sonificationContext.createGain();

                noise.buffer = buffer;

                filter.type = 'bandpass';
                filter.frequency.value = frequency;
                filter.Q.value = 10;

                // Envelope migliorato
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(gainValue * 0.4, now + improvedAttack);
                gain.gain.setValueAtTime(gainValue * 0.4, now + duration - improvedRelease);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                panner.pan.value = pan;

                // Dry/Wet mix
                dryGain.gain.value = 0.6;
                wetGain.gain.value = 0.4;

                // Routing
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(panner);

                panner.connect(dryGain);
                panner.connect(wetGain);

                dryGain.connect(masterCompressor);
                wetGain.connect(masterReverb);

                noise.start(now);
                sonificationOscillators.push(noise);
            }
        }

        // ========================================
        // SOUNDSCAPE MAP - LEAFLET.JS IMPLEMENTATION
        // ========================================

        var leafletMap = null;
        var mapMarkers = [];
        var soundscapeData = [];
        var currentAudioBlob = null;
        var mediaRecorder = null;
        var recordingChunks = [];
        var recordingTimer = null;
        var recordingSeconds = 0;
        var pendingMarkerCoords = null;

        // Category icons mapping
        const categoryIcons = {
            traffic: '🚗',
            market: '🛒',
            voices: '👥',
            industrial: '🏭',
            railway: '🚂',
            coastal: '🌊',
            forest: '🌲',
            park: '🌳',
            construction: '🚧',
            airport: '✈️',
            other: '📌'
        };

        const categoryColors = {
            traffic: '#e74c3c',
            market: '#f39c12',
            voices: '#3498db',
            industrial: '#95a5a6',
            railway: '#9b59b6',
            coastal: '#1abc9c',
            forest: '#27ae60',
            park: '#2ecc71',
            construction: '#e67e22',
            airport: '#34495e',
            other: '#7f8c8d'
        };

        // Initialize map when section becomes visible
        function initializeSoundscapeMap() {
            console.log('🗺️ Initializing Soundscape Map...');

            if (leafletMap) {
                // Map already exists, just refresh it
                console.log('Map exists, refreshing...');
                leafletMap.invalidateSize();
                return;
            }

            // Create map centered on Italy
            try {
                leafletMap = L.map('leafletMap').setView([43.7696, 11.2558], 6);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(leafletMap);

                // Add click event to add markers
                leafletMap.on('click', function(e) {
                    pendingMarkerCoords = e.latlng;
                    alert('📍 Marker placed! Now add category, notes and audio, then the marker will be saved automatically.');
                });

                // Load saved markers
                loadSoundscapeData();

                console.log('✅ Map initialized');
            } catch (error) {
                console.error('❌ Error initializing map:', error);
                alert('Map initialization error: ' + error.message);
            }
        }

        // Recording controls
        document.getElementById('startRecording').addEventListener('click', async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);
                recordingChunks = [];
                recordingSeconds = 0;

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordingChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    currentAudioBlob = new Blob(recordingChunks, { type: 'audio/webm' });
                    showAudioPreview(currentAudioBlob);

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    // Save marker if coordinates are set
                    if (pendingMarkerCoords) {
                        saveMarker();
                    }
                };

                mediaRecorder.start();

                // Update UI
                document.getElementById('startRecording').style.display = 'none';
                document.getElementById('stopRecording').style.display = 'block';
                document.getElementById('recordingTime').style.display = 'block';

                // Start timer
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const mins = Math.floor(recordingSeconds / 60);
                    const secs = recordingSeconds % 60;
                    document.getElementById('recordingTime').textContent =
                        `⏱️ ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                }, 1000);

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('❌ Impossibile accedere al microfono. Verifica i permessi del browser.');
            }
        });

        document.getElementById('stopRecording').addEventListener('click', function() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingTimer);

                // Reset UI
                document.getElementById('startRecording').style.display = 'block';
                document.getElementById('stopRecording').style.display = 'none';
                document.getElementById('recordingTime').style.display = 'none';
            }
        });

        // File upload
        document.getElementById('audioFileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentAudioBlob = file;
                showAudioPreview(file);

                // Save marker if coordinates are set
                if (pendingMarkerCoords) {
                    saveMarker();
                }
            }
        });

        // Show audio preview
        function showAudioPreview(audioBlob) {
            const preview = document.getElementById('audioPreview');
            const player = document.getElementById('audioPreviewPlayer');

            const url = URL.createObjectURL(audioBlob);
            player.src = url;
            preview.style.display = 'block';
        }

        // Save marker to map and storage
        // Aggiungi marker da esercizio completato
        async function addExerciseMarkerToMap(exerciseData, exerciseId) {
            if (!exerciseData.locationCoords || !exerciseData.locationCoords.lat) {
                console.warn('Coordinate non disponibili per il marker');
                return;
            }

            // Determina categoria basata sul tipo di esercizio
            const category = 'park'; // Default: parco urbano (soundscape exercise)

            // Create marker data
            const markerData = {
                id: Date.now(),
                lat: parseFloat(exerciseData.locationCoords.lat),
                lng: parseFloat(exerciseData.locationCoords.lon),
                category: category,
                notes: `📝 ${exerciseData.exercise.title}\n\n${exerciseData.notes || 'Nessuna nota'}`,
                timestamp: exerciseData.timestamp,
                hasAudio: exerciseData.audioFiles && exerciseData.audioFiles.length > 0,
                exerciseTitle: exerciseData.exercise.title,
                exerciseId: exerciseId  // ID dell'esercizio completo in IndexedDB
            };

            // Save audio to IndexedDB if present
            if (exerciseData.audioFiles && exerciseData.audioFiles.length > 0) {
                // Usa il primo file audio per il marker
                const audioBlob = await fetch(exerciseData.audioFiles[0].data).then(r => r.blob());
                await saveAudioToIndexedDB(markerData.id, audioBlob);
            }

            // Add marker to map (solo se la mappa è inizializzata)
            if (leafletMap) {
                const icon = L.divIcon({
                    html: `<div style="font-size: 28px;">${categoryIcons[category]}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });

                const marker = L.marker([markerData.lat, markerData.lng], { icon: icon }).addTo(leafletMap);

                // Create popup content
                const popupContent = createPopupContent(markerData);
                marker.bindPopup(popupContent, { maxWidth: 300 });

                mapMarkers.push({ marker: marker, data: markerData });
            }

            soundscapeData.push(markerData);

            // Save to localStorage
            saveSoundscapeData();

            // Update markers list (se siamo nella sezione map)
            if (document.getElementById('map').classList.contains('active')) {
                updateMarkersList();
            }

            console.log('✅ Marker aggiunto alla mappa per esercizio:', exerciseData.exercise.title);
        }

        async function saveMarker() {
            if (!pendingMarkerCoords) {
                alert('❌ Clicca prima sulla mappa per posizionare un marker!');
                return;
            }

            const category = document.getElementById('markerCategory').value;
            const notes = document.getElementById('markerNotes').value;

            if (!notes.trim()) {
                alert('⚠️ Aggiungi una descrizione per il soundscape!');
                return;
            }

            // Create marker data
            const markerData = {
                id: Date.now(),
                lat: pendingMarkerCoords.lat,
                lng: pendingMarkerCoords.lng,
                category: category,
                notes: notes,
                timestamp: new Date().toISOString(),
                hasAudio: currentAudioBlob !== null
            };

            // Save audio to IndexedDB if present
            if (currentAudioBlob) {
                await saveAudioToIndexedDB(markerData.id, currentAudioBlob);
            }

            // Add marker to map
            const icon = L.divIcon({
                html: `<div style="font-size: 28px;">${categoryIcons[category]}</div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            const marker = L.marker([markerData.lat, markerData.lng], { icon: icon }).addTo(leafletMap);

            // Create popup content
            const popupContent = createPopupContent(markerData);
            marker.bindPopup(popupContent, { maxWidth: 300 });

            mapMarkers.push({ marker: marker, data: markerData });
            soundscapeData.push(markerData);

            // Save to localStorage
            saveSoundscapeData();

            // Update markers list
            updateMarkersList();

            // Reset form
            document.getElementById('markerNotes').value = '';
            document.getElementById('audioPreview').style.display = 'none';
            currentAudioBlob = null;
            pendingMarkerCoords = null;

            alert('✅ Marker saved successfully!');
        }

        // Create popup content for marker
        function createPopupContent(markerData) {
            const categoryName = document.querySelector(`#markerCategory option[value="${markerData.category}"]`).textContent;

            let html = `
                <div style="min-width: 250px;">
                    <h4 style="margin: 0 0 10px 0; color: ${categoryColors[markerData.category]};">
                        ${categoryIcons[markerData.category]} ${categoryName}
                    </h4>
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">
                        ${markerData.notes}
                    </p>
                    <p style="margin: 0; font-size: 12px; color: #999;">
                        📅 ${new Date(markerData.timestamp).toLocaleString('it-IT')}
                    </p>
            `;

            if (markerData.hasAudio) {
                html += `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <button onclick="playMarkerAudio(${markerData.id})"
                                style="width: 100%; padding: 8px; background: #2d5f4f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            🔊 Riproduci Audio
                        </button>
                    </div>
                `;
            }

            // Se c'è exerciseId, aggiungi bottone per aprire esercizio completo
            if (markerData.exerciseId) {
                html += `
                    <div style="margin-top: 8px;">
                        <button onclick="openExerciseFromMap(${markerData.exerciseId})"
                                style="width: 100%; padding: 8px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            📄 Vedi Esercizio Completo
                        </button>
                    </div>
                `;
            }

            html += `
                    <div style="margin-top: 8px;">
                        <button onclick="deleteMarker(${markerData.id})"
                                style="width: 100%; padding: 6px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            🗑️ Elimina
                        </button>
                    </div>
                </div>
            `;

            return html;
        }

        // Apri esercizio completo dalla mappa
        window.openExerciseFromMap = async function(exerciseId) {
            try {
                // Chiudi eventuali popup aperti
                if (leafletMap) {
                    leafletMap.closePopup();
                }

                // Vai alla sezione dashboard
                showSection('dashboard');

                // Apri il modal con l'esercizio completo
                await viewCompletedExercise(exerciseId);

                console.log('✅ Esercizio aperto:', exerciseId);
            } catch (error) {
                console.error('Errore apertura esercizio:', error);
                alert('❌ Errore durante l\'apertura dell\'esercizio!');
            }
        };

        // Play audio from marker
        window.playMarkerAudio = async function(markerId) {
            try {
                const audioBlob = await getAudioFromIndexedDB(markerId);
                if (audioBlob) {
                    const url = URL.createObjectURL(audioBlob);
                    const audio = new Audio(url);
                    audio.play();
                } else {
                    alert('❌ Audio not found');
                }
            } catch (error) {
                console.error('Error playing audio:', error);
                alert('❌ Audio playback error');
            }
        };

        // Delete marker
        window.deleteMarker = function(markerId) {
            if (!confirm('Are you sure you want to delete this marker?')) return;

            // Remove from map
            const markerIndex = mapMarkers.findIndex(m => m.data.id === markerId);
            if (markerIndex !== -1) {
                leafletMap.removeLayer(mapMarkers[markerIndex].marker);
                mapMarkers.splice(markerIndex, 1);
            }

            // Remove from data
            const dataIndex = soundscapeData.findIndex(m => m.id === markerId);
            if (dataIndex !== -1) {
                soundscapeData.splice(dataIndex, 1);
            }

            // Remove audio from IndexedDB
            deleteAudioFromIndexedDB(markerId);

            // Save to localStorage
            saveSoundscapeData();

            // Update list
            updateMarkersList();

            alert('✅ Marker deleted');
        };

        // Update markers list
        function updateMarkersList() {
            const listDiv = document.getElementById('markersList');

            if (soundscapeData.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-style: italic;">No markers saved</p>';
                return;
            }

            let html = '';
            soundscapeData.forEach(marker => {
                const categoryName = document.querySelector(`#markerCategory option[value="${marker.category}"]`).textContent;
                html += `
                    <div style="padding: 10px; margin-bottom: 8px; background: #f8f9f5; border-radius: 6px; border-left: 3px solid ${categoryColors[marker.category]}; cursor: pointer;"
                         onclick="leafletMap.setView([${marker.lat}, ${marker.lng}], 15);">
                        <div style="font-weight: 600; color: #2d5f4f; margin-bottom: 4px;">
                            ${categoryIcons[marker.category]} ${marker.notes.substring(0, 30)}${marker.notes.length > 30 ? '...' : ''}
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            ${categoryName}${marker.hasAudio ? ' • 🔊 Audio' : ''}
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // IndexedDB functions
        function openSoundscapeDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SoundscapeDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('audioFiles')) {
                        db.createObjectStore('audioFiles', { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveAudioToIndexedDB(markerId, audioBlob) {
            try {
                const db = await openSoundscapeDB();
                const transaction = db.transaction(['audioFiles'], 'readwrite');
                const store = transaction.objectStore('audioFiles');

                await store.put({ id: markerId, audio: audioBlob });
                console.log(`✅ Audio saved for marker ${markerId}`);
            } catch (error) {
                console.error('Error saving audio to IndexedDB:', error);
            }
        }

        async function getAudioFromIndexedDB(markerId) {
            try {
                const db = await openSoundscapeDB();
                const transaction = db.transaction(['audioFiles'], 'readonly');
                const store = transaction.objectStore('audioFiles');

                return new Promise((resolve, reject) => {
                    const request = store.get(markerId);
                    request.onsuccess = () => resolve(request.result ? request.result.audio : null);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('Error getting audio from IndexedDB:', error);
                return null;
            }
        }

        async function deleteAudioFromIndexedDB(markerId) {
            try {
                const db = await openSoundscapeDB();
                const transaction = db.transaction(['audioFiles'], 'readwrite');
                const store = transaction.objectStore('audioFiles');

                await store.delete(markerId);
                console.log(`✅ Audio deleted for marker ${markerId}`);
            } catch (error) {
                console.error('Error deleting audio from IndexedDB:', error);
            }
        }

        // LocalStorage functions
        function saveSoundscapeData() {
            try {
                localStorage.setItem('soundscapeMarkers', JSON.stringify(soundscapeData));
                console.log('✅ Markers saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadSoundscapeData() {
            try {
                const saved = localStorage.getItem('soundscapeMarkers');
                if (saved) {
                    soundscapeData = JSON.parse(saved);

                    // Recreate markers on map
                    soundscapeData.forEach(markerData => {
                        const icon = L.divIcon({
                            html: `<div style="font-size: 28px;">${categoryIcons[markerData.category]}</div>`,
                            className: 'custom-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        });

                        const marker = L.marker([markerData.lat, markerData.lng], { icon: icon }).addTo(leafletMap);
                        const popupContent = createPopupContent(markerData);
                        marker.bindPopup(popupContent, { maxWidth: 300 });

                        mapMarkers.push({ marker: marker, data: markerData });
                    });

                    updateMarkersList();
                    console.log(`✅ Loaded ${soundscapeData.length} markers`);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        // ==================== TOOLKIT SECTION ====================

        // Equipment Data
        var equipmentData = {
            recorders: {
                consumer: [
                    {
                        name: 'Zoom H1essential',
                        price: '€80-100',
                        features: ['32-bit float recording standard', 'Compatto e ultraleggero', 'USB-C audio interface', 'Perfetto per principianti'],
                        link: 'https://www.thomann.it/zoom_h1essential.htm'
                    },
                    {
                        name: 'Tascam DR-40X',
                        price: '€140-180',
                        features: ['Dual recording backup', 'USB audio interface', 'XLR/TRS combo inputs', 'Industry standard affidabile'],
                        link: 'https://www.thomann.it/tascam_dr_40x.htm'
                    },
                    {
                        name: 'Zoom H4n Pro',
                        price: '€180-220',
                        features: ['Capsule X/Y ruotabili 120°', '2 input XLR combo', 'Overdubbing multitrack', 'Basso rumore'],
                        link: 'https://www.thomann.it/zoom_h4essential_aph_4e_bundle.htm'
                    },
                    {
                        name: 'Zoom H5',
                        price: '€280-320',
                        features: ['4 tracce simultanee', 'Capsule intercambiabili incluse', 'Phantom power 48V', 'Registrazione fino a 96kHz/24bit'],
                        link: 'https://www.thomann.it/zoom_h5.htm'
                    }
                ],
                professional: [
                    {
                        name: 'Zoom F6',
                        price: '€550-650',
                        features: ['32-bit float 192kHz', 'Dual ADC per ogni canale', 'No gain staging necessario', 'Top qualità/prezzo pro'],
                        link: 'https://www.thomann.it/zoom_f6_case_set.htm',
                        review: 'Il Zoom F6 è il registratore che ha democratizzato il 32-bit float. Il dual ADC system garantisce registrazioni perfette anche in condizioni estreme (concerti, temporali). A questo prezzo, nessun competitor offre questa libertà. Consigliato a tutti i field recordist seri.'
                    },
                    {
                        name: 'Zoom F3',
                        price: '€280-320',
                        features: ['32-bit float 192kHz', 'Ultra-compatto 2 canali', 'Timecode sync', 'Preamp ultra-low noise'],
                        link: 'https://www.thomann.it/zoom_f3.htm',
                        review: 'Il Zoom F3 è una rivoluzione nel field recording compatto. Il 32-bit float elimina completamente il problema del clipping, permettendoti di concentrarti sulla composizione senza preoccuparti dei livelli. Perfetto per chi registra eventi imprevedibili (natura, città). Unico limite: solo 2 canali.'
                    },
                    {
                        name: 'Tascam Portacapture X8',
                        price: '€450-550',
                        features: ['32-bit float/192kHz', '4 capsule intercambiabili', 'Touchscreen intuitivo', 'Audio studio-quality'],
                        link: 'https://www.thomann.it/tascam_portacapture_x8.htm',
                        review: 'Il Portacapture X8 è la scelta perfetta per chi vuole flessibilità. Le 4 capsule intercambiabili (X/Y, A/B, shotgun, ecc.) ti permettono di adattarti a ogni situazione senza portare microfoni esterni. Il touchscreen rende l\'editing sul campo velocissimo. Unico limite: batterie proprietarie.'
                    },
                    {
                        name: 'Sound Devices MixPre-3 II',
                        price: '€650-750',
                        features: ['3 input Kashmir preamps', '32-bit float recording', 'Limitatore trasparente', 'Build quality professionale'],
                        link: 'https://www.thomann.it/sound_devices_mixpre_3_ii.htm',
                        review: 'I preamp Kashmir di Sound Devices sono considerati tra i migliori al mondo. Il MixPre-3 II offre qualità broadcast in un package compatto. Ideale per registrazioni critiche dove la qualità è tutto. Costoso ma vale ogni euro se lavori professionalmente.'
                    },
                    {
                        name: 'Sound Devices MixPre-6 II',
                        price: '€850-1000',
                        features: ['Kashmir preamps leggendari', '32-bit float recording', 'Timecode per sync video', 'Build quality broadcast'],
                        link: 'https://www.thomann.it/sound_devices_mixpre_6_ii.htm',
                        review: 'Sound Devices è sinonimo di broadcast quality. Il MixPre-6 II con i preamp Kashmir offre il suono più trasparente e musicale che puoi ottenere in un field recorder. Timecode, limitatori trasparenti, build indistruttibile. È l\'investimento definitivo se lavori su documentari o produzioni audio professionali.'
                    }
                ]
            },
            microphones: {
                consumer: [
                    {
                        name: 'Rode VideoMic NTG',
                        price: '€220-280',
                        features: ['Shotgun broadcast-quality', 'Batteria ricaricabile USB-C', 'Gain infinito digitale', 'Safety channel -20dB'],
                        link: 'https://www.thomann.it/rode_videomic_ntg.htm'
                    },
                    {
                        name: 'Sennheiser MKE 600',
                        price: '€280-350',
                        features: ['Short shotgun versatile', 'Phantom o batteria', 'Industria-standard', 'Low self-noise'],
                        link: 'https://www.thomann.it/sennheiser_mke_600.htm'
                    },
                    {
                        name: 'Rode NT5 Matched Pair',
                        price: '€350-420',
                        features: ['Small diaphragm condenser', 'Stereo pair matched', 'Cardioide precision', 'Eccellente per ambience'],
                        link: 'https://www.thomann.it/rode_nt5_stativ_bundle.htm'
                    }
                ],
                professional: [
                    {
                        name: 'Sennheiser MKH 416',
                        price: '€850-1100',
                        features: ['Industry-standard shotgun', 'RF condenser (anti-umidità)', 'Broadcast quality', 'Direzionalità top'],
                        link: 'https://www.thomann.it/sennheiser_mkh416p48u3.htm',
                        review: 'Il MKH 416 è il shotgun più usato nel cinema e broadcast mondiale. RF condenser (immune a umidità), direzionalità chirurgica, suono neutro e dettagliato. Dopo 40+ anni è ancora lo standard. Costoso, ma se registri voci o soundscape urbani, non ha rivali. Un acquisto per la vita.'
                    },
                    {
                        name: 'Rode NTG5',
                        price: '€450-550',
                        features: ['Super-leggero 76g', 'RF-bias technology', 'Suono trasparente', 'Best value pro shotgun'],
                        link: 'https://www.thomann.it/rode_ntg5_kit.htm',
                        review: 'Il Rode NTG5 è il miglior rapporto qualità/prezzo tra gli shotgun professionali. Pesa solo 76g (perfetto per aste lunghe), suono cristallino grazie alla RF-bias technology, e costa la metà di un MKH 416. Se il tuo budget non arriva a Sennheiser, il NTG5 è la scelta ovvia.'
                    },
                    {
                        name: 'Audio-Technica AT875R',
                        price: '€150-180',
                        features: ['Short shotgun budget', 'Line/mic switch', 'Batteria AAA', 'Ottimo rapporto qualità/prezzo'],
                        link: 'https://www.thomann.it/audio_technica_at_875_r.htm',
                        review: 'Il microfono "entry-level professional" per eccellenza. Non ha la raffinatezza di un MKH 416, ma a 1/5 del prezzo offre prestazioni sorprendenti. Perfetto per chi vuole iniziare con shotgun professionali senza spendere €1000. Consigliato come backup anche per i pro.'
                    },
                    {
                        name: 'DPA 4060',
                        price: '€700-800',
                        features: ['Omnidirezionale miniatura', 'Self-noise 23dB-A', 'Montaggio discreto', 'SPL 134dB'],
                        link: 'https://www.thomann.it/dpa_4060_oc_c_f03.htm',
                        review: 'I DPA 4060 sono i lavalier preferiti dai field recordist professionisti. Omnidirezionali con risposta in frequenza lineare, si "nascondono" ovunque (alberi, muri, abbigliamento) catturando l\'ambiente naturale senza colorazione. Costosi ma insostituibili per tecniche creative.'
                    },
                    {
                        name: 'Sennheiser MKH 8070',
                        price: '€1400-1700',
                        features: ['Long shotgun premium', 'Self-noise solo 8dB', 'Moisture-resistant', 'Rifiuto laterale 38dB'],
                        link: 'https://www.thomann.it/sennheiser_mkh_8070.htm',
                        review: 'Il MKH 8070 è un long shotgun da €1500+ per una ragione: isolamento laterale incredibile (38dB di reiezione) e rumore proprio di soli 8dB. Usato per wildlife recording a distanza e produzioni cinematografiche. Se devi catturare suoni specifici in ambienti rumorosi, è insuperabile. Ma è un tool specializzato, non versatile.'
                    }
                ]
            },
            windscreens: {
                consumer: [
                    {
                        name: 'Rode DeadCat VMPR',
                        price: '€30-40',
                        features: ['Furry windshield efficace', 'Fit VideoMic Pro/NTG', 'Riduzione vento 20dB', 'Qualità Rode'],
                        link: 'https://www.thomann.it/rode_deadcat_vmpr.htm'
                    },
                    {
                        name: 'Rycote Mini Windjammer',
                        price: '€40-50',
                        features: ['Per recorder portatili', 'Fit Zoom H1n/H4n/H5/H6', 'Pelo high-quality', 'Elastic mount sicuro'],
                        link: 'https://www.thomann.it/rycote_mini_wind_screen_for_zoom_h5.htm'
                    },
                    {
                        name: 'Rode DeadCat GO',
                        price: '€20-30',
                        features: ['Per VideoMic GO/ME', 'Budget-friendly', 'Protezione vento efficace', 'Compatto'],
                        link: 'https://www.thomann.it/rode_deadcat_go.htm'
                    }
                ],
                professional: [
                    {
                        name: 'Rycote Super-Softie',
                        price: '€90-120',
                        features: ['Windshield slip-on premium', 'Per shotgun fino 24cm', 'Riduzione vento fino 30dB', 'Mounting clips inclusi'],
                        link: 'https://www.thomann.it/rycote_super_softie_windshield_18cm.htm'
                    },
                    {
                        name: 'Rode Blimp MKII',
                        price: '€330-400',
                        features: ['Sistema completo windshield', 'Rycote Lyre shock mount', 'Fit shotgun fino 325mm', 'Dead Wombat incluso'],
                        link: 'https://www.thomann.it/rode_blimp_mkii.htm'
                    },
                    {
                        name: 'Rycote Nano-Shield Kit NS4-DB',
                        price: '€400-500',
                        features: ['Sistema professionale completo', 'Lyre suspension mount', 'Windjammer furry incluso', 'Standard broadcast'],
                        link: 'https://www.thomann.it/rycote_nano_shield_kit_ns4_db.htm'
                    }
                ]
            },
            stands: {
                consumer: [
                    {
                        name: 'K&M 210/2 Microphone Stand',
                        price: '€25-35',
                        features: ['Telescopica 900-1600mm', 'Base tripod stabile', 'Boom arm incluso', 'K&M qualità tedesca'],
                        link: 'https://www.thomann.it/km_210_2_mikrofonstativ.htm'
                    },
                    {
                        name: 'K&M 23325 Table Stand',
                        price: '€35-45',
                        features: ['Base ghisa pesante', 'Altezza 217-347mm', 'Perfetto per desk recording', 'Super stabile'],
                        link: 'https://www.thomann.it/km_23325_table_microphone_stand.htm'
                    },
                    {
                        name: 'K&M 23150 Table Stand',
                        price: '€15-25',
                        features: ['Mini stand da tavolo', 'Base compatta portatile', 'Altezza regolabile', 'Perfetto per field recording'],
                        link: 'https://www.thomann.it/km_23150.htm'
                    }
                ],
                professional: [
                    {
                        name: 'K&M 259 Low Tripod Boom',
                        price: '€110-150',
                        features: ['Low-profile per ground micing', 'Boom professionale', 'Altezza 530-995mm', 'Stabile e versatile'],
                        link: 'https://www.thomann.it/km_259_mic_stand.htm'
                    },
                    {
                        name: 'K&M 210/9 Studio Boom',
                        price: '€60-80',
                        features: ['Boom lungo professionale', 'Altezza 900-1605mm', 'Base pesante stabile', 'Industry workhorse'],
                        link: 'https://www.thomann.it/km_210_9_mikrofonstativ.htm'
                    },
                    {
                        name: 'K&M 25400 Speaker Stand',
                        price: '€80-110',
                        features: ['Professionale e compatto', 'Altezza 1.2-1.8m', 'Telescopico robusto', 'Carico max 50kg'],
                        link: 'https://www.thomann.it/km_25400.htm'
                    }
                ]
            },
            storage: [
                {
                    name: 'SanDisk Extreme PRO 128GB',
                    price: '€25-35',
                    features: ['Read 200MB/s Write 90MB/s', 'UHS-I U3 V30', 'Affidabilità comprovata', 'Ottima per 96kHz/24bit'],
                    link: 'https://www.amazon.it/dp/B07H48412Q'
                },
                {
                    name: 'Sony SF-G Tough 128GB',
                    price: '€50-70',
                    features: ['Read 300MB/s Write 299MB/s', 'UHS-II velocissima', 'Waterproof dustproof', 'Top per 32-bit float'],
                    link: 'https://www.amazon.it/dp/B07FDTVCVL'
                },
                {
                    name: 'Lexar Professional 256GB',
                    price: '€40-60',
                    features: ['Read 270MB/s Write 150MB/s', 'UHS-II V90', 'Capacità doppia', 'Rapporto qualità/prezzo'],
                    link: 'https://www.amazon.it/dp/B07MG44FDJ'
                },
                {
                    name: 'Samsung PRO Plus 512GB',
                    price: '€60-80',
                    features: ['Enorme capacità 512GB', 'Read 160MB/s Write 120MB/s', 'UHS-I U3', '10 anni garanzia'],
                    link: 'https://www.amazon.it/dp/B09B1HMJ9Z'
                }
            ],
            bags: [
                {
                    name: 'Thomann Recorder Bag Universal',
                    price: '€20-30',
                    features: ['Protezione imbottita', 'Fit Zoom/Tascam portatili', 'Tasche per accessori', 'Budget-friendly'],
                    link: 'https://www.thomann.it/thomann_recorder_bag_universal.htm'
                },
                {
                    name: 'Orca OR-28 Audio Bag',
                    price: '€130-170',
                    features: ['Per recorder compatti', 'Fit MixPre-3/Zoom F3', 'Padding interno regolabile', 'Harness confortevole'],
                    link: 'https://www.thomann.it/orca_or_28.htm'
                },
                {
                    name: 'Zoom PCF-6 Protective Bag',
                    price: '€90-120',
                    features: ['Specifico per Zoom F6', 'Due compartimenti separati', 'Sistema cinghie versatile', 'Ottima protezione'],
                    link: 'https://www.thomann.it/zoom_pcf_6.htm'
                },
                {
                    name: 'Thomann Case Recorder Large',
                    price: '€40-60',
                    features: ['Hard case protettivo', 'Foam customizzabile', 'Waterproof crushproof', 'Ottimo value'],
                    link: 'https://www.thomann.it/thomann_case_recorder_large.htm'
                }
            ],
            smartphones: [
                {
                    name: 'iPhone 15 Pro / Pro Max',
                    price: '€1200-1500',
                    features: ['4 microfoni studio-quality', 'Spatial Audio recording', 'ProRes video audio 48kHz', 'Apps: FiRe, Ferrite, AudioShare']
                },
                {
                    name: 'iPhone 14 Pro',
                    price: '€900-1200',
                    features: ['Ottimo audio array', 'Dolby Atmos recording', 'Riduzione rumore AI', 'Best value iPhone pro']
                },
                {
                    name: 'Samsung Galaxy S24 Ultra',
                    price: '€1200-1400',
                    features: ['3 microfoni AKG-tuned', 'Audio 360° recording', 'Pro video mode con gain', 'Android flagship']
                }
            ],
            software: [
                {
                    name: 'Reaper',
                    price: '€60 (licenza personale)',
                    features: ['DAW completo leggero', 'Editing multitrack illimitato', 'VST/AU support', 'Cross-platform'],
                    link: 'https://www.reaper.fm/purchase.php'
                },
                {
                    name: 'iZotope RX 10 Standard',
                    price: '€350-450',
                    features: ['Noise reduction AI-powered', 'Spectral repair tools', 'Standard audio restoration', 'Standalone o plugin'],
                    link: 'https://www.pluginboutique.com/product/2-Effects/39-FX-Bundle/9222-RX-10-Standard'
                },
                {
                    name: 'Audacity',
                    price: 'Gratis (open source)',
                    features: ['Editor multitrack gratis', 'Analisi spettrale', 'Effetti base inclusi', 'Community enorme'],
                    link: 'https://www.audacityteam.org/download/'
                },
                {
                    name: 'Wavelab Pro 12',
                    price: '€500-600',
                    features: ['Mastering professionale', 'Analisi avanzata', 'Batch processing', 'Metering broadcast'],
                    link: 'https://www.pluginboutique.com/product/2-Effects/41-Mastering/9856-WaveLab-Pro-12'
                },
                {
                    name: 'Max/MSP',
                    price: '€400 (€8/mese studenti)',
                    features: ['Visual programming audio', 'Strumenti custom', 'Real-time processing', 'Community patches'],
                    link: 'https://cycling74.com/products/max'
                }
            ]
        };

        // Reference content};

        // Reference content
        var referenceContent = {
            'polar-patterns': {
                title: '🎙️ Polar Patterns - Diagrammi Polari',
                content: `
                    <h3 style="color: #2d5f4f;">Cosa sono i Polar Patterns?</h3>
                    <p>I <strong>diagrammi polari</strong> mostrano da quale direzione un microfono capta il suono. Ogni pattern è ottimizzato per situazioni diverse nel field recording.</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">🔴 Omnidirezionale</h4>
                            <div style="width: 80px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50%; margin: 10px auto;"></div>
                            <p><strong>Capta:</strong> 360° tutt'attorno</p>
                            <p><strong>Usa per:</strong> Ambience naturale, spazi architettonici, catturare tutto l'ambiente</p>
                            <p><strong>Evita:</strong> Ambienti rumorosi, quando serve isolamento</p>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">❤️ Cardioide</h4>
                            <div style="width: 80px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50% 50% 50% 0; margin: 10px auto; transform: rotate(-135deg);"></div>
                            <p><strong>Capta:</strong> Fronte (90°), rifiuta retro</p>
                            <p><strong>Usa per:</strong> Interviste, voice-over, isolamento sorgente specifica</p>
                            <p><strong>Evita:</strong> Quando serve catturare tutto l'ambiente</p>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">🎯 Shotgun (Lobar)</h4>
                            <div style="width: 100px; height: 60px; border: 3px solid #2d5f4f; border-radius: 0 30px 30px 0; margin: 10px auto;"></div>
                            <p><strong>Capta:</strong> Iper-direzionale (30-40°)</p>
                            <p><strong>Usa per:</strong> Soggetti distanti, wildlife, rifiuto massimo laterale</p>
                            <p><strong>Evita:</strong> Spazi chiusi (riflessi), wide ambience</p>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">∞ Figure-8 (Bidirezionale)</h4>
                            <div style="width: 40px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50%; margin: 10px auto;"></div>
                            <div style="width: 40px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50%; margin: -90px auto 10px; transform: rotate(0deg);"></div>
                            <p><strong>Capta:</strong> Fronte e retro, rifiuta lati</p>
                            <p><strong>Usa per:</strong> Interviste faccia-a-faccia, MS stereo (Mid side), dialoghi</p>
                            <p><strong>Evita:</strong> Ambienti con rumori laterali</p>
                        </div>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 Tips Pratici</h4>
                        <ul>
                            <li><strong>Omnidirezionale:</strong> Perfetto per catturare "room tone" e ambience completa di uno spazio</li>
                            <li><strong>Cardioide:</strong> Il tuttofare - 80% dei field recording usa questo pattern</li>
                            <li><strong>Shotgun:</strong> Indispensabile per wildlife e situazioni dove non puoi avvicinarti</li>
                            <li><strong>Stereo X/Y:</strong> Due cardioidi a 90° = immagine stereo naturale</li>
                            <li><strong>MS (Mid-Side):</strong> Cardioide + Figure-8 = stereo width regolabile in post!</li>
                        </ul>
                    </div>
                `
            },
            'frequency-chart': {
                title: '📊 Frequency Chart - Guida Frequenze Audio',
                content: `
                    <h3 style="color: #2d5f4f;">Spettro Audio 20Hz - 20kHz</h3>
                    <p>Comprendere le frequenze ti aiuta a <strong>identificare suoni</strong>, <strong>scegliere microfoni</strong> e <strong>applicare EQ corretto</strong>.</p>

                    <div class="frequency-bar">
                        <div class="frequency-section" style="background: #1a237e; flex: 1;">
                            <div>SUB BASS<br>20-60 Hz<br><small>Feel fisico</small></div>
                        </div>
                        <div class="frequency-section" style="background: #283593; flex: 1.5;">
                            <div>BASS<br>60-250 Hz<br><small>Fondamentale basso</small></div>
                        </div>
                        <div class="frequency-section" style="background: #303f9f; flex: 2;">
                            <div>LOW MIDS<br>250-500 Hz<br><small>Warmth, body</small></div>
                        </div>
                        <div class="frequency-section" style="background: #3949ab; flex: 2;">
                            <div>MIDS<br>500Hz-2kHz<br><small>Voce, presenza</small></div>
                        </div>
                        <div class="frequency-section" style="background: #1e88e5; flex: 2;">
                            <div>HIGH MIDS<br>2-4 kHz<br><small>Definizione, clarity</small></div>
                        </div>
                        <div class="frequency-section" style="background: #42a5f5; flex: 1.5;">
                            <div>PRESENCE<br>4-6 kHz<br><small>Intelligibilità</small></div>
                        </div>
                        <div class="frequency-section" style="background: #64b5f6; flex: 2;">
                            <div>TREBLE<br>6-12 kHz<br><small>Brillantezza</small></div>
                        </div>
                        <div class="frequency-section" style="background: #90caf9; flex: 1;">
                            <div>AIR<br>12-20 kHz<br><small>Spazio, aria</small></div>
                        </div>
                    </div>

                    <h4 style="color: #2d5f4f; margin-top: 30px;">Esempi Soundscape per Frequenza</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #1a237e;">
                            <strong>20-60 Hz (Sub Bass)</strong><br>
                            Tuono distante, traffic pesante, vento forte, terremoto, onde oceaniche grosse
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #283593;">
                            <strong>60-250 Hz (Bass)</strong><br>
                            Motori, rumble urbano, voce maschile bassa, grancassa, contrabbasso
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #303f9f;">
                            <strong>250-500 Hz (Low Mids)</strong><br>
                            Voce umana fondamentale, chitarra acustica body, traffic medio, passi su legno
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #3949ab;">
                            <strong>500Hz-2kHz (Mids)</strong><br>
                            Parlato (intelligibilità), piano, la maggior parte strumenti, porte che sbattono
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #1e88e5;">
                            <strong>2-4 kHz (High Mids)</strong><br>
                            Dettaglio voce, clash piatti, sibilanti, campanelli, clacson auto
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #42a5f5;">
                            <strong>4-6 kHz (Presence)</strong><br>
                            Uccellini, fruscii foglie, hi-hat, sibilanti forti, grilli
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #64b5f6;">
                            <strong>6-12 kHz (Treble)</strong><br>
                            Cinguettii acuti, cicale, wind chimes, shimmer piatti, fruscio vento
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #90caf9;">
                            <strong>12-20 kHz (Air)</strong><br>
                            Spazialità, riverbero naturale, armonici estremi, "aria" della registrazione
                        </div>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 Come Usare Questa Guida</h4>
                        <ul>
                            <li><strong>Scelta Microfono:</strong> Se registri uccellini (4-12kHz), serve un mic con risposta extended high freq</li>
                            <li><strong>EQ in Post:</strong> Rumble traffic (60-250Hz)? High-pass filter a 80-100Hz</li>
                            <li><strong>Identificazione:</strong> Analizza con spettrogramma per "vedere" dove vive il suono</li>
                            <li><strong>Mixing:</strong> Ogni elemento soundscape occupa uno spazio - evita sovrapposizioni</li>
                        </ul>
                    </div>
                `
            },
            'eq-settings': {
                title: '🎚️ EQ Settings - Equalizzazione per Ambienti',
                content: `
                    <h3 style="color: #2d5f4f;">EQ Strategies per Field Recording</h3>
                    <p>L'equalizzazione ti permette di <strong>pulire rumori indesiderati</strong> e <strong>enfatizzare elementi chiave</strong> del tuo soundscape.</p>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">Preset EQ per Ambiente</h4>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🌳 Natura / Foresta</h4>
                        <p><strong>Obiettivo:</strong> Preservare dettaglio naturale, rimuovere wind rumble</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 80Hz (-12dB/oct):</strong> Rimuove vento basso e rumble</li>
                            <li><strong>+2dB @ 5-8kHz (shelf):</strong> Esalta uccellini e fruscio foglie</li>
                            <li><strong>-1dB @ 200-400Hz (wide Q):</strong> Riduce mud se presente</li>
                            <li><strong>Tip:</strong> Mantieni dynamic range naturale - non comprimere troppo!</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🏙️ Urbano / Città</h4>
                        <p><strong>Obiettivo:</strong> Bilanciare traffic rumble con dettagli umani</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 60-100Hz:</strong> Controlla sub bass motori (attenzione a non tagliare troppo!)</li>
                            <li><strong>-3dB @ 150-250Hz (narrow Q):</strong> Taglia resonance traffic fastidiosa</li>
                            <li><strong>+1-2dB @ 2-4kHz:</strong> Porta avanti voci e dettagli umani</li>
                            <li><strong>Tip:</strong> Il rumble urbano è parte del paesaggio - non eliminarlo completamente!</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🌊 Acqua / Oceano</h4>
                        <p><strong>Obiettivo:</strong> Catturare movimento acqua senza harshness</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 40Hz:</strong> Mantieni sub bass onde grosse</li>
                            <li><strong>+1-2dB @ 8-12kHz (shelf):</strong> Esalta dettaglio spray e schiuma</li>
                            <li><strong>-2dB @ 3-4kHz (se harsh):</strong> Ammorbidisce splash aggressivi</li>
                            <li><strong>Tip:</strong> Onde hanno molto low-end - registra con headroom!</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🏛️ Interni / Architettura</h4>
                        <p><strong>Obiettivo:</strong> Controllare riverbero, preservare spazialità</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 100Hz:</strong> Rimuove room rumble e HVAC</li>
                            <li><strong>-2-3dB @ 200-500Hz (wide Q):</strong> Riduce boominess dello spazio</li>
                            <li><strong>+1dB @ 10-15kHz:</strong> Recupera air e dimensione</li>
                            <li><strong>Tip:</strong> Usa de-reverb (iZotope RX) se troppo riflessivo</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🎤 Voce / Intervista</h4>
                        <p><strong>Obiettivo:</strong> Massima intelligibilità e naturalezza</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 80-120Hz:</strong> Elimina proximity effect e plosive</li>
                            <li><strong>+2-3dB @ 3-5kHz (presence peak):</strong> Aumenta chiarezza e intelligibilità</li>
                            <li><strong>-2dB @ 200-300Hz (se voce maschile):</strong> Riduce muddiness</li>
                            <li><strong>De-esser @ 6-8kHz:</strong> Controlla sibilanti (non EQ - dynamics!)</li>
                        </ul>
                    </div>

                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800;">
                        <h4 style="color: #e65100;">⚠️ Regole d'Oro EQ</h4>
                        <ol>
                            <li><strong>Sottrai prima di aggiungere:</strong> Cut elimina problemi, boost introduce artefatti</li>
                            <li><strong>High-pass sempre:</strong> Frequenze sotto 40Hz sono quasi sempre inutili e mangiano headroom</li>
                            <li><strong>Wide Q per musicali, Narrow Q per problemi:</strong> Broad boost suona naturale, narrow cut risolve risonanze</li>
                            <li><strong>A/B costantemente:</strong> Le orecchie si abituano - compara sempre con originale</li>
                            <li><strong>Less is more:</strong> Se hai bisogno di +10dB, probabilmente hai il mic sbagliato o posizionato male</li>
                            <li><strong>Context matters:</strong> EQ per headphones ≠ EQ per speakers ≠ EQ per installazione</li>
                        </ol>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 Tools Consigliati</h4>
                        <ul>
                            <li><strong>FabFilter Pro-Q 3:</strong> EQ chirurgico con analyzer spettrale in tempo reale</li>
                            <li><strong>Voxengo SPAN:</strong> Spectral analyzer gratuito per identificare problemi</li>
                            <li><strong>iZotope Ozone EQ:</strong> AI-assisted EQ matching (copia il tone di riferimento)</li>
                            <li><strong>Waves Renaissance EQ:</strong> Musicale e vintage-sounding per materiale organico</li>
                        </ul>
                    </div>
                `
            },
            'sample-rate': {
                title: '💿 Sample Rate & Bit Depth - Guida Formati Audio',
                content: `
                    <h3 style="color: #2d5f4f;">Sample Rate e Bit Depth Spiegati</h3>
                    <p>Scegliere il formato giusto significa bilanciare <strong>qualità audio</strong>, <strong>dimensione file</strong> e <strong>compatibilità</strong>.</p>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">📊 Sample Rate (Frequenza di Campionamento)</h4>
                    <p>Quanti "snapshot" del segnale audio vengono catturati al secondo. Più alto = più dettaglio frequenze alte.</p>

                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background: #2d5f4f; color: white;">
                            <th style="padding: 10px; text-align: left;">Sample Rate</th>
                            <th style="padding: 10px; text-align: left;">Freq Max</th>
                            <th style="padding: 10px; text-align: left;">Usa Per</th>
                            <th style="padding: 10px; text-align: left;">Note</th>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>44.1 kHz</strong></td>
                            <td style="padding: 10px;">22.05 kHz</td>
                            <td style="padding: 10px;">CD, streaming, podcasts</td>
                            <td style="padding: 10px;">Standard consumer. Più che sufficiente per 99% ascolto umano (20Hz-20kHz)</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;"><strong>48 kHz</strong></td>
                            <td style="padding: 10px;">24 kHz</td>
                            <td style="padding: 10px;">Video, TV, film, game audio</td>
                            <td style="padding: 10px;">Standard industria video. Sync perfetto con frame rate</td>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>96 kHz</strong></td>
                            <td style="padding: 10px;">48 kHz</td>
                            <td style="padding: 10px;">Field recording pro, sound design</td>
                            <td style="padding: 10px;">Ottimo per pitch-shifting/time-stretching. Cattura ultrasonici (utile per rallentare)</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;"><strong>192 kHz</strong></td>
                            <td style="padding: 10px;">96 kHz</td>
                            <td style="padding: 10px;">Extreme sound design, archival</td>
                            <td style="padding: 10px;">File enormi. Solo per manipolazioni estreme o archive masterizzazione</td>
                        </tr>
                    </table>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">🎚️ Bit Depth (Profondità di Bit)</h4>
                    <p>Quanti "livelli" di volume possono essere rappresentati. Più alto = più dynamic range e meno noise floor.</p>

                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background: #2d5f4f; color: white;">
                            <th style="padding: 10px; text-align: left;">Bit Depth</th>
                            <th style="padding: 10px; text-align: left;">Dynamic Range</th>
                            <th style="padding: 10px; text-align: left;">Usa Per</th>
                            <th style="padding: 10px; text-align: left;">Note</th>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>16-bit</strong></td>
                            <td style="padding: 10px;">~96 dB</td>
                            <td style="padding: 10px;">CD, delivery finale</td>
                            <td style="padding: 10px;">Mai registrare in 16-bit! Solo per export finale</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;"><strong>24-bit</strong></td>
                            <td style="padding: 10px;">~144 dB</td>
                            <td style="padding: 10px;">Field recording, studio tracking</td>
                            <td style="padding: 10px;">Standard professionale. Headroom enorme = meno rischio clipping</td>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>32-bit float</strong></td>
                            <td style="padding: 10px;">~1500 dB (!)</td>
                            <td style="padding: 10px;">Field recording unpredictable</td>
                            <td style="padding: 10px;">🚀 Impossibile clippare! Puoi recuperare tutto in post. Game changer!</td>
                        </tr>
                    </table>

                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;">
                        <h4 style="color: #1565c0;">🚀 32-bit Float - Perché è Rivoluzionario</h4>
                        <p>I recorder moderni (Sound Devices MixPre, Zoom F6) registrano in <strong>32-bit float</strong>:</p>
                        <ul>
                            <li>✅ <strong>No gain staging:</strong> Non serve impostare livelli prima - puoi farlo tutto in post!</li>
                            <li>✅ <strong>No clipping:</strong> Anche se registri "in the red", l'audio oltre 0dB è recuperabile</li>
                            <li>✅ <strong>Situazioni unpredictable:</strong> Thunderstorm, proteste, wildlife - catturi tutto dal sussurro all'esplosione</li>
                            <li>✅ <strong>Dual ADC:</strong> Registra 2 conversioni simultane (una hot, una safe) - scegli dopo quale usare</li>
                        </ul>
                        <p><strong>Svantaggio:</strong> File 2x più grandi del 24-bit (ma storage è cheap, audio rovinato no!)</p>
                    </div>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">🎯 Raccomandazioni per Soundscape</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <h4 style="color: #2d5f4f;">✅ Setup Consigliato</h4>
                            <p><strong>Registrazione:</strong></p>
                            <ul>
                                <li>96kHz / 24-bit (o 32-bit float se disponibile)</li>
                                <li>WAV uncompressed</li>
                                <li>Mono o stereo (no MP3 mai!)</li>
                            </ul>
                            <p><strong>Delivery Finale:</strong></p>
                            <ul>
                                <li>48kHz / 24-bit per installazioni</li>
                                <li>44.1kHz / 16-bit per streaming</li>
                            </ul>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <h4 style="color: #2d5f4f;">⚡ Best Practice</h4>
                            <ul>
                                <li><strong>96kHz se:</strong> Farai pitch/time manipulation, o vuoi catturare ultrasonici (bat calls, insetti)</li>
                                <li><strong>48kHz se:</strong> Per video sync o archiving standard</li>
                                <li><strong>32-bit float se:</strong> Situazioni imprevedibili (thunderstorms, crowds, wildlife)</li>
                                <li><strong>24-bit se:</strong> Setup controllato, gain staging attento</li>
                            </ul>
                        </div>
                    </div>

                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800;">
                        <h4 style="color: #e65100;">⚠️ Miti da Sfatare</h4>
                        <ul>
                            <li>❌ <strong>"192kHz suona meglio":</strong> No. L'orecchio umano arriva a ~20kHz. 192kHz serve solo per extreme processing</li>
                            <li>❌ <strong>"Più alto è meglio sempre":</strong> No. 192kHz = file 4x più grandi, più CPU, più problemi. Usa solo se necessario</li>
                            <li>❌ <strong>"MP3 320kbps è uguale a WAV":</strong> No! Mai registrare in lossy. Sempre WAV o FLAC</li>
                            <li>✅ <strong>"48kHz/24bit è il sweet spot pro":</strong> Sì! Qualità eccellente, file ragionevoli, compatibilità totale</li>
                        </ul>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 File Size Reference (1 minuto stereo)</h4>
                        <ul>
                            <li>44.1kHz / 16-bit: ~10 MB</li>
                            <li>48kHz / 24-bit: ~17 MB</li>
                            <li>96kHz / 24-bit: ~34 MB</li>
                            <li>96kHz / 32-bit float: ~46 MB</li>
                            <li>192kHz / 24-bit: ~69 MB (!)</li>
                        </ul>
                        <p><strong>Tip:</strong> Un field recording day (4 ore @ 96/24) = circa 8GB. Porta HD esterni!</p>
                    </div>
                `
            }
        };

        // Show Reference Modal
        window.showReferenceModal = function(type) {
            var modal = document.getElementById('referenceModal');
            var content = document.getElementById('referenceContent');
            var data = referenceContent[type];

            if (data) {
                content.innerHTML = `
                    <h2 style="color: #2d5f4f; margin-bottom: 20px;">${data.title}</h2>
                    ${data.content}
                `;
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        };

        // Close Reference Modal
        window.closeReferenceModal = function() {
            var modal = document.getElementById('referenceModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Show Equipment Tab
        window.showEquipmentTab = function(category) {
            // Update active button
            var buttons = document.querySelectorAll('[data-equipment]');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.querySelector('[data-equipment="' + category + '"]').classList.add('active');

            // Render content
            var contentDiv = document.getElementById('equipment-content');
            var html = '';

            if (category === 'recorders' || category === 'microphones' || category === 'windscreens' || category === 'stands') {
                var data = equipmentData[category];

                html += '<h4 style="color: #2d5f4f; margin: 20px 0 15px 0;">💚 Consumer / Enthusiast</h4>';
                html += '<div class="equipment-grid">';
                data.consumer.forEach(function(item) {
                    html += `
                        <div class="equipment-card">
                            <span class="category-badge">CONSUMER</span>
                            <h4>${item.name}</h4>
                            <div class="price">${item.price}</div>
                            <ul>
                                ${item.features.map(f => '<li>' + f + '</li>').join('')}
                            </ul>
                            ${item.link ? `<a href="${item.link}" target="_blank" rel="noopener" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #2d5f4f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">🛒 Acquista</a>` : ''}
                        </div>
                    `;
                });
                html += '</div>';

                html += '<h4 style="color: #2d5f4f; margin: 30px 0 15px 0;">🔥 Professional</h4>';
                html += '<div class="equipment-grid">';
                data.professional.forEach(function(item) {
                    html += `
                        <div class="equipment-card">
                            <span class="category-badge" style="background: #d32f2f;">PROFESSIONAL</span>
                            <h4>${item.name}</h4>
                            <div class="price">${item.price}</div>
                            ${item.review ? `<div style="background: #fff8f0; padding: 12px; border-left: 3px solid #d32f2f; margin: 10px 0; border-radius: 4px;"><p style="margin: 0; font-size: 13px; color: #555; line-height: 1.6; font-style: italic;">"${item.review}"</p></div>` : ''}
                            <ul>
                                ${item.features.map(f => '<li>' + f + '</li>').join('')}
                            </ul>
                            ${item.link ? `<a href="${item.link}" target="_blank" rel="noopener" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #d32f2f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">🛒 Acquista</a>` : ''}
                        </div>
                    `;
                });
                html += '</div>';

            } else if (category === 'smartphones' || category === 'software' || category === 'storage' || category === 'bags') {
                var data = equipmentData[category];
                html += '<div class="equipment-grid">';
                data.forEach(function(item) {
                    html += `
                        <div class="equipment-card">
                            <h4>${item.name}</h4>
                            <div class="price">${item.price}</div>
                            <ul>
                                ${item.features.map(f => '<li>' + f + '</li>').join('')}
                            </ul>
                            ${item.link ? `<a href="${item.link}" target="_blank" rel="noopener" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #2d5f4f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">${category === 'software' ? '💻 Visita' : '🛒 Acquista'}</a>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            contentDiv.innerHTML = html;
        };

        // Initialize equipment tab - call this when toolkit section is shown
        var toolkitInitialized = false;

        window.initializeToolkit = function() {
            if (!toolkitInitialized && document.getElementById('equipment-content')) {
                showEquipmentTab('recorders');
                toolkitInitialized = true;
            }
        };

        // ==================== LIBRARY SECTION ====================

        var libraryData = {
            books: [
                {
                    title: 'The Soundscape: Our Sonic Environment and the Tuning of the World',
                    author: 'R. Murray Schafer',
                    category: 'FONDAMENTALE',
                    description: 'Il testo fondamentale che ha definito il campo dell\'acoustic ecology. Schafer introduce concetti chiave come soundmark, keynote sounds, e schizofonia. Lettura obbligatoria per chiunque lavori con soundscape.',
                    link: 'https://www.amazon.com/Soundscape-Our-Sonic-Environment-Tuning/dp/0892814551?tag=soundscapestu-21'
                },
                {
                    title: 'Sonic Experience: A Guide to Everyday Sounds',
                    author: 'Jean-François Augoyard & Henry Torgue',
                    category: 'FONDAMENTALE',
                    description: 'Un compendio di 82 "effetti sonori" che strutturano la nostra esperienza quotidiana del suono. Approccio fenomenologico indispensabile per sound designers e ricercatori.',
                    link: 'https://www.amazon.com/Sonic-Experience-Guide-Everyday-Sounds/dp/0773532447?tag=soundscapestu-21'
                },
                {
                    title: 'The Great Animal Orchestra: Finding the Origins of Music in the Wild',
                    author: 'Bernie Krause',
                    category: 'ECOLOGIA ACUSTICA',
                    description: 'Il pioniere della bioacustica esplora come gli animali hanno creato la "prima orchestra" del pianeta. Include spettrogrammi e analisi di soundscape naturali da tutto il mondo.',
                    link: 'https://www.amazon.com/Great-Animal-Orchestra-Finding-Origins/dp/031608686X?tag=soundscapestu-21'
                },
                {
                    title: 'Listening to Noise and Silence',
                    author: 'Salomé Voegelin',
                    category: 'FILOSOFIA',
                    description: 'Approccio fenomenologico all\'ascolto sonoro. Esplora come ascoltare attivamente trasforma la percezione dello spazio e del tempo.',
                    link: 'https://www.amazon.com/Listening-Noise-Silence-Towards-Philosophy/dp/1441162070?tag=soundscapestu-21'
                },
                {
                    title: 'Ocean of Sound: Aether Talk, Ambient Sound',
                    author: 'David Toop',
                    category: 'STORIA',
                    description: 'Storia culturale della musica ambient e soundscape dal 1889 ad oggi. Connette Debussy, Cage, Brian Eno, e l\'electronic music in una narrativa affascinante.',
                    link: 'https://www.amazon.com/Ocean-Sound-Aether-Talk-Ambient/dp/1852427434?tag=soundscapestu-21'
                },
                {
                    title: 'Handbook for Acoustic Ecology',
                    author: 'Barry Truax',
                    category: 'REFERENCE',
                    description: 'Dizionario definitivo dei termini di acoustic ecology. Disponibile gratuitamente online - risorsa indispensabile per comprendere la terminologia del campo.',
                    link: 'https://www.sfu.ca/sonic-studio-webdav/handbook/index.html'
                },
                {
                    title: 'In The Field: The Art of Field Recording',
                    author: 'Cathy Lane & Angus Carlyle',
                    category: 'PRATICA',
                    description: 'Raccolta di interviste con sound artists contemporanei che usano field recording. Copre aspetti tecnici, etici ed estetici della pratica.',
                    link: 'https://www.amazon.com/Field-Art-Recording/dp/0956855962?tag=soundscapestu-21'
                },
                {
                    title: 'Soundscape Ecology: Principles, Patterns, Methods and Applications',
                    author: 'Almo Farina',
                    category: 'SCIENZA',
                    description: 'Approccio scientifico alla soundscape ecology. Include metodologie quantitative per analizzare paesaggi sonori e biodiversità acustica.',
                    link: 'https://www.amazon.com/Soundscape-Ecology-Principles-Patterns-Applications/dp/9401794588?tag=soundscapestu-21'
                },
                {
                    title: 'Deep Listening: A Composer\'s Sound Practice',
                    author: 'Pauline Oliveros',
                    category: 'PRATICA',
                    description: 'Testo fondamentale sull\'ascolto profondo. Esercizi e filosofia per espandere la consapevolezza sonora attraverso la pratica dell\'ascolto attivo.',
                    link: 'https://www.amazon.com/Deep-Listening-Composers-Sound-Practice/dp/0595343643?tag=soundscapestu-21'
                }
            ],
            videos: [
                {
                    title: 'The Voice of Landscape - Bernie Krause TED Talk',
                    author: 'Bernie Krause',
                    category: 'TED TALK',
                    description: 'Il biologo acustico Bernie Krause presenta 45 anni di registrazioni naturali, mostrando come il soundscape naturale si sta drammaticamente deteriorando.',
                    link: 'https://www.youtube.com/watch?v=uTbp0c68FTY'
                },
                {
                    title: 'Giorgio Nottoli - Soundscape e Paesaggio Sonoro',
                    author: 'Giorgio Nottoli',
                    category: 'DOCUMENTARIO',
                    description: 'Documentario e lecture di Giorgio Nottoli sul concetto di soundscape e paesaggio sonoro. Approfondimento sulla ricerca italiana in acoustic ecology e sound studies.',
                    link: 'https://www.youtube.com/watch?v=MqxfMtw6DmM'
                },
                {
                    title: 'Hildegard Westerkamp - Soundwalking',
                    author: 'Hildegard Westerkamp',
                    category: 'ARTICOLO',
                    description: 'La compositrice canadese spiega la pratica del soundwalking e come ascoltare attentamente trasforma la percezione dell\'ambiente. Testo fondamentale dal suo sito ufficiale.',
                    link: 'https://www.hildegardwesterkamp.ca/writings/writingsby/?post_id=13&title=soundwalking'
                },
                {
                    title: 'Chris Watson - Weather Report (Documentary)',
                    author: 'Chris Watson',
                    category: 'DOCUMENTARIO',
                    description: 'Il maestro field recordist della BBC mostra il suo processo creativo registrando ambienti estremi in tutto il mondo.',
                    link: 'https://www.youtube.com/results?search_query=chris+watson+weather+report'
                },
                {
                    title: 'Francisco López - Blind Listening',
                    author: 'Francisco López',
                    category: 'PERFORMANCE',
                    description: 'Performance di ascolto bendato del sound artist spagnolo. Approccio radicale all\'ascolto acusmatico.',
                    link: 'https://www.youtube.com/results?search_query=francisco+lopez+blind+listening'
                },
                {
                    title: 'Sonic Acts - Field Recording Symposium',
                    author: 'Various Artists',
                    category: 'CONFERENZA',
                    description: 'Lectures e performances dal festival olandese Sonic Acts. Include presentazioni di Jana Winderen, Chris Watson, e altri. Video disponibili su YouTube.',
                    link: 'https://sonicacts.com/'
                },
                {
                    title: 'Gordon Hempton - One Square Inch of Silence',
                    author: 'Gordon Hempton',
                    category: 'DOCUMENTARIO',
                    description: 'L\'acoustic ecologist Gordon Hempton presenta la sua missione di preservare luoghi naturali silenziosi negli USA.',
                    link: 'https://www.youtube.com/results?search_query=gordon+hempton+one+square+inch'
                }
            ],
            audio: [
                {
                    title: 'World Soundscape Project Archive',
                    author: 'Simon Fraser University',
                    category: 'ARCHIVIO',
                    description: 'Archivio storico del progetto fondato da Schafer negli anni \'70. Include registrazioni di Vancouver, Europa, e progetti "Five Village Soundscapes".',
                    link: 'https://www.sfu.ca/~truax/wsp.html'
                },
                {
                    title: 'Freesound',
                    author: 'Community-driven',
                    category: 'DATABASE',
                    description: 'Database collaborativo con oltre 500.000 suoni gratuiti sotto licenze Creative Commons. Ottimo per trovare esempi e materiale per composizioni.',
                    link: 'https://freesound.org/'
                },
                {
                    title: 'Cities and Memory',
                    author: 'Stuart Fowkes',
                    category: 'PROGETTO GLOBALE',
                    description: 'Mappa sonora globale con registrazioni field e rielaborazioni artistiche. Oltre 5000 suoni da 100+ paesi.',
                    link: 'https://citiesandmemory.com/'
                },
                {
                    title: 'Touch Radio',
                    author: 'Touch Records',
                    category: 'PODCAST',
                    description: 'Podcast mensile di field recordings e sound art dalla leggendaria label Touch. Artisti: Chris Watson, BJ Nilsen, Philip Jeck.',
                    link: 'https://www.touchradio.org.uk/'
                },
                {
                    title: 'Locus Sonus Soundmap',
                    author: 'Locus Sonus Research Lab',
                    category: 'LIVE STREAMING',
                    description: 'Mappa mondiale di microfoni live streaming. Ascolta suoni in tempo reale da tutto il mondo.',
                    link: 'https://locusonus.org/soundmap/'
                },
                {
                    title: 'Aporee Maps',
                    author: 'Aporee Community',
                    category: 'MAPPA SONORA',
                    description: 'Piattaforma collaborativa per condividere field recordings geo-localizzati. Oltre 20.000 registrazioni.',
                    link: 'https://aporee.org/maps/'
                },
                {
                    title: 'BBC Sound Effects Library',
                    author: 'BBC',
                    category: 'ARCHIVIO',
                    description: 'Oltre 16.000 effetti sonori BBC disponibili per download personale, educativo e di ricerca. Qualità broadcast.',
                    link: 'https://sound-effects.bbcrewind.co.uk/'
                },
                {
                    title: 'Sounding Nature - Cornell Lab',
                    author: 'Cornell Lab of Ornithology',
                    category: 'NATURA',
                    description: 'Archivio Macaulay Library: 1+ milione di registrazioni di uccelli, mammiferi, insetti. Risorsa scientifica fondamentale.',
                    link: 'https://www.macaulaylibrary.org/'
                }
            ],
            papers: [
                {
                    title: 'The Soundscape of Modernity',
                    author: 'Emily Thompson',
                    category: 'LIBRO',
                    description: 'Libro accademico fondamentale sulla trasformazione del paesaggio sonoro americano 1900-1933. Analisi storica dell\'industrializzazione acustica e nascita della modernità sonora.',
                    link: 'https://mitpress.mit.edu/9780262701068/the-soundscape-of-modernity/'
                },
                {
                    title: 'Acoustic Ecology and the World Soundscape Project',
                    author: 'Barry Truax',
                    category: 'ARTICOLO',
                    description: 'Overview storico del World Soundscape Project e dello sviluppo dell\'acoustic ecology come disciplina. Documenti e metodologie del progetto originale.',
                    link: 'https://www.sfu.ca/~truax/wsp.html'
                },
                {
                    title: 'Soundscape Indices for Environmental Monitoring',
                    author: 'Pijanowski et al.',
                    category: 'PAPER SCIENTIFICO',
                    description: 'Metodologie quantitative per misurare biodiversità attraverso soundscape. Include Acoustic Complexity Index (ACI), Acoustic Diversity Index, e altri indici ecologici.',
                    link: 'https://www.sciencedirect.com/science/article/pii/S1470160X11000562'
                },
                {
                    title: 'Acoustic Ecology - Barry Truax Website',
                    author: 'Barry Truax',
                    category: 'RISORSA WEB',
                    description: 'Sito personale di Barry Truax con articoli, composizioni, e documentazione completa sull\'acoustic ecology e il World Soundscape Project.',
                    link: 'https://www.sfu.ca/~truax/'
                },
                {
                    title: 'Hildegard Westerkamp - Compositions & Writings',
                    author: 'Hildegard Westerkamp',
                    category: 'ARCHIVIO ARTISTA',
                    description: 'Sito ufficiale con composizioni soundscape, articoli teorici, e metodologie di soundwalking. Include "Kits Beach Soundscape" e altri lavori fondamentali.',
                    link: 'https://www.hildegardwesterkamp.ca/'
                }
            ],
            resources: [
                {
                    title: 'Simon Fraser University - Acoustic Ecology',
                    author: 'SFU / Barry Truax',
                    category: 'UNIVERSITÀ',
                    description: 'Centro di ricerca originale fondato da Schafer. Accesso a Handbook for Acoustic Ecology, archivi WSP, e software.',
                    link: 'https://www.sfu.ca/~truax/'
                },
                {
                    title: 'gruenrekorder - Label & Publisher',
                    author: 'gruenrekorder',
                    category: 'LABEL',
                    description: 'Label tedesca specializzata in field recording e soundscape composition. Catalogo con oltre 200 release.',
                    link: 'https://gruenrekorder.de/'
                },
                {
                    title: 'Sound Studies Lab',
                    author: 'Humboldt University Berlin',
                    category: 'RICERCA',
                    description: 'Laboratorio di ricerca interdisciplinare su sound studies, acoustic ecology, e sonic knowledge.',
                    link: 'https://www.soundstudieslab.org/'
                },
                {
                    title: 'Sounding Out! - Blog',
                    author: 'Various Contributors',
                    category: 'BLOG',
                    description: 'Blog accademico su sound studies, cultura sonora, e tecnologie audio. Articoli settimanali.',
                    link: 'https://soundstudiesblog.com/'
                },
                {
                    title: 'Sonic Acts',
                    author: 'Festival / Organization',
                    category: 'FESTIVAL',
                    description: 'Festival olandese di art sonora e cultura digitale. Include conferenze, performances, e pubblicazioni.',
                    link: 'https://sonicacts.com/'
                },
                {
                    title: 'CRiSAP - Creative Research into Sound Arts Practice',
                    author: 'University of Arts London',
                    category: 'UNIVERSITÀ',
                    description: 'Centro di ricerca britannico su sound art e acoustic ecology. Master programs, pubblicazioni e symposium. Ha celebrato 20 anni nel 2024.',
                    link: 'https://www.arts.ac.uk/research/research-centres/creative-research-in-sound-arts-practice-crisap'
                },
                {
                    title: 'Phonography Monthly',
                    author: 'Podcast',
                    category: 'PODCAST',
                    description: 'Podcast mensile con un singolo field recording non editato per ogni episodio. Ascolto contemplativo.',
                    link: 'https://phonography.org/'
                },
                {
                    title: 'Wild Sanctuary - Bernie Krause',
                    author: 'Bernie Krause',
                    category: 'ARCHIVIO',
                    description: 'Archivio personale di Bernie Krause con 5000+ ore di registrazioni naturali da 50 anni di carriera.',
                    link: 'https://www.wildsanctuary.com/'
                }
            ]
        };

        // Show Library Tab
        window.showLibraryTab = function(category) {
            // Update active button
            var buttons = document.querySelectorAll('[data-library]');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.querySelector('[data-library="' + category + '"]').classList.add('active');

            // Render content
            var contentDiv = document.getElementById('library-content');
            var data = libraryData[category];
            var html = '';

            data.forEach(function(item) {
                html += `
                    <div class="library-item">
                        <span class="library-category">${item.category}</span>
                        <h4>${item.title}</h4>
                        <div class="author">di ${item.author}</div>
                        <div class="description">${item.description}</div>
                        <a href="${item.link}" target="_blank" class="link-btn">
                            🔗 Apri Risorsa →
                        </a>
                    </div>
                `;
            });

            contentDiv.innerHTML = html;
        };

        // Initialize library
        var libraryInitialized = false;

        // Re-implement initializeLibrary with full functionality
        window.initializeLibrary = function() {
            if (!libraryInitialized && document.getElementById('library-content')) {
                showLibraryTab('books');
                libraryInitialized = true;
            }
        };

    </script>
</body>
</html>
