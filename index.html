<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🎧 Soundscape Studio - Professional Field Recording & Composition</title>

    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Tone.js for high-quality sampled instruments -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- jsPDF for PDF export (Premium feature) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- JSZip for ZIP file creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Lame.js for MP3 encoding (Audio export) -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>

    <!-- EmailJS for contact form -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <!-- Firebase SDK for PWA (Analytics & Crashlytics) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <!-- Firebase Integration Script -->
    <script src="firebase-init.js"></script>

    <!-- Capacitor Core (Native App Framework) -->
    <script src="capacitor.js"></script>

    <!-- IAP Integration (RevenueCat) -->
    <script src="iap-integration.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e8f5f1 0%, #d4f1e8 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d5f4f 0%, #3d7f6f 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f8f9f5;
            color: #2d5f4f;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-button:hover {
            background: #2d5f4f;
            color: white;
        }

        .nav-button.active {
            background: #2d5f4f;
            color: white;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Sections */
        .section {
            display: none;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(45,95,79,0.2);
        }

        .card h3 {
            color: #2d5f4f;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .card input, .card select, .card textarea, .card button {
            max-width: 100%;
            box-sizing: border-box;
        }

        .card-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        /* Premium Banner */
        .premium-banner {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 12px rgba(212,175,55,0.3);
        }

        /* Paywall Modal */
        .paywall-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .paywall-modal.active {
            display: flex;
        }

        .paywall-content {
            background: white;
            padding: 15px;
            border-radius: 16px;
            max-width: 450px;
            max-height: 70vh;
            width: 85%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .paywall-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 50%;
            font-size: 32px;
            cursor: pointer;
            color: #666;
            line-height: 1;
            padding: 5px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
            font-weight: bold;
        }

        .paywall-close:hover {
            background: #d4af37;
            color: white;
            border-color: #d4af37;
            transform: scale(1.1);
        }

        .premium-features {
            list-style: none;
            margin: 20px 0;
        }

        .premium-features li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .premium-features li:last-child {
            border-bottom: none;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5f4f, #8ba888);
            transition: width 0.3s;
        }

        /* Spectrogram Container */
        .spectrogram-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .spectrogram-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .spectrogram-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #f4a261;
            color: white;
        }

        .btn-primary:hover {
            background: #e89b5a;
        }

        .btn-secondary {
            background: #8ba888;
            color: white;
        }

        .btn-secondary:hover {
            background: #7a9777;
        }

        .btn-danger {
            background: #e76f51;
            color: white;
        }

        .btn-danger:hover {
            background: #d66548;
        }

        #spectrogramCanvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            background: #000;
        }

        .spectrogram-info {
            display: flex;
            justify-content: space-between;
            color: #8ba888;
            font-size: 12px;
            margin-top: 10px;
            font-family: monospace;
        }

        /* Exercise Grid */
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .exercise-card {
            position: relative;
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #2d5f4f;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .exercise-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(45,95,79,0.2);
        }

        .exercise-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .cat-ascolto { background: #ffeaa7; color: #2d3436; }
        .cat-registrazione { background: #74b9ff; color: #2d3436; }
        .cat-editing { background: #a29bfe; color: white; }
        .cat-composizione { background: #fd79a8; color: white; }

        .exercise-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d5f4f;
            margin-bottom: 8px;
        }

        .exercise-meta {
            font-size: 13px;
            color: #666;
        }

        /* Toolkit */
        .toolkit-section {
            margin-bottom: 30px;
        }

        .toolkit-section h3 {
            color: #2d5f4f;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .reference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .reference-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .reference-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Reference Modal */
        .reference-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            overflow-y: auto;
        }

        .reference-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            max-width: 800px;
            border-radius: 12px;
            position: relative;
        }

        .reference-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #666;
        }

        .reference-modal-close:hover {
            color: #2d5f4f;
        }

        .frequency-bar {
            display: flex;
            height: 60px;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .frequency-section {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
            padding: 5px;
            position: relative;
        }

        .eq-diagram {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        /* Equipment Cards */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .equipment-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #2d5f4f;
        }

        .equipment-card h4 {
            color: #2d5f4f;
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .equipment-card .price {
            color: #8ba888;
            font-weight: bold;
            font-size: 16px;
            margin: 10px 0;
        }

        .equipment-card .category-badge {
            display: inline-block;
            background: #2d5f4f;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .equipment-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .equipment-card ul li {
            margin: 5px 0;
            font-size: 14px;
            color: #555;
        }

        /* Library Cards */
        .library-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #2d5f4f;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .library-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .library-item h4 {
            color: #2d5f4f;
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .library-item .author {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            font-style: italic;
        }

        .library-item .description {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .library-item .link-btn {
            display: inline-block;
            background: #2d5f4f;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .library-item .link-btn:hover {
            background: #1f4538;
            transform: translateX(3px);
        }

        .library-category {
            display: inline-block;
            background: #e8f5e9;
            color: #2d5f4f;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Audio Upload */
        .upload-area {
            border: 2px dashed #8ba888;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #2d5f4f;
            background: #f8f9f5;
        }

        .upload-area input {
            display: none;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2d5f4f;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #2d5f4f;
            background: #f8f9f5;
        }

        .filter-btn.active {
            border-color: #2d5f4f;
            background: #2d5f4f;
            color: white;
        }

        /* Example Image Cards */
        .example-image-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .example-image-card:hover {
            transform: translateY(-4px);
        }

        .example-image-card canvas {
            transition: border-color 0.3s;
        }

        .example-image-card:hover canvas {
            border-color: #2d5f4f !important;
            box-shadow: 0 4px 8px rgba(45,95,79,0.3);
        }

        /* Footer */
        .section-footer {
            margin-top: 40px;
            padding: 30px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .footer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .footer-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .footer-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .footer-btn.whatsapp:hover {
            background: #1da851;
        }

        .footer-btn.facebook {
            background: #1877F2;
            color: white;
        }

        .footer-btn.facebook:hover {
            background: #145dbf;
        }

        .footer-btn.paypal {
            background: #FFC439;
            color: #003087;
        }

        .footer-btn.paypal:hover {
            background: #e6b033;
        }

        .footer-btn.feedback {
            background: #2d5f4f;
            color: white;
        }

        .footer-btn.feedback:hover {
            background: #1f4538;
        }

        .footer-credits {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .footer-credits strong {
            color: #2d5f4f;
        }

        /* Leaflet Popup Responsive Fix */
        .leaflet-popup-content-wrapper {
            max-width: calc(100vw - 60px) !important;
            box-sizing: border-box !important;
        }

        .leaflet-popup-content {
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            word-wrap: break-word !important;
        }

        .leaflet-container {
            max-width: 100% !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>🎧 Soundscape Studio</h1>
        <p>Professional Field Recording & Composition Toolkit</p>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <button class="nav-button active" onclick="showSection('dashboard')">🏠 Dashboard</button>
        <button class="nav-button" onclick="showSection('exercises')">🔔 Soundscape Exercises</button>
        <button class="nav-button" onclick="showMapSection()">🗺️ Soundscape Map</button>
        <button class="nav-button" onclick="showSection('toolkit')">🔧 Toolkit</button>
        <button class="nav-button" onclick="showSection('library')">📚 Library</button>
        <button class="nav-button" onclick="showSection('export')">📤 Export</button>
        <button class="nav-button" onclick="showSection('about')">ℹ️ About</button>
        <button class="nav-button" onclick="showSection('guide')">📖 Guide</button>
    </div>

    <!-- Container -->
    <div class="container">

        <!-- DASHBOARD SECTION -->
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">👋 Welcome to Your Studio</h2>

            <!-- Premium Banner (FREE VERSION) -->
            <div id="premium-banner" class="premium-banner" style="display: none;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 10px 0; color: #fff;">🔒 Protect Your Work</h3>
                    <p style="margin: 0; opacity: 0.95;">Complete backup, professional export, unlimited markers</p>
                </div>
                <button onclick="showUpgradeModal()" style="padding: 12px 24px; background: white; color: #d4af37; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; white-space: nowrap;">
                    ⬆️ Upgrade
                </button>
            </div>

            <!-- Esercizi Completati -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 15px; text-align: center;">📝 Your Completed Exercises</h3>
                <div id="completedExercisesList" style="max-height: 400px; overflow-y: auto; overflow-x: hidden; width: 100%;">
                    <!-- Verrà popolato dinamicamente -->
                </div>
                <button onclick="showAllCompletedExercises()" style="margin-top: 15px; padding: 10px 20px; background: #2d5f4f; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600;">
                    📋 View All Completed Exercises
                </button>
            </div>

            <!-- Quick Access -->
            <h3 style="margin: 30px 0 15px; color: #2d5f4f;">🚀 Quick Access</h3>
            <div class="dashboard-grid">
                <div class="card" onclick="showSection('exercises')">
                    <div class="card-icon">🎯</div>
                    <h3>Daily Exercises</h3>
                    <p>Guided field recording exercises</p>
                </div>

                <div class="card" onclick="showSection('toolkit')">
                    <div class="card-icon">🔧</div>
                    <h3>Professional Toolkit</h3>
                    <p>Technical guides, reference charts, templates</p>
                </div>

                <div class="card" onclick="showSection('library')">
                    <div class="card-icon">📚</div>
                    <h3>Library</h3>
                    <p>History, theory, articles and resources</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Dai%20un'occhiata%20a%20Soundscape%20Studio!%20Un%20toolkit%20completo%20per%20field%20recording%20e%20composizione%20sonora%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- EXERCISES SECTION -->
        <div id="exercises" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">🔔 Soundscape Exercises</h2>

            <!-- Filters -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="margin-bottom: 15px;">
                    <strong style="color: #2d5f4f;">Filter by Category:</strong>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="filter-btn active" onclick="filterExercises('all')" data-filter="all">
                            All
                        </button>
                        <button class="filter-btn" onclick="filterExercises('ascolto-base')" data-filter="ascolto-base">
                            👂 Basic Listening
                        </button>
                        <button class="filter-btn" onclick="filterExercises('consapevolezza')" data-filter="consapevolezza">
                            🧘 Awareness
                        </button>
                        <button class="filter-btn" onclick="filterExercises('movimento')" data-filter="movimento">
                            🚶 Movement
                        </button>
                        <button class="filter-btn" onclick="filterExercises('analisi')" data-filter="analisi">
                            🔍 Analysis
                        </button>
                        <button class="filter-btn" onclick="filterExercises('registrazione')" data-filter="registrazione">
                            🎚️ Recording
                        </button>
                        <button class="filter-btn" onclick="filterExercises('progetto')" data-filter="progetto">
                            📁 Project
                        </button>
                    </div>
                </div>
            </div>

            <div class="exercise-grid" id="exerciseGrid">
                <!-- Esercizi verranno generati via JavaScript -->
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Dai%20un'occhiata%20a%20Soundscape%20Studio!%20Un%20toolkit%20completo%20per%20field%20recording%20e%20composizione%20sonora%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- TOOLKIT SECTION -->
        <div id="toolkit" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">🔧 Professional Toolkit</h2>

            <!-- Reference Guides - Cliccabili -->
            <div class="toolkit-section">
                <h3>📐 Reference Guides</h3>
                <div class="reference-grid">
                    <div class="reference-item" onclick="showReferenceModal('polar-patterns')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">🎙️</div>
                        <strong>Polar Patterns</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Polar pattern guide</p>
                    </div>
                    <div class="reference-item" onclick="showReferenceModal('frequency-chart')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">📊</div>
                        <strong>Frequency Chart</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Frequency ranges</p>
                    </div>
                    <div class="reference-item" onclick="showReferenceModal('eq-settings')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">🎚️</div>
                        <strong>EQ Settings</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">EQ for environments</p>
                    </div>
                    <div class="reference-item" onclick="showReferenceModal('sample-rate')" style="cursor: pointer;">
                        <div style="font-size: 30px; margin-bottom: 10px;">💿</div>
                        <strong>Sample Rate</strong>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Audio format guide</p>
                    </div>
                </div>
            </div>

            <!-- Equipment Tabs -->
            <div class="toolkit-section" style="margin-top: 30px;">
                <h3>🎙️ Recommended Equipment</h3>

                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="filter-btn active" onclick="showEquipmentTab('recorders')" data-equipment="recorders">
                        🎙️ Field Recorders
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('microphones')" data-equipment="microphones">
                        🎤 Microphones
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('windscreens')" data-equipment="windscreens">
                        🌬️ Windscreens
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('stands')" data-equipment="stands">
                        🎚️ Stands
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('storage')" data-equipment="storage">
                        💾 Memory Card
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('bags')" data-equipment="bags">
                        🎒 Bags
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('smartphones')" data-equipment="smartphones">
                        📱 Smartphone
                    </button>
                    <button class="filter-btn" onclick="showEquipmentTab('software')" data-equipment="software">
                        💻 Software
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="equipment-content">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Dai%20un'occhiata%20a%20Soundscape%20Studio!%20Un%20toolkit%20completo%20per%20field%20recording%20e%20composizione%20sonora%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- LIBRARY SECTION -->
        <div id="library" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">📚 Library Soundscape</h2>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="filter-btn active" onclick="showLibraryTab('books')" data-library="books">
                    📕 Essential Books
                </button>
                <button class="filter-btn" onclick="showLibraryTab('videos')" data-library="videos">
                    🎬 Videos & Documentaries
                </button>
                <button class="filter-btn" onclick="showLibraryTab('audio')" data-library="audio">
                    🎧 Audio Examples
                </button>
                <button class="filter-btn" onclick="showLibraryTab('papers')" data-library="papers">
                    📄 Papers & Articles
                </button>
                <button class="filter-btn" onclick="showLibraryTab('resources')" data-library="resources">
                    🔗 Online Resources
                </button>
            </div>

            <!-- Tab Content -->
            <div id="library-content">
                <!-- Content will be loaded by JavaScript -->
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Dai%20un'occhiata%20a%20Soundscape%20Studio!%20Un%20toolkit%20completo%20per%20field%20recording%20e%20composizione%20sonora%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- EXPORT SECTION -->
        <div id="export" class="section">
            <h2 style="margin-bottom: 30px; color: #2d5f4f; text-align: center;">📤 Export & Backup</h2>

            <!-- Main Export Card -->
            <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #d4af37;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <h3 style="color: #d4af37; margin-bottom: 15px; font-size: 24px;">💾 Professional Backup & Export</h3>
                    <p style="color: #666; font-size: 16px; line-height: 1.6;">
                        Protect your work and share your results in professional formats.<br>
                        All export features are <strong style="color: #d4af37;">Premium ⭐</strong>
                    </p>
                </div>

                <!-- Complete Backup -->
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #2d5f4f; font-size: 16px; margin-bottom: 12px; font-weight: 600; border-bottom: 2px solid #d4af37; padding-bottom: 8px;">🔒 Complete Backup & Restore</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
                        Save your ENTIRE Soundscape archive (exercises, audio, photos, markers) in a single JSON file.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button onclick="exportCompleteBackup()" style="padding: 12px 18px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(212,175,55,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(212,175,55,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(212,175,55,0.3)'">
                            💾 Complete Backup ⭐
                        </button>
                        <button onclick="importCompleteBackup()" style="padding: 12px 18px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(212,175,55,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(212,175,55,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(212,175,55,0.3)'">
                            📥 Restore Backup ⭐
                        </button>
                    </div>
                </div>

                <!-- Export Exercises -->
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #2d5f4f; font-size: 16px; margin-bottom: 12px; font-weight: 600; border-bottom: 2px solid #d4af37; padding-bottom: 8px;">📝 Export Exercise Database</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
                        Export all your completed exercises in universal formats for analysis and sharing.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button onclick="exportToExcel()" style="padding: 12px 18px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(212,175,55,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(212,175,55,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(212,175,55,0.3)'">
                            📊 Excel (.xlsx) ⭐
                        </button>
                        <button onclick="exportToWord()" style="padding: 12px 18px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(212,175,55,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(212,175,55,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(212,175,55,0.3)'">
                            📝 Word Report (.doc) ⭐
                        </button>
                    </div>
                </div>

                <!-- Advanced Export (Collapsible) -->
                <div style="margin-bottom: 25px; border: 2px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                    <button id="advancedExportToggle" onclick="toggleAdvancedExport()" style="width: 100%; padding: 15px; background: #f8f9fa; border: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s;">
                        <span style="color: #2d5f4f; font-size: 16px; font-weight: 600;">
                            🔧 Advanced Export (GIS / Research)
                        </span>
                        <span id="advancedExportArrow" style="color: #2d5f4f; font-size: 20px; transition: transform 0.3s;">▼</span>
                    </button>

                    <div id="advancedExportContent" style="display: none; padding: 20px; background: white;">
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                            <strong>⚠️ Note:</strong> These formats are designed for advanced users working with GIS software, scientific research, or geospatial analysis.
                            If you just want to save your data, use <strong>Complete Backup</strong> (already contains all markers).
                        </p>

                        <!-- KML Export with guide -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="color: #2d5f4f; margin: 0 0 10px 0; font-size: 15px;">🗺️ KML (Keyhole Markup Language)</h5>
                            <p style="font-size: 13px; color: #666; margin-bottom: 10px; line-height: 1.5;">
                                <strong>What it is:</strong> Format for visualizing geographic points on 3D maps<br>
                                <strong>Opens with:</strong> Google Earth, Google Maps<br>
                                <strong>Typical use:</strong> Geographic visualization, interactive maps, visual documentation<br>
                                <strong>For whom:</strong> Sound artists, documentarians, field researchers
                            </p>
                            <button onclick="exportToKML()" style="padding: 10px 16px; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                📥 Export KML
                            </button>
                        </div>

                        <!-- GeoJSON Export with guide -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="color: #2d5f4f; margin: 0 0 10px 0; font-size: 15px;">📄 GeoJSON (Geographic JSON)</h5>
                            <p style="font-size: 13px; color: #666; margin-bottom: 10px; line-height: 1.5;">
                                <strong>What it is:</strong> JSON standard for geographic data, readable by GIS software<br>
                                <strong>Opens with:</strong> QGIS, ArcGIS, Mapbox Studio, professional GIS software<br>
                                <strong>Typical use:</strong> Spatial analysis, academic research, interactive web maps<br>
                                <strong>For whom:</strong> Researchers, urban planners, data scientists, developers
                            </p>
                            <button onclick="exportSoundscapeMapGeoJSON()" style="padding: 10px 16px; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                📥 Export GeoJSON
                            </button>
                        </div>

                        <!-- CSV Map with guide -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h5 style="color: #2d5f4f; margin: 0 0 10px 0; font-size: 15px;">📊 CSV Map (Spreadsheet)</h5>
                            <p style="font-size: 13px; color: #666; margin-bottom: 10px; line-height: 1.5;">
                                <strong>What it is:</strong> Table with geographic coordinates and metadata<br>
                                <strong>Opens with:</strong> Excel, Google Sheets, any spreadsheet software<br>
                                <strong>Typical use:</strong> Tabular data analysis, charts, geographic statistics<br>
                                <strong>For whom:</strong> Anyone who wants to analyze markers in tabular format
                            </p>
                            <button onclick="exportSoundscapeMapCSV()" style="padding: 10px 16px; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                📥 Export CSV Map
                            </button>
                        </div>

                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <p style="font-size: 13px; color: #856404; margin: 0; line-height: 1.5;">
                                💡 <strong>Tip:</strong> If you don't know which format to choose, you probably don't need these exports.
                                The <strong>Complete Backup (JSON)</strong> already contains all marker data and can be reimported into the app.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Export Audio -->
                <div>
                    <h4 style="color: #2d5f4f; font-size: 16px; margin-bottom: 12px; font-weight: 600; border-bottom: 2px solid #d4af37; padding-bottom: 8px;">🎵 Export Audio Archive</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
                        Download all your audio files organized in a ZIP archive with complete metadata.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button onclick="exportAudioZIP()" style="padding: 12px 18px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(212,175,55,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(212,175,55,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(212,175,55,0.3)'">
                            🎵 All Audio (ZIP) ⭐
                        </button>
                    </div>
                </div>

                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; text-align: center;">
                    <p style="font-size: 13px; color: #999; margin-bottom: 8px;">
                        ⭐ <strong>All export features require Soundscape Studio Premium</strong>
                    </p>
                    <p style="font-size: 12px; color: #999;">
                        Protect and share your professional field recording archive
                    </p>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card" style="background: linear-gradient(135deg, #f0f7f4 0%, #e8f5f1 100%); border-left: 5px solid #2d5f4f;">
                <h3 style="color: #2d5f4f; margin-bottom: 15px;">💡 Format Information</h3>

                <div style="margin-bottom: 15px;">
                    <p style="margin-bottom: 8px;"><strong style="color: #2d5f4f;">📊 Excel (.xlsx)</strong></p>
                    <p style="font-size: 14px; color: #666; line-height: 1.6;">
                        Universal spreadsheet with date, title, category, difficulty, location, coordinates, notes and audio/photo counters.
                        Open with Excel, Numbers, Google Sheets or any data analysis software.
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <p style="margin-bottom: 8px;"><strong style="color: #2d5f4f;">📝 Word (.doc)</strong></p>
                    <p style="font-size: 14px; color: #666; line-height: 1.6;">
                        Formatted report ready for printing with all exercise details.
                        Perfect for documentation, portfolios or presentations.
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <p style="margin-bottom: 8px;"><strong style="color: #2d5f4f;">🗺️ KML (Google Earth)</strong></p>
                    <p style="font-size: 14px; color: #666; line-height: 1.6;">
                        Standard geographic format for Google Earth and Google Maps.
                        Visualize your markers in 3D with color-coded category icons.
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <p style="margin-bottom: 8px;"><strong style="color: #2d5f4f;">📄 GeoJSON</strong></p>
                    <p style="font-size: 14px; color: #666; line-height: 1.6;">
                        Standard for professional GIS applications (QGIS, ArcGIS, Mapbox).
                        Includes complete metadata for advanced geographic analysis.
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <p style="margin-bottom: 8px;"><strong style="color: #2d5f4f;">📊 CSV</strong></p>
                    <p style="font-size: 14px; color: #666; line-height: 1.6;">
                        Simple spreadsheet for quick import into Excel, databases or Python/R scripts.
                    </p>
                </div>

                <div>
                    <p style="margin-bottom: 8px;"><strong style="color: #2d5f4f;">🎵 ZIP Audio</strong></p>
                    <p style="font-size: 14px; color: #666; line-height: 1.6;">
                        Organized archive with folders for each exercise, original audio files and text files with metadata.
                        Complete backup of your sound archive.
                    </p>
                </div>
            </div>
        </div>

        <!-- ABOUT SECTION -->
        <div id="about" class="section">
            <h2 style="margin-bottom: 30px; color: #2d5f4f; text-align: center;">ℹ️ About Soundscape Studio</h2>

            <!-- Introduzione al Progetto -->
            <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #f0f7f4 0%, #e8f5f1 100%); border-left: 5px solid #2d5f4f;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">🎯 The Project</h3>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    <strong>Soundscape Studio</strong> is part of a broader <strong>research and development project for educational applications for artists and musicians</strong>,
                    created by <strong>Francesco Mariano</strong> of <strong>Gruppo Apuano Sperimentale</strong>.
                </p>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    This project was born from the need to provide professional and accessible tools to support the artistic and technical growth
                    of musicians, sound designers, composers, and sound artists. The goal is to democratize access to advanced skills through
                    interactive digital platforms that combine theory, practice, and field experience.
                </p>

                <!-- Presentazione Francesco Mariano -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #4a9d7f;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">👤 Francesco Mariano</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 15px;">
                        My artistic research focuses on <strong>electroacoustic composition</strong>, <strong>interactive sound installations</strong>,
                        <strong>soundscape composition</strong>, and <strong>immersive audio environments</strong> through programming in <strong>Max/MSP Jitter</strong>,
                        <strong>TouchDesigner</strong>, and developing interactive applications and software in the artistic field.
                    </p>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        <strong>Professor of Interaction Design</strong> at the <strong>Academy of Fine Arts of Macerata</strong> and the <strong>Academy of Fine Arts of Catania</strong>.
                    </p>
                </div>

                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">🌟 Project Philosophy</h4>
                    <ul style="line-height: 2; color: #2c3e50; font-size: 15px;">
                        <li><strong>Active Learning</strong>: Not just theory, but guided practical exercises</li>
                        <li><strong>Accessibility</strong>: Professional tools accessible to everyone</li>
                        <li><strong>Professionalism</strong>: Professional standards, real equipment, established workflows</li>
                        <li><strong>Community</strong>: Sharing experiences, recordings and discoveries</li>
                        <li><strong>Innovation</strong>: Use of modern technologies (IndexedDB, Web Audio API, Geolocation)</li>
                    </ul>
                </div>

                <div style="background: #fffbe6; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f4a261;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">🚀 Future Roadmap</h4>
                    <p style="color: #2c3e50; line-height: 1.8; font-size: 15px; margin-bottom: 15px;">
                        <strong>📱 Soundscape Studio iOS App</strong> (coming soon to App Store): Native version with complete backup,
                        advanced offline functionality, professional export tools, and additional analysis instruments. It will be a paid app
                        to support the ongoing development of the project.
                    </p>
                    <p style="color: #2c3e50; line-height: 1.8; font-size: 15px;">
                        Soundscape Studio is the first of a series of educational tools dedicated to various musical and artistic disciplines.
                        Future applications will be developed for composition, music theory, sound design, audio production,
                        acoustic analysis, and much more.
                    </p>
                </div>
            </div>

            <!-- Cos'è il Soundscape -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">🎧 What is Soundscape?</h3>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    The term <strong>soundscape</strong> was coined by Canadian composer and theorist <strong>R. Murray Schafer</strong>
                    in the 1970s, as part of his revolutionary <em>World Soundscape Project</em>.
                </p>

                <p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin-bottom: 20px;">
                    A soundscape is the totality of all sounds present in a specific environment: natural (wind, rain, animals),
                    human (voices, traffic, machines), and architectural (reverberations, reflections). It's not just "ambient recording,"
                    but a conscious approach to <strong>deep listening</strong> and <strong>composition with real sounds</strong>.
                </p>

                <div style="background: #f8f9f5; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">📚 Schafer's Fundamental Concepts</h4>
                    <ul style="line-height: 2; color: #2c3e50; font-size: 15px;">
                        <li><strong>Keynote Sounds</strong>: Constant background sounds (wind, distant traffic, sea)</li>
                        <li><strong>Signal Sounds</strong>: Foreground sounds that emerge (church bells, siren, bird call)</li>
                        <li><strong>Soundmark</strong>: Characteristic sounds of a place (like a visual "landmark")</li>
                        <li><strong>Hi-Fi vs Lo-Fi</strong>: Clean sonic environments vs noisy/confused ones</li>
                        <li><strong>Schizophonia</strong>: Separation of sound from its original source (e.g., recordings)</li>
                    </ul>
                </div>

                <div style="background: #e8f5f1; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 15px;">🎼 Applications of Field Recording</h4>
                    <ul style="line-height: 2; color: #2c3e50; font-size: 15px;">
                        <li><strong>Musique Concrète</strong>: Composition with concrete sounds (Pierre Schaeffer, Pierre Henry)</li>
                        <li><strong>Sound Art</strong>: Sound installations, acoustic sculptures</li>
                        <li><strong>Sound Design</strong>: Cinema, video games, theater</li>
                        <li><strong>Acoustic Documentation</strong>: Sound archives, anthropological research</li>
                        <li><strong>Acoustic Ecology</strong>: Study of natural environments, bioacoustics</li>
                        <li><strong>Sonic Mindfulness</strong>: Deep listening, meditation, sound therapy</li>
                    </ul>
                </div>
            </div>

            <!-- Contacts & Support -->
            <div class="card" style="background: linear-gradient(135deg, #2d5f4f 0%, #3d7f6f 100%); color: white;">
                <h3 style="margin-bottom: 20px; font-size: 22px; color: white;">📧 Contact & Support</h3>

                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; color: #ffffff;">
                    For questions, feedback, bug reports or collaborations, send me a message:
                </p>

                <!-- Contact Form -->
                <form id="contactForm" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Your Name:</label>
                        <input type="text" id="contactName" required style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.95);">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Your Email:</label>
                        <input type="email" id="contactEmail" required style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.95);">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Subject:</label>
                        <select id="contactSubject" required style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.95);">
                            <option value="">Select a subject...</option>
                            <option value="feedback">💬 Feedback</option>
                            <option value="bug">🐛 Bug Report</option>
                            <option value="feature">💡 Feature Request</option>
                            <option value="collaboration">🤝 Collaboration</option>
                            <option value="other">❓ Other</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Message:</label>
                        <textarea id="contactMessage" required rows="5" style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; resize: vertical; background: rgba(255,255,255,0.95);"></textarea>
                    </div>

                    <button type="submit" class="btn" style="width: 100%; padding: 14px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        📨 Send Message
                    </button>

                    <p id="contactFormStatus" style="margin-top: 15px; text-align: center; font-size: 14px; color: #ffffff; display: none;"></p>
                </form>

                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="font-size: 15px; margin-bottom: 5px; color: #ffffff;"><strong>👨‍💻 Developed by:</strong></p>
                    <p style="font-size: 16px; color: #ffffff;">Francesco Mariano - Gruppo Apuano Sperimentale</p>
                </div>

                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                    <p style="font-size: 15px; margin-bottom: 10px; color: #ffffff;"><strong>💰 Support the Project:</strong></p>
                    <p style="font-size: 14px; line-height: 1.6; color: #ffffff;">
                        If you find this project useful, consider supporting it by purchasing the Premium upgrade,
                        using affiliate links for equipment, or via PayPal donation.
                    </p>
                </div>
            </div>
        </div>

        <!-- GUIDE SECTION -->
        <div id="guide" class="section">
            <h2 style="margin-bottom: 30px; color: #2d5f4f; text-align: center;">📖 User Guide</h2>

            <!-- Spiegazione Sezioni -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 25px; font-size: 22px;">🧭 How to Use Soundscape Studio</h3>

                <!-- Dashboard -->
                <div style="background: #f8f9f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2d5f4f;">
                    <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 18px;">🏠 Dashboard</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        Your <strong>home base</strong>. Here you'll find:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>Completed Exercises</strong>: History of your saved exercises with audio, photos, and notes</li>
                        <li><strong>Quick Access</strong>: Shortcuts to main sections (Exercises, Toolkit, Map, Library)</li>
                        <li><strong>Activity Overview</strong>: View your progress in field recording</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 Tip: Return here after each session to review your work!
                    </p>
                </div>

                <!-- Esercizi -->
                <div style="background: #fff8f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #d32f2f;">
                    <h4 style="color: #d32f2f; margin-bottom: 12px; font-size: 18px;">🔔 Soundscape Exercises</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        The <strong>heart of the toolkit</strong>. 96 professional exercises divided into 6 categories:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>Basic Listening</strong>: Acoustic catalog, classification, intensity mapping</li>
                        <li><strong>Awareness</strong>: Awakening soundscape, silence census, acoustic transitions</li>
                        <li><strong>Movement</strong>: Walking variations, cycling, elevation shifts</li>
                        <li><strong>Analysis</strong>: Foreground/background, dynamic range, acoustic DNA</li>
                        <li><strong>Recording</strong>: First field recording, directional recording, gain staging</li>
                        <li><strong>Project</strong>: 7-day diary, soundscape composition, sonic postcards</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 How it works:
                    </p>
                    <ol style="line-height: 1.8; color: #2c3e50; font-size: 14px; margin-left: 20px; margin-top: 8px;">
                        <li>Filter by category or difficulty level</li>
                        <li>Read brief, objectives, recommended setup</li>
                        <li>Go to the field and record</li>
                        <li>Return to the app and click "Start Exercise"</li>
                        <li>Upload audio, photos, notes, answers to guided questions</li>
                        <li>Save everything locally (IndexedDB) - no account required!</li>
                    </ol>
                </div>

                <!-- Soundscape Map -->
                <div style="background: #e8f5f1; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4a9d7f;">
                    <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 18px;">🗺️ Soundscape Map</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        An <strong>interactive map</strong> to document your soundscapes:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>Geolocate</strong>: Click on the map to add markers</li>
                        <li><strong>Categorize</strong>: Traffic, market, nature, industrial, etc.</li>
                        <li><strong>Record or Upload</strong>: Add audio directly from microphone or from files</li>
                        <li><strong>Annotate</strong>: Describe the soundscape, time, weather conditions</li>
                        <li><strong>Playback</strong>: Click on markers to listen to your recordings</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 Use the Map to build a <strong>geolocated personal archive</strong> of your recordings.
                        Perfect for urban or natural acoustic documentation projects.
                    </p>
                </div>

                <!-- Toolkit -->
                <div style="background: #fff4f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff6b35;">
                    <h4 style="color: #d32f2f; margin-bottom: 12px; font-size: 18px;">🔧 Toolkit</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        An <strong>equipment guide</strong> for field recording. Divided into 3 levels:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>🟢 Budget (€50-200)</strong>: Smartphone + apps, entry-level recorders (Zoom H1n)</li>
                        <li><strong>🟡 Intermediate (€200-1000)</strong>: Zoom H5/F3, shotgun microphones, accessories</li>
                        <li><strong>🔴 Professional (€1000+)</strong>: Zoom F6, Sound Devices, professional Sennheiser/Rode microphones</li>
                    </ul>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-top: 12px;">
                        Each product includes:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 14px; margin-left: 20px;">
                        <li>📄 <strong>Professional review</strong>: Pros, cons, ideal use cases</li>
                        <li>🛒 <strong>Purchase links</strong>: Thomann (audio hardware) or Amazon (accessories/books)</li>
                        <li>💰 <strong>Price range</strong>: Updated estimate</li>
                        <li>⚙️ <strong>Key specs</strong>: Resolution, channels, battery life, weight</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 You don't need to buy everything! Start with Budget, experiment, then invest based on your needs.
                    </p>
                </div>

                <!-- Library -->
                <div style="background: #f0f4ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #5b7cff;">
                    <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 18px;">📚 Library</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        Curated resources to deepen theory and practice:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li><strong>📕 Essential Books</strong>: Schafer, Krause, Watson, Oliveros - field recording classics</li>
                        <li><strong>🎬 Videos & Documentaries</strong>: Tutorials, interviews, soundscape documentaries</li>
                        <li><strong>🎧 Audio Examples</strong>: Iconic recordings to study (Bernie Krause, Chris Watson)</li>
                        <li><strong>📄 Papers & Articles</strong>: Academic research on acoustic ecology, sound studies</li>
                        <li><strong>🔗 Online Resources</strong>: Sound archives, communities, forums, databases</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 Amazon links in the Library include the affiliate tag <code>soundscapestu-21</code> - if you purchase from there,
                        you support the development of this project at no additional cost!
                    </p>
                </div>
            </div>

            <!-- Free vs Premium Version -->
            <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #d4af37;">
                <h3 style="color: #d4af37; margin-bottom: 20px; font-size: 22px; text-align: center;">🆓 Free Version vs ⭐ Premium</h3>

                <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                    <h4 style="color: #28a745; margin-bottom: 12px; font-size: 18px;">🆓 Free Version</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        The free version lets you <strong>experience all the main features</strong> of Soundscape Studio:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>✅ <strong>All 96 exercises</strong> accessible (12 complete categories)</li>
                        <li>✅ <strong>Unlimited audio and photos</strong> for each completed exercise</li>
                        <li>✅ <strong>Up to 20 markers</strong> on the interactive map</li>
                        <li>✅ Complete local saving (IndexedDB + LocalStorage)</li>
                        <li>✅ Access to Toolkit, Library, Guide</li>
                    </ul>
                    <p style="font-size: 15px; line-height: 1.8; color: #d32f2f; margin-top: 15px; font-weight: 600;">
                        ⚠️ LIMITATIONS:
                    </p>
                    <ul style="line-height: 1.8; color: #d32f2f; font-size: 15px; margin-left: 20px;">
                        <li>⚠️ <strong>Data saved ONLY locally</strong> in the browser (risk of data loss)</li>
                        <li>⚠️ If you delete the app or change devices, <strong>you lose your entire archive</strong></li>
                        <li>❌ <strong>No export functions</strong> (no PDF, no GeoJSON/CSV, no complete backup)</li>
                        <li>❌ Maximum <strong>20 markers on the map</strong> (vs unlimited in Premium)</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 The free version is perfect for <strong>trying the app and first exercises</strong>, but doesn't offer long-term protection for your work.
                    </p>
                </div>

                <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffe082 20%); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #d4af37;">
                    <h4 style="color: #d4af37; margin-bottom: 12px; font-size: 18px;">⭐ Premium Version - "The Professional Archive"</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        The Premium version transforms Soundscape Studio into a <strong>secure and shareable professional archive</strong>:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>💾 <strong>Complete Backup and Restore</strong>: Export/import all data (exercises, audio, photos, markers) in a single JSON file</li>
                        <li>📄 <strong>Professional PDF Export</strong>: Generate printable reports of your exercises with audio, photos and notes</li>
                        <li>🗺️ <strong>GeoJSON/CSV/KML/Excel/Word Export</strong>: Export your data for GIS analysis, scientific research, team sharing</li>
                        <li>♾️ <strong>Unlimited markers</strong> on the map (vs 20 in free version)</li>
                        <li>🚀 <strong>All future Pro features</strong>: New features, advanced tools, professional integrations</li>
                    </ul>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-top: 15px; font-weight: 600;">
                        🎯 Who is Premium for?
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 14px; margin-left: 20px;">
                        <li><strong>Professional sound designers</strong> who want to protect their sound archive</li>
                        <li><strong>University students</strong> who need to present field recording projects</li>
                        <li><strong>Researchers and sound artists</strong> who need GeoJSON export for scientific analysis</li>
                        <li><strong>Serious enthusiasts</strong> who invest time in field recording and don't want to risk losing data</li>
                    </ul>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        💡 Premium gives you <strong>peace of mind</strong>: your work is safe, shareable and professional.
                    </p>
                </div>

                <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <h4 style="color: #2196F3; margin-bottom: 12px; font-size: 16px;">💰 How to Upgrade to Premium?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                        Upgrade to Premium happens via <strong>in-app purchase</strong> on the App Store:
                    </p>
                    <ol style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Click on any Premium feature (e.g. "Complete Backup", "Export PDF")</li>
                        <li>The upgrade modal will appear with price and details</li>
                        <li>Confirm purchase via Apple Pay / Touch ID / Face ID</li>
                        <li>Premium features will activate immediately!</li>
                    </ol>
                    <p style="font-size: 14px; color: #666; margin-top: 12px; font-style: italic;">
                        🔐 The purchase is managed by Apple (secure, protected) and can be restored on all your devices.
                    </p>
                </div>
            </div>

            <!-- Tips & Best Practices -->
            <div class="card" style="margin-bottom: 30px; background: #fffbe6; border-left: 5px solid #f4a261;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">💡 Tips & Best Practices</h3>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">🎤 During Recording</h4>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Always use <strong>headphones</strong> to monitor in real-time</li>
                        <li>Check levels: avoid clipping (red LEDs), but don't record too low</li>
                        <li>Record at least <strong>2-3 minutes</strong> for each soundscape (you need material for editing)</li>
                        <li>Make multiple takes of the same location (morning vs evening, weekday vs weekend)</li>
                        <li>Experiment with different angles: XY stereo, MS, spaced pair</li>
                        <li>Note everything: time, weather, special events, technical problems</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">📝 Documentation</h4>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Take <strong>photos of the setup</strong>: microphone, position, environment</li>
                        <li>Mark precise GPS coordinates (use the Map!)</li>
                        <li>Describe in detail: "Market square, Saturday morning 9:30 AM, sunny, about 50 people"</li>
                        <li>Save technical metadata: gain, sample rate, microphone type</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">🔒 Privacy & Legal</h4>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Recording in <strong>public spaces</strong> is generally legal (no expectation of privacy)</li>
                        <li>Avoid recognizable private conversations (GDPR/privacy laws)</li>
                        <li>Ask permission for private spaces (museums, shops, restaurants)</li>
                        <li>If publishing online, consider Creative Commons licensing</li>
                    </ul>
                </div>

                <div>
                    <h4 style="color: #2d5f4f; margin-bottom: 10px; font-size: 16px;">🎓 Recommended Workflow</h4>
                    <ol style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px;">
                        <li>Choose 1-2 exercises from the <strong>Exercises</strong> section</li>
                        <li>Study the brief and prepare equipment (see <strong>Toolkit</strong>)</li>
                        <li>Go to the field and record (use <strong>Soundscape Map</strong> to geolocate)</li>
                        <li>Return home, complete the exercise in the app (upload audio, photos, notes)</li>
                        <li>Listen back, analyze with the exercise's guided questions</li>
                        <li>Deepen your knowledge by reading resources from the <strong>Library</strong></li>
                        <li>Repeat! Consistent practice is essential</li>
                    </ol>
                </div>
            </div>

            <!-- FAQ -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #2d5f4f; margin-bottom: 20px; font-size: 22px;">❓ FAQ - Frequently Asked Questions</h3>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Where is my data saved?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Everything is stored <strong>locally in your browser</strong> (IndexedDB). No server, no account, no upload.
                        Your audio, photos, and exercises remain private on your device.
                        <strong>⚠️ Warning</strong>: If you delete browser data, you lose everything! Use the "Export" function for backup.
                    </p>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Can I use Soundscape Studio on mobile?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Yes! The site is responsive. Audio recording works on mobile browsers (Chrome, Safari).
                        Geolocation works perfectly on smartphones. A dedicated native iOS app is planned for the future.
                    </p>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">How does the business model work?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Soundscape Studio is available as an <strong>iOS app on the App Store</strong> with complete features:
                        professional export, advanced offline access, and analysis tools.
                    </p>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50; margin-top: 10px;">
                        The project is supported through <strong>app sales</strong>, <strong>affiliate links</strong> (Thomann, Amazon), and voluntary PayPal donations.
                        If you find this toolkit useful, consider purchasing the app, buying equipment from the provided links, or making a donation to support development!
                    </p>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Can I contribute to the project?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Absolutely! You can:
                    </p>
                    <ul style="line-height: 1.8; color: #2c3e50; font-size: 15px; margin-left: 20px; margin-top: 8px;">
                        <li>📧 Send feedback and suggestions via email</li>
                        <li>🎧 Share the project with other sound recordists</li>
                        <li>💰 Make a PayPal donation</li>
                        <li>🛒 Purchase equipment from affiliate links</li>
                        <li>📝 Report bugs or propose new exercises</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e8f5f1;">
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">How much space does it take in the browser?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        It depends on how many exercises you complete. An exercise with 5 audio files (2-3 min each) and 3 photos takes approximately 20-50 MB.
                        Most modern browsers allow several GB of IndexedDB storage.
                        You can monitor space in browser settings.
                    </p>
                </div>

                <div>
                    <h4 style="color: #2d5f4f; margin-bottom: 8px; font-size: 16px;">Can I share my recordings?</h4>
                    <p style="font-size: 15px; line-height: 1.8; color: #2c3e50;">
                        Currently there is no integrated sharing function (everything is local).
                        You can export your exercises as files and share them manually.
                        In the future, an optional community/gallery feature may be added.
                    </p>
                </div>
            </div>

            <!-- Contacts & Support -->
            <div class="card" style="background: linear-gradient(135deg, #2d5f4f 0%, #3d7f6f 100%); color: white;">
                <h3 style="margin-bottom: 20px; font-size: 22px; color: white;">📧 Contact & Support</h3>

                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; color: #ffffff;">
                    For questions, feedback, bug reports or collaborations, send me a message:
                </p>

                <!-- Contact Form -->
                <form id="contactForm2" onsubmit="sendContactEmail(event)" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Your Name:</label>
                        <input type="text" id="contactName2" required style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.95);">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Your Email:</label>
                        <input type="email" id="contactEmail2" required style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.95);">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Subject:</label>
                        <select id="contactSubject2" required style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.95);">
                            <option value="">Select a subject...</option>
                            <option value="feedback">💬 Feedback</option>
                            <option value="bug">🐛 Bug Report</option>
                            <option value="feature">💡 Feature Request</option>
                            <option value="collaboration">🤝 Collaboration</option>
                            <option value="other">❓ Other</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #ffffff; font-weight: 600;">Message:</label>
                        <textarea id="contactMessage2" required rows="5" style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; resize: vertical; background: rgba(255,255,255,0.95);"></textarea>
                    </div>

                    <button type="submit" class="btn" style="width: 100%; padding: 14px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        📨 Send Message
                    </button>

                    <p id="contactFormStatus2" style="margin-top: 15px; text-align: center; font-size: 14px; color: #ffffff; display: none;"></p>
                </form>

                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="font-size: 15px; margin-bottom: 5px; color: #ffffff;"><strong>🎨 Developed by:</strong></p>
                    <p style="font-size: 16px; color: #ffffff;"><strong>Francesco Mariano</strong> - Gruppo Apuano Sperimentale</p>
                </div>

                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                    <p style="font-size: 15px; margin-bottom: 5px; color: #ffffff;"><strong>💰 Support the Project:</strong></p>
                    <p style="font-size: 14px; line-height: 1.6; color: #ffffff;">
                        If you find this project useful, consider supporting it by purchasing the iOS app,
                        <a href="https://www.paypal.com/paypalme/francescomariano" target="_blank" style="color: #ffffff; text-decoration: underline; font-weight: bold;">PayPal donation</a>
                        or purchasing equipment from the Thomann/Amazon affiliate links in the Toolkit and Library.
                    </p>
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Dai%20un'occhiata%20a%20Soundscape%20Studio!%20Un%20toolkit%20completo%20per%20field%20recording%20e%20composizione%20sonora%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>

        <!-- MAP SECTION -->
        <div id="map" class="section">
            <h2 style="margin-bottom: 20px; color: #2d5f4f;">🗺️ Soundscape Map</h2>

            <!-- Istruzioni -->
            <div class="card" style="background: #fffbe6; border-left: 4px solid #f4a261; margin-bottom: 20px;">
                <p style="color: #2d5f4f; font-weight: 600; margin-bottom: 8px;">📍 How to use the map:</p>
                <p style="color: #666; font-size: 14px;">
                    1. Click on the map to add a marker<br>
                    2. Select a category (traffic, market, nature, etc.)<br>
                    3. Add a description<br>
                    4. Record audio from microphone or upload a file<br>
                    5. Play your saved soundscapes!
                </p>
            </div>

            <!-- Map Container -->
            <div style="margin-bottom: 20px; width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                <div id="leafletMap" style="height: 500px; width: 100%; max-width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #e0e0e0; margin-bottom: 20px; box-sizing: border-box;"></div>
            </div>

            <!-- Controls and Markers -->
            <div style="width: 100%; max-width: 100%; margin-bottom: 20px; box-sizing: border-box; overflow-x: hidden;">
                <!-- Sidebar with Controls -->
                <div style="width: 100%; max-width: 100%; box-sizing: border-box; overflow-x: hidden;">
                    <div class="card" style="width: 100%; max-width: 100%; overflow-x: hidden; box-sizing: border-box; padding: 15px;">
                        <h4 style="color: #2d5f4f; margin-bottom: 15px;">🎯 Add Marker</h4>

                        <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Click on the map to place or:</p>
                        <button onclick="detectMapGPSLocation()" style="width: 100%; padding: 10px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 15px;">
                            📍 Use My Current Location
                        </button>

                        <label style="display: block; font-weight: 600; color: #2d5f4f; margin-bottom: 8px; font-size: 14px;">Category:</label>
                        <select id="markerCategory" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #e0e0e0; margin-bottom: 15px;">
                            <option value="traffic">🚗 Urban Traffic</option>
                            <option value="market">🛒 Market</option>
                            <option value="voices">👥 Voices/Crowd</option>
                            <option value="industrial">🏭 Industrial</option>
                            <option value="railway">🚂 Railway</option>
                            <option value="coastal">🌊 Coastal</option>
                            <option value="forest">🌲 Forest</option>
                            <option value="park">🌳 Urban Park</option>
                            <option value="construction">🚧 Construction Site</option>
                            <option value="airport">✈️ Airport</option>
                            <option value="other">📌 Other</option>
                        </select>

                        <div style="margin-bottom: 15px; width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                            <label style="display: block; font-weight: 600; color: #2d5f4f; margin-bottom: 8px; font-size: 14px;">Notes:</label>
                            <div style="width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                                <input type="text" id="markerNotes" placeholder="Soundscape description..." style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #e0e0e0; font-size: 16px; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif;" />
                            </div>
                        </div>

                        <div style="border-top: 2px solid #e8f5f1; padding-top: 15px; margin-top: 15px;">
                            <h4 style="color: #2d5f4f; margin-bottom: 12px; font-size: 14px;">🎤 Audio</h4>

                            <!-- Recording Controls -->
                            <div id="recordingControls">
                                <button id="startRecording" class="btn" style="width: 100%; margin-bottom: 8px; background: #d32f2f; color: white;">
                                    🔴 Record
                                </button>
                                <button id="stopRecording" class="btn" style="width: 100%; margin-bottom: 8px; display: none; background: #666;">
                                    ⏹️ Stop
                                </button>
                                <div id="recordingTime" style="text-align: center; font-size: 14px; color: #d32f2f; margin-bottom: 8px; display: none; font-weight: 600;">
                                    ⏱️ 00:00
                                </div>
                            </div>

                            <!-- Upload File -->
                            <label for="audioFileUpload" class="btn" style="width: 100%; text-align: center; display: inline-block; margin-bottom: 8px; background: #2d5f4f; color: white; cursor: pointer;">
                                📁 Upload Audio File
                            </label>
                            <input type="file" id="audioFileUpload" accept="audio/*" style="display: none;">

                            <!-- Audio Preview -->
                            <div id="audioPreview" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9f5; border-radius: 6px; max-width: 100%; box-sizing: border-box; overflow: hidden;">
                                <p style="font-size: 12px; color: #2d5f4f; margin-bottom: 6px; font-weight: 600;">Preview:</p>
                                <audio id="audioPreviewPlayer" controls style="width: 100%; max-width: 100%; height: 32px; box-sizing: border-box;"></audio>
                            </div>

                            <!-- Spectrum Analyzer -->
                            <div style="margin-top: 15px; margin-bottom: 15px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <label style="font-weight: 600; color: #00d4ff; font-size: 13px; text-shadow: 0 0 10px rgba(0,212,255,0.5);">
                                        📊 Spectrum Analyzer
                                    </label>
                                    <span id="spectrumStatus" style="font-size: 11px; color: #888; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 12px;">
                                        Waiting...
                                    </span>
                                </div>
                                <canvas id="spectrumCanvas" width="800" height="300" style="width: 100%; height: 150px; border-radius: 8px; background: #0a0a15; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);"></canvas>

                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                    <div style="font-size: 10px; color: #666;">
                                        <span style="color: #00d4ff;">20 Hz - 10 kHz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Markers List -->
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #2d5f4f; margin: 0;">📍 Your Markers</h4>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <button onclick="exportToKML()" style="padding: 4px 10px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;" title="Export for Google Earth/Maps (Premium)">
                                    🗺️ KML
                                </button>
                                <button onclick="exportMapGeoJSON()" style="padding: 4px 10px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;" title="Export as GeoJSON (Premium)">
                                    📥 GeoJSON
                                </button>
                                <button onclick="exportMapCSV()" style="padding: 4px 10px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;" title="Export as CSV (Premium)">
                                    📊 CSV
                                </button>
                                <button onclick="deleteAllMarkers()" style="padding: 4px 10px; background: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;" title="Delete all markers">
                                    🗑️ Delete All
                                </button>
                            </div>
                        </div>
                        <div id="markersList" style="font-size: 14px; max-height: 600px; overflow-y: auto; padding-right: 8px;">
                            <p style="color: #999; font-style: italic;">No markers saved</p>
                        </div>
                    </div>
                </div>

                <!-- Markers List Expanded (right side) -->
                <div style="flex: 1;">
                    <!-- Placeholder for expanded view -->
                </div>
            </div>

            <!-- Footer -->
            <div class="section-footer">
                <div class="footer-buttons">
                    <a href="https://wa.me/?text=Dai%20un'occhiata%20a%20Soundscape%20Studio!%20Un%20toolkit%20completo%20per%20field%20recording%20e%20composizione%20sonora%20🎧%20https://soundscape-project-studio.netlify.app" class="footer-btn whatsapp" target="_blank">
                        📱 Share on WhatsApp
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsoundscape-project-studio.netlify.app" class="footer-btn facebook" target="_blank">
                        📘 Share on Facebook
                    </a>
                    <a href="https://www.paypal.com/paypalme/francescomariano" class="footer-btn paypal" target="_blank">
                        💰 Support with Donation
                    </a>
                    <a href="mailto:artistmentalhealth@gmail.com?subject=Feedback%20Soundscape%20Studio" class="footer-btn feedback">
                        ✉️ Send Feedback
                    </a>
                </div>
                <div class="footer-credits">
                    <p><strong>Created and developed by Francesco Mariano</strong></p>
                    <p>Gruppo Apuano Sperimentale</p>
                </div>
            </div>
        </div>


    </div>

    <!-- Modal for Marker Details -->
    <div class="modal" id="markerDetailsModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeMarkerDetailsModal()">×</button>
            <div id="markerDetailsContent"></div>
        </div>
    </div>

    <!-- Modal per Esercizi -->
    <div class="modal" id="exerciseModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeExerciseModal()">×</button>
            <div id="exerciseDetails"></div>
        </div>
    </div>

    <!-- Modal per Completamento Esercizio -->
    <div class="modal" id="completeExerciseModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeCompleteExerciseModal()">×</button>
            <div id="completeExerciseContent">
                <h2 style="color: #2d5f4f; margin-bottom: 20px;">📋 Complete Your Exercise</h2>

                <!-- Riassunto Esercizio -->
                <div id="exerciseSummary" style="background: #f0f7f4; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #2d5f4f;">
                    <!-- Verrà popolato dinamicamente -->
                </div>

                <form id="exerciseCompletionForm" onsubmit="return saveExerciseCompletion(event)">

                    <!-- Sezione 1: Info Base -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">📍 Basic Information</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">📅 Date</label>
                                <input type="date" id="exerciseDate" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">⏰ Start Time</label>
                                <input type="time" id="exerciseTime" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">📍 Place name (optional)</label>
                            <input type="text" id="exerciseLocation" placeholder="e.g. Central Park, New York" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <div id="geoStatus" style="margin-top: 8px; padding: 8px; background: #f0f7f4; border-radius: 6px; font-size: 13px; color: #2d5f4f;">
                                📍 Automatic GPS detection in progress...
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">⏱️ Actual Duration</label>
                            <input type="text" id="exerciseDuration" placeholder="e.g. 15 minutes" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>

                    <!-- Section 2: Environmental Context -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">🌤️ Environmental Context</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">Describe the surrounding environment</label>
                            <textarea id="environmentDescription" rows="3" placeholder="Describe the environment, predominant sounds, general atmosphere..." required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">☀️ Weather Conditions</label>
                                <select id="weatherConditions" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="soleggiato">☀️ Sunny</option>
                                    <option value="nuvoloso">☁️ Cloudy</option>
                                    <option value="piovoso">🌧️ Rainy</option>
                                    <option value="ventoso">💨 Windy</option>
                                    <option value="nebbioso">🌫️ Foggy</option>
                                    <option value="neve">❄️ Snowy</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🔊 Noise Level</label>
                                <select id="noiseLevel" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="molto-silenzioso">🔇 Very Quiet</option>
                                    <option value="silenzioso">🔉 Quiet</option>
                                    <option value="moderato">🔊 Moderate</option>
                                    <option value="rumoroso">📢 Noisy</option>
                                    <option value="molto-rumoroso">📣 Very Noisy</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">👥 Were you alone?</label>
                                <select id="alone" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="si">Yes, alone</option>
                                    <option value="no">No, with company</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🚶 Were you still or moving?</label>
                                <select id="movement" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select...</option>
                                    <option value="fermo">Still</option>
                                    <option value="movimento">Moving</option>
                                    <option value="entrambi">Both</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Tools and Recording -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">🎙️ Tools and Recording</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">What tools did you use for recording?</label>
                            <input type="text" id="recordingTools" placeholder="e.g. Zoom H5, binaural microphone, smartphone..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #2d5f4f;">🎙️ Audio Recording</label>

                            <!-- Integrated Recorder -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 12px; border: 2px solid #e0e0e0;">
                                <p style="font-size: 13px; color: #666; margin-bottom: 12px;">Record directly during the exercise:</p>

                                <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <button type="button" id="startRecordingBtn" onclick="startExerciseRecording()" style="flex: 1; min-width: 120px; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                        ⏺️ Start Recording
                                    </button>
                                    <button type="button" id="stopRecordingBtn" onclick="stopExerciseRecording()" disabled style="flex: 1; min-width: 120px; padding: 12px; background: #666; color: white; border: none; border-radius: 6px; cursor: not-allowed; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                        ⏹️ Stop
                                    </button>
                                </div>

                                <div id="recordingStatus" style="display: none; padding: 10px; background: #ffebee; border-radius: 6px; text-align: center;">
                                    <span style="color: #d32f2f; font-weight: 600;">⏺️ Recording...</span>
                                    <span id="recordingTimer" style="margin-left: 10px; font-family: monospace; color: #d32f2f; font-weight: 600;">00:00</span>
                                </div>

                                <div id="recordedAudiosList" style="margin-top: 12px;"></div>
                            </div>

                            <!-- File Upload (alternative) -->
                            <div style="border-top: 1px dashed #ddd; padding-top: 12px;">
                                <p style="font-size: 13px; color: #666; margin-bottom: 8px;"><strong>Or</strong> upload existing files:</p>
                                <input type="file" id="audioUpload" accept="audio/*" multiple style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <small style="color: #666; display: block; margin-top: 5px;">You can upload multiple audio files</small>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">📸 Location Photo (optional)</label>
                            <input type="file" id="photoUpload" accept="image/*" multiple style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🗺️ Do you want to add a marker on the map?</label>
                            <select id="addMapMarker" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="no">No</option>
                                <option value="si">Yes, add to map</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sezione 4: Canvas per Disegno -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">✏️ Draw your sound analysis</h3>
                        <p style="color: #666; margin-bottom: 15px;">Use this space to draw sound maps, directions, listening circles, etc.</p>

                        <div style="margin-bottom: 15px;">
                            <button type="button" onclick="setDrawingTool('pen')" style="padding: 8px 16px; margin-right: 10px; background: #2d5f4f; color: white; border: none; border-radius: 6px; cursor: pointer;">🖊️ Pen</button>
                            <button type="button" onclick="setDrawingTool('eraser')" style="padding: 8px 16px; margin-right: 10px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">🧹 Eraser</button>
                            <button type="button" onclick="clearCanvas()" style="padding: 8px 16px; margin-right: 10px; background: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer;">🗑️ Clear all</button>
                            <label style="margin-left: 10px;">
                                Color: <input type="color" id="drawingColor" value="#2d5f4f" onchange="updateDrawingColor()" style="vertical-align: middle; cursor: pointer;">
                            </label>
                            <label style="margin-left: 10px;">
                                Thickness:
                                <select id="drawingThickness" onchange="updateDrawingThickness()" style="padding: 4px; border-radius: 4px;">
                                    <option value="2">Thin</option>
                                    <option value="5" selected>Medium</option>
                                    <option value="10">Thick</option>
                                    <option value="15">Very thick</option>
                                </select>
                            </label>
                        </div>

                        <canvas id="drawingCanvas" width="800" height="500" style="width: 100%; max-width: 100%; height: auto; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: crosshair; display: block; box-sizing: border-box; touch-action: none;"></canvas>
                    </div>

                    <!-- Sezione 5: Note e Considerazioni -->
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 20px;">💭 Reflections and Notes</h3>

                        <div style="margin-bottom: 20px; width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">What did you discover? Personal reflections</label>
                            <div style="width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                                <textarea id="personalNotes" placeholder="Describe your experience..." style="width: 100%; height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; resize: none; box-sizing: border-box; overflow-y: auto; overflow-x: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif;"></textarea>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px; width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">🏷️ Tags (comma separated)</label>
                            <div style="width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                                <input type="text" id="exerciseTags" placeholder="e.g. urban, nature, morning" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d5f4f;">⭐ Rate your experience</label>
                            <div id="ratingStars" style="font-size: 32px; cursor: pointer;">
                                <span onclick="setRating(1)" data-rating="1">☆</span>
                                <span onclick="setRating(2)" data-rating="2">☆</span>
                                <span onclick="setRating(3)" data-rating="3">☆</span>
                                <span onclick="setRating(4)" data-rating="4">☆</span>
                                <span onclick="setRating(5)" data-rating="5">☆</span>
                            </div>
                            <input type="hidden" id="exerciseRating" value="0">
                        </div>
                    </div>

                    <!-- Bottoni Azione -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" onclick="closeCompleteExerciseModal()" style="padding: 14px 28px; background: #999; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">
                            Cancel
                        </button>
                        <button type="submit" style="padding: 14px 28px; background: #2d5f4f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">
                            💾 Save Exercise
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal per Visualizzare Esercizio Completato -->
    <div class="modal" id="viewCompletedExerciseModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; overflow-x: hidden; padding: 20px; box-sizing: border-box;">
            <button class="modal-close" onclick="closeViewCompletedModal()">×</button>
            <div id="viewCompletedContent" style="width: 100%; overflow-x: hidden; word-wrap: break-word;">
                <!-- Verrà popolato dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal per Reference Guides -->
    <div class="reference-modal" id="referenceModal" onclick="if(event.target === this) closeReferenceModal()">
        <div class="reference-modal-content">
            <span class="reference-modal-close" onclick="closeReferenceModal()">×</span>
            <div id="referenceContent">
                <!-- Verrà popolato dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Load Complete Exercise Database -->
    <script src="exercises-complete.js"></script>

    <script>
        // ==================== INDEXEDDB SETUP ====================
        let db;
        const DB_NAME = 'SoundscapeStudioDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'completedExercises';

        // Inizializza IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => {
                    console.error('Database opening error:', request.error);
                    reject(request.error);
                };

                request.onsuccess = () => {
                    db = request.result;
                    console.log('✅ IndexedDB database opened successfully');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    // Crea object store se non esiste
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id',
                            autoIncrement: true
                        });

                        // Crea indici per query più veloci
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                        objectStore.createIndex('exerciseTitle', 'exercise.title', { unique: false });
                        objectStore.createIndex('date', 'date', { unique: false });

                        console.log('✅ Object store created');
                    }
                };
            });
        }

        // Salva esercizio in IndexedDB con audio files e photos
        async function saveExerciseToIndexedDB(exerciseData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);

                const request = objectStore.add(exerciseData);

                request.onsuccess = () => {
                    console.log('✅ Exercise saved with ID:', request.result);
                    resolve(request.result);
                };

                request.onerror = () => {
                    console.error('❌ Saving error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Recupera tutti gli esercizi
        async function getAllExercisesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    resolve(request.result || []);
                };

                request.onerror = () => {
                    console.error('❌ Exercises retrieval error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Recupera singolo esercizio per ID
        async function getExerciseFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.get(id);

                request.onsuccess = () => {
                    resolve(request.result);
                };

                request.onerror = () => {
                    console.error('❌ Exercise retrieval error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Elimina esercizio
        async function deleteExerciseFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    console.log('✅ Exercise deleted');
                    resolve();
                };

                request.onerror = () => {
                    console.error('❌ Deletion error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Elimina tutti gli esercizi
        async function clearAllExercisesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.clear();

                request.onsuccess = () => {
                    console.log('✅ All exercises deleted');
                    resolve();
                };

                request.onerror = () => {
                    console.error('❌ Database cleanup error:', request.error);
                    reject(request.error);
                };
            });
        }

        // Converte File in Blob per salvare in IndexedDB
        async function fileToBlob(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    resolve({
                        data: e.target.result,
                        name: file.name,
                        type: file.type,
                        size: file.size
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Converte FileList in array di Blob
        async function filesToBlobs(fileList) {
            if (!fileList || fileList.length === 0) return [];

            const promises = Array.from(fileList).map(file => fileToBlob(file));
            return Promise.all(promises);
        }

        // ==================== NAVIGATION ====================
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Attiva il pulsante corrispondente (se chiamato da un click)
            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            } else {
                // Se chiamato programmaticamente, trova il pulsante corrispondente
                const btn = document.querySelector(`[onclick*="showSection('${sectionId}')"]`);
                if (btn) btn.classList.add('active');
            }

            // Initialize toolkit equipment tabs when first opened
            if (sectionId === 'toolkit') {
                setTimeout(() => {
                    if (window.initializeToolkit) {
                        window.initializeToolkit();
                    }
                }, 100);
            }

            // Initialize library when first opened
            if (sectionId === 'library') {
                setTimeout(() => {
                    if (window.initializeLibrary) {
                        window.initializeLibrary();
                    }
                }, 100);
            }
        }

        // Funzione dedicata per mostrare la sezione mappa
        function showMapSection() {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));

            // Show map section
            document.getElementById('map').classList.add('active');
            event.target.classList.add('active');

            // Initialize map after a brief delay to ensure DOM is ready
            setTimeout(() => {
                initializeSoundscapeMap();
            }, 200);
        }

        // ==================== GLOBAL FUNCTION DECLARATIONS ====================
        // These are declared early so onclick handlers can find them

        window.showReferenceModal = function(type) {
            console.log('showReferenceModal called with type:', type);
        };

        window.closeReferenceModal = function() {
            console.log('closeReferenceModal called');
        };

        window.showEquipmentTab = function(category) {
            console.log('showEquipmentTab called with category:', category);
        };

        window.showLibraryTab = function(category) {
            console.log('showLibraryTab called with category:', category);
        };

        window.initializeToolkit = function() {
            console.log('initializeToolkit called');
        };

        window.initializeLibrary = function() {
            console.log('initializeLibrary called');
        };

        // ==================== SPETTROGRAMMA ====================
        // Codice spettrogramma rimosso (sezione HTML rimossa)

        /* SPETTROGRAMMA CODE - COMMENTED OUT
        let audioContext;
        let analyser;
        let dataArray;
        let bufferLength;
        let canvas;
        let canvasCtx;
        let animationId;
        let microphone;
        let audioElement;
        let sourceNode;

        function initSpectrogram() {
            canvas = document.getElementById('spectrogramCanvas');
            canvasCtx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;

            // Initialize audio context
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
        }

        // Start Microphone
        const startMicBtn = document.getElementById('startMicBtn');
        if (startMicBtn) {
        startMicBtn.addEventListener('click', async () => {
            if (!audioContext) initSpectrogram();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                document.getElementById('startMicBtn').style.display = 'none';
                document.getElementById('stopMicBtn').style.display = 'inline-block';

                drawSpectrogram();
            } catch (err) {
                alert('Microphone access error: ' + err.message);
            }
        });

        // Stop Microphone
        document.getElementById('stopMicBtn').addEventListener('click', () => {
            if (microphone) {
                microphone.disconnect();
                microphone.mediaStream.getTracks().forEach(track => track.stop());
                microphone = null;
            }

            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            document.getElementById('startMicBtn').style.display = 'inline-block';
            document.getElementById('stopMicBtn').style.display = 'none';

            // Clear canvas
            canvasCtx.fillStyle = '#000';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        });

        // Load Audio File
        document.getElementById('audioFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!audioContext) initSpectrogram();

            const arrayBuffer = await file.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            // Create audio element for playback
            audioElement = new Audio(URL.createObjectURL(file));

            document.getElementById('playAudioBtn').style.display = 'inline-block';
            document.getElementById('pauseAudioBtn').style.display = 'none';
        });

        // Play Audio
        document.getElementById('playAudioBtn').addEventListener('click', () => {
            if (!audioElement) return;

            if (!sourceNode) {
                sourceNode = audioContext.createMediaElementSource(audioElement);
                sourceNode.connect(analyser);
                analyser.connect(audioContext.destination);
            }

            audioElement.play();
            document.getElementById('playAudioBtn').style.display = 'none';
            document.getElementById('pauseAudioBtn').style.display = 'inline-block';

            drawSpectrogram();
        });

        // Pause Audio
        document.getElementById('pauseAudioBtn').addEventListener('click', () => {
            if (audioElement) {
                audioElement.pause();
                document.getElementById('playAudioBtn').style.display = 'inline-block';
                document.getElementById('pauseAudioBtn').style.display = 'none';
            }
        });

        // Draw Spectrogram
        function drawSpectrogram() {
            animationId = requestAnimationFrame(drawSpectrogram);

            analyser.getByteFrequencyData(dataArray);

            // Shift canvas left
            const imageData = canvasCtx.getImageData(1, 0, canvas.width - 1, canvas.height);
            canvasCtx.putImageData(imageData, 0, 0);

            // Draw new column
            for (let i = 0; i < bufferLength; i++) {
                const value = dataArray[i];
                const y = canvas.height - (i / bufferLength) * canvas.height;

                // Color mapping (black -> blue -> green -> yellow -> red)
                let r, g, b;
                if (value < 64) {
                    r = 0; g = 0; b = value * 4;
                } else if (value < 128) {
                    r = 0; g = (value - 64) * 4; b = 255;
                } else if (value < 192) {
                    r = (value - 128) * 4; g = 255; b = 255 - (value - 128) * 4;
                } else {
                    r = 255; g = 255 - (value - 192) * 4; b = 0;
                }

                canvasCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                canvasCtx.fillRect(canvas.width - 1, y, 1, canvas.height / bufferLength);
            }

            // Update info
            const maxIndex = dataArray.indexOf(Math.max(...dataArray));
            const frequency = Math.round((maxIndex / bufferLength) * (audioContext.sampleRate / 2));
            const avgLevel = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const dB = 20 * Math.log10(avgLevel / 255);

            document.getElementById('freqInfo').textContent = `Frequenza dominante: ${frequency} Hz`;
            document.getElementById('dbInfo').textContent = `Livello: ${dB.toFixed(1)} dB`;

            if (audioElement) {
                document.getElementById('timeInfo').textContent = `Tempo: ${audioElement.currentTime.toFixed(2)}s / ${audioElement.duration.toFixed(2)}s`;
            }
        }
        END OF SPETTROGRAMMA CODE */

        // ==================== ESERCIZI ====================
        // Convert fieldRecordingExercises object to flat array
        var exercises = [];
        if (typeof fieldRecordingExercises !== 'undefined') {
            Object.keys(fieldRecordingExercises).forEach(category => {
                fieldRecordingExercises[category].forEach(ex => {
                    exercises.push({
                        category: category,
                        title: ex.title,
                        description: ex.description,
                        prompt: ex.prompt,
                        duration: ex.duration,
                        examples: ex.examples,
                        level: 'Intermedio', // Default level
                        time: ex.duration
                    });
                });
            });
        }

        // Category name translations
        const categoryLabels = {
            'ascolto-base': 'BASIC LISTENING',
            'consapevolezza': 'AWARENESS',
            'movimento': 'MOVEMENT',
            'analisi': 'ANALYSIS',
            'registrazione': 'RECORDING',
            'progetto': 'PROJECT'
        };

        // State for filtering
        var currentCategoryFilter = 'all';
        var currentLevelFilter = 'all';

        async function loadExercises(filteredExercises = exercises) {
            const grid = document.getElementById('exerciseGrid');
            grid.innerHTML = ''; // Clear existing

            if (filteredExercises.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🔍</div>
                        <p>Nessun esercizio trovato con questi filtri.</p>
                    </div>
                `;
                return;
            }

            // Ottieni tutti gli esercizi completati
            const completedExercises = await getAllExercisesFromIndexedDB();

            // Crea un Set con i titoli degli esercizi completati per ricerca veloce
            const completedTitles = new Set(
                completedExercises.map(ex => ex.exercise.title)
            );

            filteredExercises.forEach(ex => {
                const card = document.createElement('div');
                card.className = 'exercise-card';
                card.onclick = () => showExerciseDetail(ex);

                const isCompleted = completedTitles.has(ex.title);
                const completedBadge = isCompleted ?
                    `<span style="position: absolute; top: 10px; right: 10px; font-size: 24px; background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">✅</span>` : '';

                card.innerHTML = `
                    ${completedBadge}
                    <span class="exercise-category cat-${ex.category}">${categoryLabels[ex.category] || ex.category.toUpperCase()}</span>
                    <div class="exercise-title">${ex.title}</div>
                    <div class="exercise-meta">
                        📊 ${ex.level} | ⏱️ ${ex.time}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function filterExercises(category) {
            currentCategoryFilter = category;
            applyFilters();

            // Update button states
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${category}"]`).classList.add('active');
        }

        function filterByLevel(level) {
            currentLevelFilter = level;
            applyFilters();

            // Update button states
            document.querySelectorAll('[data-level]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
        }

        async function applyFilters() {
            let filtered = exercises;

            // Apply category filter
            if (currentCategoryFilter !== 'all') {
                filtered = filtered.filter(ex => ex.category === currentCategoryFilter);
            }

            // Apply level filter
            if (currentLevelFilter !== 'all') {
                filtered = filtered.filter(ex => ex.level === currentLevelFilter);
            }

            await loadExercises(filtered);
        }

        function showExerciseDetail(exercise) {
            const modal = document.getElementById('exerciseModal');
            const details = document.getElementById('exerciseDetails');

            const examplesHTML = exercise.examples && exercise.examples.length > 0 ?
                `<div style="margin-top: 20px;">
                    <h3 style="color: #2d5f4f; margin-bottom: 10px;">💡 Examples</h3>
                    <ul style="line-height: 2;">
                        ${exercise.examples.map(ex => `<li>${ex}</li>`).join('')}
                    </ul>
                </div>` : '';

            details.innerHTML = `
                <span class="exercise-category cat-${exercise.category}">${exercise.category.replace(/-/g, ' ').toUpperCase()}</span>
                <h2 style="margin: 15px 0; color: #2d5f4f;">${exercise.title}</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    <strong>Durata:</strong> ${exercise.time}
                </p>
                <div style="line-height: 1.8;">
                    <h3 style="color: #2d5f4f; margin-bottom: 10px;">📝 Description</h3>
                    <p>${exercise.description}</p>

                    <h3 style="color: #2d5f4f; margin: 20px 0 10px 0;">🎯 Instructions</h3>
                    <p style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #2d5f4f;">
                        ${exercise.prompt}
                    </p>

                    ${examplesHTML}
                </div>
                <button onclick="startExerciseCompletion()" style="margin-top: 20px; padding: 12px 24px; background: #2d5f4f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Start Exercise
                </button>
            `;

            modal.classList.add('active');
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        // ==================== EXERCISE COMPLETION FUNCTIONS ====================
        var currentExercise = null;
        var drawingCanvas = null;
        var drawingCtx = null;
        var isDrawing = false;
        var currentTool = 'pen';
        var currentColor = '#2d5f4f';
        var currentThickness = 5;

        function startExerciseCompletion() {
            // Salva l'esercizio corrente
            const exerciseTitle = document.querySelector('#exerciseDetails h2').textContent;
            const exerciseCategory = document.querySelector('#exerciseDetails .exercise-category').textContent;
            const exerciseDescription = document.querySelector('#exerciseDetails p:nth-of-type(2)').textContent;
            const exercisePrompt = document.querySelector('#exerciseDetails p[style*="background"]').textContent;

            currentExercise = {
                title: exerciseTitle,
                category: exerciseCategory,
                description: exerciseDescription,
                prompt: exercisePrompt
            };

            // Chiudi il modal degli esercizi
            closeExerciseModal();

            // Popola il riassunto
            document.getElementById('exerciseSummary').innerHTML = `
                <h3 style="color: #2d5f4f; margin-bottom: 10px;">${currentExercise.title}</h3>
                <p style="margin-bottom: 15px;"><strong>Category:</strong> ${currentExercise.category}</p>
                <p style="margin-bottom: 15px;"><strong>Descrizione:</strong> ${currentExercise.description}</p>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #4a9d7f;">
                    <strong>Key Steps:</strong><br>
                    ${currentExercise.prompt}
                </div>
            `;

            // Imposta data e ora correnti
            const now = new Date();
            document.getElementById('exerciseDate').valueAsDate = now;
            document.getElementById('exerciseTime').value = now.toTimeString().slice(0,5);

            // Reset form
            document.getElementById('exerciseCompletionForm').reset();
            document.getElementById('exerciseDate').valueAsDate = now;
            document.getElementById('exerciseTime').value = now.toTimeString().slice(0,5);
            document.getElementById('exerciseRating').value = '0';

            // Reset stelle
            document.querySelectorAll('#ratingStars span').forEach(star => {
                star.textContent = '☆';
            });

            // Apri il modal di completamento
            document.getElementById('completeExerciseModal').classList.add('active');

            // Inizializza il canvas
            setTimeout(() => {
                initDrawingCanvas();
            }, 100);

            // Auto-detect GPS automatically
            autoDetectGeolocation();
        }

        function closeCompleteExerciseModal() {
            document.getElementById('completeExerciseModal').classList.remove('active');
            currentExercise = null;

            // Reset recorded audios
            exerciseRecordedAudios = [];
            displayRecordedAudios();

            // Reset recorder UI
            document.getElementById('startRecordingBtn').disabled = false;
            document.getElementById('startRecordingBtn').style.background = '#d32f2f';
            document.getElementById('startRecordingBtn').style.cursor = 'pointer';
            document.getElementById('stopRecordingBtn').disabled = true;
            document.getElementById('stopRecordingBtn').style.background = '#666';
            document.getElementById('stopRecordingBtn').style.cursor = 'not-allowed';
            document.getElementById('recordingStatus').style.display = 'none';
            document.getElementById('recordingTimer').textContent = '00:00';

            // Stop any active recording
            if (exerciseMediaRecorder && exerciseMediaRecorder.state !== 'inactive') {
                exerciseMediaRecorder.stop();
                clearInterval(exerciseRecordingTimer);
            }
        }

        function initDrawingCanvas() {
            drawingCanvas = document.getElementById('drawingCanvas');
            if (!drawingCanvas) return;

            drawingCtx = drawingCanvas.getContext('2d');
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';

            // Clear canvas
            drawingCtx.fillStyle = 'white';
            drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);

            // Mouse events
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            drawingCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                drawingCanvas.dispatchEvent(mouseEvent);
            });

            drawingCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                drawingCanvas.dispatchEvent(mouseEvent);
            });

            drawingCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                drawingCanvas.dispatchEvent(mouseEvent);
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            const scaleX = drawingCanvas.width / rect.width;
            const scaleY = drawingCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            drawingCtx.beginPath();
            drawingCtx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = drawingCanvas.getBoundingClientRect();
            const scaleX = drawingCanvas.width / rect.width;
            const scaleY = drawingCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'pen') {
                drawingCtx.strokeStyle = currentColor;
                drawingCtx.lineWidth = currentThickness;
                drawingCtx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'eraser') {
                drawingCtx.strokeStyle = 'white';
                drawingCtx.lineWidth = currentThickness * 3;
                drawingCtx.globalCompositeOperation = 'destination-out';
            }

            drawingCtx.lineTo(x, y);
            drawingCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function setDrawingTool(tool) {
            currentTool = tool;
        }

        function clearCanvas() {
            if (!drawingCtx || !drawingCanvas) return;
            drawingCtx.fillStyle = 'white';
            drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }

        function updateDrawingColor() {
            currentColor = document.getElementById('drawingColor').value;
        }

        function updateDrawingThickness() {
            currentThickness = parseInt(document.getElementById('drawingThickness').value);
        }

        // Auto-detect GPS when modal opens
        function autoDetectGeolocation() {
            const statusEl = document.getElementById('geoStatus');
            const locationInput = document.getElementById('exerciseLocation');

            if (!navigator.geolocation) {
                console.warn('❌ Geolocation not supported');
                statusEl.innerHTML = '❌ Geolocation not supported - using default coordinates';
                statusEl.style.background = '#ffe0e0';
                statusEl.style.color = '#d32f2f';
                // Use fallback IMMEDIATELY
                useFallbackCoordinates();
                return;
            }

            // IMPORTANT: Set fallback IMMEDIATELY, then try GPS
            // This ensures coordinates are ALWAYS present
            useFallbackCoordinates();
            console.log('📍 Fallback coordinates set immediately');

            statusEl.innerHTML = '🔄 Automatic GPS detection in progress...';
            statusEl.style.background = '#fff9e6';
            statusEl.style.color = '#f57c00';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);

                    // Override fallback with real GPS
                    locationInput.dataset.lat = lat;
                    locationInput.dataset.lon = lon;

                    statusEl.innerHTML = `✅ GPS detected: ${lat}, ${lon}`;
                    statusEl.style.background = '#e8f5e9';
                    statusEl.style.color = '#2e7d32';

                    console.log('✅ GPS auto-detected:', lat, lon);
                },
                (error) => {
                    console.warn('⚠️ GPS auto-detection failed:', error);
                    statusEl.innerHTML = '⚠️ GPS unavailable - using default position';
                    statusEl.style.background = '#fff3e0';
                    statusEl.style.color = '#e65100';

                    // Fallback already set at start
                    console.log('📍 Using fallback coordinates already set');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,  // Reduced to 5 seconds
                    maximumAge: 0
                }
            );
        }

        // Use current map center as fallback if GPS unavailable
        function useFallbackCoordinates() {
            const locationInput = document.getElementById('exerciseLocation');

            if (leafletMap) {
                const center = leafletMap.getCenter();
                const lat = center.lat.toFixed(6);
                const lon = center.lng.toFixed(6);

                locationInput.dataset.lat = lat;
                locationInput.dataset.lon = lon;

                console.log('📍 Using map center as fallback:', lat, lon);
            } else {
                // Absolute fallback: Rome, Italy
                locationInput.dataset.lat = '41.902782';
                locationInput.dataset.lon = '12.496366';
                console.log('📍 Using default coordinates (Rome)');
            }
        }

        // Legacy function kept for compatibility (no longer used in UI)
        function getGeolocation() {
            autoDetectGeolocation();
        }

        function setRating(rating) {
            document.getElementById('exerciseRating').value = rating;

            // Aggiorna stelle visivamente
            document.querySelectorAll('#ratingStars span').forEach((star, index) => {
                if (index < rating) {
                    star.textContent = '★';
                } else {
                    star.textContent = '☆';
                }
            });
        }

        async function saveExerciseCompletion(event) {
            event.preventDefault();

            // Mostra loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '⏳ Salvataggio in corso...';
            submitBtn.disabled = true;

            try {
                // Converti i audio files e photos in Blob
                const audioFiles = document.getElementById('audioUpload').files;
                const photoFiles = document.getElementById('photoUpload').files;

                // NO LIMITS in free version - all data is unlimited
                // Premium offers export and backup features instead

                const audioBlobs = await filesToBlobs(audioFiles);
                const photoBlobs = await filesToBlobs(photoFiles);

                // Combine recorded audios with uploaded files
                const recordedBlobs = exerciseRecordedAudios.map(audio => audio.blob);
                const allAudioBlobs = [...recordedBlobs, ...audioBlobs];

                // Raccogli tutti i dati inclusi audio e photos
                const completionData = {
                    exercise: currentExercise,
                    date: document.getElementById('exerciseDate').value,
                    time: document.getElementById('exerciseTime').value,
                    location: document.getElementById('exerciseLocation').value,
                    locationCoords: {
                        lat: document.getElementById('exerciseLocation').dataset.lat || null,
                        lon: document.getElementById('exerciseLocation').dataset.lon || null
                    },
                    duration: document.getElementById('exerciseDuration').value,
                    environment: document.getElementById('environmentDescription').value,
                    weather: document.getElementById('weatherConditions').value,
                    noiseLevel: document.getElementById('noiseLevel').value,
                    alone: document.getElementById('alone').value,
                    movement: document.getElementById('movement').value,
                    recordingTools: document.getElementById('recordingTools').value,
                    notes: document.getElementById('personalNotes').value,
                    tags: document.getElementById('exerciseTags').value,
                    rating: document.getElementById('exerciseRating').value,
                    addMapMarker: document.getElementById('addMapMarker').value,
                    drawing: drawingCanvas ? drawingCanvas.toDataURL() : null,
                    audioFiles: allAudioBlobs,  // Array di audio files (recorded + uploaded)
                    photoFiles: photoBlobs,  // Array di photos
                    timestamp: new Date().toISOString()
                };

                // Salva in IndexedDB e ottieni l'ID generato
                const exerciseId = await saveExerciseToIndexedDB(completionData);

                // Se richiesto, aggiungi marker alla mappa
                // Coordinates are ALWAYS available (auto-detected GPS or fallback)
                if (completionData.addMapMarker === 'si') {
                    try {
                        // Ensure coordinates exist (fallback if missing)
                        if (!completionData.locationCoords.lat) {
                            completionData.locationCoords.lat = leafletMap ? leafletMap.getCenter().lat.toFixed(6) : '41.902782';
                            completionData.locationCoords.lon = leafletMap ? leafletMap.getCenter().lng.toFixed(6) : '12.496366';
                            console.log('📍 Using fallback coordinates for marker:', completionData.locationCoords);
                        }

                        await addExerciseMarkerToMap(completionData, exerciseId);
                        console.log('✅ Marker added to map:', completionData.locationCoords);
                    } catch (error) {
                        console.error('Marker addition error:', error);
                    }
                }

                // Reset recorded audios array for next exercise
                exerciseRecordedAudios = [];

                // Aggiorna counter esercizi completati
                await updateCompletedExercisesCounter();

                // Ricarica gli esercizi per mostrare la spunta verde
                await applyFilters();

                // Reset button state BEFORE closing modal (button reference still valid)
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

                // Chiudi modal
                closeCompleteExerciseModal();

                // Show confirmation
                alert('✅ Exercise saved successfully!\n\n' +
                      `Audio files saved: ${allAudioBlobs.length}\n` +
                      `Photos saved: ${photoBlobs.length}\n\n` +
                      'You can find all your completed exercises in the Dashboard section.');

            } catch (error) {
                console.error('Saving error:', error);
                alert('❌ Error during save!\n\n' + error.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }

            return false;
        }

        async function updateCompletedExercisesCounter() {
            try {
                const savedExercises = await getAllExercisesFromIndexedDB();
                const counters = document.querySelectorAll('[style*="Completed exercises"]');
                counters.forEach(counter => {
                    counter.textContent = `Completed exercises: ${savedExercises.length}/96`;
                });

                // Aggiorna anche la lista nella Dashboard
                await loadCompletedExercisesList();
            } catch (error) {
                console.error('Counter update error:', error);
            }
        }

        // ==================== VISUALIZZAZIONE ESERCIZI COMPLETATI ====================

        async function loadCompletedExercisesList() {
            const listContainer = document.getElementById('completedExercisesList');
            if (!listContainer) return;

            try {
                const savedExercises = await getAllExercisesFromIndexedDB();

                if (savedExercises.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">📭</div>
                            <p>You haven't completed any exercises yet.</p>
                            <p style="font-size: 14px; margin-top: 10px;">Start an exercise and document your experience!</p>
                        </div>
                    `;
                    return;
                }

                // Mostra gli ultimi 5 esercizi
                const recentExercises = savedExercises.slice(-5).reverse();

                listContainer.innerHTML = recentExercises.map((ex) => {
                    const date = new Date(ex.timestamp);
                    const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = ex.time || date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                    // Badge per audio e photos
                    const badges = [];
                    if (ex.audioFiles && ex.audioFiles.length > 0) {
                        badges.push(`🎵 ${ex.audioFiles.length}`);
                    }
                    if (ex.photoFiles && ex.photoFiles.length > 0) {
                        badges.push(`📷 ${ex.photoFiles.length}`);
                    }

                    return `
                        <div onclick="viewCompletedExercise(${ex.id})" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #2d5f4f; box-sizing: border-box; max-width: 100%; overflow: hidden;" onmouseover="this.style.background='#f0f7f4'" onmouseout="this.style.background='#f9f9f9'">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                                <div style="flex: 1; min-width: 0;">
                                    <h4 style="margin: 0 0 8px 0; color: #2d5f4f; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.exercise.title}</h4>
                                    <div style="font-size: 13px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        <span>📅 ${dateStr}</span> •
                                        <span>⏰ ${timeStr}</span> •
                                        <span>📍 ${ex.location}</span>
                                    </div>
                                    ${badges.length > 0 ? `<div style="margin-top: 5px; font-size: 12px; color: #4a9d7f;">${badges.join(' • ')}</div>` : ''}
                                    ${ex.rating > 0 ? `<div style="margin-top: 5px; color: #f39c12;">${'★'.repeat(parseInt(ex.rating))}</div>` : ''}
                                </div>
                                <div style="font-size: 24px;">👁️</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('List loading error:', error);
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #d9534f;">
                        <div style="font-size: 48px; margin-bottom: 15px;">❌</div>
                        <p>Error loading exercises</p>
                    </div>
                `;
            }
        }

        async function showAllCompletedExercises() {
            try {
                const savedExercises = await getAllExercisesFromIndexedDB();

                if (savedExercises.length === 0) {
                    alert('You haven\'t completed any exercises yet!');
                return;
            }

            const modal = document.getElementById('viewCompletedExerciseModal');
            const content = document.getElementById('viewCompletedContent');

            content.innerHTML = `
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h2 style="color: #2d5f4f; margin: 0;">📋 All Completed Exercises (${savedExercises.length})</h2>
                    <button onclick="closeViewCompletedModal()" style="padding: 10px 20px; background: #2d5f4f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                        ← Back to Dashboard
                    </button>
                </div>

                <div style="margin-bottom: 20px; margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="exportCompleteBackup()" style="padding: 10px 20px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        💾 Complete Backup ⭐
                    </button>
                    <button onclick="importCompleteBackup()" style="padding: 10px 20px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        📂 Restore Backup ⭐
                    </button>
                    <button onclick="exportAllExercises()" style="padding: 10px 20px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        📥 Export Exercises (JSON)
                    </button>
                    <button onclick="clearAllExercises()" style="padding: 10px 20px; background: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        🗑️ Delete All
                    </button>
                </div>

                <div style="max-height: 500px; overflow-y: auto; overflow-x: hidden; width: 100%;">
                    ${savedExercises.map((ex) => {
                        const date = new Date(ex.timestamp);
                        const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
                        const timeStr = ex.time || date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                        // Badge per audio e photos
                        const badges = [];
                        if (ex.audioFiles && ex.audioFiles.length > 0) {
                            badges.push(`🎵 ${ex.audioFiles.length} audio`);
                        }
                        if (ex.photoFiles && ex.photoFiles.length > 0) {
                            badges.push(`📷 ${ex.photoFiles.length} photos`);
                        }

                        return `
                            <div onclick="viewCompletedExercise(${ex.id})" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s; box-sizing: border-box; max-width: 100%; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <span style="display: inline-block; background: #2d5f4f; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; margin-bottom: 8px;">${ex.exercise.category}</span>
                                        <h3 style="margin: 5px 0; color: #2d5f4f;">${ex.exercise.title}</h3>
                                    </div>
                                    ${ex.rating > 0 ? `<div style="font-size: 20px; color: #f39c12;">${'★'.repeat(parseInt(ex.rating))}</div>` : ''}
                                </div>
                                <div style="font-size: 14px; color: #666; line-height: 1.8;">
                                    <div><strong>📅 Date:</strong> ${dateStr} at ${timeStr}</div>
                                    <div><strong>📍 Location:</strong> ${ex.location}</div>
                                    <div><strong>⏱️ Duration:</strong> ${ex.duration}</div>
                                    <div><strong>☀️ Weather:</strong> ${ex.weather}</div>
                                </div>
                                ${badges.length > 0 ? `<div style="margin-top: 10px; padding: 8px; background: #f0f7f4; border-radius: 6px; font-size: 13px; color: #2d5f4f; font-weight: 600;">${badges.join(' • ')}</div>` : ''}
                                ${ex.tags ? `<div style="margin-top: 10px;">${ex.tags.split(',').map(tag => `<span style="background: #e0f2f7; color: #2d5f4f; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px;">${tag.trim()}</span>`).join('')}</div>` : ''}
                                <div style="margin-top: 10px; text-align: right; color: #4a9d7f; font-weight: 600;">Click to see details →</div>
                            </div>
                        `;
                    }).reverse().join('')}
                </div>
            `;

                modal.classList.add('active');
            } catch (error) {
                console.error('Exercises display error:', error);
                alert('❌ Error loading exercises!');
            }
        }

        async function viewCompletedExercise(id) {
            try {
                const ex = await getExerciseFromIndexedDB(id);

                if (!ex) {
                    alert('❌ Exercise not found!');
                    return;
                }

                const modal = document.getElementById('viewCompletedExerciseModal');
                const content = document.getElementById('viewCompletedContent');

                const date = new Date(ex.timestamp);
                const dateStr = date.toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
                const timeStr = ex.time || date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                // HTML per audio files
                var audioHTML = '';
                if (ex.audioFiles && ex.audioFiles.length > 0) {
                    // Convert audio blobs to URLs
                    const audioURLs = ex.audioFiles.map((audioBlob, idx) => {
                        // Create object URL from blob
                        const url = URL.createObjectURL(audioBlob);
                        return {
                            url: url,
                            name: `Audio ${idx + 1}`,
                            type: audioBlob.type || 'audio/webm'
                        };
                    });

                    audioHTML = `
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="color: #2d5f4f; margin-bottom: 15px;">🎵 Audio Recordings (${ex.audioFiles.length})</h3>
                            ${audioURLs.map((audio, idx) => `
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="margin-bottom: 10px; font-weight: 600; color: #2d5f4f;">
                                        ${audio.name}
                                    </div>
                                    <audio controls style="width: 100%; margin-bottom: 10px;">
                                        <source src="${audio.url}" type="${audio.type}">
                                        Your browser does not support HTML5 audio.
                                    </audio>
                                    <button onclick="downloadAudio(${ex.id}, ${idx})" style="padding: 6px 12px; background: #4a9d7f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                        📥 Download Audio
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // HTML per photo files
                var photoHTML = '';
                if (ex.photoFiles && ex.photoFiles.length > 0) {
                    // Convert photo blobs to URLs
                    const photoURLs = ex.photoFiles.map((photoBlob, idx) => {
                        // Create object URL from blob
                        const url = URL.createObjectURL(photoBlob);
                        return {
                            url: url,
                            name: `Photo ${idx + 1}`
                        };
                    });

                    photoHTML = `
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 100%; overflow: hidden; box-sizing: border-box;">
                            <h3 style="color: #2d5f4f; margin-bottom: 15px;">📷 Location Photos (${ex.photoFiles.length})</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(150px, 100%), 1fr)); gap: 15px; width: 100%;">
                                ${photoURLs.map((photo, idx) => `
                                    <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; box-sizing: border-box; max-width: 100%;">
                                        <img src="${photo.url}"
                                             onclick="viewFullImage('${photo.url.replace(/'/g, "\\'")}', '${photo.name.replace(/'/g, "\\'")}')"
                                             style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; cursor: pointer; margin-bottom: 8px; max-width: 100%;"
                                             alt="${photo.name}">
                                        <button onclick="downloadPhoto(${ex.id}, ${idx})" style="width: 100%; padding: 6px; background: #4a9d7f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; box-sizing: border-box;">
                                            📤 Save/Share
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <button onclick="showAllCompletedExercises()" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 15px;">
                            ← Back to list
                        </button>
                        <button onclick="exportExerciseToWord(${ex.id})" style="padding: 8px 16px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px; font-weight: 600;">
                            📝 Export Word ${!isPremium ? '⭐' : ''}
                        </button>
                        <button onclick="deleteExercise(${ex.id})" style="padding: 8px 16px; background: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                            🗑️ Delete this exercise
                        </button>
                    </div>

                    <h2 style="color: #2d5f4f; margin-bottom: 10px;">${ex.exercise.title}</h2>
                    <span style="display: inline-block; background: #2d5f4f; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 20px;">${ex.exercise.category}</span>

                    ${ex.rating > 0 ? `<div style="font-size: 32px; color: #f39c12; margin-bottom: 20px;">${'★'.repeat(parseInt(ex.rating))}</div>` : ''}

                    ${audioHTML}
                    ${photoHTML}

                    <!-- Info Base -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">📍 Basic Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px; line-height: 2;">
                            <div><strong>📅 Date:</strong> ${dateStr}</div>
                            <div><strong>⏰ Time:</strong> ${timeStr}</div>
                            <div><strong>📍 Location:</strong> ${ex.location}</div>
                            <div><strong>⏱️ Duration:</strong> ${ex.duration}</div>
                        </div>
                    </div>

                    <!-- Contesto Ambientale -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">🌤️ Environmental Context</h3>
                        <div style="margin-bottom: 15px;">
                            <strong>Environment description:</strong>
                            <p style="background: #f9f9f9; padding: 12px; border-radius: 6px; margin-top: 5px;">${ex.environment}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; font-size: 14px;">
                            <div><strong>☀️ Weather:</strong> ${ex.weather}</div>
                            <div><strong>🔊 Noise:</strong> ${ex.noiseLevel}</div>
                            <div><strong>👥 Alone:</strong> ${ex.alone}</div>
                            <div><strong>🚶 Movement:</strong> ${ex.movement}</div>
                        </div>
                    </div>

                    <!-- Strumenti -->
                    ${ex.recordingTools ? `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">🎙️ Tools Used</h3>
                        <p>${ex.recordingTools}</p>
                    </div>
                    ` : ''}

                    <!-- Disegno -->
                    ${ex.drawing ? `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">✏️ Drawn Sound Analysis</h3>
                        <img src="${ex.drawing}" onclick="viewFullImage('${ex.drawing.replace(/'/g, "\\'")}', 'Sound Analysis')" style="max-width: 100%; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                        <button onclick="downloadDrawing(${ex.id})" style="margin-top: 10px; padding: 8px 16px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📤 Save/Share Image
                        </button>
                    </div>
                    ` : ''}

                    <!-- Note e Considerazioni -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #2d5f4f; margin-bottom: 15px;">💭 Reflections and Notes</h3>
                        <p style="background: #f9f9f9; padding: 15px; border-radius: 6px; line-height: 1.8; white-space: pre-wrap;">${ex.notes}</p>
                        ${ex.tags ? `
                        <div style="margin-top: 15px;">
                            <strong>🏷️ Tag:</strong><br>
                            ${ex.tags.split(',').map(tag => `<span style="background: #e0f2f7; color: #2d5f4f; padding: 5px 12px; border-radius: 4px; font-size: 13px; margin-right: 8px; margin-top: 8px; display: inline-block;">${tag.trim()}</span>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;

                modal.classList.add('active');
            } catch (error) {
                console.error('Exercise display error:', error);
                alert('❌ Error loading exercise!');
            }
        }

        function closeViewCompletedModal() {
            document.getElementById('viewCompletedExerciseModal').classList.remove('active');
        }

        async function deleteExercise(id) {
            if (!confirm('Are you sure you want to delete this exercise? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteExerciseFromIndexedDB(id);
                alert('✅ Exercise deleted successfully!');
                await updateCompletedExercisesCounter();
                closeViewCompletedModal();
                // Ricarica la lista esercizi se siamo nella vista completa
                showAllCompletedExercises();
                // Remove green checkmark from exercise list
                await applyFilters();
            } catch (error) {
                console.error('Deletion error:', error);
                alert('❌ Error deleting exercise!');
            }
        }

        async function clearAllExercises() {
            if (!confirm('⚠️ WARNING!\n\nAre you sure you want to delete ALL completed exercises?\n\nThis action is IRREVERSIBLE and will delete all your saved data (audio, photos, drawings, notes).')) {
                return;
            }

            if (!confirm('Do you confirm you want to proceed? All your exercises, drawings, audio and photos will be lost forever.')) {
                return;
            }

            try {
                await clearAllExercisesFromIndexedDB();
                alert('✅ All exercises have been deleted.');
                await updateCompletedExercisesCounter();
                closeViewCompletedModal();
                // Ricarica la dashboard
                await loadCompletedExercisesList();
                // Remove all green checkmarks from exercise list
                await applyFilters();
            } catch (error) {
                console.error('Deletion error:', error);
                alert('❌ Error deleting exercises!');
            }
        }

        function exportAllExercises() {
            const savedExercises = JSON.parse(localStorage.getItem('completedExercises') || '[]');

            if (savedExercises.length === 0) {
                alert('There are no exercises to export!');
                return;
            }

            const dataStr = JSON.stringify(savedExercises, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `soundscape-exercises-backup-${new Date().toISOString().slice(0,10)}.json`;
            link.click();

            URL.revokeObjectURL(url);

            alert('✅ Exportzione completata! Il file è stato scaricato.');
        }

        // Helper function per scaricare audio
        async function downloadAudio(exerciseId, audioIndex) {
            // Premium check
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nDownloading individual audio files is only available in the Premium version.\n\n🌟 Upgrade to Premium to download your audio files!');
                showUpgradeModal();
                return;
            }

            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);
                if (!ex || !ex.audioFiles || !ex.audioFiles[audioIndex]) {
                    alert('❌ Audio not found!');
                    return;
                }

                const audioBlob = ex.audioFiles[audioIndex];

                // Download audio using Share API on iOS
                try {
                    // audioBlob is already a Blob (no need to fetch)
                    const blob = audioBlob;
                    const fileName = `audio-${audioIndex + 1}.webm`;

                    // On iOS with Capacitor, use Share API
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Share) {
                        // Convert blob to base64 data URL
                        const reader = new FileReader();
                        const dataUrl = await new Promise((resolve, reject) => {
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });

                        // Share audio
                        await window.Capacitor.Plugins.Share.share({
                            title: 'Save Soundscape Audio',
                            text: fileName,
                            url: dataUrl,
                            dialogTitle: 'Save audio'
                        });
                    } else {
                        // Web fallback
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        setTimeout(() => URL.revokeObjectURL(url), 100);
                        alert('✅ Audio downloaded!');
                    }
                    return;
                } catch (error) {
                    console.error('Audio download error:', error);
                    alert('❌ Error downloading audio: ' + error.message);
                    return;
                }

                // Fallback for web (not needed anymore)
                const link = document.createElement('a');
                link.href = audio.data;
                link.download = audio.name || `audio-${audioIndex + 1}.m4a`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert('✅ Audio downloaded!');
            } catch (error) {
                console.error('Audio download error:', error);
                alert('❌ Error downloading audio!');
            }
        }

        // Helper function per scaricare photos
        async function downloadPhoto(exerciseId, photoIndex) {
            // Premium check
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nDownloading individual photos is only available in the Premium version.\n\n🌟 Upgrade to Premium to download your photos!');
                showUpgradeModal();
                return;
            }

            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);
                if (!ex || !ex.photoFiles || !ex.photoFiles[photoIndex]) {
                    alert('❌ Photo not found!');
                    return;
                }

                const photo = ex.photoFiles[photoIndex];

                // Check if running on native (Capacitor) with Media plugin
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Media) {
                    try {
                        const { Media } = window.Capacitor.Plugins;

                        // Save to photo library
                        await Media.savePhoto({
                            path: photo.data
                        });

                        alert('✅ Photo saved to Photo Library!');
                        return;
                    } catch (mediaError) {
                        console.error('Media error:', mediaError);
                        alert('❌ Error saving photo: ' + mediaError.message);
                        return;
                    }
                }

                // Fallback for web
                const response = await fetch(photo.data);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = photo.name || `photo-${photoIndex + 1}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => URL.revokeObjectURL(url), 100);
                alert('✅ Photo downloaded!');
            } catch (error) {
                console.error('Photo download error:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // Helper function per visualizzare immagine a schermo intero
        function viewFullImage(dataUrl, imageName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = dataUrl;
            img.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                object-fit: contain;
                border-radius: 8px;
            `;

            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '✕ Chiudi';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                background: white;
                color: black;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                z-index: 10001;
            `;

            closeBtn.onclick = (e) => {
                e.stopPropagation();
                document.body.removeChild(modal);
            };

            modal.onclick = () => {
                document.body.removeChild(modal);
            };

            modal.appendChild(img);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);
        }

        // Download disegno
        async function downloadDrawing(exerciseId) {
            // Premium check
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nDownloading drawings is only available in the Premium version.\n\n🌟 Upgrade to Premium to download your drawings!');
                showUpgradeModal();
                return;
            }

            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);

                if (!ex || !ex.drawing) {
                    alert('❌ Drawing not found!');
                    return;
                }

                // Check if running on native (Capacitor) and Share plugin is available
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Share && window.Capacitor.Plugins.Filesystem) {
                    // Use Capacitor Share API for native platforms
                    try {
                        await Share.share({
                            title: 'Save Drawing',
                            text: `Soundscape Studio - ${ex.exercise.title}`,
                            url: ex.drawing,
                            dialogTitle: 'Save or Share Drawing'
                        });
                        return; // Success, exit function
                    } catch (shareError) {
                        console.error('Share plugin error:', shareError);
                        // Fall through to download method
                    }
                }

                // Fallback for web or if share fails
                {
                    // Fallback for web: download link
                    const response = await fetch(ex.drawing);
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `soundscape-drawing-${ex.exercise.title.replace(/[^a-z0-9]/gi, '-')}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    alert('✅ Image downloaded!');
                }
            } catch (error) {
                console.error('Drawing share/download error:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            // Inizializza IndexedDB
            try {
                await initDB();
                console.log('✅ Database initialized');
            } catch (error) {
                console.error('❌ Database initialization error:', error);
                alert('⚠️ Database initialization error!\n\nThe app may not work properly.');
            }

            // Carica interfaccia
            loadExercises();
            generateExampleImages();
            await updateCompletedExercisesCounter();
        });

        // ==================== EXAMPLE IMAGES GENERATION ====================
        function generateExampleImages() {
            // Check if example canvases exist
            if (!document.getElementById('exampleCanvas0')) {
                console.log('Example canvases not found, skipping generation');
                return;
            }

            // 0: Rainbow Gradient
            const canvas0 = document.getElementById('exampleCanvas0');
            if (!canvas0) return;
            const ctx0 = canvas0.getContext('2d');
            const gradient0 = ctx0.createLinearGradient(0, 0, 150, 0);
            gradient0.addColorStop(0, '#ff0000');
            gradient0.addColorStop(0.17, '#ff7f00');
            gradient0.addColorStop(0.33, '#ffff00');
            gradient0.addColorStop(0.5, '#00ff00');
            gradient0.addColorStop(0.67, '#0000ff');
            gradient0.addColorStop(0.83, '#4b0082');
            gradient0.addColorStop(1, '#9400d3');
            ctx0.fillStyle = gradient0;
            ctx0.fillRect(0, 0, 150, 150);

            // 1: Checkerboard
            const ctx1 = document.getElementById('exampleCanvas1').getContext('2d');
            const squareSize = 15;
            for (let y = 0; y < 150; y += squareSize) {
                for (let x = 0; x < 150; x += squareSize) {
                    ctx1.fillStyle = ((x / squareSize) + (y / squareSize)) % 2 === 0 ? '#000' : '#fff';
                    ctx1.fillRect(x, y, squareSize, squareSize);
                }
            }

            // 2: Geometric Spiral
            const ctx2 = document.getElementById('exampleCanvas2').getContext('2d');
            ctx2.fillStyle = '#f0f0f0';
            ctx2.fillRect(0, 0, 150, 150);
            ctx2.strokeStyle = '#2d5f4f';
            ctx2.lineWidth = 2;
            ctx2.beginPath();
            const centerX = 75, centerY = 75;
            let angle = 0;
            let radius = 0;
            ctx2.moveTo(centerX, centerY);
            while (radius < 70) {
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                ctx2.lineTo(x, y);
                angle += 0.1;
                radius += 0.3;
            }
            ctx2.stroke();

            // 3: Vertical Lines
            const ctx3 = document.getElementById('exampleCanvas3').getContext('2d');
            ctx3.fillStyle = '#fff';
            ctx3.fillRect(0, 0, 150, 150);
            for (let x = 0; x < 150; x += 10) {
                const brightness = Math.floor((x / 150) * 255);
                ctx3.fillStyle = `rgb(${brightness}, ${brightness}, ${brightness})`;
                ctx3.fillRect(x, 0, 10, 150);
            }

            // 4: Abstract Art (Random Circles)
            const ctx4 = document.getElementById('exampleCanvas4').getContext('2d');
            ctx4.fillStyle = '#1a1a1a';
            ctx4.fillRect(0, 0, 150, 150);
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * 150;
                const y = Math.random() * 150;
                const r = Math.random() * 30 + 10;
                const hue = Math.random() * 360;
                ctx4.fillStyle = `hsla(${hue}, 80%, 60%, 0.5)`;
                ctx4.beginPath();
                ctx4.arc(x, y, r, 0, Math.PI * 2);
                ctx4.fill();
            }

            // 5: Sine Wave
            const ctx5 = document.getElementById('exampleCanvas5').getContext('2d');
            ctx5.fillStyle = '#fff';
            ctx5.fillRect(0, 0, 150, 150);
            ctx5.strokeStyle = '#2d5f4f';
            ctx5.lineWidth = 3;
            ctx5.beginPath();
            for (let x = 0; x < 150; x++) {
                const y = 75 + Math.sin(x / 10) * 40;
                if (x === 0) ctx5.moveTo(x, y);
                else ctx5.lineTo(x, y);
            }
            ctx5.stroke();

            // Add more waves with different frequencies
            ctx5.strokeStyle = '#8ba888';
            ctx5.lineWidth = 2;
            ctx5.beginPath();
            for (let x = 0; x < 150; x++) {
                const y = 75 + Math.sin(x / 5) * 20;
                if (x === 0) ctx5.moveTo(x, y);
                else ctx5.lineTo(x, y);
            }
            ctx5.stroke();

            // 6: Circular Pattern (Mandala-like)
            const ctx6 = document.getElementById('exampleCanvas6').getContext('2d');
            ctx6.fillStyle = '#fff';
            ctx6.fillRect(0, 0, 150, 150);
            const cx = 75, cy = 75;
            for (let r = 10; r < 70; r += 10) {
                const hue = (r / 70) * 360;
                ctx6.strokeStyle = `hsl(${hue}, 70%, 50%)`;
                ctx6.lineWidth = 3;
                ctx6.beginPath();
                ctx6.arc(cx, cy, r, 0, Math.PI * 2);
                ctx6.stroke();
            }

            // 7: QR-like Pattern
            const ctx7 = document.getElementById('exampleCanvas7').getContext('2d');
            ctx7.fillStyle = '#fff';
            ctx7.fillRect(0, 0, 150, 150);
            ctx7.fillStyle = '#000';
            const blockSize = 10;
            for (let y = 0; y < 150; y += blockSize) {
                for (let x = 0; x < 150; x += blockSize) {
                    if (Math.random() > 0.5) {
                        ctx7.fillRect(x, y, blockSize, blockSize);
                    }
                }
            }

            // 8: Sunset Gradient
            const ctx8 = document.getElementById('exampleCanvas8').getContext('2d');
            const gradient8 = ctx8.createLinearGradient(0, 0, 0, 150);
            gradient8.addColorStop(0, '#ff6b35');
            gradient8.addColorStop(0.3, '#f7931e');
            gradient8.addColorStop(0.5, '#fdc830');
            gradient8.addColorStop(0.7, '#f37335');
            gradient8.addColorStop(1, '#4a148c');
            ctx8.fillStyle = gradient8;
            ctx8.fillRect(0, 0, 150, 150);

            // 9: Noise Texture
            const ctx9 = document.getElementById('exampleCanvas9').getContext('2d');
            const imageData = ctx9.createImageData(150, 150);
            for (let i = 0; i < imageData.data.length; i += 4) {
                const noise = Math.random() * 255;
                imageData.data[i] = noise;     // R
                imageData.data[i + 1] = noise; // G
                imageData.data[i + 2] = noise; // B
                imageData.data[i + 3] = 255;   // A
            }
            ctx9.putImageData(imageData, 0, 0);
        }

        function loadExampleImage(index) {
            const exampleCanvas = document.getElementById(`exampleCanvas${index}`);

            // Load the example into the main image canvas
            imgCanvas = document.getElementById('imageCanvas');
            imgCtx = imgCanvas.getContext('2d');

            // Set canvas size to match example
            const size = 400; // Larger for better quality
            imgCanvas.width = size;
            imgCanvas.height = size;
            imageWidth = size;
            imageHeight = size;

            // Regenerate the image at higher resolution
            regenerateExampleImage(index, imgCtx, size);

            // Get image data
            imgData = imgCtx.getImageData(0, 0, size, size);

            // Show canvas and controls
            document.getElementById('imageCanvasContainer').style.display = 'block';
            document.getElementById('sonificationControls').style.display = 'block';

            // Update scan line height
            document.getElementById('scanLine').style.height = size + 'px';
        }

        // Load example image and navigate to Image Sonification section
        function loadExampleImageAndNavigate(index) {
            // Load the image first
            loadExampleImage(index);

            // Navigate to imagesonification section
            showSection('imagesonification');
        }

        function regenerateExampleImage(index, ctx, size) {
            switch(index) {
                case 0: // Rainbow
                    const gradient0 = ctx.createLinearGradient(0, 0, size, 0);
                    gradient0.addColorStop(0, '#ff0000');
                    gradient0.addColorStop(0.17, '#ff7f00');
                    gradient0.addColorStop(0.33, '#ffff00');
                    gradient0.addColorStop(0.5, '#00ff00');
                    gradient0.addColorStop(0.67, '#0000ff');
                    gradient0.addColorStop(0.83, '#4b0082');
                    gradient0.addColorStop(1, '#9400d3');
                    ctx.fillStyle = gradient0;
                    ctx.fillRect(0, 0, size, size);
                    break;

                case 1: // Checkerboard
                    const squareSize = Math.floor(size / 10);
                    for (let y = 0; y < size; y += squareSize) {
                        for (let x = 0; x < size; x += squareSize) {
                            ctx.fillStyle = ((x / squareSize) + (y / squareSize)) % 2 === 0 ? '#000' : '#fff';
                            ctx.fillRect(x, y, squareSize, squareSize);
                        }
                    }
                    break;

                case 2: // Spiral
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, size, size);
                    ctx.strokeStyle = '#2d5f4f';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    const centerX = size / 2, centerY = size / 2;
                    let angle = 0, radius = 0;
                    ctx.moveTo(centerX, centerY);
                    while (radius < size / 2 - 20) {
                        const x = centerX + radius * Math.cos(angle);
                        const y = centerY + radius * Math.sin(angle);
                        ctx.lineTo(x, y);
                        angle += 0.1;
                        radius += 0.8;
                    }
                    ctx.stroke();
                    break;

                case 3: // Vertical Lines
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    for (let x = 0; x < size; x += size / 15) {
                        const brightness = Math.floor((x / size) * 255);
                        ctx.fillStyle = `rgb(${brightness}, ${brightness}, ${brightness})`;
                        ctx.fillRect(x, 0, size / 15, size);
                    }
                    break;

                case 4: // Abstract Art
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(0, 0, size, size);
                    for (let i = 0; i < 50; i++) {
                        const x = Math.random() * size;
                        const y = Math.random() * size;
                        const r = Math.random() * 80 + 20;
                        const hue = Math.random() * 360;
                        ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.5)`;
                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;

                case 5: // Sine Wave
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    ctx.strokeStyle = '#2d5f4f';
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    for (let x = 0; x < size; x++) {
                        const y = size / 2 + Math.sin(x / 30) * (size / 4);
                        if (x === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    ctx.strokeStyle = '#8ba888';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    for (let x = 0; x < size; x++) {
                        const y = size / 2 + Math.sin(x / 15) * (size / 8);
                        if (x === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    break;

                case 6: // Circular Pattern
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    const cx = size / 2, cy = size / 2;
                    for (let r = 20; r < size / 2 - 20; r += 20) {
                        const hue = (r / (size / 2)) * 360;
                        ctx.strokeStyle = `hsl(${hue}, 70%, 50%)`;
                        ctx.lineWidth = 5;
                        ctx.beginPath();
                        ctx.arc(cx, cy, r, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    break;

                case 7: // QR-like
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, size, size);
                    ctx.fillStyle = '#000';
                    const blockSize = Math.floor(size / 15);
                    for (let y = 0; y < size; y += blockSize) {
                        for (let x = 0; x < size; x += blockSize) {
                            if (Math.random() > 0.5) {
                                ctx.fillRect(x, y, blockSize, blockSize);
                            }
                        }
                    }
                    break;

                case 8: // Sunset
                    const gradient8 = ctx.createLinearGradient(0, 0, 0, size);
                    gradient8.addColorStop(0, '#ff6b35');
                    gradient8.addColorStop(0.3, '#f7931e');
                    gradient8.addColorStop(0.5, '#fdc830');
                    gradient8.addColorStop(0.7, '#f37335');
                    gradient8.addColorStop(1, '#4a148c');
                    ctx.fillStyle = gradient8;
                    ctx.fillRect(0, 0, size, size);
                    break;

                case 9: // Noise
                    const imageData = ctx.createImageData(size, size);
                    for (let i = 0; i < imageData.data.length; i += 4) {
                        const noise = Math.random() * 255;
                        imageData.data[i] = noise;
                        imageData.data[i + 1] = noise;
                        imageData.data[i + 2] = noise;
                        imageData.data[i + 3] = 255;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
            }
        }

        // ==================== IMAGE SONIFICATION ====================
        let imgCanvas, imgCtx, imgData;
        let sonificationContext, sonificationOscillators = [];
        let sonificationInterval, isPaused = false, currentPosition = 0;
        let imageWidth, imageHeight;
        let masterCompressor, masterReverb, reverbGain;

        // Tone.js Samplers for high-quality instruments
        let toneSynths = {};
        let toneInitialized = false;

        // Initialize Tone.js instruments
        async function initializeToneSynths() {
            if (toneInitialized) return;

            console.log('🎹 Initializing Tone.js instruments...');

            // Start Tone.js audio context
            await Tone.start();
            console.log('✅ Tone.start() completed, context state:', Tone.context.state);

            // Create simple synths first (more reliable)
            toneSynths.piano = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths.piano.set({
                oscillator: { type: "sine" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
            });

            toneSynths['synth-pad'] = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths['synth-pad'].set({
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.3, decay: 0.4, sustain: 0.7, release: 2.0 }
            });

            toneSynths.bass = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths.bass.set({
                oscillator: { type: "square" },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.8 }
            });

            toneSynths.bells = new Tone.PolySynth(Tone.FMSynth).toDestination();
            toneSynths.bells.set({
                harmonicity: 8,
                modulationIndex: 2,
                envelope: { attack: 0.001, decay: 2, sustain: 0.1, release: 2 }
            });

            toneSynths.pluck = new Tone.PolySynth(Tone.Synth).toDestination();
            toneSynths.pluck.set({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.2 }
            });

            // Set LOUD volume for all synths
            Object.values(toneSynths).forEach(synth => {
                synth.volume.value = 0; // 0 dB = full volume
            });

            toneInitialized = true;
            console.log('✅ Tone.js instruments ready!');

            // Test sound
            console.log('🔊 Testing piano with C4...');
            toneSynths.piano.triggerAttackRelease("C4", "8n");
            console.log('✅ Test note triggered');
        }

        // Load Image
        const imageInput = document.getElementById('imageInput');
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Setup canvas
                    imgCanvas = document.getElementById('imageCanvas');
                    imgCtx = imgCanvas.getContext('2d');

                    // Resize image to reasonable size (max 800px width)
                    const maxWidth = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        const ratio = maxWidth / width;
                        width = maxWidth;
                        height = height * ratio;
                    }

                    imgCanvas.width = width;
                    imgCanvas.height = height;
                    imageWidth = width;
                    imageHeight = height;

                    // Draw image
                    imgCtx.drawImage(img, 0, 0, width, height);
                    imgData = imgCtx.getImageData(0, 0, width, height);

                    // Show canvas and controls
                    document.getElementById('imageCanvasContainer').style.display = 'block';
                    document.getElementById('sonificationControls').style.display = 'block';

                    // Update scan line height
                    document.getElementById('scanLine').style.height = height + 'px';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            });
        }

        // Clear Image
        const clearImageBtn = document.getElementById('clearImageBtn');
        if (clearImageBtn) {
            clearImageBtn.addEventListener('click', function() {
            document.getElementById('imageCanvasContainer').style.display = 'none';
            document.getElementById('sonificationControls').style.display = 'none';
            document.getElementById('imageInput').value = '';
            stopSonification();
            });
        }

        // Speed Slider
        const scanSpeed = document.getElementById('scanSpeed');
        if (scanSpeed) {
            scanSpeed.addEventListener('input', function(e) {
                document.getElementById('speedValue').textContent = parseFloat(e.target.value).toFixed(1) + 'x';
            });
        }

        // Filter Cutoff Slider
        const filterCutoff = document.getElementById('filterCutoff');
        if (filterCutoff) {
            filterCutoff.addEventListener('input', function(e) {
                document.getElementById('filterValue').textContent = e.target.value + ' Hz';
            });
        }

        // Resonance Slider
        const resonance = document.getElementById('resonance');
        if (resonance) {
            resonance.addEventListener('input', function(e) {
                document.getElementById('resonanceValue').textContent = parseFloat(e.target.value).toFixed(1);
            });
        }

        // Attack Slider
        const attackTime = document.getElementById('attackTime');
        if (attackTime) {
            attackTime.addEventListener('input', function(e) {
                document.getElementById('attackValue').textContent = parseFloat(e.target.value).toFixed(3) + 's';
            });
        }

        // Release Slider
        const releaseTime = document.getElementById('releaseTime');
        if (releaseTime) {
            releaseTime.addEventListener('input', function(e) {
                document.getElementById('releaseValue').textContent = parseFloat(e.target.value).toFixed(2) + 's';
            });
        }

        // Musical Scales Toggle
        const useMusicalScales = document.getElementById('useMusicalScales');
        if (useMusicalScales) {
            useMusicalScales.addEventListener('change', function(e) {
                const scaleControls = document.getElementById('scaleControls');
                if (scaleControls) {
                    scaleControls.style.display = e.target.checked ? 'grid' : 'none';
                }
            });
        }

        // Musical Scales Definitions (in semitones from root)
        const musicalScales = {
            // Major modes
            major: [0, 2, 4, 5, 7, 9, 11],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],

            // Minor modes
            minor: [0, 2, 3, 5, 7, 8, 10],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            harmonic_minor: [0, 2, 3, 5, 7, 8, 11],
            melodic_minor: [0, 2, 3, 5, 7, 9, 11],

            // Pentatonic
            pentatonic_major: [0, 2, 4, 7, 9],
            pentatonic_minor: [0, 3, 5, 7, 10],

            // Blues & Jazz
            blues: [0, 3, 5, 6, 7, 10],
            bebop_major: [0, 2, 4, 5, 7, 8, 9, 11],
            bebop_minor: [0, 2, 3, 5, 7, 8, 9, 10],

            // Mediorientali/Arabe
            arabic: [0, 1, 4, 5, 7, 8, 11],          // Maqam Hijaz
            persian: [0, 1, 4, 5, 6, 8, 11],         // Dastgah
            hijaz: [0, 1, 4, 5, 7, 8, 10],           // Hijaz

            // Indiane (Raga)
            raga_bhairav: [0, 1, 4, 5, 7, 8, 11],   // Alba
            raga_todi: [0, 1, 3, 6, 7, 8, 11],       // Mezzogiorno
            raga_yaman: [0, 2, 4, 6, 7, 9, 11],     // Sera

            // Giapponesi
            japanese_in: [0, 1, 5, 7, 8],            // In (misteriosa)
            japanese_yo: [0, 2, 5, 7, 9],            // Yo (allegra)
            japanese_hirajoshi: [0, 2, 3, 7, 8],     // Hirajōshi

            // Africane
            african_1: [0, 2, 3, 5, 7, 9, 10],       // Africana comune
            african_2: [0, 3, 5, 7, 10],             // Pentatonica africana

            // Esotiche/Moderne
            whole_tone: [0, 2, 4, 6, 8, 10],         // Debussy
            diminished: [0, 2, 3, 5, 6, 8, 9, 11],   // Jazz
            augmented: [0, 3, 4, 7, 8, 11],
            spanish: [0, 1, 3, 4, 5, 6, 8, 10],      // Flamenco
            gypsy: [0, 2, 3, 6, 7, 8, 11],

            // Altre
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            whole_half: [0, 2, 3, 5, 6, 8, 9, 11]
        };

        // Function to quantize frequency to nearest note in scale
        function quantizeToScale(frequency, scaleName, keyOffset, octaveRange) {
            const scale = musicalScales[scaleName];
            if (!scale) return frequency;

            // Convert frequency to MIDI note number
            const midiNote = 12 * Math.log2(frequency / 440) + 69;

            // Get the scale notes across all octaves
            const baseOctave = Math.floor(midiNote / 12) - Math.floor(octaveRange / 2);
            const scaleNotes = [];

            for (let oct = 0; oct < octaveRange + 1; oct++) {
                for (let i = 0; i < scale.length; i++) {
                    const note = (baseOctave + oct) * 12 + scale[i] + parseInt(keyOffset);
                    scaleNotes.push(note);
                }
            }

            // Find closest scale note
            let closestNote = scaleNotes[0];
            let minDistance = Math.abs(midiNote - closestNote);

            for (let i = 1; i < scaleNotes.length; i++) {
                const distance = Math.abs(midiNote - scaleNotes[i]);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestNote = scaleNotes[i];
                }
            }

            // Convert back to frequency
            return 440 * Math.pow(2, (closestNote - 69) / 12);
        }

        // Play Sonification
        const playSonificationBtn = document.getElementById('playSonificationBtn');
        if (playSonificationBtn) {
            playSonificationBtn.addEventListener('click', function() {
                startSonification();
            });
        }

        // Stop Sonification
        const stopSonificationBtn = document.getElementById('stopSonificationBtn');
        if (stopSonificationBtn) {
            stopSonificationBtn.addEventListener('click', function() {
                stopSonification();
            });
        }

        // Pause Sonification
        const pauseSonificationBtn = document.getElementById('pauseSonificationBtn');
        if (pauseSonificationBtn) {
            pauseSonificationBtn.addEventListener('click', function() {
                pauseSonification();
            });
        }

        // Resume Sonification
        const resumeSonificationBtn = document.getElementById('resumeSonificationBtn');
        if (resumeSonificationBtn) {
            resumeSonificationBtn.addEventListener('click', function() {
                resumeSonification();
            });
        }

        async function startSonification() {
            if (!imgData) {
                alert('Carica prima un\'immagine!');
                return;
            }

            try {
                // Initialize Tone.js instruments first
                await initializeToneSynths();
                console.log('✅ Tone.js initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing Tone.js:', error);
            }

            // Initialize Audio Context
            if (!sonificationContext) {
                sonificationContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create master compressor for better dynamics
                masterCompressor = sonificationContext.createDynamicsCompressor();
                masterCompressor.threshold.value = -24;
                masterCompressor.knee.value = 30;
                masterCompressor.ratio.value = 12;
                masterCompressor.attack.value = 0.003;
                masterCompressor.release.value = 0.25;

                // Create reverb using ConvolverNode
                masterReverb = sonificationContext.createConvolver();
                reverbGain = sonificationContext.createGain();
                reverbGain.gain.value = 0.15; // Mix leggero di reverb

                // Generate impulse response for reverb
                const reverbLength = sonificationContext.sampleRate * 2; // 2 secondi
                const impulse = sonificationContext.createBuffer(2, reverbLength, sonificationContext.sampleRate);
                const impulseL = impulse.getChannelData(0);
                const impulseR = impulse.getChannelData(1);

                for (let i = 0; i < reverbLength; i++) {
                    const decay = Math.pow(1 - i / reverbLength, 2);
                    impulseL[i] = (Math.random() * 2 - 1) * decay;
                    impulseR[i] = (Math.random() * 2 - 1) * decay;
                }
                masterReverb.buffer = impulse;

                // Connect reverb chain: reverb -> reverbGain -> compressor -> destination
                masterReverb.connect(reverbGain);
                reverbGain.connect(masterCompressor);
                masterCompressor.connect(sonificationContext.destination);
            }

            // Reset position
            currentPosition = 0;

            // Update UI
            document.getElementById('playSonificationBtn').style.display = 'none';
            document.getElementById('stopSonificationBtn').style.display = 'inline-block';
            document.getElementById('pauseSonificationBtn').style.display = 'inline-block';
            document.getElementById('resumeSonificationBtn').style.display = 'none';
            document.getElementById('scanLine').style.display = 'block';

            // Get parameters
            const scanMode = document.getElementById('scanMode').value;
            const speed = parseFloat(document.getElementById('scanSpeed').value);
            const mappingMode = document.getElementById('mappingMode').value;

            // Start scanning
            isPaused = false;
            scanImage(scanMode, speed, mappingMode);
        }

        function stopSonification() {
            // Stop interval
            if (sonificationInterval) {
                clearInterval(sonificationInterval);
                sonificationInterval = null;
            }

            // Stop all oscillators
            sonificationOscillators.forEach(osc => {
                try {
                    osc.stop();
                } catch (e) {}
            });
            sonificationOscillators = [];

            // Stop all Tone.js synths
            if (toneInitialized) {
                Object.values(toneSynths).forEach(synth => {
                    synth.releaseAll();
                });
            }

            // Reset UI
            document.getElementById('playSonificationBtn').style.display = 'inline-block';
            document.getElementById('stopSonificationBtn').style.display = 'none';
            document.getElementById('pauseSonificationBtn').style.display = 'none';
            document.getElementById('resumeSonificationBtn').style.display = 'none';
            document.getElementById('scanLine').style.display = 'none';
            document.getElementById('sonificationProgress').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';

            currentPosition = 0;
            isPaused = false;
        }

        function pauseSonification() {
            isPaused = true;
            if (sonificationInterval) {
                clearInterval(sonificationInterval);
                sonificationInterval = null;
            }

            sonificationOscillators.forEach(osc => {
                try {
                    osc.stop();
                } catch (e) {}
            });
            sonificationOscillators = [];

            // Stop all Tone.js synths
            if (toneInitialized) {
                Object.values(toneSynths).forEach(synth => {
                    synth.releaseAll();
                });
            }

            document.getElementById('pauseSonificationBtn').style.display = 'none';
            document.getElementById('resumeSonificationBtn').style.display = 'inline-block';
        }

        function resumeSonification() {
            isPaused = false;
            const scanMode = document.getElementById('scanMode').value;
            const speed = parseFloat(document.getElementById('scanSpeed').value);
            const mappingMode = document.getElementById('mappingMode').value;

            document.getElementById('pauseSonificationBtn').style.display = 'inline-block';
            document.getElementById('resumeSonificationBtn').style.display = 'none';

            scanImage(scanMode, speed, mappingMode);
        }

        function scanImage(scanMode, speed, mappingMode) {
            const baseInterval = 20; // ms per column/row
            const interval = baseInterval / speed;

            sonificationInterval = setInterval(() => {
                if (isPaused) return;

                if (scanMode === 'horizontal') {
                    if (currentPosition >= imageWidth) {
                        stopSonification();
                        return;
                    }

                    // Get column data
                    const columnData = getColumnData(currentPosition);

                    // Sonify column
                    sonifyData(columnData, currentPosition / imageWidth, mappingMode);

                    // Update scan line
                    const scanLine = document.getElementById('scanLine');
                    scanLine.style.left = currentPosition + 'px';

                    // Update progress
                    const progress = (currentPosition / imageWidth) * 100;
                    document.getElementById('sonificationProgress').style.width = progress + '%';
                    document.getElementById('progressText').textContent = Math.round(progress) + '%';

                    currentPosition++;

                } else if (scanMode === 'vertical') {
                    if (currentPosition >= imageHeight) {
                        stopSonification();
                        return;
                    }

                    // Get row data
                    const rowData = getRowData(currentPosition);

                    // Sonify row
                    sonifyData(rowData, currentPosition / imageHeight, mappingMode);

                    // Update scan line (rotate for vertical)
                    const scanLine = document.getElementById('scanLine');
                    scanLine.style.width = imageWidth + 'px';
                    scanLine.style.height = '2px';
                    scanLine.style.top = currentPosition + 'px';
                    scanLine.style.left = '0px';

                    // Update progress
                    const progress = (currentPosition / imageHeight) * 100;
                    document.getElementById('sonificationProgress').style.width = progress + '%';
                    document.getElementById('progressText').textContent = Math.round(progress) + '%';

                    currentPosition++;
                }

            }, interval);
        }

        function getColumnData(x) {
            const data = [];
            for (let y = 0; y < imageHeight; y++) {
                const index = (y * imageWidth + x) * 4;
                const r = imgData.data[index];
                const g = imgData.data[index + 1];
                const b = imgData.data[index + 2];
                data.push({ r, g, b, y });
            }
            return data;
        }

        function getRowData(y) {
            const data = [];
            for (let x = 0; x < imageWidth; x++) {
                const index = (y * imageWidth + x) * 4;
                const r = imgData.data[index];
                const g = imgData.data[index + 1];
                const b = imgData.data[index + 2];
                data.push({ r, g, b, x });
            }
            return data;
        }

        function sonifyData(pixelData, progress, mappingMode) {
            // Stop previous oscillators
            sonificationOscillators.forEach(osc => {
                try {
                    osc.stop();
                } catch (e) {}
            });
            sonificationOscillators = [];

            // Get all parameters
            const freqRangeSelect = document.getElementById('freqRange').value;
            const synthesisType = document.getElementById('synthesisType').value;
            const filterCutoff = parseFloat(document.getElementById('filterCutoff').value);
            const resonance = parseFloat(document.getElementById('resonance').value);
            const attackTime = parseFloat(document.getElementById('attackTime').value);
            const releaseTime = parseFloat(document.getElementById('releaseTime').value);

            // Musical scales parameters
            const useScales = document.getElementById('useMusicalScales').checked;
            const scaleName = document.getElementById('musicalScale').value;
            const keyOffset = document.getElementById('musicalKey').value;
            const octaveRange = parseInt(document.getElementById('octaveRange').value);

            let minFreq, maxFreq;
            switch(freqRangeSelect) {
                case 'low': minFreq = 50; maxFreq = 200; break;
                case 'mid': minFreq = 200; maxFreq = 1000; break;
                case 'high': minFreq = 1000; maxFreq = 4000; break;
                case 'full': minFreq = 50; maxFreq = 4000; break;
                default: minFreq = 200; maxFreq = 1000;
            }

            const now = sonificationContext.currentTime;
            const duration = attackTime + releaseTime;

            if (mappingMode === 'brightness') {
                // Brightness mode: average brightness → single frequency
                let totalBrightness = 0;
                pixelData.forEach(pixel => {
                    const brightness = (pixel.r + pixel.g + pixel.b) / 3;
                    totalBrightness += brightness;
                });
                const avgBrightness = totalBrightness / pixelData.length;
                const normalizedBrightness = avgBrightness / 255;
                let frequency = minFreq + (normalizedBrightness * (maxFreq - minFreq));

                // Apply musical scale quantization if enabled
                if (useScales) {
                    frequency = quantizeToScale(frequency, scaleName, keyOffset, octaveRange);
                }

                createSynthVoice(frequency, normalizedBrightness, 0, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);

            } else if (mappingMode === 'color') {
                // Color mode: RGB → 3 separate voices
                let totalR = 0, totalG = 0, totalB = 0;
                pixelData.forEach(pixel => {
                    totalR += pixel.r;
                    totalG += pixel.g;
                    totalB += pixel.b;
                });

                const avgR = totalR / pixelData.length / 255;
                const avgG = totalG / pixelData.length / 255;
                const avgB = totalB / pixelData.length / 255;

                let freqR = minFreq + (avgR * (maxFreq - minFreq));
                let freqG = minFreq + (avgG * (maxFreq - minFreq));
                let freqB = minFreq + (avgB * (maxFreq - minFreq));

                // Apply musical scale quantization if enabled
                if (useScales) {
                    freqR = quantizeToScale(freqR, scaleName, keyOffset, octaveRange);
                    freqG = quantizeToScale(freqG, scaleName, keyOffset, octaveRange);
                    freqB = quantizeToScale(freqB, scaleName, keyOffset, octaveRange);
                }

                // Create separate voices for R, G, B
                createSynthVoice(freqR, avgR, -0.3, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);
                createSynthVoice(freqG, avgG, 0, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);
                createSynthVoice(freqB, avgB, 0.3, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);

            } else if (mappingMode === 'position') {
                // Position mode: vertical position → frequency, horizontal → pan
                let totalBrightness = 0;
                let weightedPosition = 0;

                pixelData.forEach(pixel => {
                    const brightness = (pixel.r + pixel.g + pixel.b) / 3;
                    totalBrightness += brightness;
                    const pos = pixel.y !== undefined ? pixel.y : pixel.x;
                    weightedPosition += pos * brightness;
                });

                const avgBrightness = totalBrightness / pixelData.length;
                const avgPosition = weightedPosition / totalBrightness;
                const maxPos = pixelData[0].y !== undefined ? imageHeight : imageWidth;
                const normalizedPos = avgPosition / maxPos;
                let frequency = minFreq + (normalizedPos * (maxFreq - minFreq));
                const panValue = (progress * 2) - 1; // -1 to 1

                // Apply musical scale quantization if enabled
                if (useScales) {
                    frequency = quantizeToScale(frequency, scaleName, keyOffset, octaveRange);
                }

                createSynthVoice(frequency, avgBrightness / 255, panValue, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration);
            }
        }

        function createSynthVoice(frequency, intensity, pan, synthesisType, filterCutoff, resonance, attackTime, releaseTime, now, duration) {
            // Check if using Tone.js sampled instruments
            const toneSynthTypes = ['piano', 'synth-pad', 'bass', 'bells', 'pluck'];
            if (toneSynthTypes.includes(synthesisType)) {
                // Tone.js should already be initialized in startSonification
                if (!toneInitialized) {
                    console.warn('⚠️ Tone.js not initialized yet');
                    return;
                }

                // Convert frequency to note name
                const midiNote = 12 * Math.log2(frequency / 440) + 69;
                const noteName = Tone.Frequency(Math.round(midiNote), "midi").toNote();

                // Calculate velocity from intensity (0-1)
                const velocity = Math.max(0.1, Math.min(1, intensity * 1.5));

                // Schedule note with Tone.js
                const synth = toneSynths[synthesisType];
                if (synth) {
                    // Trigger note immediately with duration
                    // Tone.js uses seconds for duration, so we use duration directly
                    synth.triggerAttackRelease(noteName, duration, "+0", velocity);
                    console.log(`🎵 Playing ${noteName} on ${synthesisType} (velocity: ${velocity.toFixed(2)})`);
                } else {
                    console.error(`❌ Synth not found: ${synthesisType}`);
                }

                return; // Exit early, Tone.js handles everything
            }

            // Web Audio API synthesis (original code)
            const gainValue = intensity * 0.2; // Ridotto per headroom del compressore

            // Migliora attack e release per evitare click
            const improvedAttack = Math.max(attackTime, 0.01); // Minimo 10ms
            const improvedRelease = Math.max(releaseTime, 0.05); // Minimo 50ms

            if (synthesisType === 'pure') {
                // Pure sine wave
                const osc = sonificationContext.createOscillator();
                const filter = sonificationContext.createBiquadFilter();
                const gain = sonificationContext.createGain();
                const panner = sonificationContext.createStereoPanner();
                const dryGain = sonificationContext.createGain();
                const wetGain = sonificationContext.createGain();

                osc.type = 'sine';
                osc.frequency.value = frequency;

                // Filter
                filter.type = 'lowpass';
                filter.frequency.value = filterCutoff;
                filter.Q.value = resonance;

                // Envelope migliorato
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(gainValue, now + improvedAttack);
                gain.gain.setValueAtTime(gainValue, now + duration - improvedRelease);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                panner.pan.value = pan;

                // Dry/Wet mix: 80% dry, 20% wet
                dryGain.gain.value = 0.8;
                wetGain.gain.value = 0.2;

                // Routing: osc -> filter -> gain -> panner -> [dry->compressor, wet->reverb]
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(panner);

                panner.connect(dryGain);
                panner.connect(wetGain);

                dryGain.connect(masterCompressor);
                wetGain.connect(masterReverb);

                osc.start(now);
                osc.stop(now + duration);
                sonificationOscillators.push(osc);

            } else if (synthesisType === 'harmonic') {
                // Additive synthesis with harmonics (migliorato)
                const harmonics = [1, 2, 3, 4, 5, 6];
                const harmAmps = [1.0, 0.6, 0.4, 0.25, 0.15, 0.1];

                harmonics.forEach((harmonic, i) => {
                    const osc = sonificationContext.createOscillator();
                    const filter = sonificationContext.createBiquadFilter();
                    const gain = sonificationContext.createGain();
                    const panner = sonificationContext.createStereoPanner();
                    const dryGain = sonificationContext.createGain();
                    const wetGain = sonificationContext.createGain();

                    osc.type = 'sine';
                    osc.frequency.value = frequency * harmonic;

                    // Filter
                    filter.type = 'lowpass';
                    filter.frequency.value = filterCutoff;
                    filter.Q.value = resonance;

                    // Envelope migliorato per ogni armonica
                    const harmGain = gainValue * harmAmps[i];
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(harmGain, now + improvedAttack);
                    gain.gain.setValueAtTime(harmGain, now + duration - improvedRelease);
                    gain.gain.linearRampToValueAtTime(0, now + duration);

                    panner.pan.value = pan + (Math.random() * 0.1 - 0.05); // Leggero stereo spread

                    // Dry/Wet mix
                    dryGain.gain.value = 0.8;
                    wetGain.gain.value = 0.2;

                    // Routing
                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(panner);

                    panner.connect(dryGain);
                    panner.connect(wetGain);

                    dryGain.connect(masterCompressor);
                    wetGain.connect(masterReverb);

                    osc.start(now);
                    osc.stop(now + duration);
                    sonificationOscillators.push(osc);
                });

            } else if (synthesisType === 'filtered') {
                // Sawtooth with lowpass filter
                const osc = sonificationContext.createOscillator();
                const filter = sonificationContext.createBiquadFilter();
                const gain = sonificationContext.createGain();
                const panner = sonificationContext.createStereoPanner();
                const dryGain = sonificationContext.createGain();
                const wetGain = sonificationContext.createGain();

                osc.type = 'sawtooth';
                osc.frequency.value = frequency;

                filter.type = 'lowpass';
                filter.frequency.value = filterCutoff;
                filter.Q.value = resonance;

                // Envelope migliorato
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(gainValue, now + improvedAttack);
                gain.gain.setValueAtTime(gainValue, now + duration - improvedRelease);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                panner.pan.value = pan;

                // Dry/Wet mix
                dryGain.gain.value = 0.8;
                wetGain.gain.value = 0.2;

                // Routing
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(panner);

                panner.connect(dryGain);
                panner.connect(wetGain);

                dryGain.connect(masterCompressor);
                wetGain.connect(masterReverb);

                osc.start(now);
                osc.stop(now + duration);
                sonificationOscillators.push(osc);

            } else if (synthesisType === 'rich') {
                // Multi-harmonic rich sound
                const harmonics = [1, 1.5, 2, 2.5, 3, 4, 5, 6];
                const harmAmps = [1.0, 0.6, 0.5, 0.3, 0.25, 0.2, 0.15, 0.1];

                harmonics.forEach((harmonic, i) => {
                    const osc = sonificationContext.createOscillator();
                    const filter = sonificationContext.createBiquadFilter();
                    const gain = sonificationContext.createGain();
                    const panner = sonificationContext.createStereoPanner();
                    const dryGain = sonificationContext.createGain();
                    const wetGain = sonificationContext.createGain();

                    osc.type = i % 2 === 0 ? 'sine' : 'triangle';
                    osc.frequency.value = frequency * harmonic;

                    // Filter
                    filter.type = 'lowpass';
                    filter.frequency.value = filterCutoff;
                    filter.Q.value = resonance;

                    // Envelope migliorato
                    const harmGain = gainValue * harmAmps[i] * 0.4;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(harmGain, now + improvedAttack);
                    gain.gain.setValueAtTime(harmGain, now + duration - improvedRelease);
                    gain.gain.linearRampToValueAtTime(0, now + duration);

                    panner.pan.value = pan + (Math.random() * 0.2 - 0.1);

                    // Dry/Wet mix
                    dryGain.gain.value = 0.75;
                    wetGain.gain.value = 0.25;

                    // Routing
                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(panner);

                    panner.connect(dryGain);
                    panner.connect(wetGain);

                    dryGain.connect(masterCompressor);
                    wetGain.connect(masterReverb);

                    osc.start(now);
                    osc.stop(now + duration);
                    sonificationOscillators.push(osc);
                });

            } else if (synthesisType === 'granular') {
                // Granular synthesis simulation
                const grains = 5;
                const grainDuration = duration / 3;

                for (let g = 0; g < grains; g++) {
                    const osc = sonificationContext.createOscillator();
                    const filter = sonificationContext.createBiquadFilter();
                    const gain = sonificationContext.createGain();
                    const panner = sonificationContext.createStereoPanner();
                    const dryGain = sonificationContext.createGain();
                    const wetGain = sonificationContext.createGain();

                    const freqVariation = frequency * (0.98 + Math.random() * 0.04);
                    osc.type = 'sine';
                    osc.frequency.value = freqVariation;

                    // Filter
                    filter.type = 'lowpass';
                    filter.frequency.value = filterCutoff;
                    filter.Q.value = resonance;

                    const startTime = now + (g * duration / grains);
                    const grainGain = gainValue * 0.25;

                    // Envelope con attack/release migliorato
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(grainGain, startTime + Math.max(grainDuration * 0.3, 0.01));
                    gain.gain.linearRampToValueAtTime(0, startTime + grainDuration);

                    panner.pan.value = pan + (Math.random() * 0.4 - 0.2);

                    // Dry/Wet mix
                    dryGain.gain.value = 0.7;
                    wetGain.gain.value = 0.3;

                    // Routing
                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(panner);

                    panner.connect(dryGain);
                    panner.connect(wetGain);

                    dryGain.connect(masterCompressor);
                    wetGain.connect(masterReverb);

                    osc.start(startTime);
                    osc.stop(startTime + grainDuration);
                    sonificationOscillators.push(osc);
                }

            } else if (synthesisType === 'noise') {
                // Filtered noise
                const bufferSize = sonificationContext.sampleRate * duration;
                const buffer = sonificationContext.createBuffer(1, bufferSize, sonificationContext.sampleRate);
                const data = buffer.getChannelData(0);

                // Generate noise
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                const noise = sonificationContext.createBufferSource();
                const filter = sonificationContext.createBiquadFilter();
                const gain = sonificationContext.createGain();
                const panner = sonificationContext.createStereoPanner();
                const dryGain = sonificationContext.createGain();
                const wetGain = sonificationContext.createGain();

                noise.buffer = buffer;

                filter.type = 'bandpass';
                filter.frequency.value = frequency;
                filter.Q.value = 10;

                // Envelope migliorato
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(gainValue * 0.4, now + improvedAttack);
                gain.gain.setValueAtTime(gainValue * 0.4, now + duration - improvedRelease);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                panner.pan.value = pan;

                // Dry/Wet mix
                dryGain.gain.value = 0.6;
                wetGain.gain.value = 0.4;

                // Routing
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(panner);

                panner.connect(dryGain);
                panner.connect(wetGain);

                dryGain.connect(masterCompressor);
                wetGain.connect(masterReverb);

                noise.start(now);
                sonificationOscillators.push(noise);
            }
        }

        // ========================================
        // SOUNDSCAPE MAP - LEAFLET.JS IMPLEMENTATION
        // ========================================

        var leafletMap = null;
        var mapMarkers = [];
        var soundscapeData = [];
        var currentAudioBlob = null;
        var mediaRecorder = null;
        var recordingChunks = [];
        var recordingTimer = null;
        var recordingSeconds = 0;
        var pendingMarkerCoords = null;
        var tempMarker = null;

        // Exercise recorder variables
        var exerciseMediaRecorder = null;
        var exerciseRecordingChunks = [];
        var exerciseRecordingTimer = null;
        var exerciseRecordingSeconds = 0;
        var exerciseRecordedAudios = []; // Array of {blob, timestamp, name}

        // Spectrum Analyzer variables
        var spectrumAudioContext = null;
        var spectrumAnalyser = null;
        var spectrumDataArray = null;
        var spectrumAnimationId = null;
        var spectrumCanvas = null;
        var spectrumCtx = null;
        var spectrumImageData = null; // For scrolling effect
        var spectrumMediaElementSource = null; // Track media element source to avoid recreating
        var spectrumStreamSource = null; // MediaStreamSource for recording (needs disconnect)
        var currentlyPlayingAudio = null; // Currently playing audio element
        var audioPreviewSource = null; // MediaElementSource for preview player (created once)

        // Category icons mapping
        const categoryIcons = {
            traffic: '🚗',
            market: '🛒',
            voices: '👥',
            industrial: '🏭',
            railway: '🚂',
            coastal: '🌊',
            forest: '🌲',
            park: '🌳',
            construction: '🚧',
            airport: '✈️',
            other: '📌'
        };

        const categoryColors = {
            traffic: '#e74c3c',
            market: '#f39c12',
            voices: '#3498db',
            industrial: '#95a5a6',
            railway: '#9b59b6',
            coastal: '#1abc9c',
            forest: '#27ae60',
            park: '#2ecc71',
            construction: '#e67e22',
            airport: '#34495e',
            other: '#7f8c8d'
        };

        // ==================== SPECTRUM ANALYZER ====================

        function initSpectrumAnalyzer() {
            spectrumCanvas = document.getElementById('spectrumCanvas');
            if (!spectrumCanvas) return;

            spectrumCtx = spectrumCanvas.getContext('2d');
            spectrumAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            spectrumAnalyser = spectrumAudioContext.createAnalyser();
            spectrumAnalyser.fftSize = 2048;
            spectrumAnalyser.smoothingTimeConstant = 0.8;
            spectrumDataArray = new Uint8Array(spectrumAnalyser.frequencyBinCount);
        }

        // Heat map color scheme (Blue -> Cyan -> Green -> Yellow -> Red)
        function getSpectrumColor(normalized) {
            let r, g, b;

            if (normalized < 0.1) {
                r = 0; g = 0; b = Math.floor(normalized * 500);
            } else if (normalized < 0.3) {
                const t = (normalized - 0.1) / 0.2;
                r = 0; g = Math.floor(t * 100); b = Math.floor(100 + t * 155);
            } else if (normalized < 0.5) {
                const t = (normalized - 0.3) / 0.2;
                r = 0; g = Math.floor(100 + t * 155); b = Math.floor(255 - t * 100);
            } else if (normalized < 0.7) {
                const t = (normalized - 0.5) / 0.2;
                r = Math.floor(t * 255); g = 255; b = 0;
            } else {
                const t = (normalized - 0.7) / 0.3;
                r = 255; g = Math.floor(255 - t * 255); b = 0;
            }

            return `rgb(${r}, ${g}, ${b})`;
        }

        function drawSpectrum() {
            spectrumAnimationId = requestAnimationFrame(drawSpectrum);

            if (!spectrumAnalyser || !spectrumDataArray || !spectrumCtx) return;

            // Get frequency data
            spectrumAnalyser.getByteFrequencyData(spectrumDataArray);

            const width = spectrumCanvas.width;
            const height = spectrumCanvas.height;

            // Scroll existing image to the left
            if (spectrumImageData) {
                spectrumCtx.putImageData(spectrumImageData, -1, 0);
            } else {
                spectrumCtx.fillStyle = '#0a0a15';
                spectrumCtx.fillRect(0, 0, width, height);
            }

            // Calculate frequency range: 20 Hz to 10 kHz
            const sampleRate = spectrumAudioContext.sampleRate || 48000;
            const nyquist = sampleRate / 2;
            const binCount = spectrumDataArray.length;
            const hzPerBin = nyquist / binCount;

            const startBin = Math.floor(20 / hzPerBin);
            const endBin = Math.floor(10000 / hzPerBin);
            const usefulBins = endBin - startBin;

            const sliceWidth = 1;
            const frequencyBands = height;

            for (let i = 0; i < frequencyBands; i++) {
                const binIndex = Math.max(startBin, Math.min(endBin - 1,
                    startBin + Math.floor((frequencyBands - i - 1) * usefulBins / frequencyBands)));

                const value = spectrumDataArray[binIndex] || 0;
                const normalized = value / 255;
                const color = getSpectrumColor(normalized);

                spectrumCtx.fillStyle = color;
                spectrumCtx.fillRect(width - sliceWidth, i, sliceWidth, 1);
            }

            // Save current state for next frame
            spectrumImageData = spectrumCtx.getImageData(0, 0, width, height);

            // Draw subtle grid lines
            spectrumCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            spectrumCtx.lineWidth = 1;
            for (let i = 0; i < 4; i++) {
                const y = (height / 4) * i;
                spectrumCtx.beginPath();
                spectrumCtx.moveTo(0, y);
                spectrumCtx.lineTo(width, y);
                spectrumCtx.stroke();
            }
        }

        function startSpectrumVisualization(stream) {
            try {
                // ALWAYS reinitialize to ensure clean state
                console.log('🎯 Reinitializing spectrum analyzer for new recording...');

                // Disconnect and cleanup previous source if exists
                if (spectrumStreamSource) {
                    try {
                        spectrumStreamSource.disconnect();
                        console.log('🔌 Disconnected previous stream source');
                    } catch (e) {
                        console.warn('Could not disconnect previous source:', e);
                    }
                    spectrumStreamSource = null;
                }

                // Close previous AudioContext if exists
                if (spectrumAudioContext) {
                    try {
                        spectrumAudioContext.close();
                        console.log('🔒 Closed previous AudioContext');
                    } catch (e) {
                        console.warn('Could not close previous AudioContext:', e);
                    }
                }

                // Reinitialize analyzer (creates new AudioContext)
                initSpectrumAnalyzer();
                console.log('✅ Spectrum analyzer reinitialized');

                // Connect microphone stream to NEW analyser
                spectrumStreamSource = spectrumAudioContext.createMediaStreamSource(stream);
                spectrumStreamSource.connect(spectrumAnalyser);
                console.log('🔌 Connected new stream source to analyzer');

                // Update status
                document.getElementById('spectrumStatus').textContent = '🔴 Recording...';
                document.getElementById('spectrumStatus').style.color = '#ff3b3b';
                document.getElementById('spectrumStatus').style.background = 'rgba(255,59,59,0.2)';

                // Start drawing
                drawSpectrum();
            } catch (err) {
                console.warn('Spectrum analyzer failed:', err);
            }
        }

        function stopSpectrumVisualization() {
            if (spectrumAnimationId) {
                cancelAnimationFrame(spectrumAnimationId);
                spectrumAnimationId = null;
            }

            // Disconnect stream source
            if (spectrumStreamSource) {
                try {
                    spectrumStreamSource.disconnect();
                    spectrumStreamSource = null;
                    console.log('🔌 Stream source disconnected');
                } catch (e) {
                    console.warn('Could not disconnect stream source:', e);
                }
            }

            // Update status
            const statusEl = document.getElementById('spectrumStatus');
            if (statusEl) {
                statusEl.textContent = 'Waiting...';
                statusEl.style.color = '#888';
                statusEl.style.background = 'rgba(255,255,255,0.1)';
            }
        }

        // Initialize map when section becomes visible
        function initializeSoundscapeMap() {
            console.log('🗺️ Initializing Soundscape Map...');

            if (leafletMap) {
                // Map already exists, refresh and reload markers
                console.log('Map exists, refreshing and reloading markers...');
                leafletMap.invalidateSize();

                // Remove all existing markers from map
                mapMarkers.forEach(m => {
                    if (m.marker) {
                        leafletMap.removeLayer(m.marker);
                    }
                });
                mapMarkers = [];

                // Reload markers from localStorage
                loadSoundscapeData();
                updateMarkersList();
                return;
            }

            // Create map centered on Italy
            try {
                leafletMap = L.map('leafletMap').setView([43.7696, 11.2558], 6);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(leafletMap);

                // Add click event to add markers
                leafletMap.on('click', function(e) {
                    // Save coordinates for marker placement
                    pendingMarkerCoords = e.latlng;

                    // Show temporary marker at click location
                    if (tempMarker) {
                        leafletMap.removeLayer(tempMarker);
                    }

                    tempMarker = L.marker([e.latlng.lat, e.latlng.lng], {
                        icon: L.divIcon({
                            html: '<div style="font-size: 28px;">📍</div>',
                            className: 'custom-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    }).addTo(leafletMap);

                    // Scroll to form
                    document.getElementById('markerCategory').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });

                // Load saved markers
                loadSoundscapeData();

                console.log('✅ Map initialized');
            } catch (error) {
                console.error('❌ Error initializing map:', error);
                alert('Map initialization error: ' + error.message);
            }
        }

        // Recording controls
        document.getElementById('startRecording').addEventListener('click', async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);
                recordingChunks = [];
                recordingSeconds = 0;

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordingChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    // Use compatible audio format for iOS
                    const mimeType = mediaRecorder.mimeType || 'audio/mp4';
                    currentAudioBlob = new Blob(recordingChunks, { type: mimeType });
                    showAudioPreview(currentAudioBlob);

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    // Save marker if coordinates are set
                    if (pendingMarkerCoords) {
                        saveMarker();
                    }
                };

                mediaRecorder.start();

                // Start spectrum visualization
                startSpectrumVisualization(stream);

                // Update UI
                document.getElementById('startRecording').style.display = 'none';
                document.getElementById('stopRecording').style.display = 'block';
                document.getElementById('recordingTime').style.display = 'block';

                // Start timer
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const mins = Math.floor(recordingSeconds / 60);
                    const secs = recordingSeconds % 60;
                    document.getElementById('recordingTime').textContent =
                        `⏱️ ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                }, 1000);

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('❌ Impossibile accedere al microfono. Verifica i permessi del browser.');
            }
        });

        document.getElementById('stopRecording').addEventListener('click', function() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingTimer);
                stopSpectrumVisualization();

                // Reset UI
                document.getElementById('startRecording').style.display = 'block';
                document.getElementById('stopRecording').style.display = 'none';
                document.getElementById('recordingTime').style.display = 'none';
            }
        });

        // File upload
        document.getElementById('audioFileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentAudioBlob = file;
                showAudioPreview(file);

                // Save marker if coordinates are set
                if (pendingMarkerCoords) {
                    saveMarker();
                }
            }
        });

        // Show audio preview
        function showAudioPreview(audioBlob) {
            const preview = document.getElementById('audioPreview');
            const player = document.getElementById('audioPreviewPlayer');

            // Revoke previous URL to prevent memory leaks
            if (player.src && player.src.startsWith('blob:')) {
                URL.revokeObjectURL(player.src);
            }

            // Update player source
            const url = URL.createObjectURL(audioBlob);
            player.src = url;
            preview.style.display = 'block';

            // Use native HTML5 controls for playback
            // NO spectrum analyzer for preview player (avoiding conflicts)
            // Spectrum is active only during recording and marker playback
        }

        // ==================== EXERCISE RECORDER FUNCTIONS ====================

        async function startExerciseRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                exerciseMediaRecorder = new MediaRecorder(stream);
                exerciseRecordingChunks = [];
                exerciseRecordingSeconds = 0;

                exerciseMediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        exerciseRecordingChunks.push(e.data);
                    }
                };

                exerciseMediaRecorder.onstop = () => {
                    // Use compatible audio format for iOS
                    const mimeType = exerciseMediaRecorder.mimeType || 'audio/mp4';
                    const audioBlob = new Blob(exerciseRecordingChunks, { type: mimeType });

                    // Add to recorded audios array
                    const timestamp = new Date().toISOString();
                    const name = `Recording ${exerciseRecordedAudios.length + 1}`;
                    exerciseRecordedAudios.push({ blob: audioBlob, timestamp, name });

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    // Update UI
                    displayRecordedAudios();
                };

                exerciseMediaRecorder.start();

                // Update UI
                document.getElementById('startRecordingBtn').disabled = true;
                document.getElementById('startRecordingBtn').style.background = '#999';
                document.getElementById('startRecordingBtn').style.cursor = 'not-allowed';

                document.getElementById('stopRecordingBtn').disabled = false;
                document.getElementById('stopRecordingBtn').style.background = '#2d5f4f';
                document.getElementById('stopRecordingBtn').style.cursor = 'pointer';

                document.getElementById('recordingStatus').style.display = 'block';

                // Start timer
                exerciseRecordingTimer = setInterval(() => {
                    exerciseRecordingSeconds++;
                    const mins = Math.floor(exerciseRecordingSeconds / 60);
                    const secs = exerciseRecordingSeconds % 60;
                    document.getElementById('recordingTimer').textContent =
                        `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                }, 1000);

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('❌ Unable to access microphone.\n\nPlease check browser permissions.');
            }
        }

        function stopExerciseRecording() {
            if (exerciseMediaRecorder && exerciseMediaRecorder.state !== 'inactive') {
                exerciseMediaRecorder.stop();
                clearInterval(exerciseRecordingTimer);

                // Reset UI
                document.getElementById('startRecordingBtn').disabled = false;
                document.getElementById('startRecordingBtn').style.background = '#d32f2f';
                document.getElementById('startRecordingBtn').style.cursor = 'pointer';

                document.getElementById('stopRecordingBtn').disabled = true;
                document.getElementById('stopRecordingBtn').style.background = '#666';
                document.getElementById('stopRecordingBtn').style.cursor = 'not-allowed';

                document.getElementById('recordingStatus').style.display = 'none';
                document.getElementById('recordingTimer').textContent = '00:00';
            }
        }

        function displayRecordedAudios() {
            const container = document.getElementById('recordedAudiosList');

            if (exerciseRecordedAudios.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">';
            html += '<p style="font-size: 13px; font-weight: 600; color: #2d5f4f; margin-bottom: 8px;">📼 Saved recordings:</p>';

            exerciseRecordedAudios.forEach((audio, index) => {
                const url = URL.createObjectURL(audio.blob);
                html += `
                    <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-weight: 600; font-size: 13px;">${audio.name}</span>
                            <button onclick="deleteRecordedAudio(${index})" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                🗑️ Delete
                            </button>
                        </div>
                        <audio controls style="width: 100%; height: 32px;" src="${url}"></audio>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function deleteRecordedAudio(index) {
            if (confirm('Do you want to delete this recording?')) {
                exerciseRecordedAudios.splice(index, 1);
                displayRecordedAudios();
            }
        }

        // ==================== END EXERCISE RECORDER FUNCTIONS ====================

        // Save marker to map and storage
        // Aggiungi marker da esercizio completato
        async function addExerciseMarkerToMap(exerciseData, exerciseId) {
            console.log('🎯 addExerciseMarkerToMap called with:', {
                exerciseId,
                hasCoords: !!exerciseData.locationCoords,
                lat: exerciseData.locationCoords?.lat,
                lon: exerciseData.locationCoords?.lon,
                audioFiles: exerciseData.audioFiles?.length || 0
            });

            if (!exerciseData.locationCoords || !exerciseData.locationCoords.lat) {
                console.error('❌ Coordinates not available for marker');
                alert('❌ Cannot create marker: GPS coordinates not available');
                return;
            }

            // IMPORTANT: Load soundscapeData from localStorage before checking limit
            // This is because when saving from Exercises, soundscapeData might be empty
            const saved = localStorage.getItem('soundscapeMarkers');
            if (saved) {
                try {
                    soundscapeData = JSON.parse(saved);
                    console.log('📂 Loaded existing markers from localStorage:', soundscapeData.length);
                } catch (error) {
                    console.error('Error loading markers from localStorage:', error);
                }
            }

            console.log('✅ Coordinates OK, checking marker limit...');
            console.log('Current markers count:', soundscapeData.length);
            console.log('isPremium:', isPremium);

            // FREE VERSION: Check marker limit (20 markers max)
            if (!isPremium && soundscapeData.length >= FREE_LIMITS.markers) {
                console.warn('⚠️ Marker limit reached');
                alert(`⚠️ Free Version: Maximum ${FREE_LIMITS.markers} markers on the map\n\n🌟 Upgrade to Premium for unlimited markers and secure backup!`);
                showUpgradeModal();
                return;
            }

            console.log('✅ Marker limit OK, creating marker...');

            // Determina categoria basata sul tipo di esercizio
            const category = 'park'; // Default: parco urbano (soundscape exercise)

            // Create marker data
            const markerData = {
                id: Date.now(),
                lat: parseFloat(exerciseData.locationCoords.lat),
                lng: parseFloat(exerciseData.locationCoords.lon),
                category: category,
                notes: `📝 ${exerciseData.exercise.title}\n\n${exerciseData.notes || 'No notes'}`,
                timestamp: exerciseData.timestamp,
                hasAudio: exerciseData.audioFiles && exerciseData.audioFiles.length > 0,
                exerciseTitle: exerciseData.exercise.title,
                exerciseId: exerciseId  // ID dell'esercizio completo in IndexedDB
            };

            // Save audio to IndexedDB if present
            if (exerciseData.audioFiles && exerciseData.audioFiles.length > 0) {
                // Use first audio file for marker
                // exerciseData.audioFiles contains direct Blobs (not URLs)
                const audioBlob = exerciseData.audioFiles[0];
                await saveAudioToIndexedDB(markerData.id, audioBlob);
                console.log('✅ Audio saved to IndexedDB for marker:', markerData.id);
            }

            // Add marker to map (solo se la mappa è inizializzata)
            console.log('🗺️ leafletMap exists:', !!leafletMap);

            if (leafletMap) {
                console.log('✅ Adding marker to Leaflet map at:', markerData.lat, markerData.lng);

                const icon = L.divIcon({
                    html: `<div style="font-size: 28px;">${categoryIcons[category]}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });

                const marker = L.marker([markerData.lat, markerData.lng], { icon: icon }).addTo(leafletMap);

                // Create popup content
                const popupContent = createPopupContent(markerData);
                marker.bindPopup(popupContent, { maxWidth: 280, minWidth: 200 });

                mapMarkers.push({ marker: marker, data: markerData });
                console.log('✅ Marker added to mapMarkers array. Total markers:', mapMarkers.length);
            } else {
                console.warn('⚠️ leafletMap not initialized, marker will be saved but not displayed');
            }

            soundscapeData.push(markerData);
            console.log('✅ Marker added to soundscapeData. Total data:', soundscapeData.length);

            // Save to localStorage
            saveSoundscapeData();

            // Update markers list (se siamo nella sezione map)
            if (document.getElementById('map').classList.contains('active')) {
                updateMarkersList();
            }

            // Update premium UI banner with new marker count
            if (typeof updatePremiumUI === 'function') {
                updatePremiumUI();
            }

            console.log('✅ Marker added to map for exercise:', exerciseData.exercise.title);
        }

        // Detect GPS location for map marker
        function detectMapGPSLocation() {
            if (!navigator.geolocation) {
                alert('❌ Geolocation is not supported by your device');
                return;
            }

            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '🔄 Detecting location...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Remove old temp marker if exists
                    if (tempMarker) {
                        leafletMap.removeLayer(tempMarker);
                    }

                    // Create new marker at current location
                    tempMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: '<div style="font-size: 28px;">📍</div>',
                            className: 'custom-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    }).addTo(leafletMap);

                    // Set pending coordinates
                    pendingMarkerCoords = { lat, lng };

                    // Center map on current location
                    leafletMap.setView([lat, lng], 15);

                    // Scroll to form
                    document.getElementById('markerCategory').scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Restore button
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    alert('✅ Location detected! Now fill in the marker details below.');
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert('❌ Unable to detect location. Please check your GPS settings and try again.');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        async function saveMarker() {
            if (!pendingMarkerCoords) {
                alert('❌ Click on the map first to place a marker!');
                return;
            }

            // FREE VERSION: Check marker limit (20 markers max)
            if (!isPremium && soundscapeData.length >= FREE_LIMITS.markers) {
                alert(`⚠️ Free Version: Maximum ${FREE_LIMITS.markers} markers on the map\n\n🌟 Upgrade to Premium for unlimited markers and secure backup!`);
                showUpgradeModal();
                return;
            }

            const category = document.getElementById('markerCategory').value;
            const notes = document.getElementById('markerNotes').value.trim();

            // Create marker data
            const markerData = {
                id: Date.now(),
                lat: pendingMarkerCoords.lat,
                lng: pendingMarkerCoords.lng,
                category: category,
                notes: notes || categoryIcons[category] || '',
                timestamp: new Date().toISOString(),
                hasAudio: currentAudioBlob !== null
            };

            // Save audio to IndexedDB if present
            if (currentAudioBlob) {
                await saveAudioToIndexedDB(markerData.id, currentAudioBlob);
            }

            // Remove temporary marker
            if (tempMarker) {
                leafletMap.removeLayer(tempMarker);
                tempMarker = null;
            }

            // Add marker to map
            const icon = L.divIcon({
                html: `<div style="font-size: 28px;">${categoryIcons[category]}</div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            const marker = L.marker([markerData.lat, markerData.lng], { icon: icon }).addTo(leafletMap);

            // Create popup content
            const popupContent = createPopupContent(markerData);
            marker.bindPopup(popupContent, { maxWidth: 280, minWidth: 200 });

            mapMarkers.push({ marker: marker, data: markerData });
            soundscapeData.push(markerData);

            // Save to localStorage
            saveSoundscapeData();

            // Update markers list
            updateMarkersList();

            // Update premium UI banner with new marker count
            if (typeof updatePremiumUI === 'function') {
                updatePremiumUI();
            }

            // Reset form
            document.getElementById('markerNotes').value = '';
            document.getElementById('audioPreview').style.display = 'none';
            currentAudioBlob = null;
            pendingMarkerCoords = null;

            alert('✅ Marker saved successfully!');
        }

        // Create popup content for marker
        function createPopupContent(markerData) {
            const categoryName = document.querySelector(`#markerCategory option[value="${markerData.category}"]`).textContent;

            let html = `
                <div style="min-width: 200px; max-width: 280px; box-sizing: border-box;">
                    <h4 style="margin: 0 0 10px 0; color: ${categoryColors[markerData.category]}; word-wrap: break-word;">
                        ${categoryIcons[markerData.category]} ${categoryName}
                    </h4>
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">
                        ${markerData.notes}
                    </p>
                    <p style="margin: 0; font-size: 12px; color: #999;">
                        📅 ${new Date(markerData.timestamp).toLocaleString('it-IT')}
                    </p>
            `;

            if (markerData.hasAudio) {
                html += `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="playMarkerAudio(${markerData.id})"
                                    style="flex: 1; padding: 8px; background: #2d5f4f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                ▶️ Play
                            </button>
                            <button onclick="stopMarkerAudio()"
                                    style="flex: 1; padding: 8px; background: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                ⏹️ Stop
                            </button>
                        </div>
                    </div>
                `;
            }

            // Se c'è exerciseId, aggiungi bottone per aprire esercizio completo
            if (markerData.exerciseId) {
                html += `
                    <div style="margin-top: 8px;">
                        <button onclick="openExerciseFromMap(${markerData.exerciseId})"
                                style="width: 100%; padding: 8px; background: #4a9d7f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            📄 Vedi Esercizio Completo
                        </button>
                    </div>
                `;
            }

            html += `
                    <div style="margin-top: 8px;">
                        <button onclick="deleteMarker(${markerData.id})"
                                style="width: 100%; padding: 6px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `;

            return html;
        }

        // Apri esercizio completo dalla mappa
        window.openExerciseFromMap = async function(exerciseId) {
            try {
                // Chiudi eventuali popup aperti
                if (leafletMap) {
                    leafletMap.closePopup();
                }

                // Vai alla sezione dashboard
                showSection('dashboard');

                // Apri il modal con l'esercizio completo
                await viewCompletedExercise(exerciseId);

                console.log('✅ Exercise opened:', exerciseId);
            } catch (error) {
                console.error('Exercise opening error:', error);
                alert('❌ Error opening exercise!');
            }
        };

        // Play audio from marker
        // Global variable to track currently playing audio
        let currentlyPlayingAudio = null;

        window.playMarkerAudio = async function(markerId) {
            try {
                // Stop any currently playing audio
                if (currentlyPlayingAudio) {
                    currentlyPlayingAudio.pause();
                    currentlyPlayingAudio.currentTime = 0;
                    currentlyPlayingAudio = null;
                }

                const audioBlob = await getAudioFromIndexedDB(markerId);
                if (audioBlob) {
                    // Convert blob to base64 data URL for iOS compatibility
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        const audio = new Audio(reader.result);
                        currentlyPlayingAudio = audio;

                        audio.onerror = (e) => {
                            console.error('Audio playback error:', e);
                            alert('❌ Cannot play this audio format.');
                            currentlyPlayingAudio = null;
                        };

                        // Reset when audio ends
                        audio.onended = () => {
                            currentlyPlayingAudio = null;
                            console.log('✅ Audio playback finished');
                        };

                        // Play audio directly (no spectrum analyzer to avoid createMediaElementSource conflicts)
                        audio.play().catch(err => {
                            console.error('Play error:', err);
                            alert('❌ Error playing: ' + err.message);
                            currentlyPlayingAudio = null;
                        });
                    };
                    reader.readAsDataURL(audioBlob);
                } else {
                    alert('❌ Audio not found');
                }
            } catch (error) {
                console.error('Error playing audio:', error);
                alert('❌ Error: ' + error.message);
            }
        };

        window.stopMarkerAudio = function() {
            if (currentlyPlayingAudio) {
                currentlyPlayingAudio.pause();
                currentlyPlayingAudio.currentTime = 0;
                currentlyPlayingAudio = null;
                console.log('⏹️ Audio playback stopped');
            }
            // No alert needed - silent stop
        };

        // Delete marker
        window.deleteMarker = function(markerId) {
            if (!confirm('Are you sure you want to delete this marker?')) return;

            // Remove from map
            const markerIndex = mapMarkers.findIndex(m => m.data.id === markerId);
            if (markerIndex !== -1) {
                leafletMap.removeLayer(mapMarkers[markerIndex].marker);
                mapMarkers.splice(markerIndex, 1);
            }

            // Remove from data
            const dataIndex = soundscapeData.findIndex(m => m.id === markerId);
            if (dataIndex !== -1) {
                soundscapeData.splice(dataIndex, 1);
            }

            // Remove audio from IndexedDB
            deleteAudioFromIndexedDB(markerId);

            // Save to localStorage
            saveSoundscapeData();

            // Update list
            updateMarkersList();

            alert('✅ Marker eliminato');
        };

        // Delete all markers
        window.deleteAllMarkers = async function() {
            if (soundscapeData.length === 0) {
                alert('ℹ️ No markers to delete');
                return;
            }

            if (!confirm(`⚠️ Are you sure you want to delete ALL ${soundscapeData.length} markers?\n\nThis action cannot be undone!`)) {
                return;
            }

            // Second confirmation for safety
            if (!confirm('⚠️ FINAL WARNING: This will permanently delete all your markers and audio recordings!\n\nClick OK to confirm deletion.')) {
                return;
            }

            // Remove all markers from map
            mapMarkers.forEach(m => {
                leafletMap.removeLayer(m.marker);
            });

            // Delete all audio from IndexedDB
            for (const markerData of soundscapeData) {
                await deleteAudioFromIndexedDB(markerData.id);
            }

            // Clear arrays
            mapMarkers = [];
            soundscapeData = [];

            // Clear localStorage
            saveSoundscapeData();

            // Update list
            updateMarkersList();

            // Update premium UI
            if (typeof updatePremiumUI === 'function') {
                updatePremiumUI();
            }

            alert('✅ All markers deleted successfully');
        };

        // Update markers list
        function updateMarkersList() {
            const listDiv = document.getElementById('markersList');

            if (soundscapeData.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-style: italic;">No markers saved</p>';
                return;
            }

            let html = '';
            soundscapeData.forEach(marker => {
                const categoryName = document.querySelector(`#markerCategory option[value="${marker.category}"]`).textContent;
                html += `
                    <div style="padding: 10px; margin-bottom: 8px; background: #f8f9f5; border-radius: 6px; border-left: 3px solid ${categoryColors[marker.category]}; cursor: pointer;"
                         onclick="showMarkerDetails(${marker.id});">
                        <div style="font-weight: 600; color: #2d5f4f; margin-bottom: 4px;">
                            ${categoryIcons[marker.category]} ${marker.notes.substring(0, 30)}${marker.notes.length > 30 ? '...' : ''}
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            ${categoryName}${marker.hasAudio ? ' • 🔊 Audio' : ''}
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // Show marker details modal
        window.showMarkerDetails = async function(markerId) {
            const marker = soundscapeData.find(m => m.id === markerId);
            if (!marker) {
                alert('❌ Marker not found');
                return;
            }

            const categoryName = document.querySelector(`#markerCategory option[value="${marker.category}"]`).textContent;
            const hasAudio = await getAudioFromIndexedDB(markerId);

            const detailsContent = document.getElementById('markerDetailsContent');
            detailsContent.innerHTML = `
                <h2 style="color: #2d5f4f; margin-bottom: 20px;">📍 Marker Details</h2>

                <div style="background: #f0f7f4; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid ${categoryColors[marker.category]};">
                    <div style="font-size: 32px; text-align: center; margin-bottom: 10px;">
                        ${categoryIcons[marker.category]}
                    </div>
                    <h3 style="color: #2d5f4f; text-align: center; margin-bottom: 5px;">${categoryName}</h3>
                    <p style="color: #666; text-align: center; font-size: 14px; margin: 0;">
                        ${new Date(marker.timestamp).toLocaleString('en-US')}
                    </p>
                </div>

                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px;">📝 Notes</h4>
                    <p style="color: #333; line-height: 1.6; margin: 0; white-space: pre-wrap;">${marker.notes || 'No notes'}</p>
                </div>

                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px;">🌍 Coordinates</h4>
                    <p style="color: #333; margin: 5px 0;"><strong>Latitude:</strong> ${marker.lat.toFixed(6)}</p>
                    <p style="color: #333; margin: 5px 0;"><strong>Longitude:</strong> ${marker.lng.toFixed(6)}</p>
                    <button onclick="goToMarkerOnMap(${marker.lat}, ${marker.lng});"
                            style="margin-top: 10px; width: 100%; padding: 12px; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        🗺️ Go to Location on Map
                    </button>
                </div>

                ${hasAudio ? `
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #2d5f4f; margin-bottom: 10px;">🔊 Audio Recording</h4>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="playMarkerAudio(${markerId})"
                                style="flex: 1; padding: 12px; background: linear-gradient(135deg, #2d5f4f 0%, #1e3f33 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ▶️ Play
                        </button>
                        <button onclick="stopMarkerAudio()"
                                style="flex: 1; padding: 12px; background: linear-gradient(135deg, #d9534f 0%, #c9302c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ⏹️ Stop
                        </button>
                    </div>
                </div>
                ` : ''}

                <div style="display: flex; gap: 10px;">
                    <button onclick="deleteSingleMarker(${markerId})"
                            style="flex: 1; padding: 12px; background: #d9534f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        🗑️ Delete Marker
                    </button>
                    <button onclick="closeMarkerDetailsModal()"
                            style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ✖️ Close
                    </button>
                </div>
            `;

            document.getElementById('markerDetailsModal').style.display = 'flex';
        };

        // Close marker details modal
        window.closeMarkerDetailsModal = function() {
            document.getElementById('markerDetailsModal').style.display = 'none';
        };

        // Go to marker on map (scroll + open map + zoom)
        window.goToMarkerOnMap = function(lat, lng) {
            // Close the marker details modal
            closeMarkerDetailsModal();

            // Switch to map section
            showMapSection();

            // Scroll to top smoothly
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Wait for map to initialize, then zoom to marker
            setTimeout(() => {
                if (leafletMap) {
                    leafletMap.setView([lat, lng], 18); // Zoom level 18 for close-up
                }
            }, 500);
        };

        // Delete single marker
        window.deleteSingleMarker = async function(markerId) {
            if (!confirm('Are you sure you want to delete this marker?')) {
                return;
            }

            // Remove from soundscapeData array
            const index = soundscapeData.findIndex(m => m.id === markerId);
            if (index > -1) {
                soundscapeData.splice(index, 1);
            }

            // Remove from localStorage
            localStorage.setItem('soundscapeData', JSON.stringify(soundscapeData));

            // Remove audio from IndexedDB
            await deleteAudioFromIndexedDB(markerId);

            // Remove marker from map (correct structure: {marker, data})
            const markerIndex = mapMarkers.findIndex(m => m.data.id === markerId);
            if (markerIndex !== -1) {
                leafletMap.removeLayer(mapMarkers[markerIndex].marker);
                mapMarkers.splice(markerIndex, 1);
            }

            // Update list and close modal
            updateMarkersList();
            closeMarkerDetailsModal();

            alert('✅ Marker deleted successfully');
        };

        // IndexedDB functions
        function openSoundscapeDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SoundscapeDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('audioFiles')) {
                        db.createObjectStore('audioFiles', { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveAudioToIndexedDB(markerId, audioBlob) {
            try {
                const db = await openSoundscapeDB();
                const transaction = db.transaction(['audioFiles'], 'readwrite');
                const store = transaction.objectStore('audioFiles');

                await store.put({ id: markerId, audio: audioBlob });
                console.log(`✅ Audio saved for marker ${markerId}`);
            } catch (error) {
                console.error('Error saving audio to IndexedDB:', error);
            }
        }

        async function getAudioFromIndexedDB(markerId) {
            try {
                const db = await openSoundscapeDB();
                const transaction = db.transaction(['audioFiles'], 'readonly');
                const store = transaction.objectStore('audioFiles');

                return new Promise((resolve, reject) => {
                    const request = store.get(markerId);
                    request.onsuccess = () => resolve(request.result ? request.result.audio : null);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('Error getting audio from IndexedDB:', error);
                return null;
            }
        }

        async function deleteAudioFromIndexedDB(markerId) {
            try {
                const db = await openSoundscapeDB();
                const transaction = db.transaction(['audioFiles'], 'readwrite');
                const store = transaction.objectStore('audioFiles');

                await store.delete(markerId);
                console.log(`✅ Audio deleted for marker ${markerId}`);
            } catch (error) {
                console.error('Error deleting audio from IndexedDB:', error);
            }
        }

        // LocalStorage functions
        function saveSoundscapeData() {
            try {
                localStorage.setItem('soundscapeMarkers', JSON.stringify(soundscapeData));
                console.log('✅ Markers saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadSoundscapeData() {
            try {
                const saved = localStorage.getItem('soundscapeMarkers');
                if (saved) {
                    soundscapeData = JSON.parse(saved);

                    // Recreate markers on map
                    soundscapeData.forEach(markerData => {
                        const icon = L.divIcon({
                            html: `<div style="font-size: 28px;">${categoryIcons[markerData.category]}</div>`,
                            className: 'custom-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        });

                        const marker = L.marker([markerData.lat, markerData.lng], { icon: icon }).addTo(leafletMap);
                        const popupContent = createPopupContent(markerData);
                        marker.bindPopup(popupContent, { maxWidth: 280, minWidth: 200 });

                        mapMarkers.push({ marker: marker, data: markerData });
                    });

                    updateMarkersList();
                    console.log(`✅ Loaded ${soundscapeData.length} markers`);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        // ==================== TOOLKIT SECTION ====================

        // Equipment Data
        var equipmentData = {
            recorders: {
                consumer: [
                    {
                        name: 'Zoom H1essential',
                        price: '€80-100',
                        features: ['32-bit float recording standard', 'Compatto e ultraleggero', 'USB-C audio interface', 'Perfetto per principianti'],
                        link: 'https://www.thomann.it/zoom_h1essential.htm'
                    },
                    {
                        name: 'Tascam DR-40X',
                        price: '€140-180',
                        features: ['Dual recording backup', 'USB audio interface', 'XLR/TRS combo inputs', 'Industry standard affidabile'],
                        link: 'https://www.thomann.it/tascam_dr_40x.htm'
                    },
                    {
                        name: 'Zoom H4n Pro',
                        price: '€180-220',
                        features: ['Capsule X/Y ruotabili 120°', '2 input XLR combo', 'Overdubbing multitrack', 'Basso rumore'],
                        link: 'https://www.thomann.it/zoom_h4essential_aph_4e_bundle.htm'
                    },
                    {
                        name: 'Zoom H5',
                        price: '€280-320',
                        features: ['4 tracce simultanee', 'Capsule intercambiabili incluse', 'Phantom power 48V', 'Recordzione fino a 96kHz/24bit'],
                        link: 'https://www.thomann.it/zoom_h5.htm'
                    }
                ],
                professional: [
                    {
                        name: 'Zoom F6',
                        price: '€550-650',
                        features: ['32-bit float 192kHz', 'Dual ADC per ogni canale', 'No gain staging necessario', 'Top qualità/prezzo pro'],
                        link: 'https://www.thomann.it/zoom_f6_case_set.htm',
                        review: 'Il Zoom F6 è il registratore che ha democratizzato il 32-bit float. Il dual ADC system garantisce registrazioni perfette anche in condizioni estreme (concerti, temporali). A questo prezzo, nessun competitor offre questa libertà. Consigliato a tutti i field recordist seri.'
                    },
                    {
                        name: 'Zoom F3',
                        price: '€280-320',
                        features: ['32-bit float 192kHz', 'Ultra-compatto 2 canali', 'Timecode sync', 'Preamp ultra-low noise'],
                        link: 'https://www.thomann.it/zoom_f3.htm',
                        review: 'The Zoom F3 is a revolution in compact field recording. The 32-bit float completely eliminates clipping issues, letting you focus on composition without worrying about levels. Perfect for recording unpredictable events (nature, city). Only limitation: just 2 channels.'
                    },
                    {
                        name: 'Tascam Portacapture X8',
                        price: '€450-550',
                        features: ['32-bit float/192kHz', '4 interchangeable capsules', 'Intuitive touchscreen', 'Studio-quality audio'],
                        link: 'https://www.thomann.it/tascam_portacapture_x8.htm',
                        review: 'The Portacapture X8 is the perfect choice for those who want flexibility. The 4 interchangeable capsules (X/Y, A/B, shotgun, etc.) let you adapt to any situation without carrying external mics. The touchscreen makes field editing super fast. Only limitation: proprietary batteries.'
                    },
                    {
                        name: 'Sound Devices MixPre-3 II',
                        price: '€650-750',
                        features: ['3 input Kashmir preamps', '32-bit float recording', 'Transparent limiter', 'Professional build quality'],
                        link: 'https://www.thomann.it/sound_devices_mixpre_3_ii.htm',
                        review: 'Sound Devices Kashmir preamps are considered among the best in the world. The MixPre-3 II offers broadcast quality in a compact package. Ideal for critical recordings where quality is everything. Expensive but worth every euro if you work professionally.'
                    },
                    {
                        name: 'Sound Devices MixPre-6 II',
                        price: '€850-1000',
                        features: ['Legendary Kashmir preamps', '32-bit float recording', 'Timecode for video sync', 'Broadcast build quality'],
                        link: 'https://www.thomann.it/sound_devices_mixpre_6_ii.htm',
                        review: 'Sound Devices is synonymous with broadcast quality. The MixPre-6 II with Kashmir preamps offers the most transparent and musical sound you can get in a field recorder. Timecode, transparent limiters, indestructible build. It\'s the ultimate investment if you work on documentaries or professional audio productions.'
                    }
                ]
            },
            microphones: {
                consumer: [
                    {
                        name: 'Rode VideoMic NTG',
                        price: '€220-280',
                        features: ['Shotgun broadcast-quality', 'Batteria ricaricabile USB-C', 'Gain infinito digitale', 'Safety channel -20dB'],
                        link: 'https://www.thomann.it/rode_videomic_ntg.htm'
                    },
                    {
                        name: 'Sennheiser MKE 600',
                        price: '€280-350',
                        features: ['Short shotgun versatile', 'Phantom o batteria', 'Industria-standard', 'Low self-noise'],
                        link: 'https://www.thomann.it/sennheiser_mke_600.htm'
                    },
                    {
                        name: 'Rode NT5 Matched Pair',
                        price: '€350-420',
                        features: ['Small diaphragm condenser', 'Stereo pair matched', 'Cardioide precision', 'Eccellente per ambience'],
                        link: 'https://www.thomann.it/rode_nt5_stativ_bundle.htm'
                    }
                ],
                professional: [
                    {
                        name: 'Sennheiser MKH 416',
                        price: '€850-1100',
                        features: ['Industry-standard shotgun', 'RF condenser (anti-umidità)', 'Broadcast quality', 'Direzionalità top'],
                        link: 'https://www.thomann.it/sennheiser_mkh416p48u3.htm',
                        review: 'Il MKH 416 è il shotgun più usato nel cinema e broadcast mondiale. RF condenser (immune a umidità), direzionalità chirurgica, suono neutro e dettagliato. Dopo 40+ anni è ancora lo standard. Costoso, ma se registri voci o soundscape urbani, non ha rivali. Un acquisto per la vita.'
                    },
                    {
                        name: 'Rode NTG5',
                        price: '€450-550',
                        features: ['Super-leggero 76g', 'RF-bias technology', 'Suono trasparente', 'Best value pro shotgun'],
                        link: 'https://www.thomann.it/rode_ntg5_kit.htm',
                        review: 'Il Rode NTG5 è il miglior rapporto qualità/prezzo tra gli shotgun professionali. Pesa solo 76g (perfetto per aste lunghe), suono cristallino grazie alla RF-bias technology, e costa la metà di un MKH 416. Se il tuo budget non arriva a Sennheiser, il NTG5 è la scelta ovvia.'
                    },
                    {
                        name: 'Audio-Technica AT875R',
                        price: '€150-180',
                        features: ['Short shotgun budget', 'Line/mic switch', 'Batteria AAA', 'Ottimo rapporto qualità/prezzo'],
                        link: 'https://www.thomann.it/audio_technica_at_875_r.htm',
                        review: 'Il microfono "entry-level professional" per eccellenza. Non ha la raffinatezza di un MKH 416, ma a 1/5 del prezzo offre prestazioni sorprendenti. Perfetto per chi vuole iniziare con shotgun professionali senza spendere €1000. Consigliato come backup anche per i pro.'
                    },
                    {
                        name: 'DPA 4060',
                        price: '€700-800',
                        features: ['Miniature omnidirectional', 'Self-noise 23dB-A', 'Discreet mounting', 'SPL 134dB'],
                        link: 'https://www.thomann.it/dpa_4060_oc_c_f03.htm',
                        review: 'The DPA 4060 are the favorite lavaliers of professional field recordists. Omnidirectional with linear frequency response, they "hide" anywhere (trees, walls, clothing) capturing the natural environment without coloration. Expensive but irreplaceable for creative techniques.'
                    },
                    {
                        name: 'Sennheiser MKH 8070',
                        price: '€1400-1700',
                        features: ['Premium long shotgun', 'Self-noise only 8dB', 'Moisture-resistant', 'Lateral rejection 38dB'],
                        link: 'https://www.thomann.it/sennheiser_mkh_8070.htm',
                        review: 'The MKH 8070 is a €1500+ long shotgun for a reason: incredible lateral isolation (38dB rejection) and self-noise of only 8dB. Used for distant wildlife recording and film productions. If you need to capture specific sounds in noisy environments, it\'s unbeatable. But it\'s a specialized tool, not versatile.'
                    }
                ]
            },
            windscreens: {
                consumer: [
                    {
                        name: 'Rode DeadCat VMPR',
                        price: '€30-40',
                        features: ['Effective furry windshield', 'Fits VideoMic Pro/NTG', 'Wind reduction 20dB', 'Rode quality'],
                        link: 'https://www.thomann.it/rode_deadcat_vmpr.htm'
                    },
                    {
                        name: 'Rycote Mini Windjammer',
                        price: '€40-50',
                        features: ['For portable recorders', 'Fits Zoom H1n/H4n/H5/H6', 'High-quality fur', 'Secure elastic mount'],
                        link: 'https://www.thomann.it/rycote_mini_wind_screen_for_zoom_h5.htm'
                    },
                    {
                        name: 'Rode DeadCat GO',
                        price: '€20-30',
                        features: ['For VideoMic GO/ME', 'Budget-friendly', 'Effective wind protection', 'Compact'],
                        link: 'https://www.thomann.it/rode_deadcat_go.htm'
                    }
                ],
                professional: [
                    {
                        name: 'Rycote Super-Softie',
                        price: '€90-120',
                        features: ['Premium slip-on windshield', 'For shotguns up to 24cm', 'Wind reduction up to 30dB', 'Mounting clips included'],
                        link: 'https://www.thomann.it/rycote_super_softie_windshield_18cm.htm'
                    },
                    {
                        name: 'Rode Blimp MKII',
                        price: '€330-400',
                        features: ['Complete windshield system', 'Rycote Lyre shock mount', 'Fits shotguns up to 325mm', 'Dead Wombat included'],
                        link: 'https://www.thomann.it/rode_blimp_mkii.htm'
                    },
                    {
                        name: 'Rycote Nano-Shield Kit NS4-DB',
                        price: '€400-500',
                        features: ['Sistema professionale completo', 'Lyre suspension mount', 'Windjammer furry incluso', 'Standard broadcast'],
                        link: 'https://www.thomann.it/rycote_nano_shield_kit_ns4_db.htm'
                    }
                ]
            },
            stands: {
                consumer: [
                    {
                        name: 'K&M 210/2 Microphone Stand',
                        price: '€25-35',
                        features: ['Telescopica 900-1600mm', 'Base tripod stabile', 'Boom arm incluso', 'K&M qualità tedesca'],
                        link: 'https://www.thomann.it/km_210_2_mikrofonstativ.htm'
                    },
                    {
                        name: 'K&M 23325 Table Stand',
                        price: '€35-45',
                        features: ['Base ghisa pesante', 'Altezza 217-347mm', 'Perfetto per desk recording', 'Super stabile'],
                        link: 'https://www.thomann.it/km_23325_table_microphone_stand.htm'
                    },
                    {
                        name: 'K&M 23150 Table Stand',
                        price: '€15-25',
                        features: ['Mini stand da tavolo', 'Base compatta portatile', 'Altezza regolabile', 'Perfetto per field recording'],
                        link: 'https://www.thomann.it/km_23150.htm'
                    }
                ],
                professional: [
                    {
                        name: 'K&M 259 Low Tripod Boom',
                        price: '€110-150',
                        features: ['Low-profile per ground micing', 'Boom professionale', 'Altezza 530-995mm', 'Stabile e versatile'],
                        link: 'https://www.thomann.it/km_259_mic_stand.htm'
                    },
                    {
                        name: 'K&M 210/9 Studio Boom',
                        price: '€60-80',
                        features: ['Boom lungo professionale', 'Altezza 900-1605mm', 'Base pesante stabile', 'Industry workhorse'],
                        link: 'https://www.thomann.it/km_210_9_mikrofonstativ.htm'
                    },
                    {
                        name: 'K&M 25400 Speaker Stand',
                        price: '€80-110',
                        features: ['Professionale e compatto', 'Altezza 1.2-1.8m', 'Telescopico robusto', 'Carico max 50kg'],
                        link: 'https://www.thomann.it/km_25400.htm'
                    }
                ]
            },
            storage: [
                {
                    name: 'SanDisk Extreme PRO 128GB',
                    price: '€25-35',
                    features: ['Read 200MB/s Write 90MB/s', 'UHS-I U3 V30', 'Affidabilità comprovata', 'Ottima per 96kHz/24bit'],
                    link: 'https://www.amazon.it/dp/B07H48412Q'
                },
                {
                    name: 'Sony SF-G Tough 128GB',
                    price: '€50-70',
                    features: ['Read 300MB/s Write 299MB/s', 'UHS-II velocissima', 'Waterproof dustproof', 'Top per 32-bit float'],
                    link: 'https://www.amazon.it/dp/B07FDTVCVL'
                },
                {
                    name: 'Lexar Professional 256GB',
                    price: '€40-60',
                    features: ['Read 270MB/s Write 150MB/s', 'UHS-II V90', 'Capacità doppia', 'Rapporto qualità/prezzo'],
                    link: 'https://www.amazon.it/dp/B07MG44FDJ'
                },
                {
                    name: 'Samsung PRO Plus 512GB',
                    price: '€60-80',
                    features: ['Enorme capacità 512GB', 'Read 160MB/s Write 120MB/s', 'UHS-I U3', '10 anni garanzia'],
                    link: 'https://www.amazon.it/dp/B09B1HMJ9Z'
                }
            ],
            bags: [
                {
                    name: 'Thomann Recorder Bag Universal',
                    price: '€20-30',
                    features: ['Protezione imbottita', 'Fit Zoom/Tascam portatili', 'Tasche per accessori', 'Budget-friendly'],
                    link: 'https://www.thomann.it/thomann_recorder_bag_universal.htm'
                },
                {
                    name: 'Orca OR-28 Audio Bag',
                    price: '€130-170',
                    features: ['Per recorder compatti', 'Fit MixPre-3/Zoom F3', 'Padding interno regolabile', 'Harness confortevole'],
                    link: 'https://www.thomann.it/orca_or_28.htm'
                },
                {
                    name: 'Zoom PCF-6 Protective Bag',
                    price: '€90-120',
                    features: ['Specifico per Zoom F6', 'Due compartimenti separati', 'Sistema cinghie versatile', 'Ottima protezione'],
                    link: 'https://www.thomann.it/zoom_pcf_6.htm'
                },
                {
                    name: 'Thomann Case Recorder Large',
                    price: '€40-60',
                    features: ['Hard case protettivo', 'Foam customizzabile', 'Waterproof crushproof', 'Ottimo value'],
                    link: 'https://www.thomann.it/thomann_case_recorder_large.htm'
                }
            ],
            smartphones: [
                {
                    name: 'iPhone 15 Pro / Pro Max',
                    price: '€1200-1500',
                    features: ['4 microfoni studio-quality', 'Spatial Audio recording', 'ProRes video audio 48kHz', 'Apps: FiRe, Ferrite, AudioShare']
                },
                {
                    name: 'iPhone 14 Pro',
                    price: '€900-1200',
                    features: ['Ottimo audio array', 'Dolby Atmos recording', 'Riduzione rumore AI', 'Best value iPhone pro']
                },
                {
                    name: 'Samsung Galaxy S24 Ultra',
                    price: '€1200-1400',
                    features: ['3 microfoni AKG-tuned', 'Audio 360° recording', 'Pro video mode con gain', 'Android flagship']
                }
            ],
            software: [
                {
                    name: 'Reaper',
                    price: '€60 (licenza personale)',
                    features: ['DAW completo leggero', 'Editing multitrack illimitato', 'VST/AU support', 'Cross-platform'],
                    link: 'https://www.reaper.fm/purchase.php'
                },
                {
                    name: 'iZotope RX 10 Standard',
                    price: '€350-450',
                    features: ['Noise reduction AI-powered', 'Spectral repair tools', 'Standard audio restoration', 'Standalone o plugin'],
                    link: 'https://www.pluginboutique.com/product/2-Effects/39-FX-Bundle/9222-RX-10-Standard'
                },
                {
                    name: 'Audacity',
                    price: 'Gratis (open source)',
                    features: ['Editor multitrack gratis', 'Analisi spettrale', 'Effetti base inclusi', 'Community enorme'],
                    link: 'https://www.audacityteam.org/download/'
                },
                {
                    name: 'Wavelab Pro 12',
                    price: '€500-600',
                    features: ['Mastering professionale', 'Analisi avanzata', 'Batch processing', 'Metering broadcast'],
                    link: 'https://www.pluginboutique.com/product/2-Effects/41-Mastering/9856-WaveLab-Pro-12'
                },
                {
                    name: 'Max/MSP',
                    price: '€400 (€8/mese studenti)',
                    features: ['Visual audio programming', 'Custom tools', 'Real-time processing', 'Community patches'],
                    link: 'https://cycling74.com/products/max'
                }
            ]
        };

        // Reference content};

        // Reference content
        var referenceContent = {
            'polar-patterns': {
                title: '🎙️ Polar Patterns',
                content: `
                    <h3 style="color: #2d5f4f;">What are Polar Patterns?</h3>
                    <p><strong>Polar patterns</strong> show from which direction a microphone captures sound. Each pattern is optimized for different situations in field recording.</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">🔴 Omnidirectional</h4>
                            <div style="width: 80px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50%; margin: 10px auto;"></div>
                            <p><strong>Captures:</strong> 360° all around</p>
                            <p><strong>Use for:</strong> Natural ambience, architectural spaces, capturing full environment</p>
                            <p><strong>Avoid:</strong> Noisy environments, when isolation is needed</p>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">❤️ Cardioid</h4>
                            <div style="width: 80px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50% 50% 50% 0; margin: 10px auto; transform: rotate(-135deg);"></div>
                            <p><strong>Captures:</strong> Front (90°), rejects rear</p>
                            <p><strong>Use for:</strong> Interviews, voice-over, specific source isolation</p>
                            <p><strong>Avoid:</strong> When you need to capture the full environment</p>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">🎯 Shotgun (Lobar)</h4>
                            <div style="width: 100px; height: 60px; border: 3px solid #2d5f4f; border-radius: 0 30px 30px 0; margin: 10px auto;"></div>
                            <p><strong>Captures:</strong> Hyper-directional (30-40°)</p>
                            <p><strong>Use for:</strong> Distant subjects, wildlife, maximum lateral rejection</p>
                            <p><strong>Avoid:</strong> Enclosed spaces (reflections), wide ambience</p>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2d5f4f;">∞ Figure-8 (Bidirectional)</h4>
                            <div style="width: 40px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50%; margin: 10px auto;"></div>
                            <div style="width: 40px; height: 80px; border: 3px solid #2d5f4f; border-radius: 50%; margin: -90px auto 10px; transform: rotate(0deg);"></div>
                            <p><strong>Captures:</strong> Front and rear, rejects sides</p>
                            <p><strong>Use for:</strong> Face-to-face interviews, MS stereo (Mid-side), dialogues</p>
                            <p><strong>Avoid:</strong> Environments with lateral noise</p>
                        </div>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 Practical Tips</h4>
                        <ul>
                            <li><strong>Omnidirectional:</strong> Perfect for capturing "room tone" and complete ambience of a space</li>
                            <li><strong>Cardioid:</strong> The all-rounder - 80% of field recordings use this pattern</li>
                            <li><strong>Shotgun:</strong> Essential for wildlife and situations where you can't get close</li>
                            <li><strong>Stereo X/Y:</strong> Two cardioids at 90° = natural stereo image</li>
                            <li><strong>MS (Mid-Side):</strong> Cardioid + Figure-8 = adjustable stereo width in post!</li>
                        </ul>
                    </div>
                `
            },
            'frequency-chart': {
                title: '📊 Audio Frequency Guide',
                content: `
                    <h3 style="color: #2d5f4f;">Audio Spectrum 20Hz - 20kHz</h3>
                    <p>Understanding frequencies helps you <strong>identify sounds</strong>, <strong>choose microphones</strong> and <strong>apply correct EQ</strong>.</p>

                    <div class="frequency-bar">
                        <div class="frequency-section" style="background: #1a237e; flex: 1;">
                            <div>SUB BASS<br>20-60 Hz<br><small>Physical feel</small></div>
                        </div>
                        <div class="frequency-section" style="background: #283593; flex: 1.5;">
                            <div>BASS<br>60-250 Hz<br><small>Bass fundamental</small></div>
                        </div>
                        <div class="frequency-section" style="background: #303f9f; flex: 2;">
                            <div>LOW MIDS<br>250-500 Hz<br><small>Warmth, body</small></div>
                        </div>
                        <div class="frequency-section" style="background: #3949ab; flex: 2;">
                            <div>MIDS<br>500Hz-2kHz<br><small>Voice, presence</small></div>
                        </div>
                        <div class="frequency-section" style="background: #1e88e5; flex: 2;">
                            <div>HIGH MIDS<br>2-4 kHz<br><small>Definition, clarity</small></div>
                        </div>
                        <div class="frequency-section" style="background: #42a5f5; flex: 1.5;">
                            <div>PRESENCE<br>4-6 kHz<br><small>Intelligibility</small></div>
                        </div>
                        <div class="frequency-section" style="background: #64b5f6; flex: 2;">
                            <div>TREBLE<br>6-12 kHz<br><small>Brightness</small></div>
                        </div>
                        <div class="frequency-section" style="background: #90caf9; flex: 1;">
                            <div>AIR<br>12-20 kHz<br><small>Space, air</small></div>
                        </div>
                    </div>

                    <h4 style="color: #2d5f4f; margin-top: 30px;">Soundscape Examples by Frequency</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #1a237e;">
                            <strong>20-60 Hz (Sub Bass)</strong><br>
                            Distant thunder, heavy traffic, strong wind, earthquake, large ocean waves
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #283593;">
                            <strong>60-250 Hz (Bass)</strong><br>
                            Engines, urban rumble, low male voice, kick drum, double bass
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #303f9f;">
                            <strong>250-500 Hz (Low Mids)</strong><br>
                            Human voice fundamental, acoustic guitar body, medium traffic, footsteps on wood
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #3949ab;">
                            <strong>500Hz-2kHz (Mids)</strong><br>
                            Speech (intelligibility), piano, most instruments, slamming doors
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #1e88e5;">
                            <strong>2-4 kHz (High Mids)</strong><br>
                            Voice detail, cymbal crash, sibilants, bells, car horns
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #42a5f5;">
                            <strong>4-6 kHz (Presence)</strong><br>
                            Birds chirping, leaf rustling, hi-hat, strong sibilants, crickets
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #64b5f6;">
                            <strong>6-12 kHz (Treble)</strong><br>
                            High-pitched chirps, cicadas, wind chimes, cymbal shimmer, wind rustle
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #90caf9;">
                            <strong>12-20 kHz (Air)</strong><br>
                            Spatiality, natural reverb, extreme harmonics, recording "air"
                        </div>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 How to Use This Guide</h4>
                        <ul>
                            <li><strong>Microphone Choice:</strong> If recording birds (4-12kHz), you need a mic with extended high freq response</li>
                            <li><strong>EQ in Post:</strong> Traffic rumble (60-250Hz)? High-pass filter at 80-100Hz</li>
                            <li><strong>Identification:</strong> Analyze with spectrogram to "see" where the sound lives</li>
                            <li><strong>Mixing:</strong> Every soundscape element occupies a space - avoid overlaps</li>
                        </ul>
                    </div>
                `
            },
            'eq-settings': {
                title: '🎚️ EQ Settings for Environments',
                content: `
                    <h3 style="color: #2d5f4f;">EQ Strategies for Field Recording</h3>
                    <p>Equalization allows you to <strong>clean unwanted noise</strong> and <strong>emphasize key elements</strong> of your soundscape.</p>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">EQ Presets by Environment</h4>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🌳 Nature / Forest</h4>
                        <p><strong>Goal:</strong> Preserve natural detail, remove wind rumble</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 80Hz (-12dB/oct):</strong> Removes low wind and rumble</li>
                            <li><strong>+2dB @ 5-8kHz (shelf):</strong> Enhances birds and leaf rustle</li>
                            <li><strong>-1dB @ 200-400Hz (wide Q):</strong> Reduces mud if present</li>
                            <li><strong>Tip:</strong> Maintain natural dynamic range - don't over-compress!</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🏙️ Urban / City</h4>
                        <p><strong>Goal:</strong> Balance traffic rumble with human details</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 60-100Hz:</strong> Controls engine sub bass (be careful not to cut too much!)</li>
                            <li><strong>-3dB @ 150-250Hz (narrow Q):</strong> Cuts annoying traffic resonance</li>
                            <li><strong>+1-2dB @ 2-4kHz:</strong> Brings forward voices and human details</li>
                            <li><strong>Tip:</strong> Urban rumble is part of the landscape - don't eliminate it completely!</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🌊 Water / Ocean</h4>
                        <p><strong>Goal:</strong> Capture water movement without harshness</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 40Hz:</strong> Maintain sub bass of large waves</li>
                            <li><strong>+1-2dB @ 8-12kHz (shelf):</strong> Enhances spray and foam detail</li>
                            <li><strong>-2dB @ 3-4kHz (if harsh):</strong> Softens aggressive splashes</li>
                            <li><strong>Tip:</strong> Waves have a lot of low-end - record with headroom!</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🏛️ Interiors / Architecture</h4>
                        <p><strong>Goal:</strong> Control reverb, preserve spatiality</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 100Hz:</strong> Removes room rumble and HVAC</li>
                            <li><strong>-2-3dB @ 200-500Hz (wide Q):</strong> Reduces space boominess</li>
                            <li><strong>+1dB @ 10-15kHz:</strong> Recovers air and dimension</li>
                            <li><strong>Tip:</strong> Use de-reverb (iZotope RX) if too reflective</li>
                        </ul>
                    </div>

                    <div class="eq-diagram">
                        <h4 style="color: #2d5f4f; margin: 0 0 10px 0;">🎤 Voice / Interview</h4>
                        <p><strong>Goal:</strong> Maximum intelligibility and naturalness</p>
                        <ul>
                            <li><strong>High-Pass Filter @ 80-120Hz:</strong> Eliminates proximity effect and plosives</li>
                            <li><strong>+2-3dB @ 3-5kHz (presence peak):</strong> Increases clarity and intelligibility</li>
                            <li><strong>-2dB @ 200-300Hz (for male voice):</strong> Reduces muddiness</li>
                            <li><strong>De-esser @ 6-8kHz:</strong> Controls sibilants (not EQ - dynamics!)</li>
                        </ul>
                    </div>

                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800;">
                        <h4 style="color: #e65100;">⚠️ Golden EQ Rules</h4>
                        <ol>
                            <li><strong>Subtract before adding:</strong> Cut eliminates problems, boost introduces artifacts</li>
                            <li><strong>Always high-pass:</strong> Frequencies below 40Hz are almost always useless and eat headroom</li>
                            <li><strong>Wide Q for musical, Narrow Q for problems:</strong> Broad boost sounds natural, narrow cut fixes resonances</li>
                            <li><strong>A/B constantly:</strong> Ears adapt - always compare with original</li>
                            <li><strong>Less is more:</strong> If you need +10dB, you probably have the wrong mic or bad placement</li>
                            <li><strong>Context matters:</strong> EQ for headphones ≠ EQ for speakers ≠ EQ for installation</li>
                        </ol>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 Recommended Tools</h4>
                        <ul>
                            <li><strong>FabFilter Pro-Q 3:</strong> Surgical EQ with real-time spectral analyzer</li>
                            <li><strong>Voxengo SPAN:</strong> Free spectral analyzer to identify problems</li>
                            <li><strong>iZotope Ozone EQ:</strong> AI-assisted EQ matching (copies reference tone)</li>
                            <li><strong>Waves Renaissance EQ:</strong> Musical and vintage-sounding for organic material</li>
                        </ul>
                    </div>
                `
            },
            'sample-rate': {
                title: '💿 Sample Rate & Bit Depth - Audio Format Guide',
                content: `
                    <h3 style="color: #2d5f4f;">Sample Rate and Bit Depth Explained</h3>
                    <p>Choosing the right format means balancing <strong>audio quality</strong>, <strong>file size</strong> and <strong>compatibility</strong>.</p>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">📊 Sample Rate (Sampling Frequency)</h4>
                    <p>How many "snapshots" of the audio signal are captured per second. Higher = more high frequency detail.</p>

                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background: #2d5f4f; color: white;">
                            <th style="padding: 10px; text-align: left;">Sample Rate</th>
                            <th style="padding: 10px; text-align: left;">Max Freq</th>
                            <th style="padding: 10px; text-align: left;">Use For</th>
                            <th style="padding: 10px; text-align: left;">Notes</th>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>44.1 kHz</strong></td>
                            <td style="padding: 10px;">22.05 kHz</td>
                            <td style="padding: 10px;">CD, streaming, podcasts</td>
                            <td style="padding: 10px;">Consumer standard. More than enough for 99% of human hearing (20Hz-20kHz)</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;"><strong>48 kHz</strong></td>
                            <td style="padding: 10px;">24 kHz</td>
                            <td style="padding: 10px;">Video, TV, film, game audio</td>
                            <td style="padding: 10px;">Video industry standard. Perfect sync with frame rates</td>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>96 kHz</strong></td>
                            <td style="padding: 10px;">48 kHz</td>
                            <td style="padding: 10px;">Pro field recording, sound design</td>
                            <td style="padding: 10px;">Great for pitch-shifting/time-stretching. Captures ultrasonics (useful for slowing down)</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;"><strong>192 kHz</strong></td>
                            <td style="padding: 10px;">96 kHz</td>
                            <td style="padding: 10px;">Extreme sound design, archival</td>
                            <td style="padding: 10px;">Huge files. Only for extreme manipulation or archival mastering</td>
                        </tr>
                    </table>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">🎚️ Bit Depth</h4>
                    <p>How many "volume levels" can be represented. Higher = more dynamic range and lower noise floor.</p>

                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background: #2d5f4f; color: white;">
                            <th style="padding: 10px; text-align: left;">Bit Depth</th>
                            <th style="padding: 10px; text-align: left;">Dynamic Range</th>
                            <th style="padding: 10px; text-align: left;">Use For</th>
                            <th style="padding: 10px; text-align: left;">Notes</th>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>16-bit</strong></td>
                            <td style="padding: 10px;">~96 dB</td>
                            <td style="padding: 10px;">CD, final delivery</td>
                            <td style="padding: 10px;">Never record in 16-bit! Only for final export</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;"><strong>24-bit</strong></td>
                            <td style="padding: 10px;">~144 dB</td>
                            <td style="padding: 10px;">Field recording, studio tracking</td>
                            <td style="padding: 10px;">Professional standard. Huge headroom = less clipping risk</td>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;"><strong>32-bit float</strong></td>
                            <td style="padding: 10px;">~1500 dB (!)</td>
                            <td style="padding: 10px;">Unpredictable field recording</td>
                            <td style="padding: 10px;">🚀 Impossible to clip! Can recover everything in post. Game changer!</td>
                        </tr>
                    </table>

                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;">
                        <h4 style="color: #1565c0;">🚀 32-bit Float - Why It's Revolutionary</h4>
                        <p>Modern recorders (Sound Devices MixPre, Zoom F6) record in <strong>32-bit float</strong>:</p>
                        <ul>
                            <li>✅ <strong>No gain staging:</strong> No need to set levels beforehand - do it all in post!</li>
                            <li>✅ <strong>No clipping:</strong> Even if you record "in the red", audio beyond 0dB is recoverable</li>
                            <li>✅ <strong>Unpredictable situations:</strong> Thunderstorms, protests, wildlife - capture everything from whisper to explosion</li>
                            <li>✅ <strong>Dual ADC:</strong> Records 2 simultaneous conversions (one hot, one safe) - choose which to use later</li>
                        </ul>
                        <p><strong>Disadvantage:</strong> Files 2x larger than 24-bit (but storage is cheap, ruined audio isn't!)</p>
                    </div>

                    <h4 style="color: #2d5f4f; margin-top: 25px;">🎯 Recommendations for Soundscape</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <h4 style="color: #2d5f4f;">✅ Recommended Setup</h4>
                            <p><strong>Recording:</strong></p>
                            <ul>
                                <li>96kHz / 24-bit (or 32-bit float if available)</li>
                                <li>WAV uncompressed</li>
                                <li>Mono or stereo (never MP3!)</li>
                            </ul>
                            <p><strong>Final Delivery:</strong></p>
                            <ul>
                                <li>48kHz / 24-bit for installations</li>
                                <li>44.1kHz / 16-bit for streaming</li>
                            </ul>
                        </div>

                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <h4 style="color: #2d5f4f;">⚡ Best Practices</h4>
                            <ul>
                                <li><strong>96kHz if:</strong> You'll do pitch/time manipulation, or want to capture ultrasonics (bat calls, insects)</li>
                                <li><strong>48kHz if:</strong> For video sync or standard archiving</li>
                                <li><strong>32-bit float if:</strong> Unpredictable situations (thunderstorms, crowds, wildlife)</li>
                                <li><strong>24-bit if:</strong> Controlled setup, careful gain staging</li>
                            </ul>
                        </div>
                    </div>

                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800;">
                        <h4 style="color: #e65100;">⚠️ Myths to Bust</h4>
                        <ul>
                            <li>❌ <strong>"192kHz sounds better":</strong> No. Human hearing reaches ~20kHz. 192kHz only needed for extreme processing</li>
                            <li>❌ <strong>"Higher is always better":</strong> No. 192kHz = 4x larger files, more CPU, more problems. Use only if necessary</li>
                            <li>❌ <strong>"MP3 320kbps equals WAV":</strong> No! Never record in lossy. Always WAV or FLAC</li>
                            <li>✅ <strong>"48kHz/24bit is the pro sweet spot":</strong> Yes! Excellent quality, reasonable files, total compatibility</li>
                        </ul>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #2d5f4f;">💡 File Size Reference (1 minute stereo)</h4>
                        <ul>
                            <li>44.1kHz / 16-bit: ~10 MB</li>
                            <li>48kHz / 24-bit: ~17 MB</li>
                            <li>96kHz / 24-bit: ~34 MB</li>
                            <li>96kHz / 32-bit float: ~46 MB</li>
                            <li>192kHz / 24-bit: ~69 MB (!)</li>
                        </ul>
                        <p><strong>Tip:</strong> A field recording day (4 hours @ 96/24) = about 8GB. Bring external drives!</p>
                    </div>
                `
            }
        };

        // Show Reference Modal
        window.showReferenceModal = function(type) {
            var modal = document.getElementById('referenceModal');
            var content = document.getElementById('referenceContent');
            var data = referenceContent[type];

            if (data) {
                content.innerHTML = `
                    <h2 style="color: #2d5f4f; margin-bottom: 20px;">${data.title}</h2>
                    ${data.content}
                `;
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        };

        // Close Reference Modal
        window.closeReferenceModal = function() {
            var modal = document.getElementById('referenceModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Show Equipment Tab
        window.showEquipmentTab = function(category) {
            // Update active button
            var buttons = document.querySelectorAll('[data-equipment]');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.querySelector('[data-equipment="' + category + '"]').classList.add('active');

            // Render content
            var contentDiv = document.getElementById('equipment-content');
            var html = '';

            if (category === 'recorders' || category === 'microphones' || category === 'windscreens' || category === 'stands') {
                var data = equipmentData[category];

                html += '<h4 style="color: #2d5f4f; margin: 20px 0 15px 0;">💚 Consumer / Enthusiast</h4>';
                html += '<div class="equipment-grid">';
                data.consumer.forEach(function(item) {
                    html += `
                        <div class="equipment-card">
                            <span class="category-badge">CONSUMER</span>
                            <h4>${item.name}</h4>
                            <div class="price">${item.price}</div>
                            <ul>
                                ${item.features.map(f => '<li>' + f + '</li>').join('')}
                            </ul>
                            ${item.link ? `<a href="${item.link}" target="_blank" rel="noopener" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #2d5f4f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">🛒 Buy</a>` : ''}
                        </div>
                    `;
                });
                html += '</div>';

                html += '<h4 style="color: #2d5f4f; margin: 30px 0 15px 0;">🔥 Professional</h4>';
                html += '<div class="equipment-grid">';
                data.professional.forEach(function(item) {
                    html += `
                        <div class="equipment-card">
                            <span class="category-badge" style="background: #d32f2f;">PROFESSIONAL</span>
                            <h4>${item.name}</h4>
                            <div class="price">${item.price}</div>
                            ${item.review ? `<div style="background: #fff8f0; padding: 12px; border-left: 3px solid #d32f2f; margin: 10px 0; border-radius: 4px;"><p style="margin: 0; font-size: 13px; color: #555; line-height: 1.6; font-style: italic;">"${item.review}"</p></div>` : ''}
                            <ul>
                                ${item.features.map(f => '<li>' + f + '</li>').join('')}
                            </ul>
                            ${item.link ? `<a href="${item.link}" target="_blank" rel="noopener" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #d32f2f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">🛒 Buy</a>` : ''}
                        </div>
                    `;
                });
                html += '</div>';

            } else if (category === 'smartphones' || category === 'software' || category === 'storage' || category === 'bags') {
                var data = equipmentData[category];
                html += '<div class="equipment-grid">';
                data.forEach(function(item) {
                    html += `
                        <div class="equipment-card">
                            <h4>${item.name}</h4>
                            <div class="price">${item.price}</div>
                            <ul>
                                ${item.features.map(f => '<li>' + f + '</li>').join('')}
                            </ul>
                            ${item.link ? `<a href="${item.link}" target="_blank" rel="noopener" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #2d5f4f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">${category === 'software' ? '💻 Visit' : '🛒 Buy'}</a>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            contentDiv.innerHTML = html;
        };

        // Initialize equipment tab - call this when toolkit section is shown
        var toolkitInitialized = false;

        window.initializeToolkit = function() {
            if (!toolkitInitialized && document.getElementById('equipment-content')) {
                showEquipmentTab('recorders');
                toolkitInitialized = true;
            }
        };

        // ==================== LIBRARY SECTION ====================

        var libraryData = {
            books: [
                {
                    title: 'The Soundscape: Our Sonic Environment and the Tuning of the World',
                    author: 'R. Murray Schafer',
                    category: 'FOUNDATIONAL',
                    description: 'The foundational text that defined the field of acoustic ecology. Schafer introduces key concepts like soundmark, keynote sounds, and schizophonia. Required reading for anyone working with soundscape.',
                    link: 'https://www.amazon.com/Soundscape-Our-Sonic-Environment-Tuning/dp/0892814551?tag=soundscapestu-21'
                },
                {
                    title: 'Sonic Experience: A Guide to Everyday Sounds',
                    author: 'Jean-François Augoyard & Henry Torgue',
                    category: 'FOUNDATIONAL',
                    description: 'A compendium of 82 "sonic effects" that structure our daily sound experience. Essential phenomenological approach for sound designers and researchers.',
                    link: 'https://www.amazon.com/Sonic-Experience-Guide-Everyday-Sounds/dp/0773532447?tag=soundscapestu-21'
                },
                {
                    title: 'The Great Animal Orchestra: Finding the Origins of Music in the Wild',
                    author: 'Bernie Krause',
                    category: 'ACOUSTIC ECOLOGY',
                    description: 'The bioacoustics pioneer explores how animals created the planet\'s "first orchestra". Includes spectrograms and analysis of natural soundscapes from around the world.',
                    link: 'https://www.amazon.com/Great-Animal-Orchestra-Finding-Origins/dp/031608686X?tag=soundscapestu-21'
                },
                {
                    title: 'Listening to Noise and Silence',
                    author: 'Salomé Voegelin',
                    category: 'PHILOSOPHY',
                    description: 'Phenomenological approach to sonic listening. Explores how active listening transforms the perception of space and time.',
                    link: 'https://www.amazon.com/Listening-Noise-Silence-Towards-Philosophy/dp/1441162070?tag=soundscapestu-21'
                },
                {
                    title: 'Ocean of Sound: Aether Talk, Ambient Sound',
                    author: 'David Toop',
                    category: 'HISTORY',
                    description: 'Cultural history of ambient music and soundscape from 1889 to today. Connects Debussy, Cage, Brian Eno, and electronic music in a fascinating narrative.',
                    link: 'https://www.amazon.com/Ocean-Sound-Aether-Talk-Ambient/dp/1852427434?tag=soundscapestu-21'
                },
                {
                    title: 'Handbook for Acoustic Ecology',
                    author: 'Barry Truax',
                    category: 'REFERENCE',
                    description: 'Definitive dictionary of acoustic ecology terms. Available free online - essential resource for understanding field terminology.',
                    link: 'https://www.sfu.ca/sonic-studio-webdav/handbook/index.html'
                },
                {
                    title: 'In The Field: The Art of Field Recording',
                    author: 'Cathy Lane & Angus Carlyle',
                    category: 'PRACTICE',
                    description: 'Collection of interviews with contemporary sound artists who use field recording. Covers technical, ethical and aesthetic aspects of the practice.',
                    link: 'https://www.amazon.com/Field-Art-Recording/dp/0956855962?tag=soundscapestu-21'
                },
                {
                    title: 'Soundscape Ecology: Principles, Patterns, Methods and Applications',
                    author: 'Almo Farina',
                    category: 'SCIENCE',
                    description: 'Scientific approach to soundscape ecology. Includes quantitative methodologies for analyzing soundscapes and acoustic biodiversity.',
                    link: 'https://www.amazon.com/Soundscape-Ecology-Principles-Patterns-Applications/dp/9401794588?tag=soundscapestu-21'
                },
                {
                    title: 'Deep Listening: A Composer\'s Sound Practice',
                    author: 'Pauline Oliveros',
                    category: 'PRACTICE',
                    description: 'Foundational text on deep listening. Exercises and philosophy to expand sonic awareness through active listening practice.',
                    link: 'https://www.amazon.com/Deep-Listening-Composers-Sound-Practice/dp/0595343643?tag=soundscapestu-21'
                }
            ],
            videos: [
                {
                    title: 'The Voice of Landscape - Bernie Krause TED Talk',
                    author: 'Bernie Krause',
                    category: 'TED TALK',
                    description: 'Acoustic biologist Bernie Krause presents 45 years of natural recordings, showing how the natural soundscape is dramatically deteriorating.',
                    link: 'https://www.youtube.com/watch?v=uTbp0c68FTY'
                },
                {
                    title: 'Giorgio Nottoli - Soundscape e Paesaggio Sonoro',
                    author: 'Giorgio Nottoli',
                    category: 'DOCUMENTARY',
                    description: 'Documentary and lecture by Giorgio Nottoli on the concept of soundscape. In-depth look at Italian research in acoustic ecology and sound studies.',
                    link: 'https://www.youtube.com/watch?v=MqxfMtw6DmM'
                },
                {
                    title: 'Hildegard Westerkamp - Soundwalking',
                    author: 'Hildegard Westerkamp',
                    category: 'ARTICLE',
                    description: 'The Canadian composer explains the practice of soundwalking and how attentive listening transforms environmental perception. Foundational text from her official site.',
                    link: 'https://www.hildegardwesterkamp.ca/writings/writingsby/?post_id=13&title=soundwalking'
                },
                {
                    title: 'Chris Watson - Weather Report (Documentary)',
                    author: 'Chris Watson',
                    category: 'DOCUMENTARY',
                    description: 'The BBC master field recordist shows his creative process recording extreme environments around the world.',
                    link: 'https://www.youtube.com/results?search_query=chris+watson+weather+report'
                },
                {
                    title: 'Francisco López - Blind Listening',
                    author: 'Francisco López',
                    category: 'PERFORMANCE',
                    description: 'Blindfolded listening performance by the Spanish sound artist. Radical approach to acousmatic listening.',
                    link: 'https://www.youtube.com/results?search_query=francisco+lopez+blind+listening'
                },
                {
                    title: 'Sonic Acts - Field Recording Symposium',
                    author: 'Various Artists',
                    category: 'CONFERENCE',
                    description: 'Lectures and performances from the Dutch Sonic Acts festival. Includes presentations by Jana Winderen, Chris Watson, and others. Videos available on YouTube.',
                    link: 'https://sonicacts.com/'
                },
                {
                    title: 'Gordon Hempton - One Square Inch of Silence',
                    author: 'Gordon Hempton',
                    category: 'DOCUMENTARY',
                    description: 'Acoustic ecologist Gordon Hempton presents his mission to preserve naturally quiet places in the USA.',
                    link: 'https://www.youtube.com/results?search_query=gordon+hempton+one+square+inch'
                }
            ],
            audio: [
                {
                    title: 'World Soundscape Project Archive',
                    author: 'Simon Fraser University',
                    category: 'ARCHIVE',
                    description: 'Historical archive of the project founded by Schafer in the \'70s. Includes recordings from Vancouver, Europe, and "Five Village Soundscapes" projects.',
                    link: 'https://www.sfu.ca/~truax/wsp.html'
                },
                {
                    title: 'Freesound',
                    author: 'Community-driven',
                    category: 'DATABASE',
                    description: 'Collaborative database with over 500,000 free sounds under Creative Commons licenses. Great for finding examples and composition material.',
                    link: 'https://freesound.org/'
                },
                {
                    title: 'Cities and Memory',
                    author: 'Stuart Fowkes',
                    category: 'GLOBAL PROJECT',
                    description: 'Global sound map with field recordings and artistic reinterpretations. Over 5000 sounds from 100+ countries.',
                    link: 'https://citiesandmemory.com/'
                },
                {
                    title: 'Touch Radio',
                    author: 'Touch Records',
                    category: 'PODCAST',
                    description: 'Monthly podcast of field recordings and sound art from the legendary Touch label. Artists: Chris Watson, BJ Nilsen, Philip Jeck.',
                    link: 'https://www.touchradio.org.uk/'
                },
                {
                    title: 'Locus Sonus Soundmap',
                    author: 'Locus Sonus Research Lab',
                    category: 'LIVE STREAMING',
                    description: 'World map of live streaming microphones. Listen to sounds in real-time from around the world.',
                    link: 'https://locusonus.org/soundmap/'
                },
                {
                    title: 'Aporee Maps',
                    author: 'Aporee Community',
                    category: 'SOUND MAP',
                    description: 'Collaborative platform for sharing geo-located field recordings. Over 20,000 recordings.',
                    link: 'https://aporee.org/maps/'
                },
                {
                    title: 'BBC Sound Effects Library',
                    author: 'BBC',
                    category: 'ARCHIVE',
                    description: 'Over 16,000 BBC sound effects available for personal, educational and research download. Broadcast quality.',
                    link: 'https://sound-effects.bbcrewind.co.uk/'
                },
                {
                    title: 'Sounding Nature - Cornell Lab',
                    author: 'Cornell Lab of Ornithology',
                    category: 'NATURE',
                    description: 'Macaulay Library Archive: 1+ million recordings of birds, mammals, insects. Foundational scientific resource.',
                    link: 'https://www.macaulaylibrary.org/'
                }
            ],
            papers: [
                {
                    title: 'The Soundscape of Modernity',
                    author: 'Emily Thompson',
                    category: 'BOOK',
                    description: 'Foundational academic book on the transformation of American soundscape 1900-1933. Historical analysis of acoustic industrialization and birth of sonic modernity.',
                    link: 'https://mitpress.mit.edu/9780262701068/the-soundscape-of-modernity/'
                },
                {
                    title: 'Acoustic Ecology and the World Soundscape Project',
                    author: 'Barry Truax',
                    category: 'ARTICLE',
                    description: 'Historical overview of the World Soundscape Project and development of acoustic ecology as a discipline. Documents and methodologies of the original project.',
                    link: 'https://www.sfu.ca/~truax/wsp.html'
                },
                {
                    title: 'Soundscape Indices for Environmental Monitoring',
                    author: 'Pijanowski et al.',
                    category: 'SCIENTIFIC PAPER',
                    description: 'Quantitative methodologies for measuring biodiversity through soundscape. Includes Acoustic Complexity Index (ACI), Acoustic Diversity Index, and other ecological indices.',
                    link: 'https://www.sciencedirect.com/science/article/pii/S1470160X11000562'
                },
                {
                    title: 'Acoustic Ecology - Barry Truax Website',
                    author: 'Barry Truax',
                    category: 'WEB RESOURCE',
                    description: 'Barry Truax\'s personal website with articles, compositions, and complete documentation on acoustic ecology and the World Soundscape Project.',
                    link: 'https://www.sfu.ca/~truax/'
                },
                {
                    title: 'Hildegard Westerkamp - Compositions & Writings',
                    author: 'Hildegard Westerkamp',
                    category: 'ARTIST ARCHIVE',
                    description: 'Official website with soundscape compositions, theoretical articles, and soundwalking methodologies. Includes "Kits Beach Soundscape" and other foundational works.',
                    link: 'https://www.hildegardwesterkamp.ca/'
                }
            ],
            resources: [
                {
                    title: 'Simon Fraser University - Acoustic Ecology',
                    author: 'SFU / Barry Truax',
                    category: 'UNIVERSITY',
                    description: 'Original research center founded by Schafer. Access to Handbook for Acoustic Ecology, WSP archives, and software.',
                    link: 'https://www.sfu.ca/~truax/'
                },
                {
                    title: 'gruenrekorder - Label & Publisher',
                    author: 'gruenrekorder',
                    category: 'LABEL',
                    description: 'German label specialized in field recording and soundscape composition. Catalog with over 200 releases.',
                    link: 'https://gruenrekorder.de/'
                },
                {
                    title: 'Sound Studies Lab',
                    author: 'Humboldt University Berlin',
                    category: 'RESEARCH',
                    description: 'Interdisciplinary research laboratory on sound studies, acoustic ecology, and sonic knowledge.',
                    link: 'https://www.soundstudieslab.org/'
                },
                {
                    title: 'Sounding Out! - Blog',
                    author: 'Various Contributors',
                    category: 'BLOG',
                    description: 'Academic blog on sound studies, sonic culture, and audio technologies. Weekly articles.',
                    link: 'https://soundstudiesblog.com/'
                },
                {
                    title: 'Sonic Acts',
                    author: 'Festival / Organization',
                    category: 'FESTIVAL',
                    description: 'Dutch festival of sonic art and digital culture. Includes conferences, performances, and publications.',
                    link: 'https://sonicacts.com/'
                },
                {
                    title: 'CRiSAP - Creative Research into Sound Arts Practice',
                    author: 'University of Arts London',
                    category: 'UNIVERSITY',
                    description: 'British research center on sound art and acoustic ecology. Master programs, publications and symposiums. Celebrated 20 years in 2024.',
                    link: 'https://www.arts.ac.uk/research/research-centres/creative-research-in-sound-arts-practice-crisap'
                },
                {
                    title: 'Phonography Monthly',
                    author: 'Podcast',
                    category: 'PODCAST',
                    description: 'Monthly podcast with a single unedited field recording per episode. Contemplative listening.',
                    link: 'https://phonography.org/'
                },
                {
                    title: 'Wild Sanctuary - Bernie Krause',
                    author: 'Bernie Krause',
                    category: 'ARCHIVE',
                    description: 'Bernie Krause\'s personal archive with 5000+ hours of natural recordings from 50 years of career.',
                    link: 'https://www.wildsanctuary.com/'
                }
            ]
        };

        // Show Library Tab
        window.showLibraryTab = function(category) {
            // Update active button
            var buttons = document.querySelectorAll('[data-library]');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.querySelector('[data-library="' + category + '"]').classList.add('active');

            // Render content
            var contentDiv = document.getElementById('library-content');
            var data = libraryData[category];
            var html = '';

            data.forEach(function(item) {
                html += `
                    <div class="library-item">
                        <span class="library-category">${item.category}</span>
                        <h4>${item.title}</h4>
                        <div class="author">by ${item.author}</div>
                        <div class="description">${item.description}</div>
                        <a href="${item.link}" target="_blank" class="link-btn">
                            🔗 Open Resource →
                        </a>
                    </div>
                `;
            });

            contentDiv.innerHTML = html;
        };

        // Initialize library
        var libraryInitialized = false;

        // Re-implement initializeLibrary with full functionality
        window.initializeLibrary = function() {
            if (!libraryInitialized && document.getElementById('library-content')) {
                showLibraryTab('books');
                libraryInitialized = true;
            }
        };

        // ==================== FREEMIUM SYSTEM ====================

        // Premium Status Management
        // Initialize from localStorage (will be updated by RevenueCat)
        let isPremium = localStorage.getItem('isPremium') === 'true';

        // FREE VERSION LIMITS
        const FREE_LIMITS = {
            markers: 20  // Max 20 markers on map for free version
        };

        // NOTE: Photos and audio are UNLIMITED in free version
        // Only markers are limited to 20
        // Premium features: Export, Backup, Unlimited Markers

        // Get current usage stats
        function getCurrentUsage() {
            return {
                markers: soundscapeData ? soundscapeData.length : 0
            };
        }

        // Update UI based on premium status
        function updatePremiumUI() {
            const banner = document.getElementById('premium-banner');
            if (banner) {
                if (!isPremium) {
                    const usage = getCurrentUsage();
                    banner.style.display = 'flex';
                    // Update banner with usage stats and limit
                    const warningText = `⚠️ Limit: ${usage.markers}/${FREE_LIMITS.markers} markers | Local data only`;
                    const existingWarning = banner.querySelector('.usage-stats');
                    if (!existingWarning) {
                        const statsDiv = document.createElement('small');
                        statsDiv.className = 'usage-stats';
                        statsDiv.style.cssText = 'display: block; margin-top: 5px; opacity: 0.9;';
                        statsDiv.textContent = warningText;
                        banner.querySelector('div').appendChild(statsDiv);
                    } else {
                        existingWarning.textContent = warningText;
                    }
                } else {
                    banner.style.display = 'none';
                }
            }
        }

        // Show Upgrade Modal
        function showUpgradeModal() {
            const modal = document.getElementById('paywall-modal');
            if (modal) {
                modal.classList.add('active');
                document.body.classList.add('modal-open');
            }
        }

        // Close Upgrade Modal
        function closeUpgradeModal() {
            const modal = document.getElementById('paywall-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.classList.remove('modal-open');
            }
        }

        // Premium upgrade is handled by RevenueCat (see iap-integration.js)
        // Functions: purchasePremium() and restorePurchases() are available globally

        // ==================== PREMIUM FEATURES ====================

        // Export Exercise to PDF (PREMIUM ONLY)
        async function exportExerciseToPDF(exerciseId) {
            // Check if premium
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nPDF export is only available in the Premium version.\n\n🌟 Upgrade to Premium to unlock this feature!');
                showUpgradeModal();
                return;
            }

            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);
                if (!ex) {
                    alert('❌ Exercise not found!');
                    return;
                }

                // Create PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Title
                doc.setFontSize(20);
                doc.setTextColor(45, 95, 79);
                doc.text(ex.exercise.title, 20, 20);

                // Category badge
                doc.setFontSize(10);
                doc.setFillColor(45, 95, 79);
                doc.setTextColor(255, 255, 255);
                doc.rect(20, 25, doc.getTextWidth(ex.exercise.category) + 4, 6, 'F');
                doc.text(ex.exercise.category, 22, 29);

                // Reset color
                doc.setTextColor(0, 0, 0);

                // Date and time
                const date = new Date(ex.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' });
                const timeStr = ex.time || date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                let y = 40;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Basic Information', 20, y);
                y += 7;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Date: ${dateStr}`, 20, y);
                y += 5;
                doc.text(`Time: ${timeStr}`, 20, y);
                y += 5;
                doc.text(`Location: ${ex.location}`, 20, y);
                y += 5;
                doc.text(`Duration: ${ex.duration}`, 20, y);
                y += 10;

                // Environmental context
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Environmental Context', 20, y);
                y += 7;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Environment description: ${ex.environment}`, 20, y, { maxWidth: 170 });
                y += 10;
                doc.text(`Weather: ${ex.weather}  |  Noise: ${ex.noiseLevel}  |  Alone: ${ex.alone}  |  Movement: ${ex.movement}`, 20, y);
                y += 10;

                // Recording tools
                if (ex.recordingTools) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Recording Tools', 20, y);
                    y += 7;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    const tools = doc.splitTextToSize(ex.recordingTools, 170);
                    doc.text(tools, 20, y);
                    y += tools.length * 5 + 5;
                }

                // Notes
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Notes and Reflections', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                const notes = doc.splitTextToSize(ex.notes, 170);
                doc.text(notes, 20, y);
                y += notes.length * 5 + 5;

                // Audio/Photo counts
                if ((ex.audioFiles && ex.audioFiles.length > 0) || (ex.photoFiles && ex.photoFiles.length > 0)) {
                    y += 5;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    if (ex.audioFiles && ex.audioFiles.length > 0) {
                        doc.text(`Audio Recordings: ${ex.audioFiles.length}`, 20, y);
                        y += 5;
                    }
                    if (ex.photoFiles && ex.photoFiles.length > 0) {
                        doc.text(`Location Photos: ${ex.photoFiles.length}`, 20, y);
                        y += 5;
                    }
                }

                // Tags
                if (ex.tags) {
                    y += 5;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Tags:', 20, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(ex.tags, 35, y);
                }

                // Rating
                if (ex.rating > 0) {
                    y += 10;
                    doc.setFontSize(14);
                    doc.setTextColor(243, 156, 18);
                    doc.text('★'.repeat(parseInt(ex.rating)), 20, y);
                }

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('Generated by Soundscape Studio Premium', 20, 285);

                // Save PDF
                const filename = `${ex.exercise.title.replace(/[^a-z0-9]/gi, '-')}_${dateStr.replace(/\s/g, '-')}.pdf`;

                // Check if running on native (Capacitor) with Share
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Share && window.Capacitor.Plugins.Filesystem) {
                    try {
                        const Filesystem = window.Capacitor.Plugins.Filesystem;
                        const Share = window.Capacitor.Plugins.Share;

                        // Get PDF as base64
                        const pdfBase64 = doc.output('datauristring').split(',')[1];

                        // Save to documents
                        await Filesystem.writeFile({
                            path: filename,
                            data: pdfBase64,
                            directory: Directory.Documents
                        });

                        alert('✅ PDF saved to Documents folder!\n\nFind the file in the Files app under "On My iPhone" > Documents');
                    } catch (fsError) {
                        console.error('Filesystem error:', fsError);
                        alert('❌ PDF save error: ' + fsError.message);
                    }
                } else {
                    // Fallback for web
                    doc.save(filename);
                    alert('✅ PDF exported successfully!');
                }
            } catch (error) {
                console.error('PDF export error:', error);
                alert('❌ Error exporting PDF!');
            }
        }

        // Export single exercise to Word (.docx)
        async function exportExerciseToWord(exerciseId) {
            // Check if premium
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nWord export is only available in the Premium version.\n\n🌟 Upgrade to Premium to unlock this feature!');
                showUpgradeModal();
                return;
            }

            try {
                const ex = await getExerciseFromIndexedDB(exerciseId);
                if (!ex) {
                    alert('❌ Exercise not found!');
                    return;
                }

                // Date and time
                const date = new Date(ex.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' });
                const timeStr = ex.time || date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                // Build HTML for Word
                let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${ex.exercise.title}</title>
    <style>
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            color: #2d5f4f;
            border-bottom: 3px solid #2d5f4f;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .category {
            display: inline-block;
            background: #2d5f4f;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 25px;
        }
        .section h2 {
            color: #2d5f4f;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        .field {
            margin-bottom: 10px;
        }
        .field strong {
            color: #2d5f4f;
        }
        .notes {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #2d5f4f;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .rating {
            font-size: 20px;
            color: #f39c12;
        }
        ul {
            margin: 10px 0;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
    <h1>${ex.exercise.title}</h1>
    <div class="category">${ex.exercise.category || 'Soundscape Exercise'}</div>

    <div class="section">
        <h2>📅 Basic Information</h2>
        <div class="field"><strong>Date:</strong> ${dateStr}</div>
        <div class="field"><strong>Time:</strong> ${timeStr}</div>
        <div class="field"><strong>Location:</strong> ${ex.location || 'Not specified'}</div>
        ${ex.locationCoords && (ex.locationCoords.lat || ex.locationCoords.lon) ?
          `<div class="field"><strong>GPS Coordinates:</strong> ${ex.locationCoords.lat}, ${ex.locationCoords.lon}</div>` : ''}
        <div class="field"><strong>Duration:</strong> ${ex.duration || 'Not specified'}</div>
    </div>

    <div class="section">
        <h2>🌍 Environmental Context</h2>
        <div class="field"><strong>Environment description:</strong><br>${ex.environment || 'Not specified'}</div>
        <div class="field"><strong>Weather:</strong> ${ex.weather || 'N/A'}</div>
        <div class="field"><strong>Noise level:</strong> ${ex.noiseLevel || 'N/A'}</div>
        <div class="field"><strong>Were you alone:</strong> ${ex.alone || 'N/A'}</div>
        <div class="field"><strong>Movement:</strong> ${ex.movement || 'N/A'}</div>
    </div>

    ${ex.recordingTools ? `
    <div class="section">
        <h2>🎙️ Recording Tools</h2>
        <div class="field">${ex.recordingTools}</div>
    </div>
    ` : ''}

    <div class="section">
        <h2>📝 Notes and Considerations</h2>
        <div class="notes">${ex.notes || 'No notes'}</div>
    </div>

    ${(ex.audioFiles && ex.audioFiles.length > 0) || (ex.photoFiles && ex.photoFiles.length > 0) ? `
    <div class="section">
        <h2>📎 Media Attachments</h2>
        ${ex.audioFiles && ex.audioFiles.length > 0 ? `
        <div class="field">
            <strong>🎵 Audio Recordings (${ex.audioFiles.length}):</strong>
            <ul>
                ${ex.audioFiles.map((audio, i) => `<li>Audio ${i + 1}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        ${ex.photoFiles && ex.photoFiles.length > 0 ? `
        <div class="field">
            <strong>📸 Photos (${ex.photoFiles.length}):</strong>
            <ul>
                ${ex.photoFiles.map((photo, i) => `<li>Photo ${i + 1}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
    </div>
    ` : ''}

    ${ex.tags ? `
    <div class="section">
        <div class="field"><strong>🏷️ Tags:</strong> ${ex.tags}</div>
    </div>
    ` : ''}

    ${ex.rating > 0 ? `
    <div class="section">
        <div class="field"><strong>Rating:</strong><br>
        <span class="rating">${'★'.repeat(parseInt(ex.rating))}</span></div>
    </div>
    ` : ''}

    <div class="footer">
        Exercise completed on: ${date.toLocaleString('en-US')}<br>
        Generated by Soundscape Studio Premium
    </div>
</body>
</html>`;

                // Create blob with proper MIME type for .docx
                const blob = new Blob([html], {
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                });

                const filename = `${ex.exercise.title.replace(/[^a-z0-9]/gi, '-')}_${dateStr.replace(/\s/g, '-')}.docx`;

                await downloadOrShareFile(blob, filename, 'Export Word Document');

                if (!window.Capacitor) {
                    alert('✅ Word document exported successfully!');
                }

            } catch (error) {
                console.error('Word export error:', error);
                alert('❌ Error exporting Word document!');
            }
        }

        // Make functions global
        window.exportExerciseToPDF = exportExerciseToPDF;
        window.exportExerciseToWord = exportExerciseToWord;

        // Helper function to download/share files - FIXED FOR LARGE FILES!
        async function downloadOrShareFile(blob, filename, title = 'Save File') {
            try {
                // On iOS with Capacitor, use Filesystem + Share
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Share && window.Capacitor.Plugins.Filesystem) {
                    const Filesystem = window.Capacitor.Plugins.Filesystem;
                    const Share = window.Capacitor.Plugins.Share;

                    // Convert blob to base64
                    const reader = new FileReader();
                    const base64Data = await new Promise((resolve, reject) => {
                        reader.onloadend = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });

                    // Write to temporary file
                    const result = await Filesystem.writeFile({
                        path: filename,
                        data: base64Data,
                        directory: 'CACHE'
                    });

                    // Share the file URI
                    await Share.share({
                        title: title,
                        text: filename,
                        url: result.uri,
                        dialogTitle: title
                    });
                } else {
                    // Web fallback: standard download
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    alert('✅ File ready for download!');
                }
            } catch (error) {
                console.error('Download/Share error:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // Export Map as GeoJSON (PREMIUM ONLY)
        async function exportMapGeoJSON() {
            // Check if premium
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nMap GeoJSON export is only available in the Premium version.\n\n🌟 Upgrade to Premium to unlock this feature!');
                showUpgradeModal();
                return;
            }

            if (!soundscapeData || soundscapeData.length === 0) {
                alert('⚠️ No markers to export!');
                return;
            }

            try {
                // Create GeoJSON structure
                const geojson = {
                    type: "FeatureCollection",
                    features: soundscapeData.map(marker => ({
                        type: "Feature",
                        properties: {
                            category: marker.category,
                            notes: marker.notes,
                            timestamp: marker.timestamp,
                            hasAudio: marker.hasAudio || false,
                            exerciseTitle: marker.exerciseTitle || null,
                            exerciseId: marker.exerciseId || null
                        },
                        geometry: {
                            type: "Point",
                            coordinates: [marker.lng, marker.lat] // GeoJSON uses [lng, lat] order
                        }
                    }))
                };

                // Download as file
                const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
                const filename = `soundscape-map-${new Date().toISOString().split('T')[0]}.geojson`;
                await downloadOrShareFile(blob, filename, 'Export Map GeoJSON');

                if (!window.Capacitor) {
                    alert('✅ Map exported as GeoJSON!');
                }
            } catch (error) {
                console.error('GeoJSON export error:', error);
                alert('❌ Error during export!');
            }
        }

        // Export Map as CSV (PREMIUM ONLY)
        async function exportMapCSV() {
            // Check if premium
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nMap CSV export is only available in the Premium version.\n\n🌟 Upgrade to Premium to unlock this feature!');
                showUpgradeModal();
                return;
            }

            if (!soundscapeData || soundscapeData.length === 0) {
                alert('⚠️ No markers to export!');
                return;
            }

            try {
                // Create CSV header
                let csv = 'ID,Latitude,Longitude,Category,Notes,Timestamp,HasAudio,ExerciseTitle\n';

                // Add data rows
                soundscapeData.forEach(marker => {
                    const notes = (marker.notes || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    const exerciseTitle = (marker.exerciseTitle || '').replace(/"/g, '""');
                    csv += `${marker.id},${marker.lat},${marker.lng},"${marker.category}","${notes}","${marker.timestamp}",${marker.hasAudio || false},"${exerciseTitle}"\n`;
                });

                // Download as file
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const filename = `soundscape-map-${new Date().toISOString().split('T')[0]}.csv`;
                await downloadOrShareFile(blob, filename, 'Export Map CSV');

                if (!window.Capacitor) {
                    alert('✅ Map exported as CSV!');
                }
            } catch (error) {
                console.error('CSV export error:', error);
                alert('❌ Error during export!');
            }
        }

        // Make functions global
        window.exportMapGeoJSON = exportMapGeoJSON;
        window.exportMapCSV = exportMapCSV;

        // Toggle Advanced Export section
        function toggleAdvancedExport() {
            const content = document.getElementById('advancedExportContent');
            const arrow = document.getElementById('advancedExportArrow');
            const toggle = document.getElementById('advancedExportToggle');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
                arrow.textContent = '▲';
                toggle.style.background = '#e9ecef';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
                arrow.textContent = '▼';
                toggle.style.background = '#f8f9fa';
            }
        }
        window.toggleAdvancedExport = toggleAdvancedExport;

        // ==================== BACKUP & RESTORE (PREMIUM ONLY) ====================

        // Export Complete Backup (PREMIUM ONLY)
        async function exportCompleteBackup() {
            // Check if premium
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nComplete backup is only available in the Premium version.\n\n🌟 Upgrade to Premium to protect your work!');
                showUpgradeModal();
                return;
            }

            try {
                // Gather all data
                const exercises = await getAllExercisesFromIndexedDB();
                const markers = soundscapeData || [];

                // Create backup object
                const backup = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    exercises: exercises,
                    markers: markers,
                    stats: {
                        totalExercises: exercises.length,
                        totalMarkers: markers.length
                    }
                };

                // Convert to JSON
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const filename = `soundscape-backup-${new Date().toISOString().split('T')[0]}.json`;

                await downloadOrShareFile(blob, filename, 'Complete Soundscape Backup');

                if (!window.Capacitor) {
                    alert(`✅ Complete backup exported!\n\n${exercises.length} exercises\n${markers.length} markers\n\nFile: ${filename}`);
                }
            } catch (error) {
                console.error('Backup error:', error);
                alert('❌ Error exporting backup!');
            }
        }

        // Import Complete Backup (PREMIUM ONLY)
        async function importCompleteBackup() {
            // Check if premium
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nBackup import is only available in the Premium version.\n\n🌟 Upgrade to Premium to restore your data!');
                showUpgradeModal();
                return;
            }

            // Confirm action
            if (!confirm('⚠️ WARNING\n\nImporting will replace all current data with backup data.\n\nAre you sure you want to continue?')) {
                return;
            }

            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                try {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Read file
                    const text = await file.text();
                    const backup = JSON.parse(text);

                    // Validate backup
                    if (!backup.version || !backup.exercises || !backup.markers) {
                        alert('❌ Invalid backup file!');
                        return;
                    }

                    // Restore exercises to IndexedDB
                    for (const exercise of backup.exercises) {
                        await saveExerciseToIndexedDB(exercise);
                    }

                    // Restore markers
                    soundscapeData = backup.markers;
                    saveSoundscapeData();

                    // Reload UI
                    await updateCompletedExercisesCounter();
                    if (document.getElementById('map').classList.contains('active')) {
                        updateMarkersList();
                        // Reload map markers
                        mapMarkers.forEach(m => m.marker.remove());
                        mapMarkers = [];
                        soundscapeData.forEach(markerData => {
                            const icon = L.divIcon({
                                html: `<div style="font-size: 28px;">${categoryIcons[markerData.category]}</div>`,
                                className: 'custom-marker',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            });
                            const marker = L.marker([markerData.lat, markerData.lng], { icon: icon }).addTo(leafletMap);
                            const popupContent = createPopupContent(markerData);
                            marker.bindPopup(popupContent, { maxWidth: 280, minWidth: 200 });
                            mapMarkers.push({ marker: marker, data: markerData });
                        });
                    }

                    alert(`✅ Backup restored successfully!\n\n${backup.exercises.length} exercises\n${backup.markers.length} markers\n\nReload the page to see all data.`);

                    // Reload page to ensure everything is fresh
                    setTimeout(() => location.reload(), 2000);

                } catch (error) {
                    console.error('Import error:', error);
                    alert('❌ Error importing backup!\n\nMake sure the file is a valid backup.');
                }
            };

            input.click();
        }

        // ==================== NEW EXPORT FORMATS (PREMIUM) ====================

        // Export to Excel (.xlsx) - PREMIUM ONLY
        async function exportToExcel() {
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nExcel export is only available in the Premium version.\n\n🌟 Upgrade to Premium to export your data!');
                showUpgradeModal();
                return;
            }

            try {
                const exercises = await getAllExercisesFromIndexedDB();

                if (exercises.length === 0) {
                    alert('ℹ️ No exercises to export\n\nComplete some exercises first, then export your archive!');
                    return;
                }

                // Prepare data for Excel
                const data = exercises.map(ex => ({
                    'Date': new Date(ex.timestamp).toLocaleDateString('en-US'),
                    'Title': ex.exercise.title,
                    'Category': ex.exercise.category || 'N/A',
                    'Difficulty': ex.exercise.difficulty || 'N/A',
                    'Location': ex.locationName || 'N/A',
                    'Coordinates': ex.locationCoords ? `${ex.locationCoords.lat}, ${ex.locationCoords.lon}` : 'N/A',
                    'Notes': ex.notes || '',
                    'Audio Files': ex.audioFiles ? ex.audioFiles.length : 0,
                    'Photos': ex.photoFiles ? ex.photoFiles.length : 0
                }));

                // Create workbook using SheetJS
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data);

                // Set column widths for better readability
                ws['!cols'] = [
                    {wch: 12}, // Date
                    {wch: 40}, // Title
                    {wch: 20}, // Category
                    {wch: 12}, // Difficulty
                    {wch: 30}, // Location
                    {wch: 25}, // Coordinates
                    {wch: 50}, // Notes
                    {wch: 8},  // Audio
                    {wch: 8}   // Photos
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Soundscape Exercises");

                // Generate filename with date
                const filename = `soundscape-exercises-${new Date().toISOString().split('T')[0]}.xlsx`;

                // Generate blob for mobile
                const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
                const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});

                await downloadOrShareFile(blob, filename, 'Export Exercises Excel');

                if (!window.Capacitor) {
                    alert(`✅ Excel export completed!\n\n${exercises.length} exercises exported\n\nOpen with:\n• Microsoft Excel\n• Google Sheets\n• Apple Numbers\n\nFile: ${filename}`);
                }

            } catch (error) {
                console.error('Excel export error:', error);
                alert('❌ Error during Excel export:\n' + error.message);
            }
        }

        // Export to KML (Google Earth/Maps) - PREMIUM ONLY
        async function exportToKML() {
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nKML export is only available in the Premium version.\n\n🌟 Upgrade to Premium to view your markers in Google Earth!');
                showUpgradeModal();
                return;
            }

            try {
                if (!soundscapeData || soundscapeData.length === 0) {
                    alert('ℹ️ No markers to export\n\nAdd some markers to the map first!');
                    return;
                }

                // KML header with styles for different categories
                let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Soundscape Studio - Markers</name>
    <description>Soundscape markers exported from Soundscape Studio</description>

    <!-- Styles for different categories -->
    <Style id="traffic">
      <IconStyle>
        <color>ff0000ff</color>
        <scale>1.1</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/red-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="market">
      <IconStyle>
        <color>ff00ffff</color>
        <scale>1.1</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="nature">
      <IconStyle>
        <color>ff00ff00</color>
        <scale>1.1</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/grn-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="industrial">
      <IconStyle>
        <color>ff808080</color>
        <scale>1.1</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/wht-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="people">
      <IconStyle>
        <color>ffff00ff</color>
        <scale>1.1</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/purple-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="default">
      <IconStyle>
        <color>ff0088ff</color>
        <scale>1.1</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/blu-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>

`;

                // Add placemarks for each marker
                soundscapeData.forEach(marker => {
                    const date = new Date(marker.timestamp).toLocaleDateString('en-US');
                    const category = marker.category || 'default';
                    const notes = marker.notes ? marker.notes.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'No notes';

                    kml += `
    <Placemark>
      <name>${marker.exerciseTitle || 'Marker ' + marker.id}</name>
      <description><![CDATA[
        <b>Date:</b> ${date}<br/>
        <b>Category:</b> ${category}<br/>
        <b>Notes:</b> ${notes}<br/>
        ${marker.hasAudio ? '<b>🎵 Audio available</b>' : ''}
      ]]></description>
      <styleUrl>#${category}</styleUrl>
      <Point>
        <coordinates>${marker.lng},${marker.lat},0</coordinates>
      </Point>
    </Placemark>`;
                });

                kml += `
  </Document>
</kml>`;

                // Create and download file
                const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const filename = `soundscape-markers-${new Date().toISOString().split('T')[0]}.kml`;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);

                alert(`✅ KML export completed!\n\n${soundscapeData.length} markers exported\n\nOpen with:\n• Google Earth\n• Google Maps\n• Any GPS app\n\nFile: ${filename}`);

            } catch (error) {
                console.error('KML export error:', error);
                alert('❌ Error during KML export:\n' + error.message);
            }
        }

        // Export to Word (.doc) - PREMIUM ONLY
        async function exportToWord() {
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nWord export is only available in the Premium version.\n\n🌟 Upgrade to Premium to create professional reports!');
                showUpgradeModal();
                return;
            }

            try {
                const exercises = await getAllExercisesFromIndexedDB();

                if (exercises.length === 0) {
                    alert('ℹ️ No exercises to export\n\nComplete some exercises first!');
                    return;
                }

                // Create HTML document with professional styling
                let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Soundscape Studio - Exercises Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        h1 { color: #2d5f4f; border-bottom: 3px solid #d4af37; padding-bottom: 10px; }
        h2 { color: #d4af37; margin-top: 30px; }
        .exercise { margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .meta { color: #666; font-size: 14px; margin-bottom: 10px; }
        .notes { background: #f9f9f9; padding: 15px; border-left: 4px solid #d4af37; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        td:first-child { font-weight: bold; width: 150px; color: #2d5f4f; }
    </style>
</head>
<body>
    <h1>🎵 Soundscape Studio - Exercises Report</h1>
    <p class="meta">Generated on: ${new Date().toLocaleString('en-US')}</p>
    <p class="meta">Total exercises: ${exercises.length}</p>
    <hr>
`;

                // Add each exercise
                exercises.forEach((ex, index) => {
                    const date = new Date(ex.timestamp).toLocaleDateString('en-US');
                    html += `
    <div class="exercise">
        <h2>${index + 1}. ${ex.exercise.title}</h2>
        <table>
            <tr><td>Date:</td><td>${date}</td></tr>
            <tr><td>Category:</td><td>${ex.exercise.category || 'N/A'}</td></tr>
            <tr><td>Difficulty:</td><td>${ex.exercise.difficulty || 'N/A'}</td></tr>
            <tr><td>Location:</td><td>${ex.locationName || 'Not specified'}</td></tr>
            ${ex.locationCoords ? `<tr><td>Coordinates:</td><td>${ex.locationCoords.lat}, ${ex.locationCoords.lon}</td></tr>` : ''}
            <tr><td>Audio Files:</td><td>${ex.audioFiles ? ex.audioFiles.length : 0}</td></tr>
            <tr><td>Photos:</td><td>${ex.photoFiles ? ex.photoFiles.length : 0}</td></tr>
        </table>
        ${ex.notes ? `<div class="notes"><strong>Notes:</strong><br>${ex.notes.replace(/\n/g, '<br>')}</div>` : ''}
    </div>`;
                });

                html += `
</body>
</html>`;

                // Create and download file
                const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
                const filename = `soundscape-report-${new Date().toISOString().split('T')[0]}.doc`;

                await downloadOrShareFile(blob, filename, 'Export Word Report');

                if (!window.Capacitor) {
                    alert(`✅ Word export completed!\n\n${exercises.length} exercises exported\n\nOpen with:\n• Microsoft Word\n• Google Docs\n• Apple Pages\n\nFile: ${filename}`);
                }

            } catch (error) {
                console.error('Word export error:', error);
                alert('❌ Error during Word export:\n' + error.message);
            }
        }

        // Convert audio blob to MP3 using lamejs
        async function convertToMP3(audioBlob) {
            try {
                // Check if blob is valid
                if (!audioBlob || audioBlob.size === 0) {
                    console.warn('⚠️ Empty or invalid audio blob, skipping conversion');
                    return audioBlob;
                }

                // Create audio context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Resume AudioContext if suspended (iOS requirement)
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // Convert blob to array buffer
                const arrayBuffer = await audioBlob.arrayBuffer();

                // Validate array buffer
                if (arrayBuffer.byteLength === 0) {
                    console.warn('⚠️ Empty audio buffer, skipping conversion');
                    return audioBlob;
                }

                console.log(`🔄 Decoding audio (${(arrayBuffer.byteLength / 1024).toFixed(1)} KB)...`);

                // Decode audio data with better error handling
                let audioBuffer;
                try {
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                } catch (decodeError) {
                    console.error('❌ Audio decoding failed:', decodeError);
                    console.warn('⚠️ Returning original blob without MP3 conversion');
                    // Close context to prevent memory leak
                    await audioContext.close();
                    return audioBlob;
                }

                // Validate decoded audio
                if (!audioBuffer || audioBuffer.length === 0) {
                    console.warn('⚠️ Decoded audio is empty, returning original blob');
                    await audioContext.close();
                    return audioBlob;
                }

                console.log(`✅ Audio decoded: ${audioBuffer.duration.toFixed(2)}s, ${audioBuffer.sampleRate} Hz`);

                // Get samples from first channel (mono)
                const samples = audioBuffer.getChannelData(0);

                // Convert Float32Array to Int16Array for MP3 encoder
                const samplesInt16 = new Int16Array(samples.length);
                for (let i = 0; i < samples.length; i++) {
                    const s = Math.max(-1, Math.min(1, samples[i]));
                    samplesInt16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }

                // MP3 encoder configuration
                const sampleRate = audioBuffer.sampleRate;
                const kbps = 128; // 128 kbps quality
                const mp3encoder = new lamejs.Mp3Encoder(1, sampleRate, kbps);

                console.log(`🎵 Encoding to MP3 (${kbps} kbps)...`);

                // Encode to MP3
                const mp3Data = [];
                const sampleBlockSize = 1152; // Standard MP3 frame size

                for (let i = 0; i < samplesInt16.length; i += sampleBlockSize) {
                    const sampleChunk = samplesInt16.subarray(i, i + sampleBlockSize);
                    const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                    if (mp3buf.length > 0) {
                        mp3Data.push(mp3buf);
                    }
                }

                // Flush remaining data
                const mp3buf = mp3encoder.flush();
                if (mp3buf.length > 0) {
                    mp3Data.push(mp3buf);
                }

                // Create MP3 blob
                const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });

                console.log(`✅ MP3 created: ${(mp3Blob.size / 1024).toFixed(1)} KB`);

                // Close audio context to free resources
                await audioContext.close();

                return mp3Blob;

            } catch (error) {
                console.error('❌ MP3 conversion error:', error);
                console.warn('⚠️ Returning original audio blob without conversion');
                // Fallback: return original blob
                return audioBlob;
            }
        }

        // Export all audio files as ZIP - PREMIUM ONLY
        async function exportAudioZIP() {
            if (!isPremium) {
                alert('⚠️ Premium Feature\n\nAudio ZIP export is only available in the Premium version.\n\n🌟 Upgrade to Premium to export all your audio!');
                showUpgradeModal();
                return;
            }

            try {
                // Get exercises audio
                const exercises = await getAllExercisesFromIndexedDB();
                const exercisesWithAudio = exercises.filter(ex => ex.audioFiles && ex.audioFiles.length > 0);

                // Get map markers audio
                const markersWithAudio = [];
                for (const marker of soundscapeData) {
                    const audioBlob = await getAudioFromIndexedDB(marker.id);
                    if (audioBlob) {
                        markersWithAudio.push({
                            marker: marker,
                            audioBlob: audioBlob
                        });
                    }
                }

                // Check if there's any audio to export
                if (exercisesWithAudio.length === 0 && markersWithAudio.length === 0) {
                    alert('ℹ️ No audio files to export\n\nRecord some audio in your exercises or add audio to map markers first!');
                    return;
                }

                // Count total audio files
                let totalAudioFiles = 0;
                exercisesWithAudio.forEach(ex => {
                    totalAudioFiles += ex.audioFiles.length;
                });
                totalAudioFiles += markersWithAudio.length;

                // Confirm (this might take a while)
                if (!confirm(`📦 Preparing to export ${totalAudioFiles} audio files\n\n${exercisesWithAudio.length} exercises\n${markersWithAudio.length} map markers\n\nThis might take a few moments.\n\nContinue?`)) {
                    return;
                }

                // Create ZIP
                const zip = new JSZip();

                // Add README
                const readme = `Soundscape Studio - Audio Export
Generated: ${new Date().toLocaleString('en-US')}

This archive contains all audio files from your soundscape exercises and map markers.

AUDIO FORMAT:
Audio files are exported in their original recording format
Possible formats: WebM, WAV, M4A
Compatible with VLC, Audacity, professional DAWs

STRUCTURE:
/exercises/ - Audio recordings from completed exercises
  - Each folder: [date]-[exercise-title]
  - Files: audio-1.webm, audio-2.webm, Info.txt

/map-markers/ - Audio recordings from map markers
  - Each folder: [date]-[category]-[marker-id]
  - Files: audio-[id].webm, Info.txt

STATISTICS:
Total exercises: ${exercisesWithAudio.length}
Total map markers: ${markersWithAudio.length}
Total audio files: ${totalAudioFiles}

TO USE THESE FILES:
1. Extract the ZIP archive
2. Navigate to the folder you want (exercises/ or map-markers/)
3. Import into VLC, Audacity, DAW or other audio software
4. To convert to MP3: use Audacity (File > Export > MP3)
5. Compatible with Windows, Mac, iOS, Android

---
Soundscape Studio Premium
`;
                zip.file('README.txt', readme);

                // Add EXERCISES audio files in /exercises/ folder
                let totalAudioCount = 0;
                for (const ex of exercisesWithAudio) {
                    const date = new Date(ex.timestamp).toISOString().split('T')[0];
                    const safeTitle = ex.exercise.title.replace(/[^a-z0-9]/gi, '-').toLowerCase().substring(0, 50);
                    const folderName = `exercises/${date}-${safeTitle}`;

                    // Create info file for this exercise
                    const info = `Exercise: ${ex.exercise.title}
Date: ${new Date(ex.timestamp).toLocaleString('en-US')}
Category: ${ex.exercise.category || 'N/A'}
Location: ${ex.locationName || 'Not specified'}
Audio files: ${ex.audioFiles.length}
Notes: ${ex.notes || 'None'}
`;
                    zip.file(`${folderName}/Info.txt`, info);

                    // Add audio files (original format - no conversion)
                    for (let index = 0; index < ex.audioFiles.length; index++) {
                        const audioBlob = ex.audioFiles[index];

                        // Get file extension from blob type
                        const fileExt = audioBlob.type === 'audio/webm' ? 'webm' :
                                       audioBlob.type === 'audio/wav' ? 'wav' :
                                       audioBlob.type === 'audio/mp4' ? 'm4a' : 'webm';

                        console.log(`Adding exercise audio ${index + 1}/${ex.audioFiles.length} (${fileExt}, ${(audioBlob.size / 1024).toFixed(1)} KB)...`);

                        zip.file(`${folderName}/audio-${index + 1}.${fileExt}`, audioBlob);
                        totalAudioCount++;
                    }
                }

                // Add MAP MARKERS audio files in /map-markers/ folder
                for (let i = 0; i < markersWithAudio.length; i++) {
                    const item = markersWithAudio[i];
                    const marker = item.marker;
                    const audioBlob = item.audioBlob;

                    // Create folder name
                    const date = new Date(marker.timestamp || Date.now()).toISOString().split('T')[0];
                    const categoryName = marker.category || 'other';
                    // Convert marker.id to string before using substring
                    const markerIdStr = String(marker.id);
                    const folderName = `map-markers/${date}-${categoryName}-${markerIdStr.substring(0, 8)}`;

                    // Add marker info
                    const info = `Marker ID: ${marker.id}
Date: ${new Date(marker.timestamp || Date.now()).toLocaleString('en-US')}
Category: ${marker.category || 'N/A'}
Coordinates: ${marker.lat.toFixed(6)}, ${marker.lng.toFixed(6)}
Notes: ${marker.notes || 'None'}
`;
                    zip.file(`${folderName}/Info.txt`, info);

                    // Add audio in original format (no conversion)
                    const fileExt = audioBlob.type === 'audio/webm' ? 'webm' :
                                   audioBlob.type === 'audio/wav' ? 'wav' :
                                   audioBlob.type === 'audio/mp4' ? 'm4a' : 'webm';

                    console.log(`Adding marker audio ${i + 1}/${markersWithAudio.length} (${fileExt}, ${(audioBlob.size / 1024).toFixed(1)} KB)...`);

                    zip.file(`${folderName}/audio-${markerIdStr.substring(0, 8)}.${fileExt}`, audioBlob);
                    totalAudioCount++;
                }

                // Generate ZIP
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                // Generate filename with full timestamp to avoid overwrite prompts
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').split('.')[0]; // Format: 2025-10-24T14-30-45
                const filename = `soundscape-audio-${timestamp}.zip`;

                // Check if running on native (Capacitor) with Share
                if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Share && window.Capacitor.Plugins.Filesystem) {
                    try {
                        const Filesystem = window.Capacitor.Plugins.Filesystem;
                        const Share = window.Capacitor.Plugins.Share;

                        // Convert blob to base64
                        const reader = new FileReader();
                        const base64Promise = new Promise((resolve, reject) => {
                            reader.onloadend = () => {
                                const base64 = reader.result.split(',')[1];
                                resolve(base64);
                            };
                            reader.onerror = reject;
                        });
                        reader.readAsDataURL(zipBlob);
                        const base64Data = await base64Promise;

                        // Save to documents
                        await Filesystem.writeFile({
                            path: filename,
                            data: base64Data,
                            directory: Directory.Documents
                        });

                        alert(`✅ ZIP saved to Documents!\n\n📁 Exercises: ${exercisesWithAudio.length}\n📍 Map markers: ${markersWithAudio.length}\n🎵 Total audio files: ${totalAudioCount}\n\nFind the file in Files app under "On My iPhone" > Documents\n\nFile: ${filename}`);
                    } catch (fsError) {
                        console.error('Filesystem error:', fsError);
                        alert('❌ ZIP save error: ' + fsError.message);
                    }
                } else {
                    // Fallback for web
                    const url = URL.createObjectURL(zipBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    URL.revokeObjectURL(url);

                    alert(`✅ Audio ZIP export completed!\n\n📁 Exercises: ${exercisesWithAudio.length}\n📍 Map markers: ${markersWithAudio.length}\n🎵 Total audio files: ${totalAudioCount}\n\nFile: ${filename}`);
                }

            } catch (error) {
                console.error('Audio ZIP export error:', error);
                alert('❌ Error during audio export:\n' + error.message);
            }
        }

        // Make functions global
        window.exportCompleteBackup = exportCompleteBackup;
        window.importCompleteBackup = importCompleteBackup;
        window.exportToExcel = exportToExcel;
        window.exportToKML = exportToKML;
        window.exportToWord = exportToWord;
        window.exportAudioZIP = exportAudioZIP;

        // Initialize premium UI on load
        window.addEventListener('DOMContentLoaded', () => {
            updatePremiumUI();
            initEmailJS();
        });

        // ==================== CONTACT FORM (MAILTO FALLBACK) ====================
        function initEmailJS() {
            const contactForm = document.getElementById('contactForm');
            const contactForm2 = document.getElementById('contactForm2');

            if (contactForm) {
                contactForm.addEventListener('submit', sendContactEmail);
            }
            if (contactForm2) {
                contactForm2.addEventListener('submit', sendContactEmail);
            }
        }

        function sendContactEmail(e) {
            e.preventDefault();

            const formId = e.target.id;
            const formSuffix = formId === 'contactForm2' ? '2' : '';

            // Get form values
            const name = document.getElementById('contactName' + formSuffix).value;
            const email = document.getElementById('contactEmail' + formSuffix).value;
            const subject = document.getElementById('contactSubject' + formSuffix).value;
            const message = document.getElementById('contactMessage' + formSuffix).value;

            // Create mailto link with pre-filled content
            const mailtoSubject = encodeURIComponent(`[Soundscape Studio ENG] ${subject}`);
            const mailtoBody = encodeURIComponent(
                `Name: ${name}\n` +
                `Email: ${email}\n` +
                `Subject: ${subject}\n\n` +
                `Message:\n${message}`
            );

            const mailtoLink = `mailto:soundscapestudiopro@gmail.com?subject=${mailtoSubject}&body=${mailtoBody}`;

            // Open Mail app with pre-filled data
            window.location.href = mailtoLink;

            // Show confirmation and reset form
            const statusEl = document.getElementById('contactFormStatus' + formSuffix);
            statusEl.textContent = '✅ Opening Mail app... Complete the sending from your Mail app.';
            statusEl.style.display = 'block';
            statusEl.style.color = '#4CAF50';

            setTimeout(() => {
                e.target.reset();
                statusEl.style.display = 'none';
            }, 3000);
        }

    </script>

    <!-- Paywall Modal -->
    <div id="paywall-modal" class="paywall-modal">
        <div class="paywall-content">
            <button class="paywall-close" onclick="closeUpgradeModal()">×</button>
            <h2 style="color: #d4af37; margin-bottom: 10px; text-align: center; font-size: 20px;">🌟 Premium</h2>

            <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 12px;">
                <strong>⚠️ Free: data saved LOCALLY only</strong><br>
                <strong style="color: #d4af37;">Upgrade to protect your work</strong>
            </p>

            <ul class="premium-features" style="margin-bottom: 15px;">
                <li style="margin-bottom: 8px;">
                    <span style="font-size: 18px;">💾</span>
                    <div>
                        <strong style="font-size: 13px;">Complete Backup</strong><br>
                        <small style="color: #666; font-size: 10px;">Export/Restore all data</small>
                    </div>
                </li>
                <li style="margin-bottom: 8px;">
                    <span style="font-size: 18px;">♾️</span>
                    <div>
                        <strong style="font-size: 13px;">Unlimited Markers</strong><br>
                        <small style="color: #666; font-size: 10px;">No 20-marker limit</small>
                    </div>
                </li>
                <li style="margin-bottom: 8px;">
                    <span style="font-size: 18px;">📄</span>
                    <div>
                        <strong style="font-size: 13px;">PDF/Excel/Word Export</strong><br>
                        <small style="color: #666; font-size: 10px;">Professional portfolios</small>
                    </div>
                </li>
            </ul>

            <div style="text-align: center; margin-top: 15px;">
                <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffe082 20%); padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 2px solid #d4af37;">
                    <div style="font-size: 32px; font-weight: 800; color: #d4af37; margin-bottom: 3px;">€49.99</div>
                    <div style="font-size: 12px; color: #666;">One-time - No subscription</div>
                </div>

                <button onclick="upgradeToPremium()" style="padding: 12px 35px; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; box-shadow: 0 4px 12px rgba(212,175,55,0.3); width: 100%;">
                    🔒 Purchase Premium
                </button>

                <button onclick="restorePurchases()" style="margin-top: 10px; padding: 10px 25px; background: transparent; color: #666; border: 2px solid #ccc; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; width: 100%;">
                    🔄 Restore Purchases
                </button>

                <p style="margin-top: 10px; font-size: 10px; color: #999;">
                    Secure via Apple App Store
                </p>
            </div>
        </div>
    </div>

</body>
</html>
